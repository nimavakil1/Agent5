<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Details - Inventory</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <script src="/shell-v2.js"></script>
  <style>
    :root {
      --accent: #8b5cf6;
      --accent-soft: rgba(139, 92, 246, 0.15);
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-card: #18181f;
      --bg-input: #12121a;
      --border: #252532;
      --text: #e4e4e7;
      --text-muted: #71717a;
    }

    .page { max-width: 1400px; margin: 0 auto; padding: 20px; }

    /* Back Link */
    .back-link { display: inline-flex; align-items: center; gap: 6px; color: var(--text-muted); text-decoration: none; font-size: 13px; margin-bottom: 16px; transition: color 0.15s; }
    .back-link:hover { color: var(--accent); }
    .back-link .material-symbols-outlined { font-size: 18px; }

    /* Hero Section */
    .hero { display: grid; grid-template-columns: 320px 1fr; gap: 32px; margin-bottom: 32px; }
    @media (max-width: 900px) { .hero { grid-template-columns: 1fr; } }

    .hero-image-container { position: relative; }
    .hero-image { width: 100%; aspect-ratio: 1; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .hero-image img { max-width: 90%; max-height: 90%; object-fit: contain; }
    .hero-image .material-symbols-outlined { font-size: 80px; color: #3f3f50; }
    .hero-badge { position: absolute; top: 12px; right: 12px; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
    .hero-badge.active { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .hero-badge.inactive { background: rgba(239, 68, 68, 0.2); color: #f87171; }

    .hero-content { display: flex; flex-direction: column; }
    .hero-sku { font-size: 13px; color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
    .hero-name { font-size: 28px; font-weight: 700; color: #fff; margin: 0 0 8px 0; line-height: 1.3; }
    .hero-category { font-size: 14px; color: var(--text-muted); margin-bottom: 24px; display: flex; align-items: center; gap: 6px; }
    .hero-category .material-symbols-outlined { font-size: 18px; }

    /* Quick Stats */
    .quick-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
    @media (max-width: 600px) { .quick-stats { grid-template-columns: repeat(2, 1fr); } }
    .quick-stat { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center; }
    .quick-stat-value { font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 4px; }
    .quick-stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.03em; }
    .quick-stat.success .quick-stat-value { color: var(--success); }
    .quick-stat.warning .quick-stat-value { color: var(--warning); }
    .quick-stat.danger .quick-stat-value { color: var(--danger); }
    .quick-stat.accent .quick-stat-value { color: var(--accent); }

    /* Stock Bar */
    .stock-bar-container { margin-bottom: 24px; }
    .stock-bar-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .stock-bar-label { font-size: 12px; color: var(--text-muted); }
    .stock-bar-value { font-size: 12px; font-weight: 600; color: #fff; }
    .stock-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; display: flex; }
    .stock-bar-segment { height: 100%; transition: width 0.5s ease; }
    .stock-bar-segment.available { background: var(--success); }
    .stock-bar-segment.incoming { background: var(--accent); }
    .stock-bar-segment.outgoing { background: var(--warning); }

    /* Hero Actions */
    .hero-actions { display: flex; gap: 10px; margin-top: auto; flex-wrap: wrap; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; text-decoration: none; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: #7c3aed; transform: translateY(-1px); }
    .btn-secondary { background: var(--bg-card); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: #222230; border-color: var(--accent); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.1); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn .material-symbols-outlined { font-size: 20px; }

    /* Tabs */
    .tabs-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
    .tabs-nav { display: flex; border-bottom: 1px solid var(--border); overflow-x: auto; }
    .tab-btn { flex: 1; min-width: 100px; padding: 16px 12px; background: transparent; border: none; color: var(--text-muted); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 6px; border-bottom: 2px solid transparent; margin-bottom: -1px; }
    .tab-btn:hover { color: var(--text); background: rgba(255,255,255,0.02); }
    .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-btn .material-symbols-outlined { font-size: 18px; }

    .tab-content { display: none; padding: 24px; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* Field Groups */
    .field-group { margin-bottom: 32px; }
    .field-group:last-child { margin-bottom: 0; }
    .field-group-title { font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .field-group-title .material-symbols-outlined { font-size: 20px; color: var(--accent); }

    .fields-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .field { background: var(--bg-input); border-radius: 10px; padding: 14px 16px; position: relative; }
    .field-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }
    .field-value { font-size: 14px; color: #fff; font-weight: 500; word-break: break-word; }
    .field-value.empty { color: var(--text-muted); font-style: italic; font-weight: 400; }
    .field-value.success { color: var(--success); }
    .field-value.warning { color: var(--warning); }
    .field-value.danger { color: var(--danger); }
    .field-value.accent { color: var(--accent); }
    .field.full-width { grid-column: 1 / -1; }

    /* Editable Fields */
    .field-input { display: none; width: 100%; padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: #fff; font-size: 14px; }
    .field-input:focus { outline: none; border-color: var(--accent); }
    .field-input.textarea { min-height: 80px; resize: vertical; }
    .field-input.select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2371717a' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }
    .edit-mode .field-value { display: none; }
    .edit-mode .field-input { display: block; }
    .field-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .field-checkbox input { width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; }

    /* Tags */
    .tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: var(--accent-soft); color: var(--accent); border-radius: 6px; font-size: 12px; font-weight: 500; margin-right: 6px; margin-bottom: 6px; }
    .tag.success { background: rgba(34, 197, 94, 0.15); color: var(--success); }
    .tag.warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); }

    /* Inventory Bars */
    .inventory-visual { margin-bottom: 24px; }
    .inventory-row { display: flex; align-items: center; gap: 16px; margin-bottom: 12px; }
    .inventory-label { width: 100px; font-size: 13px; color: var(--text-muted); }
    .inventory-bar-bg { flex: 1; height: 24px; background: var(--bg-input); border-radius: 6px; overflow: hidden; position: relative; }
    .inventory-bar-fill { height: 100%; border-radius: 6px; transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; }
    .inventory-bar-fill span { font-size: 12px; font-weight: 600; color: #fff; }
    .inventory-bar-fill.green { background: linear-gradient(90deg, #22c55e, #4ade80); }
    .inventory-bar-fill.blue { background: linear-gradient(90deg, #6366f1, #8b5cf6); }
    .inventory-bar-fill.orange { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .inventory-bar-fill.red { background: linear-gradient(90deg, #ef4444, #f87171); }

    /* Description */
    .description-box { background: var(--bg-input); border-radius: 10px; padding: 16px; }
    .description-box p { font-size: 14px; color: var(--text); line-height: 1.6; margin: 0; white-space: pre-wrap; }

    /* Timeline */
    .timeline { position: relative; padding-left: 24px; }
    .timeline::before { content: ''; position: absolute; left: 8px; top: 4px; bottom: 4px; width: 2px; background: var(--border); }
    .timeline-item { position: relative; margin-bottom: 20px; }
    .timeline-item:last-child { margin-bottom: 0; }
    .timeline-dot { position: absolute; left: -20px; top: 4px; width: 12px; height: 12px; border-radius: 50%; background: var(--accent); border: 2px solid var(--bg-card); }
    .timeline-content { background: var(--bg-input); border-radius: 10px; padding: 14px 16px; }
    .timeline-date { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
    .timeline-text { font-size: 14px; color: #fff; }

    /* Attachments */
    .attachment-categories { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .attachment-cat-btn { padding: 10px 16px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 6px; }
    .attachment-cat-btn:hover { border-color: var(--accent); color: var(--text); }
    .attachment-cat-btn.active { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }
    .attachment-cat-btn .count { background: var(--border); padding: 2px 8px; border-radius: 10px; font-size: 11px; }
    .attachment-cat-btn.active .count { background: var(--accent); color: #fff; }

    .attachments-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; }
    .attachment-card { background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.15s; position: relative; }
    .attachment-card:hover { border-color: var(--accent); transform: translateY(-2px); }
    .attachment-preview { aspect-ratio: 1; background: var(--bg-card); display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .attachment-preview img { width: 100%; height: 100%; object-fit: cover; }
    .attachment-preview video { width: 100%; height: 100%; object-fit: cover; }
    .attachment-preview .material-symbols-outlined { font-size: 48px; color: #3f3f50; }
    .attachment-info { padding: 12px; }
    .attachment-name { font-size: 12px; font-weight: 500; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
    .attachment-meta { font-size: 11px; color: var(--text-muted); }
    .attachment-delete { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; border-radius: 50%; background: rgba(0,0,0,0.7); border: none; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.15s; }
    .attachment-card:hover .attachment-delete { opacity: 1; }
    .attachment-delete:hover { background: var(--danger); }
    .attachment-delete .material-symbols-outlined { font-size: 16px; }

    .upload-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.15s; }
    .upload-zone:hover, .upload-zone.dragover { border-color: var(--accent); background: var(--accent-soft); }
    .upload-zone .material-symbols-outlined { font-size: 48px; color: var(--text-muted); margin-bottom: 12px; }
    .upload-zone-text { font-size: 14px; color: var(--text-muted); margin-bottom: 8px; }
    .upload-zone-hint { font-size: 12px; color: var(--text-muted); opacity: 0.7; }
    .upload-zone input { display: none; }

    .no-attachments { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .no-attachments .material-symbols-outlined { font-size: 48px; margin-bottom: 12px; display: block; }

    /* Loading State */
    .loading-container { display: flex; align-items: center; justify-content: center; min-height: 400px; flex-direction: column; gap: 16px; }
    .loading-container .material-symbols-outlined { font-size: 48px; color: var(--accent); animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .loading-text { font-size: 14px; color: var(--text-muted); }

    /* Toast */
    .toast { position: fixed; bottom: 20px; right: 20px; background: var(--bg-card); border: 1px solid var(--success); border-radius: 10px; padding: 14px 18px; color: var(--text); font-size: 13px; z-index: 2000; display: none; align-items: center; gap: 10px; }
    .toast.error { border-color: var(--danger); }
    .toast.show { display: flex; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Saving Indicator */
    .saving-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 3000; }
    .saving-overlay.show { display: flex; }
    .saving-box { background: var(--bg-card); border-radius: 12px; padding: 24px 32px; display: flex; align-items: center; gap: 16px; }
    .saving-box .material-symbols-outlined { font-size: 24px; color: var(--accent); animation: spin 1s linear infinite; }
    .saving-box span { font-size: 14px; color: var(--text); }
  </style>
</head>
<body>
  <div class="page">
    <a href="/inventory/" class="back-link">
      <span class="material-symbols-outlined">arrow_back</span>
      Back to Products
    </a>

    <div id="content">
      <div class="loading-container">
        <span class="material-symbols-outlined">sync</span>
        <div class="loading-text">Loading product details...</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <span class="material-symbols-outlined" id="toast-icon" style="color:#22c55e">check_circle</span>
    <span id="toast-message"></span>
  </div>

  <div class="saving-overlay" id="saving-overlay">
    <div class="saving-box">
      <span class="material-symbols-outlined">sync</span>
      <span>Saving to Odoo...</span>
    </div>
  </div>

  <script>
    let product = null;
    let attachments = { pictures: [], videos: [], packaging: [], documents: [] };
    let activeAttachmentCategory = 'pictures';
    let isEditMode = false;

    async function loadProduct() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');

      if (!id) {
        document.getElementById('content').innerHTML = `
          <div class="loading-container">
            <span class="material-symbols-outlined" style="animation:none;color:#ef4444">error</span>
            <div class="loading-text">No product ID specified</div>
          </div>
        `;
        return;
      }

      try {
        const res = await fetch(`/api/odoo/products/${id}`, { credentials: 'include' });
        if (!res.ok) throw new Error('Product not found');
        const data = await res.json();
        product = data.product;
        renderProduct();
        loadAttachments();
      } catch (error) {
        document.getElementById('content').innerHTML = `
          <div class="loading-container">
            <span class="material-symbols-outlined" style="animation:none;color:#ef4444">error</span>
            <div class="loading-text">${error.message}</div>
          </div>
        `;
      }
    }

    async function loadAttachments() {
      try {
        const res = await fetch(`/api/odoo/products/${product.id}/attachments`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          attachments = data.attachments || { pictures: [], videos: [], packaging: [], documents: [] };
          renderAttachmentsTab();
        }
      } catch (error) {
        console.error('Failed to load attachments:', error);
      }
    }

    function toggleEditMode() {
      isEditMode = !isEditMode;
      document.querySelectorAll('.tabs-container .tab-content').forEach(tab => {
        if (isEditMode) {
          tab.classList.add('edit-mode');
        } else {
          tab.classList.remove('edit-mode');
        }
      });

      const editBtn = document.getElementById('edit-btn');
      const saveBtn = document.getElementById('save-btn');
      const cancelBtn = document.getElementById('cancel-btn');

      if (isEditMode) {
        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-flex';
        cancelBtn.style.display = 'inline-flex';
      } else {
        editBtn.style.display = 'inline-flex';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
      }
    }

    function cancelEdit() {
      isEditMode = false;
      renderProduct();
    }

    async function saveProduct() {
      const overlay = document.getElementById('saving-overlay');
      overlay.classList.add('show');

      // Gather all editable field values
      const updates = {};
      document.querySelectorAll('[data-field]').forEach(input => {
        const field = input.dataset.field;
        if (input.type === 'checkbox') {
          updates[field] = input.checked;
        } else if (input.type === 'number') {
          updates[field] = parseFloat(input.value) || 0;
        } else {
          updates[field] = input.value;
        }
      });

      try {
        const res = await fetch(`/api/odoo/products/${product.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(updates)
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to save');
        }

        // Reload product data
        const data = await res.json();
        product = data.product;
        isEditMode = false;
        renderProduct();
        showToast('Product saved successfully', 'success');
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        overlay.classList.remove('show');
      }
    }

    function renderProduct() {
      const p = product;
      const stockClass = p.qtyOnHand <= 0 ? 'danger' : p.qtyOnHand <= 10 ? 'warning' : 'success';
      const maxQty = Math.max(p.qtyOnHand || 0, p.qtyForecasted || 0, 100);

      document.title = `${p.name} - Inventory`;

      document.getElementById('content').innerHTML = `
        <!-- Hero Section -->
        <div class="hero">
          <div class="hero-image-container">
            <div class="hero-image">
              ${p.image ? `<img src="${p.image}" alt="${p.name}">` : '<span class="material-symbols-outlined">inventory_2</span>'}
            </div>
            <div class="hero-badge ${p.active ? 'active' : 'inactive'}">${p.active ? 'Active' : 'Inactive'}</div>
          </div>

          <div class="hero-content">
            <div class="hero-sku">${p.sku || 'No SKU'}</div>
            <h1 class="hero-name">${p.name}</h1>
            <div class="hero-category">
              <span class="material-symbols-outlined">folder</span>
              ${p.category || 'Uncategorized'}
            </div>

            <div class="quick-stats">
              <div class="quick-stat ${stockClass}">
                <div class="quick-stat-value">${p.qtyOnHand ?? 0}</div>
                <div class="quick-stat-label">On Hand</div>
              </div>
              <div class="quick-stat accent">
                <div class="quick-stat-value">${p.qtyForecasted ?? 0}</div>
                <div class="quick-stat-label">Forecasted</div>
              </div>
              <div class="quick-stat">
                <div class="quick-stat-value">\u20AC${(p.salePrice || 0).toFixed(2)}</div>
                <div class="quick-stat-label">Sale Price</div>
              </div>
              <div class="quick-stat">
                <div class="quick-stat-value">\u20AC${(p.cost || 0).toFixed(2)}</div>
                <div class="quick-stat-label">Cost</div>
              </div>
            </div>

            <div class="stock-bar-container">
              <div class="stock-bar-header">
                <span class="stock-bar-label">Stock Breakdown</span>
                <span class="stock-bar-value">${p.qtyOnHand ?? 0} available / ${p.qtyIncoming ?? 0} incoming / ${p.qtyOutgoing ?? 0} outgoing</span>
              </div>
              <div class="stock-bar">
                <div class="stock-bar-segment available" style="width:${((p.qtyFree || 0) / maxQty) * 100}%"></div>
                <div class="stock-bar-segment incoming" style="width:${((p.qtyIncoming || 0) / maxQty) * 100}%"></div>
                <div class="stock-bar-segment outgoing" style="width:${((p.qtyOutgoing || 0) / maxQty) * 100}%"></div>
              </div>
            </div>

            <div class="hero-actions">
              <button id="edit-btn" class="btn btn-primary" onclick="toggleEditMode()">
                <span class="material-symbols-outlined">edit</span>
                Edit Product
              </button>
              <button id="save-btn" class="btn btn-success" onclick="saveProduct()" style="display:none">
                <span class="material-symbols-outlined">save</span>
                Save Changes
              </button>
              <button id="cancel-btn" class="btn btn-danger" onclick="cancelEdit()" style="display:none">
                <span class="material-symbols-outlined">close</span>
                Cancel
              </button>
              <a href="https://acropaq.odoo.com/web#id=${p.id}&model=product.product&view_type=form" target="_blank" class="btn btn-secondary">
                <span class="material-symbols-outlined">open_in_new</span>
                Open in Odoo
              </a>
              <button class="btn btn-secondary" onclick="copyToClipboard('${p.sku || p.id}')">
                <span class="material-symbols-outlined">content_copy</span>
                Copy SKU
              </button>
            </div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
          <div class="tabs-nav">
            <button class="tab-btn active" onclick="showTab('overview')">
              <span class="material-symbols-outlined">info</span>
              Overview
            </button>
            <button class="tab-btn" onclick="showTab('inventory')">
              <span class="material-symbols-outlined">inventory</span>
              Inventory
            </button>
            <button class="tab-btn" onclick="showTab('pricing')">
              <span class="material-symbols-outlined">payments</span>
              Pricing
            </button>
            <button class="tab-btn" onclick="showTab('logistics')">
              <span class="material-symbols-outlined">local_shipping</span>
              Logistics
            </button>
            <button class="tab-btn" onclick="showTab('config')">
              <span class="material-symbols-outlined">settings</span>
              Config
            </button>
            <button class="tab-btn" onclick="showTab('attachments')">
              <span class="material-symbols-outlined">attach_file</span>
              Attachments
            </button>
            <button class="tab-btn" onclick="showTab('history')">
              <span class="material-symbols-outlined">history</span>
              History
            </button>
          </div>

          <!-- Overview Tab -->
          <div class="tab-content active" id="tab-overview">
            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">badge</span>
                Identification
              </div>
              <div class="fields-grid">
                <div class="field">
                  <div class="field-label">Product Name</div>
                  <div class="field-value">${p.name}</div>
                  <input type="text" class="field-input" data-field="name" value="${escapeHtml(p.name || '')}">
                </div>
                <div class="field">
                  <div class="field-label">Internal Reference (SKU)</div>
                  <div class="field-value ${!p.sku ? 'empty' : ''}">${p.sku || 'Not set'}</div>
                  <input type="text" class="field-input" data-field="sku" value="${escapeHtml(p.sku || '')}">
                </div>
                <div class="field">
                  <div class="field-label">Barcode</div>
                  <div class="field-value ${!p.barcode ? 'empty' : ''}">${p.barcode || 'Not set'}</div>
                  <input type="text" class="field-input" data-field="barcode" value="${escapeHtml(p.barcode || '')}">
                </div>
                <div class="field">
                  <div class="field-label">Product Type</div>
                  <div class="field-value">${formatType(p.type)}</div>
                  <select class="field-input select" data-field="type">
                    <option value="consu" ${p.type === 'consu' ? 'selected' : ''}>Consumable</option>
                    <option value="service" ${p.type === 'service' ? 'selected' : ''}>Service</option>
                    <option value="product" ${p.type === 'product' ? 'selected' : ''}>Storable Product</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">description</span>
                Sales Description
              </div>
              <div class="description-box">
                <p class="field-value ${!p.descriptionSale ? 'empty' : ''}">${p.descriptionSale || 'No description'}</p>
                <textarea class="field-input textarea" data-field="descriptionSale">${escapeHtml(p.descriptionSale || '')}</textarea>
              </div>
            </div>

            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">sell</span>
                Quick Info
              </div>
              <div class="fields-grid">
                <div class="field">
                  <div class="field-label">Can be Sold</div>
                  <div class="field-value ${p.canSell ? 'success' : 'danger'}">${p.canSell ? 'Yes' : 'No'}</div>
                  <label class="field-checkbox field-input">
                    <input type="checkbox" data-field="canSell" ${p.canSell ? 'checked' : ''}>
                    <span>Enable sales</span>
                  </label>
                </div>
                <div class="field">
                  <div class="field-label">Can be Purchased</div>
                  <div class="field-value ${p.canPurchase ? 'success' : 'danger'}">${p.canPurchase ? 'Yes' : 'No'}</div>
                  <label class="field-checkbox field-input">
                    <input type="checkbox" data-field="canPurchase" ${p.canPurchase ? 'checked' : ''}>
                    <span>Enable purchasing</span>
                  </label>
                </div>
                <div class="field">
                  <div class="field-label">Unit of Measure</div>
                  <div class="field-value">${p.uom || 'Units'}</div>
                </div>
                <div class="field">
                  <div class="field-label">Category</div>
                  <div class="field-value ${!p.category ? 'empty' : ''}">${p.category || 'Uncategorized'}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Inventory Tab -->
          <div class="tab-content" id="tab-inventory">
            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">analytics</span>
                Stock Levels
              </div>
              <div class="inventory-visual">
                <div class="inventory-row">
                  <div class="inventory-label">On Hand</div>
                  <div class="inventory-bar-bg">
                    <div class="inventory-bar-fill green" style="width:${Math.min(((p.qtyOnHand || 0) / maxQty) * 100, 100)}%">
                      <span>${p.qtyOnHand ?? 0}</span>
                    </div>
                  </div>
                </div>
                <div class="inventory-row">
                  <div class="inventory-label">Forecasted</div>
                  <div class="inventory-bar-bg">
                    <div class="inventory-bar-fill blue" style="width:${Math.min(((p.qtyForecasted || 0) / maxQty) * 100, 100)}%">
                      <span>${p.qtyForecasted ?? 0}</span>
                    </div>
                  </div>
                </div>
                <div class="inventory-row">
                  <div class="inventory-label">Incoming</div>
                  <div class="inventory-bar-bg">
                    <div class="inventory-bar-fill blue" style="width:${Math.min(((p.qtyIncoming || 0) / maxQty) * 100, 100)}%">
                      <span>${p.qtyIncoming ?? 0}</span>
                    </div>
                  </div>
                </div>
                <div class="inventory-row">
                  <div class="inventory-label">Outgoing</div>
                  <div class="inventory-bar-bg">
                    <div class="inventory-bar-fill orange" style="width:${Math.min(((p.qtyOutgoing || 0) / maxQty) * 100, 100)}%">
                      <span>${p.qtyOutgoing ?? 0}</span>
                    </div>
                  </div>
                </div>
                <div class="inventory-row">
                  <div class="inventory-label">Free to Use</div>
                  <div class="inventory-bar-bg">
                    <div class="inventory-bar-fill ${(p.qtyFree || 0) > 0 ? 'green' : 'red'}" style="width:${Math.min(((p.qtyFree || 0) / maxQty) * 100, 100)}%">
                      <span>${p.qtyFree ?? 0}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">autorenew</span>
                Reordering
              </div>
              <div class="fields-grid">
                <div class="field">
                  <div class="field-label">Minimum Quantity</div>
                  <div class="field-value">${p.reorderMin ?? 0}</div>
                </div>
                <div class="field">
                  <div class="field-label">Maximum Quantity</div>
                  <div class="field-value">${p.reorderMax ?? 0}</div>
                </div>
                <div class="field">
                  <div class="field-label">Tracking</div>
                  <div class="field-value">${formatTracking(p.tracking)}</div>
                  <select class="field-input select" data-field="tracking">
                    <option value="none" ${p.tracking === 'none' ? 'selected' : ''}>No Tracking</option>
                    <option value="lot" ${p.tracking === 'lot' ? 'selected' : ''}>By Lots</option>
                    <option value="serial" ${p.tracking === 'serial' ? 'selected' : ''}>By Unique Serial Number</option>
                  </select>
                </div>
                <div class="field">
                  <div class="field-label">Responsible</div>
                  <div class="field-value ${!p.responsible ? 'empty' : ''}">${p.responsible || 'Not assigned'}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Pricing Tab -->
          <div class="tab-content" id="tab-pricing">
            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">euro</span>
                Prices
              </div>
              <div class="fields-grid">
                <div class="field">
                  <div class="field-label">Sales Price</div>
                  <div class="field-value accent" style="font-size:20px;font-weight:700">\u20AC${(p.salePrice || 0).toFixed(2)}</div>
                  <input type="number" step="0.01" class="field-input" data-field="salePrice" value="${p.salePrice || 0}">
                </div>
                <div class="field">
                  <div class="field-label">Cost</div>
                  <div class="field-value" style="font-size:20px;font-weight:700">\u20AC${(p.cost || 0).toFixed(2)}</div>
                  <input type="number" step="0.01" class="field-input" data-field="cost" value="${p.cost || 0}">
                </div>
                <div class="field">
                  <div class="field-label">Margin</div>
                  <div class="field-value ${getMarginClass(p.salePrice, p.cost)}" style="font-size:20px;font-weight:700">
                    ${calculateMargin(p.salePrice, p.cost)}
                  </div>
                </div>
                <div class="field">
                  <div class="field-label">Currency</div>
                  <div class="field-value">${p.currency || 'EUR'}</div>
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">receipt</span>
                Invoicing
              </div>
              <div class="fields-grid">
                <div class="field">
                  <div class="field-label">Invoice Policy</div>
                  <div class="field-value">${formatInvoicePolicy(p.invoicePolicy)}</div>
                  <select class="field-input select" data-field="invoicePolicy">
                    <option value="order" ${p.invoicePolicy === 'order' ? 'selected' : ''}>Ordered Quantities</option>
                    <option value="delivery" ${p.invoicePolicy === 'delivery' ? 'selected' : ''}>Delivered Quantities</option>
                  </select>
                </div>
                <div class="field">
                  <div class="field-label">Sales Taxes</div>
                  <div class="field-value ${!p.salesTaxes?.length ? 'empty' : ''}">${p.salesTaxes?.length || 0} configured</div>
                </div>
                <div class="field">
                  <div class="field-label">Purchase Taxes</div>
                  <div class="field-value ${!p.purchaseTaxes?.length ? 'empty' : ''}">${p.purchaseTaxes?.length || 0} configured</div>
                </div>
                <div class="field">
                  <div class="field-label">Supplier Count</div>
                  <div class="field-value">${p.supplierCount || 0}</div>
                </div>
              </div>
            </div>

            ${(p.incomeAccount || p.expenseAccount) ? `
            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">account_balance</span>
                Accounting
              </div>
              <div class="fields-grid">
                <div class="field">
                  <div class="field-label">Income Account</div>
                  <div class="field-value ${!p.incomeAccount ? 'empty' : ''}">${p.incomeAccount || 'Default'}</div>
                </div>
                <div class="field">
                  <div class="field-label">Expense Account</div>
                  <div class="field-value ${!p.expenseAccount ? 'empty' : ''}">${p.expenseAccount || 'Default'}</div>
                </div>
              </div>
            </div>
            ` : ''}
          </div>

          <!-- Logistics Tab -->
          <div class="tab-content" id="tab-logistics">
            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">public</span>
                Trade Information
              </div>
              <div class="fields-grid">
                <div class="field">
                  <div class="field-label">HS Code</div>
                  <div class="field-value ${!p.hsCode ? 'empty' : ''}">${p.hsCode || 'Not set'}</div>
                  <input type="text" class="field-input" data-field="hsCode" value="${escapeHtml(p.hsCode || '')}" placeholder="e.g., 8471.30.0000">
                </div>
                <div class="field">
                  <div class="field-label">Country of Origin</div>
                  <div class="field-value ${!p.originCountry ? 'empty' : ''}">${p.originCountry || 'Not set'}</div>
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">schedule</span>
                Lead Times
              </div>
              <div class="fields-grid">
                <div class="field">
                  <div class="field-label">Customer Lead Time (days)</div>
                  <div class="field-value">${p.saleDelay || 0} days</div>
                  <input type="number" class="field-input" data-field="saleDelay" value="${p.saleDelay || 0}" min="0">
                </div>
                <div class="field">
                  <div class="field-label">Manufacturing Lead Time (days)</div>
                  <div class="field-value">${p.produceDelay || 0} days</div>
                  <input type="number" class="field-input" data-field="produceDelay" value="${p.produceDelay || 0}" min="0">
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">scale</span>
                Physical Attributes
              </div>
              <div class="fields-grid">
                <div class="field">
                  <div class="field-label">Weight (kg)</div>
                  <div class="field-value">${p.weight ? p.weight + ' kg' : 'Not set'}</div>
                  <input type="number" step="0.001" class="field-input" data-field="weight" value="${p.weight || 0}">
                </div>
                <div class="field">
                  <div class="field-label">Volume (m\u00B3)</div>
                  <div class="field-value">${p.volume ? p.volume + ' m\u00B3' : 'Not set'}</div>
                  <input type="number" step="0.0001" class="field-input" data-field="volume" value="${p.volume || 0}">
                </div>
                <div class="field">
                  <div class="field-label">Unit of Measure (Sales)</div>
                  <div class="field-value">${p.uom || 'Units'}</div>
                </div>
                <div class="field">
                  <div class="field-label">Unit of Measure (Purchase)</div>
                  <div class="field-value">${p.purchaseUom || p.uom || 'Units'}</div>
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">inventory_2</span>
                Packaging
              </div>
              <div class="fields-grid">
                <div class="field">
                  <div class="field-label">Packaging Types</div>
                  <div class="field-value">${p.packagingCount || 0} configured</div>
                </div>
              </div>
            </div>

            ${p.descriptionPurchase ? `
            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">description</span>
                Purchase Description
              </div>
              <div class="description-box">
                <p class="field-value">${p.descriptionPurchase}</p>
                <textarea class="field-input textarea" data-field="descriptionPurchase">${escapeHtml(p.descriptionPurchase || '')}</textarea>
              </div>
            </div>
            ` : `
            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">description</span>
                Purchase Description
              </div>
              <div class="description-box">
                <p class="field-value empty">No description</p>
                <textarea class="field-input textarea" data-field="descriptionPurchase" placeholder="Add purchase description..."></textarea>
              </div>
            </div>
            `}
          </div>

          <!-- Configuration Tab -->
          <div class="tab-content" id="tab-config">
            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">toggle_on</span>
                Status & Settings
              </div>
              <div class="fields-grid">
                <div class="field">
                  <div class="field-label">Active</div>
                  <div class="field-value ${p.active ? 'success' : 'danger'}">${p.active ? 'Yes' : 'No'}</div>
                  <label class="field-checkbox field-input">
                    <input type="checkbox" data-field="active" ${p.active ? 'checked' : ''}>
                    <span>Active</span>
                  </label>
                </div>
                <div class="field">
                  <div class="field-label">Can be Sold</div>
                  <div class="field-value ${p.canSell ? 'success' : 'danger'}">${p.canSell ? 'Yes' : 'No'}</div>
                </div>
                <div class="field">
                  <div class="field-label">Can be Purchased</div>
                  <div class="field-value ${p.canPurchase ? 'success' : 'danger'}">${p.canPurchase ? 'Yes' : 'No'}</div>
                </div>
                <div class="field">
                  <div class="field-label">Product Type</div>
                  <div class="field-value">${formatType(p.type)}</div>
                </div>
              </div>
            </div>

            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">tag</span>
                IDs & References
              </div>
              <div class="fields-grid">
                <div class="field">
                  <div class="field-label">Product ID</div>
                  <div class="field-value accent">${p.id}</div>
                </div>
                <div class="field">
                  <div class="field-label">Template ID</div>
                  <div class="field-value">${p.templateId || '\u2014'}</div>
                </div>
                <div class="field">
                  <div class="field-label">Company</div>
                  <div class="field-value">${p.company || 'All Companies'}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Attachments Tab -->
          <div class="tab-content" id="tab-attachments">
            <div id="attachments-content">
              <div class="loading-container" style="min-height:200px">
                <span class="material-symbols-outlined">sync</span>
                <div class="loading-text">Loading attachments...</div>
              </div>
            </div>
          </div>

          <!-- History Tab -->
          <div class="tab-content" id="tab-history">
            <div class="field-group">
              <div class="field-group-title">
                <span class="material-symbols-outlined">schedule</span>
                Timeline
              </div>
              <div class="timeline">
                <div class="timeline-item">
                  <div class="timeline-dot"></div>
                  <div class="timeline-content">
                    <div class="timeline-date">${formatDate(p.updatedAt)}</div>
                    <div class="timeline-text">Last modified by ${p.updatedBy || 'System'}</div>
                  </div>
                </div>
                <div class="timeline-item">
                  <div class="timeline-dot"></div>
                  <div class="timeline-content">
                    <div class="timeline-date">${formatDate(p.createdAt)}</div>
                    <div class="timeline-text">Created by ${p.createdBy || 'System'}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderAttachmentsTab() {
      const totalCount = attachments.pictures.length + attachments.videos.length +
                        attachments.packaging.length + attachments.documents.length;

      const container = document.getElementById('attachments-content');
      container.innerHTML = `
        <div class="attachment-categories">
          <button class="attachment-cat-btn ${activeAttachmentCategory === 'pictures' ? 'active' : ''}" onclick="switchAttachmentCategory('pictures')">
            <span class="material-symbols-outlined">image</span>
            Pictures
            <span class="count">${attachments.pictures.length}</span>
          </button>
          <button class="attachment-cat-btn ${activeAttachmentCategory === 'videos' ? 'active' : ''}" onclick="switchAttachmentCategory('videos')">
            <span class="material-symbols-outlined">videocam</span>
            Videos
            <span class="count">${attachments.videos.length}</span>
          </button>
          <button class="attachment-cat-btn ${activeAttachmentCategory === 'packaging' ? 'active' : ''}" onclick="switchAttachmentCategory('packaging')">
            <span class="material-symbols-outlined">inventory_2</span>
            Packaging Files
            <span class="count">${attachments.packaging.length}</span>
          </button>
          <button class="attachment-cat-btn ${activeAttachmentCategory === 'documents' ? 'active' : ''}" onclick="switchAttachmentCategory('documents')">
            <span class="material-symbols-outlined">description</span>
            Documents
            <span class="count">${attachments.documents.length}</span>
          </button>
        </div>

        <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
          <span class="material-symbols-outlined">cloud_upload</span>
          <div class="upload-zone-text">Click or drag files to upload</div>
          <div class="upload-zone-hint">${getUploadHint(activeAttachmentCategory)}</div>
          <input type="file" id="file-input" ${getAcceptTypes(activeAttachmentCategory)} multiple onchange="handleFileUpload(event)">
        </div>

        <div id="attachments-grid" class="attachments-grid" style="margin-top:20px">
          ${renderAttachmentCards(attachments[activeAttachmentCategory])}
        </div>
      `;

      // Setup drag and drop
      const zone = document.getElementById('upload-zone');
      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
      });
      zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
      });
      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        handleFileDrop(e.dataTransfer.files);
      });
    }

    function switchAttachmentCategory(category) {
      activeAttachmentCategory = category;
      renderAttachmentsTab();
    }

    function getUploadHint(category) {
      const hints = {
        pictures: 'Supported: JPG, PNG, GIF, WebP',
        videos: 'Supported: MP4, MOV, AVI, WebM',
        packaging: 'Supported: PDF, AI, EPS, PSD',
        documents: 'Supported: PDF, DOC, DOCX, XLS, XLSX, TXT'
      };
      return hints[category] || '';
    }

    function getAcceptTypes(category) {
      const types = {
        pictures: 'accept="image/*"',
        videos: 'accept="video/*"',
        packaging: 'accept=".pdf,.ai,.eps,.psd"',
        documents: 'accept=".pdf,.doc,.docx,.xls,.xlsx,.txt"'
      };
      return types[category] || '';
    }

    function renderAttachmentCards(items) {
      if (!items || items.length === 0) {
        return `
          <div class="no-attachments" style="grid-column:1/-1">
            <span class="material-symbols-outlined">folder_open</span>
            <div>No ${activeAttachmentCategory} uploaded yet</div>
          </div>
        `;
      }

      return items.map(att => `
        <div class="attachment-card">
          <div class="attachment-preview">
            ${getAttachmentPreview(att)}
          </div>
          <div class="attachment-info">
            <div class="attachment-name" title="${escapeHtml(att.name)}">${att.name}</div>
            <div class="attachment-meta">${formatFileSize(att.size)}</div>
          </div>
          <button class="attachment-delete" onclick="deleteAttachment(${att.id})" title="Delete">
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
      `).join('');
    }

    function getAttachmentPreview(att) {
      if (att.mimetype && att.mimetype.startsWith('image/')) {
        return `<img src="/api/odoo/attachments/${att.id}/download" alt="${escapeHtml(att.name)}">`;
      }
      if (att.mimetype && att.mimetype.startsWith('video/')) {
        return `<video src="/api/odoo/attachments/${att.id}/download"></video>`;
      }
      // Icon based on mimetype
      let icon = 'description';
      if (att.mimetype) {
        if (att.mimetype.includes('pdf')) icon = 'picture_as_pdf';
        else if (att.mimetype.includes('spreadsheet') || att.mimetype.includes('excel')) icon = 'table_chart';
        else if (att.mimetype.includes('word') || att.mimetype.includes('document')) icon = 'article';
      }
      return `<span class="material-symbols-outlined">${icon}</span>`;
    }

    function formatFileSize(bytes) {
      if (!bytes) return 'Unknown size';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    async function handleFileUpload(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;
      await uploadFiles(files);
    }

    async function handleFileDrop(files) {
      if (!files || files.length === 0) return;
      await uploadFiles(files);
    }

    async function uploadFiles(files) {
      const overlay = document.getElementById('saving-overlay');
      overlay.querySelector('span:last-child').textContent = 'Uploading...';
      overlay.classList.add('show');

      let successCount = 0;
      let errorCount = 0;

      for (const file of files) {
        try {
          const base64 = await fileToBase64(file);
          const res = await fetch(`/api/odoo/products/${product.id}/attachments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              name: file.name,
              data: base64,
              mimetype: file.type,
              category: activeAttachmentCategory,
              description: ''
            })
          });

          if (res.ok) {
            successCount++;
          } else {
            errorCount++;
          }
        } catch (error) {
          console.error('Upload error:', error);
          errorCount++;
        }
      }

      overlay.classList.remove('show');

      if (successCount > 0) {
        showToast(`Uploaded ${successCount} file(s) successfully`, 'success');
        await loadAttachments();
      }
      if (errorCount > 0) {
        showToast(`Failed to upload ${errorCount} file(s)`, 'error');
      }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function deleteAttachment(attachmentId) {
      if (!confirm('Are you sure you want to delete this attachment?')) return;

      const overlay = document.getElementById('saving-overlay');
      overlay.querySelector('span:last-child').textContent = 'Deleting...';
      overlay.classList.add('show');

      try {
        const res = await fetch(`/api/odoo/products/${product.id}/attachments/${attachmentId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (res.ok) {
          showToast('Attachment deleted', 'success');
          await loadAttachments();
        } else {
          const err = await res.json();
          throw new Error(err.error || 'Failed to delete');
        }
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        overlay.classList.remove('show');
      }
    }

    function showTab(tabId) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
      const tab = document.getElementById(`tab-${tabId}`);
      tab.classList.add('active');
      if (isEditMode) tab.classList.add('edit-mode');
    }

    function formatType(type) {
      const types = { 'consu': 'Consumable', 'service': 'Service', 'product': 'Storable Product' };
      return types[type] || type || 'Unknown';
    }

    function formatTracking(tracking) {
      const types = { 'none': 'No Tracking', 'lot': 'By Lots', 'serial': 'By Unique Serial Number' };
      return types[tracking] || tracking || 'No Tracking';
    }

    function formatInvoicePolicy(policy) {
      const policies = { 'order': 'Ordered Quantities', 'delivery': 'Delivered Quantities' };
      return policies[policy] || policy || 'Default';
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown';
      return new Date(dateStr).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function calculateMargin(price, cost) {
      if (!price || price === 0) return '\u2014';
      const margin = ((price - (cost || 0)) / price) * 100;
      return margin.toFixed(1) + '%';
    }

    function getMarginClass(price, cost) {
      if (!price || price === 0) return '';
      const margin = ((price - (cost || 0)) / price) * 100;
      if (margin >= 30) return 'success';
      if (margin >= 10) return 'warning';
      return 'danger';
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text);
      showToast('Copied to clipboard', 'success');
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toast-icon');

      if (type === 'error') {
        toast.classList.add('error');
        icon.textContent = 'error';
        icon.style.color = '#ef4444';
      } else {
        toast.classList.remove('error');
        icon.textContent = 'check_circle';
        icon.style.color = '#22c55e';
      }

      document.getElementById('toast-message').textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    loadProduct();
  </script>
</body>
</html>
