<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agent Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js" crossorigin="anonymous"></script>
    <style>
      #transcript { white-space: pre-wrap; word-break: break-word; }
    </style>
  </head>
  <body class="min-h-screen bg-slate-50">
    <header class="bg-white shadow-sm">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <h1 class="text-lg font-semibold text-slate-800">Agent Studio</h1>
        <div class="flex items-center gap-3">
          <span id="who" class="text-sm text-slate-500"></span>
          <button id="logout" class="text-sm text-indigo-600 hover:underline">Logout</button>
        </div>
      </div>
    </header>
    <main class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-2 gap-6">
      <section class="bg-white rounded-lg shadow p-4">
        <h2 class="font-semibold text-slate-800 mb-3">Profile</h2>
        <div class="grid grid-cols-2 gap-3">
          <div class="col-span-2">
            <label class="block text-sm text-slate-600">Profile Name</label>
            <input id="name" class="mt-1 w-full border rounded px-3 py-2" placeholder="e.g., Sales - DACH" />
          </div>
          <div>
            <label class="block text-sm text-slate-600">Voice</label>
            <select id="voice" class="mt-1 w-full border rounded px-3 py-2">
              <option value="">(model default)</option>
              <option>alloy</option>
              <option>shimmer</option>
              <option>verse</option>
              <option>aria</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-slate-600">Language</label>
            <input id="language" class="mt-1 w-full border rounded px-3 py-2" placeholder="e.g., de" />
          </div>
          <div class="col-span-2">
            <label class="block text-sm text-slate-600">Instructions</label>
            <textarea id="instructions" class="mt-1 w-full border rounded px-3 py-2 h-36" placeholder="How should the agent behave?"></textarea>
          </div>
        </div>
        <div class="mt-3 flex gap-2">
          <button id="saveProfile" class="bg-indigo-600 text-white rounded px-3 py-2">Save Profile</button>
          <button id="newProfile" class="bg-slate-100 rounded px-3 py-2">New</button>
        </div>
        <div class="mt-4">
          <label class="block text-sm text-slate-600">Profiles</label>
          <select id="profiles" class="mt-1 w-full border rounded px-3 py-2"></select>
        </div>
      </section>
      <section class="bg-white rounded-lg shadow p-4">
        <h2 class="font-semibold text-slate-800 mb-3">Talk & Test</h2>
        <div class="grid grid-cols-2 gap-3">
          <div class="col-span-2">
            <label class="block text-sm text-slate-600">Room</label>
            <input id="room" class="mt-1 w-full border rounded px-3 py-2" placeholder="test-room" />
          </div>
          <div class="col-span-2">
            <label class="block text-sm text-slate-600">Prime Text (optional)</label>
            <input id="prime" class="mt-1 w-full border rounded px-3 py-2" placeholder="Topic to open with" />
          </div>
        </div>
        <div class="mt-3 flex gap-2">
          <button id="talk" class="bg-emerald-600 text-white rounded px-3 py-2">Talk to Agent</button>
          <button id="commit" class="bg-indigo-600 text-white rounded px-3 py-2">Commit Reply</button>
          <button id="stop" class="bg-slate-100 rounded px-3 py-2">Stop</button>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-3">
          <div>
            <div class="text-sm text-slate-500">State</div>
            <div id="state" class="font-medium">idle</div>
          </div>
          <div>
            <div class="text-sm text-slate-500">Latency</div>
            <div id="latency" class="font-medium">--</div>
          </div>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-4 items-center">
          <div>
            <div class="text-sm text-slate-500 mb-1">Mic Level</div>
            <div class="h-3 w-full bg-slate-200 rounded"><div id="vum-fill" class="h-3 bg-emerald-500 rounded" style="width:0%"></div></div>
          </div>
          <div class="flex gap-2 items-center">
            <span id="youBadge" class="px-2 py-1 rounded text-xs bg-slate-100 text-slate-600">You: silent</span>
            <span id="agentBadge" class="px-2 py-1 rounded text-xs bg-slate-100 text-slate-600">Agent: idle</span>
          </div>
        </div>
        
        <div class="mt-4">
          <div class="text-sm text-slate-500 mb-1">Transcript</div>
          <pre id="transcript" class="bg-slate-50 border rounded p-2 h-40 overflow-auto"></pre>
        </div>
        <div class="mt-4">
          <div class="text-sm text-slate-500 mb-1">Subscribed Tracks</div>
          <div id="tracks" class="flex gap-2 flex-wrap"></div>
        </div>
        <div class="mt-4">
          <div class="flex items-center justify-between mb-1">
            <div class="text-sm text-slate-500">Active Rooms</div>
            <button id="refreshRooms" class="text-xs bg-slate-100 rounded px-2 py-1">Refresh</button>
          </div>
          <div id="rooms" class="text-sm text-slate-700 flex flex-wrap gap-2"></div>
        </div>
      </section>
    </main>
    <script>
      // Session info
      fetch('/api/auth/me', { credentials: 'include' }).then(r => r.ok ? r.json() : Promise.reject()).then(u => {
        document.getElementById('who').textContent = u.email;
      }).catch(() => location.href = '/app/login');
      document.getElementById('logout').onclick = async () => { await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }); location.href = '/app/login'; };

      // Profiles
      async function loadProfiles(selectedId = '') {
        const res = await fetch('/api/agents', { credentials: 'include' });
        const list = res.ok ? await res.json() : [];
        const sel = document.getElementById('profiles');
        sel.innerHTML = '';
        for (const p of list) {
          const opt = document.createElement('option'); opt.value = p._id; opt.textContent = `${p.name} — ${p.voice || 'default'}`; sel.appendChild(opt);
        }
        // pick selection: explicit -> last used -> first
        const last = localStorage.getItem('agentProfileId');
        if (selectedId) sel.value = selectedId;
        else if (last && [...sel.options].some(o => o.value === last)) sel.value = last;
        else if (sel.options.length) sel.selectedIndex = 0;

        async function applySelected() {
          const id = sel.value; if (!id) return;
          localStorage.setItem('agentProfileId', id);
          const p = await (await fetch('/api/agents/' + id, { credentials: 'include' })).json();
          document.getElementById('name').value = p.name || '';
          document.getElementById('voice').value = p.voice || '';
          document.getElementById('language').value = p.language || '';
          document.getElementById('instructions').value = p.instructions || '';
        }

        sel.onchange = applySelected;
        // apply immediately on load so fields are populated
        if (sel.value) await applySelected();
      }
      loadProfiles();
      document.getElementById('newProfile').onclick = () => {
        document.getElementById('name').value = '';
        document.getElementById('voice').value = '';
        document.getElementById('language').value = '';
        document.getElementById('instructions').value = '';
      };
      document.getElementById('saveProfile').onclick = async () => {
        const body = {
          name: document.getElementById('name').value.trim() || ('Agent ' + Date.now()),
          voice: document.getElementById('voice').value,
          language: document.getElementById('language').value,
          instructions: document.getElementById('instructions').value,
        };
        const sel = document.getElementById('profiles');
        let res;
        let doc;
        if (sel.value) { res = await fetch('/api/agents/' + sel.value, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(body) }); if (res.ok) doc = await res.json(); }
        else { res = await fetch('/api/agents', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(body) }); if (res.ok) doc = await res.json(); }
        if (doc && doc._id) { await loadProfiles(doc._id); }
      };

      // Talk unified — rely on server VAD
      let ws, audioCtx, src, proc, stream, lastCommitAt=0, currentState='idle';
      let lkRoom = null;
      const stateEl = document.getElementById('state'); const latEl = document.getElementById('latency');
      function setState(s){ currentState=s; stateEl.textContent=s; }
      function floatTo16(input){ const out=new Int16Array(input.length); for(let i=0;i<input.length;i++){ let s=Math.max(-1,Math.min(1,input[i])); out[i]= s<0 ? s*0x8000 : s*0x7fff; } return out; }
      function down48to24(int16){ const out=new Int16Array(Math.floor(int16.length/2)); for(let i=0,j=0;j<out.length;i+=2,j++) out[j]=int16[i]; return out; }
      function energy(buf){ let sum=0; for(let i=0;i<buf.length;i++){ const v=buf[i]; sum+= v*v; } return Math.sqrt(sum/buf.length); }

      function attachWs(room, prime){
        const proto = location.protocol==='https:'?'wss':'ws';
        const qs = new URLSearchParams({ room }); if (prime) qs.set('text', prime);
        const profSel = document.getElementById('profiles');
        if (profSel.value) qs.set('profile', profSel.value);
        ws = new WebSocket(`${proto}://${location.host}/agent-stream?${qs.toString()}`);
        ws.onopen = ()=> setState('connected');
        ws.onmessage = (ev)=>{
          try{ const m=JSON.parse(ev.data);
            if(m.type==='first_audio_delta' && lastCommitAt){ const dt=Date.now()-lastCommitAt; latEl.textContent=dt+' ms'; }
            if(m.type==='transcript_delta'){ const el=document.getElementById('transcript'); el.textContent+=m.text; el.scrollTop=el.scrollHeight; }
            if(m.type==='agent_speaking'){ const ab=document.getElementById('agentBadge'); if(m.speaking){ ab.textContent='Agent: speaking'; ab.className='px-2 py-1 rounded text-xs bg-indigo-600 text-white'; } else { ab.textContent='Agent: idle'; ab.className='px-2 py-1 rounded text-xs bg-slate-100 text-slate-600'; } }
            if(m.type==='agent_audio_24k' && m.audio){ playAgent24k(m.audio); }
            if(m.type==='barge_in'){ duckAndFlush(); }
          }catch(_){}
        };
        ws.onclose = ()=> setState('idle');
        ws.onerror = ()=> setState('error');
      }

      async function joinLiveKit(roomName){
        try {
          const identity = 'viewer-' + Date.now();
          const res = await fetch(`/api/livekit/token?room=${encodeURIComponent(roomName)}&identity=${encodeURIComponent(identity)}`, { credentials: 'include' });
          if (!res.ok) return;
          const { token, host } = await res.json();
          const toWs = (u)=>{ if(!u) return ''; if(u.startsWith('wss://')||u.startsWith('ws://')) return u; if(u.startsWith('https://')) return 'wss://'+u.slice(8); if(u.startsWith('http://')) return 'ws://'+u.slice(7); return u; };
          const LK = window.LivekitClient || window.LiveKitClient || window.LiveKit || window.livekitClient || window.livekit || null;
          if (!LK) return;
          const wsHost = toWs(host) || 'wss://ai.acropaq.com';
          console.log('Joining LiveKit host:', wsHost, 'room:', roomName);
          lkRoom = new LK.Room();
          await lkRoom.connect(wsHost, token);
          const tracksEl = document.getElementById('tracks'); tracksEl.innerHTML='';
          lkRoom.on(LivekitClient.RoomEvent.TrackSubscribed, (track, pub) => {
            if (track.kind === 'audio') {
              const audio = document.createElement('audio'); audio.autoplay=true; audio.controls=true; audio.dataset.name = pub.trackName || pub.source || 'audio';
              track.attach(audio); tracksEl.appendChild(audio);
              // Attempt autoplay and fall back to click-to-unmute
              const tryPlay = () => audio.play().catch(() => {
                const btn = document.createElement('button');
                btn.textContent = 'Tap to enable audio (' + (pub.trackName || 'agent') + ')';
                btn.className = 'mt-2 bg-emerald-600 text-white rounded px-3 py-2';
                btn.onclick = () => { audio.muted=false; audio.play().catch(()=>{}); btn.remove(); };
                tracksEl.appendChild(btn);
              });
              tryPlay();
            }
          });
        } catch (_) {}
      }
      async function leaveLiveKit(){ try { if (lkRoom) { await lkRoom.disconnect(); lkRoom=null; document.getElementById('tracks').innerHTML=''; } } catch(_) {}
      }

      // Direct audio playback of 24k PCM16 from WS
      let playHead = 0;
      let agentGain = null;
      let scheduled = [];
      function playAgent24k(b64){
        try{
          if(!audioCtx){ return; }
          if(!agentGain){ agentGain = audioCtx.createGain(); agentGain.gain.setValueAtTime(1.0, audioCtx.currentTime); agentGain.connect(audioCtx.destination); }
          const bin = atob(b64);
          const len = (bin.length/2)|0;
          const buf = audioCtx.createBuffer(1, len, 24000);
          const ch = buf.getChannelData(0);
          for(let i=0, j=0; i<len; i++, j+=2){
            let v = (bin.charCodeAt(j) | (bin.charCodeAt(j+1) << 8));
            if (v & 0x8000) v = v - 0x10000;
            ch[i] = v / 32768;
          }
          const src = audioCtx.createBufferSource();
          src.buffer = buf; src.connect(agentGain);
          const now = audioCtx.currentTime;
          if (playHead < now + 0.02) playHead = now + 0.02;
          src.start(playHead); scheduled.push(src); src.onended = () => { scheduled = scheduled.filter(x => x !== src); };
          playHead += buf.duration;
        }catch(_){ }
      }
      function duckAndFlush(){
        try{
          if(!audioCtx) return;
          const now = audioCtx.currentTime;
          if(agentGain){ agentGain.gain.cancelScheduledValues(now); agentGain.gain.setTargetAtTime(0.0, now, 0.02); }
          for(const s of scheduled){ try{ s.stop(); } catch(_){} }
          scheduled = [];
          playHead = audioCtx.currentTime + 0.02;
          if(agentGain){ agentGain.gain.setTargetAtTime(1.0, now+0.06, 0.05); }
        }catch(_){ }
      }

      async function startTalk(){
        const room = document.getElementById('room').value.trim() || 'test-room-1';
        const prime = document.getElementById('prime').value.trim();
        await joinLiveKit(room);
        attachWs(room, prime);
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioCtx = new (window.AudioContext||window.webkitAudioContext)({ sampleRate: 48000 });
        src = audioCtx.createMediaStreamSource(stream);
        proc = audioCtx.createScriptProcessor(1024,1,1);
        const vum = document.getElementById('vum-fill');
        const youBadge = document.getElementById('youBadge');
        proc.onaudioprocess = (e)=>{
          if(!ws || ws.readyState!==WebSocket.OPEN) return;
          const input=e.inputBuffer.getChannelData(0);
          const rms = energy(input);
          // update VU (map 0..0.1 -> 0..100%)
          const pct = Math.max(0, Math.min(100, Math.round((rms/0.1)*100)));
          if (vum) vum.style.width = pct + '%';
          const int16=floatTo16(input); const ds=down48to24(int16);
          // send audio
          const buf=new Uint8Array(ds.length*2); for(let i=0;i<ds.length;i++){ buf[i*2]=ds[i]&0xff; buf[i*2+1]=(ds[i]>>8)&0xff; }
          ws.send(JSON.stringify({ type:'audio', audio: btoa(String.fromCharCode(...buf)) }));
          // simple activity badge
          if (rms>0.01) { youBadge.textContent='You: speaking'; youBadge.className='px-2 py-1 rounded text-xs bg-emerald-600 text-white'; }
          else { youBadge.textContent='You: silent'; youBadge.className='px-2 py-1 rounded text-xs bg-slate-100 text-slate-600'; }
        };
        src.connect(proc); proc.connect(audioCtx.destination);
      }
      async function stopTalk(){
        try{ if(ws&&ws.readyState===WebSocket.OPEN){ ws.close(); } }catch(_){ }
        try{ if(proc){ proc.disconnect(); proc=null; } }catch(_){ }
        try{ if(src){ src.disconnect(); src=null; } }catch(_){ }
        try{ if(audioCtx){ await audioCtx.close(); audioCtx=null; } }catch(_){ }
        try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch(_){ }
        try{ await leaveLiveKit(); } catch(_) {}
        setState('idle');
      }
      document.getElementById('talk').onclick = startTalk;
      document.getElementById('commit').onclick = () => { try { if(ws&&ws.readyState===WebSocket.OPEN){ lastCommitAt=Date.now(); ws.send(JSON.stringify({ type:'commit' })); setState('thinking'); } } catch(_) {} };
      document.getElementById('stop').onclick = stopTalk;

      // List active rooms and click to use room name
      async function listRooms(){
        try {
          let res = await fetch('/api/livekit/rooms', { credentials: 'include' });
          let rooms = [];
          if (res.ok) { rooms = await res.json(); }
          if (!Array.isArray(rooms) || rooms.length === 0) {
            res = await fetch('/api/livekit/recent-rooms', { credentials: 'include' });
            if (res.ok) rooms = await res.json();
          }
          const wrap = document.getElementById('rooms');
          wrap.innerHTML='';
          if (!rooms || rooms.length === 0) { wrap.textContent = 'No active rooms'; return; }
          for (const r of rooms) {
            const b = document.createElement('button');
            b.className='px-2 py-1 rounded bg-slate-100 hover:bg-slate-200';
            b.textContent = `${r.name} (${r.num_participants ?? '-'})`;
            b.onclick = ()=> { document.getElementById('room').value = r.name; };
            wrap.appendChild(b);
          }
        } catch (_) {}
      }
      document.getElementById('refreshRooms').onclick = listRooms;
      listRooms();
    </script>
  </body>
  </html>
