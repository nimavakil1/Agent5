<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agent Studio · ACROPAQ</title>
    <link crossorigin href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="/app/shell.js"></script>
    <style> body{font-family:Inter, "Noto Sans", sans-serif;} .card{background:#181C20;border:1px solid #283039;border-radius:.5rem;} .inp{background:#111418;border:1px solid #283039;color:#fff;border-radius:.375rem;padding:.5rem .75rem;width:100%;} .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.5rem;padding:.5rem .75rem;font-weight:500;} .btn-primary{background:#0d7ff2;color:#fff;} .btn-secondary{background:#0f172a;color:#fff;} .btn-danger{background:#b91c1c;color:#fff;} </style>
  </head>
  <body class="min-h-screen bg-[#111418] text-gray-100">
    <main class="max-w-6xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="card p-4 lg:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold text-white">Agent Studio</h2>
          <div class="flex items-center gap-2">
            <input id="q" class="inp text-sm" placeholder="Search agents…" />
            <button id="refresh" class="btn btn-secondary text-sm">Refresh</button>
            <button id="createFromTemplate" class="btn btn-primary text-sm">Create Agent</button>
          </div>
        </div>
        <!-- Modal -->
        <div id="tmplModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
          <div class="bg-[#181C20] border border-[#283039] rounded p-6 w-full max-w-2xl">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold text-white">Create Agent</h3>
              <button id="tmplClose" class="text-sm btn btn-secondary">Close</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div class="p-3 border border-[#283039] rounded">
                <div class="font-medium text-white">Inbound Sales</div>
                <div class="text-sm text-gray-400 mb-2">Answers inbound calls, qualifies leads, and offers products.</div>
                <button data-tmpl="inbound" class="btn btn-primary text-sm">Use Template</button>
              </div>
              <div class="p-3 border border-[#283039] rounded">
                <div class="font-medium text-white">Support Agent</div>
                <div class="text-sm text-gray-400 mb-2">Greets customers, gathers issue details, provides first-line help.</div>
                <button data-tmpl="support" class="btn btn-primary text-sm">Use Template</button>
              </div>
              <div class="p-3 border border-[#283039] rounded opacity-70">
                <div class="font-medium text-white">Outbound (cold)</div>
                <div class="text-sm text-gray-400 mb-2">Prospects with a short pitch and qualification. (Soon)</div>
                <button disabled class="btn btn-secondary text-sm">Coming Soon</button>
              </div>
              <div class="p-3 border border-[#283039] rounded opacity-70">
                <div class="font-medium text-white">Worker</div>
                <div class="text-sm text-gray-400 mb-2">Background task agent (no calls). (Soon)</div>
                <button disabled class="btn btn-secondary text-sm">Coming Soon</button>
              </div>
            </div>
          </div>
        </div>
        <div id="list" class="space-y-2"></div>
      </section>
      <section class="card p-4">
        <h3 class="font-medium text-white mb-3">Create / Edit Agent</h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="col-span-2"><label class="block text-sm text-gray-400">Name</label><input id="name" class="mt-1 inp" placeholder="e.g., Sales - DACH" /></div>
          <div><label class="block text-sm text-gray-400">Agent Type</label><select id="kind" class="mt-1 inp"><option value="call">Call Agent</option><option value="chat" disabled>Chat Agent (soon)</option><option value="worker" disabled>Background Worker (soon)</option></select></div>
          <div><label class="block text-sm text-gray-400">Voice</label><select id="voice" class="mt-1 inp"><option value="">(model default)</option><option>alloy</option><option>ash</option><option>ballad</option><option>cedar</option><option>coral</option><option>echo</option><option>marin</option><option>sage</option><option>shimmer</option><option>verse</option></select></div>
          <div><label class="block text-sm text-gray-400">Language</label><input id="language" class="mt-1 inp" placeholder="e.g., de" /></div>
          <div><label class="block text-sm text-gray-400">MCP Service</label><input id="mcp_service" class="mt-1 inp" placeholder="/api/mcp" /></div>
          <div class="col-span-2"><label class="block text-sm text-gray-400">Instructions</label><textarea id="instructions" class="mt-1 inp h-36" placeholder="How should this agent behave?"></textarea></div>
        </div>
        <div class="mt-3 flex gap-2"><button id="save" class="btn btn-primary">Save</button><button id="new" class="btn btn-secondary">New</button><button id="del" class="btn btn-danger">Delete</button></div>
      </section>
    </main>
    <script>
      let currentId='';
      const els={ list:document.getElementById('list'), q:document.getElementById('q'), refresh:document.getElementById('refresh'), name:document.getElementById('name'), voice:document.getElementById('voice'), instructions:document.getElementById('instructions'), language:document.getElementById('language'), kind:document.getElementById('kind'), mcp:document.getElementById('mcp_service'), save:document.getElementById('save'), del:document.getElementById('del'), neu:document.getElementById('new') };
      function row(a){ const div=document.createElement('div'); div.className='p-3 border border-[#283039] rounded flex items-center justify-between gap-2'; const left=document.createElement('div'); const mcp=(a.mcp_service||'').trim(); left.innerHTML=`<div class=\"font-medium\">${a.name}</div><div class=\"text-xs text-gray-400\">${a.kind||'call'} · ${a.voice||'default'} · ${a.language||''}${mcp?(' · MCP: '+mcp):''}</div>`; const r=document.createElement('div'); const b=document.createElement('button'); b.className='btn btn-secondary text-sm'; b.textContent='Edit'; b.onclick=()=>loadEdit(a._id); r.appendChild(b); div.appendChild(left); div.appendChild(r); return div; }
      async function loadList(){ const r=await fetch('/api/agents',{credentials:'include'}); const list=r.ok?await r.json():[]; const q=(els.q.value||'').toLowerCase(); els.list.innerHTML=''; list.filter(a=>!q||a.name.toLowerCase().includes(q)).forEach(a=> els.list.appendChild(row(a))); }
      async function loadEdit(id){ const r=await fetch('/api/agents/'+id,{credentials:'include'}); const a=r.ok?await r.json():null; if(!a) return; currentId=a._id; els.name.value=a.name||''; els.voice.value=a.voice||''; els.language.value=a.language||''; els.instructions.value=a.instructions||''; els.kind.value=a.kind||'call'; els.mcp.value=a.mcp_service||''; }
      els.refresh.onclick=loadList; els.q.oninput=()=> loadList(); els.neu.onclick=()=>{ currentId=''; els.name.value=''; els.voice.value=''; els.language.value=''; els.instructions.value=''; els.kind.value='call'; els.mcp.value=''; };
      els.save.onclick= async ()=>{ const body={ name:els.name.value.trim(), voice:els.voice.value, language:els.language.value, instructions:els.instructions.value, kind:els.kind.value, mcp_service: (els.mcp.value||'').trim() }; if(!body.name){ alert('Name required'); return; } let r; if(currentId) r=await fetch('/api/agents/'+currentId,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(body)}); else r=await fetch('/api/agents',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(body)}); if(!r.ok){ alert('Save failed'); return;} currentId=''; els.neu.click(); loadList(); };
      els.del.onclick= async ()=>{ if(!currentId) return; if(!confirm('Delete this agent?')) return; const r=await fetch('/api/agents/'+currentId,{method:'DELETE',credentials:'include'}); if(!r.ok){ alert('Delete failed'); return;} currentId=''; els.neu.click(); loadList(); };
      loadList();
      // Modal wiring
      const modal=document.getElementById('tmplModal');
      document.getElementById('createFromTemplate').onclick=()=>{ modal.classList.remove('hidden'); modal.classList.add('flex'); };
      document.getElementById('tmplClose').onclick=()=>{ modal.classList.add('hidden'); modal.classList.remove('flex'); };
      modal.addEventListener('click',(e)=>{ if(e.target===modal){ modal.classList.add('hidden'); modal.classList.remove('flex'); } });
      modal.querySelectorAll('button[data-tmpl]').forEach(btn=>{
        btn.onclick=()=>{
          const t=btn.getAttribute('data-tmpl');
          currentId='';
          els.kind.value='call';
          if(t==='inbound'){
            els.name.value='Inbound Sales';
            els.voice.value='shimmer';
            els.language.value='en';
            els.instructions.value='You are an inbound sales agent. Greet callers warmly, identify their needs, qualify them, and recommend relevant products. Be concise, helpful, and confirm next steps.';
          } else if(t==='support'){
            els.name.value='Support Agent';
            els.voice.value='alloy';
            els.language.value='en';
            els.instructions.value='You are a support agent. Greet politely, collect details (name, order/reference), diagnose common issues, and provide clear, step-by-step solutions or escalate when needed.';
          }
          modal.classList.add('hidden'); modal.classList.remove('flex');
        };
      });
    </script>
  </body>
  </html>
