<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Campaigns · ACROPAQ</title>
    <link crossorigin href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="/app/shell.js"></script>
    <style> body{font-family:Inter, "Noto Sans", sans-serif;} .card{background:#181C20;border:1px solid #283039;border-radius:.5rem;} .inp{background:#111418;border:1px solid #283039;color:#fff;border-radius:.375rem;padding:.5rem .75rem;width:100%;} .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.5rem;padding:.5rem .75rem;font-weight:500;} .btn-primary{background:#0d7ff2;color:#fff;} .btn-secondary{background:#0f172a;color:#fff;} .btn-danger{background:#b91c1c;color:#fff;} .tag{background:#0f172a;border:1px solid #283039;border-radius:.375rem;padding:.125rem .375rem;}</style>
  </head>
  <body class="min-h-screen bg-[#111418] text-gray-100">
    <main class="max-w-6xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="card p-4 lg:col-span-1">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold text-white">Campaigns</h2>
          <div class="flex items-center gap-2">
            <button id="newCamp" class="btn btn-primary text-sm">New Campaign</button>
            <button id="refresh" class="btn btn-secondary text-sm">Refresh</button>
          </div>
        </div>
        <input id="q" class="inp text-sm mb-3" placeholder="Search by name/id" />
        <div id="list" class="space-y-2"></div>
      </section>
      <section class="card p-4 lg:col-span-2">
        <h3 class="font-medium text-white mb-3">Orchestrator</h3>
        <div id="empty" class="text-sm text-gray-400">Select a campaign to edit routing.</div>
        <div id="orch" class="hidden">
          <div class="grid grid-cols-2 gap-3">
            <div><label class="block text-sm text-gray-400">MCP Service</label><input id="mcp" class="mt-1 inp" placeholder="/api/mcp" /></div>
            <div><label class="block text-sm text-gray-400">Default Agent Profile</label><select id="defaultAgent" class="mt-1 inp"></select></div>
          </div>
          <div class="mt-4">
            <div class="flex items-center justify-between mb-2"><div class="text-sm text-gray-400">Language Routes</div><button id="addRoute" class="btn btn-secondary text-sm">Add Route</button></div>
            <div id="routes" class="space-y-2"></div>
          </div>
          <div class="mt-6">
            <div class="text-sm text-gray-400 mb-2">Rules</div>
            <label class="flex items-center gap-2 text-sm mb-3"><input type="checkbox" id="autoLang" class="rounded"> <span>Auto-switch agent by detected language</span></label>
            <div class="mb-2 flex items-center justify-between"><div class="text-sm text-gray-400">Intent Keywords → Tag</div><button id="addIntent" class="btn btn-secondary text-sm">Add Intent</button></div>
            <div id="intents" class="space-y-2"></div>
          </div>
          <div class="mt-4 flex gap-2">
            <button id="save" class="btn btn-primary">Save Orchestrator</button>
            <div class="flex items-center gap-2">
              <input id="testLang" class="inp text-sm" placeholder="Test lang (e.g., fr)" style="width:10rem" />
              <button id="test" class="btn btn-secondary text-sm">Test Routing</button>
            </div>
          </div>
          <div id="testOut" class="mt-3 text-sm text-gray-300"></div>
        </div>
      </section>
      <!-- New Campaign Modal -->
      <div id="newModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-[#181C20] border border-[#283039] rounded p-6 w-full max-w-xl">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-white">Create Campaign</h3>
            <button id="newClose" class="btn btn-secondary text-sm">Close</button>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="col-span-2">
              <label class="block text-sm text-gray-400">Name</label>
              <input id="nc_name" class="mt-1 inp" placeholder="e.g., Q4 NL FR Sales" />
            </div>
            <div class="col-span-2">
              <label class="block text-sm text-gray-400">Description</label>
              <textarea id="nc_desc" class="mt-1 inp h-24" placeholder="Short description"></textarea>
            </div>
            <div>
              <label class="block text-sm text-gray-400">Timezone</label>
              <input id="nc_tz" class="mt-1 inp" value="Europe/Brussels" />
            </div>
            <div>
              <label class="block text-sm text-gray-400">Start At (ISO)</label>
              <input id="nc_start" class="mt-1 inp" placeholder="2025-09-20T09:00:00Z" />
            </div>
          </div>
          <div class="mt-4 flex gap-2">
            <button id="createCamp" class="btn btn-primary">Create</button>
            <button id="openOrchestrator" class="btn btn-secondary" title="Open the NL orchestrator builder in a new tab">Open Orchestrator</button>
          </div>
          <div id="nc_msg" class="mt-3 text-sm text-gray-300"></div>
        </div>
      </div>
    </main>
    <script>
      let campaigns=[]; let agents=[]; let current=null;
      const el={ list:document.getElementById('list'), q:document.getElementById('q'), refresh:document.getElementById('refresh'), empty:document.getElementById('empty'), orch:document.getElementById('orch'), mcp:document.getElementById('mcp'), def:document.getElementById('defaultAgent'), routes:document.getElementById('routes'), addRoute:document.getElementById('addRoute'), autoLang:document.getElementById('autoLang'), intents:document.getElementById('intents'), addIntent:document.getElementById('addIntent'), save:document.getElementById('save'), test:document.getElementById('test'), testLang:document.getElementById('testLang'), testOut:document.getElementById('testOut'),
        newBtn:document.getElementById('newCamp'), modal:document.getElementById('newModal'), closeBtn:document.getElementById('newClose'), nc_name:document.getElementById('nc_name'), nc_desc:document.getElementById('nc_desc'), nc_tz:document.getElementById('nc_tz'), nc_start:document.getElementById('nc_start'), createBtn:document.getElementById('createCamp'), openOrch:document.getElementById('openOrchestrator'), nc_msg:document.getElementById('nc_msg') };
      function row(c){ const div=document.createElement('div'); div.className='p-3 border border-[#283039] rounded'; const title=(c.title||c.name||'untitled'); const legacy=c.campaign_id?`<span class="tag ml-2">${c.campaign_id}</span>`:''; div.innerHTML=`<div class=\"font-medium\">${title}${legacy}</div><div class=\"text-xs text-gray-400\">${c.status||'draft'} · ${c.channel||'pstn'}</div>`; div.onclick=()=> loadEdit(c); return div; }
      function opt(sel, label, value){ const o=document.createElement('option'); o.textContent=label; o.value=value; sel.appendChild(o); }
      function renderAgentOptions(sel){ sel.innerHTML=''; opt(sel, '(none)', ''); for(const a of agents){ opt(sel, a.name, a.name); } }
      function addRouteRow(r){ const wrap=document.createElement('div'); wrap.className='grid grid-cols-3 gap-2 items-center'; const lang=document.createElement('input'); lang.className='inp'; lang.placeholder='lang (e.g., nl)'; lang.value=r?.lang||''; const ap=document.createElement('select'); ap.className='inp'; renderAgentOptions(ap); if(r?.agent_profile) ap.value=r.agent_profile; const del=document.createElement('button'); del.className='btn btn-danger text-sm'; del.textContent='Remove'; del.onclick=()=>{ wrap.remove(); } ; wrap.appendChild(lang); wrap.appendChild(ap); wrap.appendChild(del); el.routes.appendChild(wrap); }
      function addIntentRow(obj){ const wrap=document.createElement('div'); wrap.className='grid grid-cols-2 gap-2 items-center'; const p=document.createElement('input'); p.className='inp'; p.placeholder='pattern (e.g., rappeler)'; p.value=obj?.pattern||''; const t=document.createElement('input'); t.className='inp'; t.placeholder='tag (e.g., callback_requested)'; t.value=obj?.tag||''; const del=document.createElement('button'); del.className='btn btn-danger text-sm col-span-2'; del.textContent='Remove'; del.onclick=()=> wrap.remove(); wrap.appendChild(p); wrap.appendChild(t); wrap.appendChild(del); el.intents.appendChild(wrap); }
      async function load(){ const r1=await fetch('/api/campaigns',{credentials:'include'}); campaigns = r1.ok? await r1.json():[]; const r2=await fetch('/api/agents',{credentials:'include'}); agents = r2.ok? await r2.json():[]; el.list.innerHTML=''; const q=(el.q.value||'').toLowerCase(); for(const c of campaigns.filter(c=>{ const t=(c.title||c.name||'').toLowerCase(); const id=(c._id||'').toLowerCase(); const cid=(c.campaign_id||'').toLowerCase(); return !q || t.includes(q) || id.includes(q) || cid.includes(q); })){ el.list.appendChild(row(c)); } }
      function loadEdit(c){ current=c; el.empty.classList.add('hidden'); el.orch.classList.remove('hidden'); el.mcp.value = (c.orchestrator && c.orchestrator.mcp_service) || '/api/mcp'; renderAgentOptions(el.def); el.def.value = (c.orchestrator && c.orchestrator.default_agent_profile) || ''; el.routes.innerHTML=''; const lr = (c.orchestrator && Array.isArray(c.orchestrator.language_routes)) ? c.orchestrator.language_routes : []; if(!lr.length) addRouteRow({}); else lr.forEach(addRouteRow); el.autoLang.checked = !!(c.orchestrator && c.orchestrator.auto_lang_switch); el.intents.innerHTML=''; const ik = (c.orchestrator && Array.isArray(c.orchestrator.intent_keywords)) ? c.orchestrator.intent_keywords : []; if(!ik.length) addIntentRow({}); else ik.forEach(addIntentRow); }
      el.q.oninput = load; el.refresh.onclick = load; el.addRoute.onclick = ()=> addRouteRow({});
      el.addIntent.onclick = ()=> addIntentRow({});
      // Modal wiring
      el.newBtn.onclick = ()=>{ el.modal.classList.remove('hidden'); el.modal.classList.add('flex'); el.nc_msg.textContent=''; };
      el.closeBtn.onclick = ()=>{ el.modal.classList.add('hidden'); el.modal.classList.remove('flex'); };
      el.modal.addEventListener('click',(e)=>{ if(e.target===el.modal){ el.modal.classList.add('hidden'); el.modal.classList.remove('flex'); } });
      el.openOrch.onclick = ()=>{ window.open('/app/orchestrator.html','_blank'); };
      el.createBtn.onclick = async ()=>{
        try {
          const name=(el.nc_name.value||'').trim(); if(!name){ el.nc_msg.textContent='Name is required'; return; }
          const body={ name, description:(el.nc_desc.value||'').trim(), schedule:{ tz:(el.nc_tz.value||'').trim()||undefined, start_at: (el.nc_start.value||'')||undefined } };
          const r = await fetch('/api/campaigns',{ method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(body) });
          if (!r.ok){ const j=await r.json().catch(()=>({message:'error'})); el.nc_msg.textContent='Create failed: '+(j.message||r.status); return; }
          const c = await r.json();
          el.modal.classList.add('hidden'); el.modal.classList.remove('flex');
          await load();
          // Focus the new campaign in editor
          loadEdit(c);
        } catch(e){ el.nc_msg.textContent = 'Error: '+(e.message||String(e)); }
      };
      el.save.onclick = async ()=>{
        if (!current) return;
        const id = current._id;
        const rows = [...el.routes.children];
        const langRoutes = rows.map(row=>{
          const [langEl, apSel] = row.querySelectorAll('.inp');
          const lang = (langEl.value||'').trim().toLowerCase();
          const agent_profile = (apSel.value||'').trim();
          return (lang && agent_profile) ? { lang, agent_profile } : null;
        }).filter(Boolean);
        const intents = [...el.intents.children].map(w=>{ const ins = w.querySelectorAll('.inp'); return { pattern: (ins[0].value||'').trim(), tag: (ins[1].value||'').trim() }; }).filter(x=>x.pattern && x.tag);
        const orchestrator = { mcp_service: (el.mcp.value||'').trim(), default_agent_profile: el.def.value || '', language_routes: langRoutes, auto_lang_switch: !!el.autoLang.checked, intent_keywords: intents };
        const res = await fetch('/api/campaigns/'+id, { method:'PUT', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ orchestrator }) });
        if (!res.ok) { alert('Save failed'); return; }
        const updated = await res.json();
        loadEdit(updated);
        load();
      };
      el.test.onclick = async ()=>{
        if (!current) return;
        const lang = (el.testLang.value||'').trim().toLowerCase();
        const id = current._id || current.campaign_id || current.name;
        const r = await fetch(`/api/orchestrator/resolve?campaign=${encodeURIComponent(id)}&lang=${encodeURIComponent(lang)}`, { credentials:'include' });
        const j = r.ok ? await r.json() : { error: 'failed' };
        el.testOut.textContent = `Resolved → agent: ${j.agent?j.agent.name:'(none)'} • mcp: ${j.mcp_service||''}`;
      };
      load();
    </script>
  </body>
  </html>
