<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Contacts · ACROPAQ AI</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="/app/shell.js"></script>
    <style> body { font-family: Inter, "Noto Sans", sans-serif; } </style>
  </head>
  <body class="min-h-screen bg-[#111418] text-gray-100">
    <main class="p-8">
      <div class="flex flex-wrap items-start justify-between gap-4 mb-4">
        <h1 class="text-2xl font-bold">Contacts</h1>
        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-2">
            <a class="inline-flex items-center gap-2 rounded-md bg-[var(--primary-color)] px-4 py-2 text-sm font-medium text-white hover:bg-opacity-90" href="/api/prospects/template.csv"><span class="material-symbols-outlined">download</span>Contacts Template CSV</a>
            <form id="uploadForm" method="post" action="/api/prospects/upload" enctype="multipart/form-data" class="flex items-center gap-2">
              <input type="file" name="csv" accept=".csv" required class="rounded-md border border-[#283039] bg-[#181C20] px-2.5 py-2 text-sm"/>
              <button class="inline-flex items-center gap-2 rounded-md bg-[#0d7ff2] px-4 py-2 text-sm font-medium text-white hover:bg-opacity-90" type="submit"><span class="material-symbols-outlined">upload</span>Upload</button>
            </form>
          </div>
          <div class="flex items-center gap-2">
            <a class="inline-flex items-center gap-2 rounded-md bg-[#0f172a] px-4 py-2 text-sm font-medium text-white hover:bg-opacity-90" href="/api/prospects/deliveries_template.csv"><span class="material-symbols-outlined">download</span>Deliveries Template CSV</a>
            <form id="uploadDeliveriesForm" method="post" action="/api/prospects/upload_deliveries" enctype="multipart/form-data" class="flex items-center gap-2">
              <input type="file" name="csv" accept=".csv" required class="rounded-md border border-[#283039] bg-[#181C20] px-2.5 py-2 text-sm"/>
              <button class="inline-flex items-center gap-2 rounded-md bg-[#0d7ff2] px-4 py-2 text-sm font-medium text-white hover:bg-opacity-90" type="submit"><span class="material-symbols-outlined">upload</span>Upload</button>
            </form>
          </div>
        </div>
      </div>
      <p class="text-sm text-gray-400 mb-4">Upload contacts (invoice + first delivery) or use the deliveries template for bulk deliveries. Toggle opt‑out per phone below.</p>
      <div id="importReport" class="hidden rounded-md border border-[#3b4754] bg-[#161b20] mb-4">
        <div class="border-b border-[#3b4754] px-4 py-2"><strong class="text-sm">Import Report</strong></div>
        <div id="importReportBody" class="p-3 text-sm text-gray-200"></div>
      </div>
      <div class="flex items-center gap-2 mb-4">
        <label class="relative flex-1">
          <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">search</span>
          <input id="q" type="text" placeholder="Search name…" class="w-full rounded-md border border-[#283039] bg-[#181C20] py-2 pl-10 pr-3 text-sm"/>
        </label>
        <button class="inline-flex items-center gap-2 rounded-md bg-[#0f172a] px-4 py-2 text-sm font-medium text-white hover:bg-opacity-90" id="searchBtn"><span class="material-symbols-outlined">manage_search</span>Search</button>
        <label class="text-sm text-gray-400 inline-flex items-center gap-2 ml-2"><input type="checkbox" id="showArchived"/> Show archived</label>
      </div>
      <div class="flex items-center justify-between mb-2">
        <div id="resultsMeta" class="text-sm text-gray-400">0–0 of 0</div>
        <div class="flex items-center gap-2">
          <button id="prevPage" class="inline-flex items-center gap-2 rounded-md bg-[#0f172a] px-3 py-1.5 text-xs font-medium text-white hover:bg-opacity-90" disabled>
            <span class="material-symbols-outlined">chevron_left</span>Prev
          </button>
          <span id="pageInfo" class="text-xs text-gray-400">Page 1</span>
          <button id="nextPage" class="inline-flex items-center gap-2 rounded-md bg-[#0f172a] px-3 py-1.5 text-xs font-medium text-white hover:bg-opacity-90" disabled>
            Next<span class="material-symbols-outlined">chevron_right</span>
          </button>
        </div>
      </div>
      <div class="overflow-x-auto rounded-md border border-[#3b4754]">
        <table class="w-full text-left">
          <thead class="bg-[#1b2127]">
            <tr>
              <th class="p-3 text-sm font-medium text-white">Type</th>
              <th class="p-3 text-sm font-medium text-white">Company</th>
              <th class="p-3 text-sm font-medium text-white">Language</th>
              <th class="p-3 text-sm font-medium text-white">Confirmed</th>
              <th class="p-3 text-sm font-medium text-white">Tags</th>
              <th class="p-3 text-sm font-medium text-white">Actions</th>
            </tr>
          </thead>
          <tbody id="rows" class="divide-y divide-[#3b4754]"></tbody>
        </table>
      </div>
    </main>

    <div class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 flex" id="editModal" role="dialog" aria-modal="true">
      <div class="w-[680px] max-w-[90vw] rounded-lg border border-[#283039] bg-[#181C20]">
        <div class="flex items-center justify-between border-b border-[#283039] px-4 py-3">
          <strong id="editTitle">Edit</strong>
          <button id="closeBtn" class="text-gray-400 hover:text-white"><span class="material-symbols-outlined">close</span></button>
        </div>
        <div class="p-4">
          <form id="editForm" class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-gray-300">Contact Name<input type="text" id="f_name" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
              <label class="text-sm text-gray-300">Company<input type="text" id="f_company" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
              <label class="text-sm text-gray-300">VAT<input type="text" id="f_vat" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
              <label class="text-sm text-gray-300">Email<input type="text" id="f_email" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
              <div id="row_website"><label class="text-sm text-gray-300">Website<input type="text" id="f_website" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5" placeholder="https://..."/></label></div>
            </div>
            <div>
              <label class="text-sm text-gray-300">Landline<input type="text" id="f_phone" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
              <label class="text-sm text-gray-300">Mobile<input type="text" id="f_mobile" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
              <label class="text-sm text-gray-300">Language<input type="text" id="f_language" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
              <label class="text-sm text-gray-300 flex items-center gap-2">Language confirmed<input type="checkbox" id="f_lang_conf" class="h-4 w-4"/></label>
              <label class="text-sm text-gray-300 flex items-center gap-2">WhatsApp preferred<input type="checkbox" id="f_wa_pref" class="h-4 w-4"/></label>
            </div>
            <label class="text-sm text-gray-300">Address<input type="text" id="f_address" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
            <label class="text-sm text-gray-300">City<input type="text" id="f_city" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
            <label class="text-sm text-gray-300">Postal Code<input type="text" id="f_postal" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
            <label class="text-sm text-gray-300">Country<input type="text" id="f_country" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
          </form>
          <div class="mt-4">
            <div class="text-sm text-gray-300 mb-1">Interactions</div>
            <div id="logsArea" class="max-h-64 overflow-auto"></div>
          </div>
          <div class="mt-6">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm text-gray-300">Deliveries</div>
              <button id="addDelivery" class="inline-flex items-center gap-2 rounded-md bg-[#0d7ff2] px-3 py-1.5 text-xs font-medium text-white hover:bg-opacity-90">Add Delivery</button>
            </div>
            <div id="deliveriesList" class="space-y-2"></div>
            <div id="deliveryEditor" class="mt-3 hidden">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label class="text-sm text-gray-300">Contact Name<input id="d_name" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
                <label class="text-sm text-gray-300">Company<input id="d_company" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
                <label class="text-sm text-gray-300">Landline<input id="d_phone" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
                <label class="text-sm text-gray-300">Mobile<input id="d_mobile" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
                <label class="text-sm text-gray-300">Language<input id="d_language" class="mt-1 w-full rounded-md border border-[#283039] bg-[#111418] p-2.5"/></label>
                <label class="text-sm text-gray-300 flex items-center gap-2">Language confirmed<input type="checkbox" id="d_lang_conf" class="h-4 w-4"/></label>
                <label class="text-sm text-gray-300 flex items-center gap-2">WhatsApp preferred<input type="checkbox" id="d_wa_pref" class="h-4 w-4"/></label>
              </div>
              <div class="mt-3 flex justify-end gap-2">
                <button id="deliverySave" class="inline-flex items-center gap-2 rounded-md bg-[#0d7ff2] px-3 py-1.5 text-xs font-medium text-white hover:bg-opacity-90">Save Delivery</button>
                <button id="deliveryCancel" class="inline-flex items-center gap-2 rounded-md bg-gray-700 px-3 py-1.5 text-xs font-medium text-white hover:bg-gray-600">Cancel</button>
              </div>
            </div>
          </div>
        </div>
        <div class="flex items-center justify-end gap-2 border-t border-[#283039] px-4 py-3">
          <button class="inline-flex items-center gap-2 rounded-md bg-[var(--primary-color)] px-4 py-2 text-sm font-medium text-white hover:bg-opacity-90" id="saveBtn"><span class="material-symbols-outlined">save</span>Save</button>
        </div>
      </div>
    </div>

    <script>
      const rows = document.getElementById('rows');
      const q = document.getElementById('q');
      document.getElementById('searchBtn').onclick = ()=> loadProspects();
      // Upload deliveries CSV
      const upDel = document.getElementById('uploadDeliveriesForm');
      upDel.onsubmit = async (e)=>{
        e.preventDefault();
        const fd=new FormData(upDel);
        const r = await fetch('/api/prospects/upload_deliveries',{ method:'POST', body: fd, credentials:'include' });
        const j = await r.json();
        if(!r.ok){ alert(j.message||'Upload failed'); return; }
        renderImportReport(j, 'deliveries');
        loadProspects();
      };
      const modal = document.getElementById('editModal');
      const editTitle = document.getElementById('editTitle');
      const formEl = document.getElementById('editForm');
      let currentEdit = null; // { id, type, code }

      document.getElementById('closeBtn').onclick = ()=> modal.style.display='none';
      document.getElementById('saveBtn').onclick = saveEdit;

      document.getElementById('uploadForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const r = await fetch('/api/prospects/upload', { method:'POST', body: fd, credentials:'include' });
        const j = await r.json();
        if(!r.ok) { alert(j.message||'Upload failed'); return; }
        renderImportReport(j, 'contacts');
        loadProspects();
      });

      function renderImportReport(payload, kind){
        const box = document.getElementById('importReport');
        const body = document.getElementById('importReportBody');
        const total = payload.total||0; const ok = payload.imported||0;
        const imported = Array.isArray(payload.imported_items)? payload.imported_items: [];
        const failed = Array.isArray(payload.failed_items)? payload.failed_items: [];
        const errs = Array.isArray(payload.errors)? payload.errors: [];
        let html = '';
        html += `<div class=\"mb-2\"><span class=\"text-gray-400\">Type:</span> ${kind}</div>`;
        html += `<div class=\"mb-2\"><span class=\"text-gray-400\">Summary:</span> Imported ${ok} of ${total}. Failed ${Math.max(0,total-ok)}.</div>`;
        if (failed.length){
          html += `<div class=\"mb-2\"><button id=\"dlFailed\" class=\"inline-flex items-center gap-2 rounded-md bg-red-700 px-3 py-1.5 text-xs font-medium text-white hover:bg-red-600\"><span class=\"material-symbols-outlined\">download</span>Download failed CSV</button></div>`;
        }
        if(imported.length){
          html += '<div class="mt-2"><div class="text-gray-300 font-medium mb-1">Imported</div>';
          html += '<div class="max-h-40 overflow-auto border border-[#283039] rounded">';
          html += imported.map(it=>{
            if (kind==='deliveries') return `<div class=\"px-2 py-1 text-xs\">Row ${it.row}: parent=${(it.parent_id||'').slice(-6)} · delivery=${(it.delivery_id||'').slice(-6)} · ${it.company||''} · ${it.phone||''}</div>`;
            return `<div class=\"px-2 py-1 text-xs\">Row ${it.row}: id=${(it.id||'').slice(-6)} · ${it.invoice_name||''} · ${it.invoice_phone||''}</div>`;
          }).join('');
          html += '</div></div>';
        }
        if(failed.length || errs.length){
          html += '<div class="mt-3"><div class="text-red-300 font-medium mb-1">Failed</div>';
          html += '<div class="max-h-40 overflow-auto border border-red-900 rounded">';
          if (failed.length){
            html += failed.map(it=> `<div class=\"px-2 py-1 text-xs\">Row ${it.row}: [${it.error_code||'ERROR'}] ${it.error_message||''}</div>`).join('');
          } else {
            html += errs.map(e=> `<div class=\"px-2 py-1 text-xs\">${String(e||'')}</div>`).join('');
          }
          html += '</div></div>';
        }
        body.innerHTML = html;
        box.classList.remove('hidden');
        box.scrollIntoView({ behavior:'smooth', block:'center' });

        // Attach download for failed CSV
        const btn = document.getElementById('dlFailed');
        if (btn) {
          btn.onclick = ()=> downloadFailedCsv(failed, kind);
        }
      }

      function downloadFailedCsv(failed, kind){
        if (!Array.isArray(failed) || !failed.length) return;
        // collect headers
        const baseCols = ['row','error_code','error_message'];
        const dynamicCols = new Set();
        for (const f of failed){
          const obj = f.original_row || {};
          Object.keys(obj).forEach(k=> dynamicCols.add(k));
        }
        const headers = baseCols.concat(Array.from(dynamicCols));
        const esc = (v)=>{
          const s = (v===null||v===undefined)? '': String(v);
          // escape quotes and wrap
          return '"' + s.replace(/"/g, '""') + '"';
        };
        let csv = headers.join(',') + '\n';
        for (const f of failed){
          const row = [];
          row.push(esc(f.row));
          row.push(esc(f.error_code||''));
          row.push(esc(f.error_message||''));
          const src = f.original_row || {};
          for (const h of headers.slice(baseCols.length)) row.push(esc(src[h]!==undefined? src[h]:''));
          csv += row.join(',') + '\n';
        }
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const ts = new Date().toISOString().replace(/[-:]/g,'').replace(/\..*$/,'');
        a.href = url;
        a.download = `import_failures_${kind}_${ts}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      let currentPage = 1;
      const pageSize = 50;
      let lastTotal = 0;

      async function loadProspects(){
        rows.innerHTML = '<tr><td colspan="6" class="p-3 text-[#9cabba]">Loading…</td></tr>';
        const params = new URLSearchParams();
        if(q.value) params.set('q', q.value);
        if (document.getElementById('showArchived').checked) params.set('show_archived','1');
        params.set('paged','1');
        params.set('page', String(currentPage));
        params.set('page_size', String(pageSize));
        const r = await fetch('/api/prospects'+(params.toString()? ('?'+params.toString()):''), { credentials:'include' });
        const payload = await r.json();
        rows.innerHTML = '';
        const items = Array.isArray(payload)? payload : (payload.items||[]);
        lastTotal = Array.isArray(payload)? items.length : (payload.total||0);
        if(!Array.isArray(items) || !items.length){
          document.getElementById('resultsMeta').textContent = `0–0 of ${lastTotal}`;
          document.getElementById('pageInfo').textContent = `Page ${currentPage}`;
          document.getElementById('prevPage').disabled = currentPage<=1;
          document.getElementById('nextPage').disabled = (currentPage*pageSize)>=lastTotal;
          rows.innerHTML='<tr><td colspan="6" class="p-3 text-[#9cabba]">No prospects</td></tr>';
          return;
        }
        const start = (currentPage-1)*pageSize + 1;
        const end = Math.min(currentPage*pageSize, lastTotal);
        document.getElementById('resultsMeta').textContent = `${start}–${end} of ${lastTotal}`;
        const totalPages = Math.max(1, Math.ceil(lastTotal / pageSize));
        document.getElementById('pageInfo').textContent = `Page ${currentPage} / ${totalPages}`;
        document.getElementById('prevPage').disabled = currentPage<=1;
        document.getElementById('nextPage').disabled = currentPage>=totalPages;
        for (const row of items){
          const tr = document.createElement('tr');
          const phone = row.phone||'';
          const tags = Array.isArray(row.tags)? row.tags.filter(Boolean) : [];
          const tagsHtml = tags.length ? tags.map(t=>`<span class=\"inline-flex items-center rounded bg-gray-700 px-1.5 py-0.5 text-[10px] text-gray-300 mr-1\">${t.replace(/</g,'&lt;')}</span>`).join('') : '<span class="text-[#9cabba]">—</span>';
          tr.innerHTML = `
            <td class="p-3 text-sm">${row.type}${row.code? ' · '+row.code:''}</td>
            <td class="p-3 text-sm">${(row.company||'').replace(/</g,'&lt;')} ${row.archived? '<span class=\'ml-2 inline-flex items-center rounded bg-gray-700 px-1.5 py-0.5 text-[10px] text-gray-300\'>Archived</span>':''}</td>
            <td class="p-3 text-sm">${row.language||''}</td>
            <td class="p-3 text-sm">${row.language_confirmed? '✔️':'—'}</td>
            <td class="p-3 text-sm">${tagsHtml}</td>
            <td class="p-3">
              <div class="flex items-center gap-2">
                <button class="inline-flex items-center gap-2 rounded-md bg-[#0d7ff2] px-3 py-1.5 text-xs font-medium text-white hover:bg-opacity-90" data-act="toggle" data-phone="${encodeURIComponent(phone)}" data-opt="${row.opt_out?0:1}">${row.opt_out?'Allow':'Opt‑out'}</button>
                <button class="inline-flex items-center gap-2 rounded-md bg-[#0f172a] px-3 py-1.5 text-xs font-medium text-white hover:bg-opacity-90" data-act="edit" data-id="${row.id}" data-type="${row.type}" data-code="${row.code||''}">Edit</button>
                <button class="inline-flex items-center gap-2 rounded-md ${row.archived? 'bg-emerald-700 hover:bg-emerald-600':'bg-gray-700 hover:bg-gray-600'} px-3 py-1.5 text-xs font-medium text-white" data-act="archive" data-arch="${row.archived?0:1}" data-id="${row.id}">${row.archived? 'Unarchive':'Archive'}</button>
              </div>
            </td>
          `;
          rows.appendChild(tr);
        }
        rows.querySelectorAll('button[data-act="toggle"]').forEach(btn=>{
          btn.onclick = async (ev)=>{
            const p = ev.currentTarget.getAttribute('data-phone');
            const to = ev.currentTarget.getAttribute('data-opt')==='1';
            const r = await fetch(`/api/prospects/phone/${p}/opt-out`, { method:'PATCH', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ opt_out: to }) });
            if(!r.ok) alert('Failed'); else loadProspects();
          };
        });
        rows.querySelectorAll('button[data-act="edit"]').forEach(btn=>{
          btn.onclick = (ev)=> openEdit(ev.currentTarget.getAttribute('data-id'), ev.currentTarget.getAttribute('data-type'), ev.currentTarget.getAttribute('data-code'));
        });
        rows.querySelectorAll('button[data-act="archive"]').forEach(btn=>{
          btn.onclick = async (ev)=>{
            const id = ev.currentTarget.getAttribute('data-id');
            const to = ev.currentTarget.getAttribute('data-arch') === '1';
            await fetch(`/api/prospects/${id}/archive`, { method:'PATCH', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ archived: to }) });
            loadProspects();
          };
        });
      }

      async function openEdit(id, type, code){
        const r = await fetch(`/api/prospects/${id}`, { credentials:'include' });
        const doc = await r.json();
        currentEdit = { id, type, code };
        if(type==='invoice'){
          editTitle.textContent = 'Edit Invoice';
          fillForm(doc.invoice||{});
          const rw=document.getElementById('row_website'); if(rw) rw.style.display='block';
          document.getElementById('f_wa_pref').checked = !!(doc.invoice && doc.invoice.wa_preferred);
        } else {
          editTitle.textContent = `Edit Delivery ${code||''}`;
          const d = (doc.delivery_addresses||[]).find(x=> x.code===code) || {};
          fillForm(d);
          const rw=document.getElementById('row_website'); if(rw) rw.style.display='none';
          document.getElementById('f_wa_pref').checked = !!d.wa_preferred;
        }
        modal.classList.remove('hidden');
        loadLogs(id);
        if (type==='invoice') loadDeliveries(id);
      }

      async function loadLogs(id){
        try {
          const r = await fetch(`/api/prospects/${id}/logs`, { credentials:'include' });
          const j = await r.json();
          const area = document.getElementById('logsArea');
          if (!area) return;
          const calls = Array.isArray(j.calls)? j.calls: [];
          area.innerHTML = calls.length? '' : '<div class="text-sm text-gray-400">No interactions yet</div>';
          for (const c of calls){
            const div = document.createElement('div');
            div.className = 'rounded border border-[#283039] p-2 mb-2';
            div.innerHTML = `<div class=\"text-xs text-gray-400\">${new Date(c.start_time).toLocaleString()} · ${c.call_status} · ${c.language_detected||''}</div>
                             <div class=\"text-sm\">${(c.transcription_summary||'').slice(0,240)}</div>`;
            area.appendChild(div);
          }
        } catch(_){}
      }

      // Deliveries UI
      let currentDeliveryId = '';
      async function loadDeliveries(parentId){
        const list = await (await fetch(`/api/prospects/${parentId}/deliveries`, { credentials:'include' })).json();
        const box = document.getElementById('deliveriesList'); box.innerHTML='';
        if (!Array.isArray(list) || !list.length){ box.innerHTML='<div class="text-sm text-gray-400">No deliveries</div>'; return; }
        for (const d of list){
          const div=document.createElement('div'); div.className='rounded border border-[#283039] p-2 flex items-center justify-between';
          div.innerHTML = `<div class="text-sm">${(d.contact_name||'').replace(/</g,'&lt;')} · ${(d.company||'').replace(/</g,'&lt;')} · ${d.phone||''}${d.mobile? ' / '+d.mobile:''}</div>
                           <div class="flex gap-2"><button class="inline-flex items-center gap-2 rounded-md bg-[#0f172a] px-3 py-1.5 text-xs font-medium text-white hover:bg-opacity-90" data-act="edit" data-id="${d._id}">Edit</button>
                           <button class="inline-flex items-center gap-2 rounded-md bg-gray-700 px-3 py-1.5 text-xs font-medium text-white hover:bg-gray-600" data-act="arch" data-id="${d._id}">Archive</button></div>`;
          box.appendChild(div);
        }
        box.querySelectorAll('[data-act="edit"]').forEach(b=> b.onclick = async (ev)=>{
          const did=ev.currentTarget.getAttribute('data-id'); currentDeliveryId=did; document.getElementById('deliveryEditor').classList.remove('hidden');
          const list = await (await fetch(`/api/prospects/${currentEdit.id}/deliveries`, { credentials:'include' })).json(); const d=list.find(x=>x._id===did); if(!d) return;
          document.getElementById('d_name').value=d.contact_name||''; document.getElementById('d_company').value=d.company||''; document.getElementById('d_phone').value=d.phone||''; document.getElementById('d_mobile').value=d.mobile||''; document.getElementById('d_language').value=d.language||''; document.getElementById('d_lang_conf').checked=!!d.language_confirmed; document.getElementById('d_wa_pref').checked=!!d.wa_preferred;
        });
        box.querySelectorAll('[data-act="arch"]').forEach(b=> b.onclick = async (ev)=>{
          const did=ev.currentTarget.getAttribute('data-id'); await fetch(`/api/prospects/${currentEdit.id}/deliveries/${did}/archive`, { method:'PATCH', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ archived: true }) }); loadDeliveries(currentEdit.id);
        });
      }
      document.getElementById('addDelivery').onclick = ()=>{ currentDeliveryId=''; document.getElementById('deliveryEditor').classList.remove('hidden'); document.getElementById('d_name').value=''; document.getElementById('d_company').value=''; document.getElementById('d_phone').value=''; document.getElementById('d_mobile').value=''; document.getElementById('d_language').value=''; document.getElementById('d_lang_conf').checked=false; document.getElementById('d_wa_pref').checked=false; };
      document.getElementById('deliveryCancel').onclick = ()=>{ document.getElementById('deliveryEditor').classList.add('hidden'); };
      document.getElementById('deliverySave').onclick = async ()=>{
        const body = { name: document.getElementById('d_name').value, company: document.getElementById('d_company').value, phone: document.getElementById('d_phone').value, mobile: document.getElementById('d_mobile').value, language: document.getElementById('d_language').value, language_confirmed: document.getElementById('d_lang_conf').checked, wa_preferred: document.getElementById('d_wa_pref').checked };
        if (currentDeliveryId) await fetch(`/api/prospects/${currentEdit.id}/deliveries/${currentDeliveryId}/archive`, { method:'PATCH', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ archived: false }) }); // ensure visible if resurrecting
        if (currentDeliveryId) await fetch(`/api/prospects/${currentEdit.id}/delivery/${encodeURIComponent(currentDeliveryId)}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(body) });
        else await fetch(`/api/prospects/${currentEdit.id}/deliveries`, { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(body) });
        document.getElementById('deliveryEditor').classList.add('hidden'); loadDeliveries(currentEdit.id);
      };

      function fillForm(obj){
        formEl.querySelector('#f_name').value = obj.name||'';
        formEl.querySelector('#f_company').value = obj.company||'';
        formEl.querySelector('#f_vat').value = obj.vat||'';
        formEl.querySelector('#f_email').value = obj.email||'';
        const wEl = formEl.querySelector('#f_website'); if (wEl) wEl.value = obj.website||'';
        formEl.querySelector('#f_phone').value = obj.phone||'';
        const fm = formEl.querySelector('#f_mobile'); if (fm) fm.value = obj.mobile||'';
        formEl.querySelector('#f_language').value = obj.language||'';
        formEl.querySelector('#f_lang_conf').checked = !!obj.language_confirmed;
        formEl.querySelector('#f_address').value = obj.address||'';
        formEl.querySelector('#f_city').value = obj.city||'';
        formEl.querySelector('#f_postal').value = obj.postal_code||'';
        formEl.querySelector('#f_country').value = obj.country||'';
      }

      async function saveEdit(){
        if(!currentEdit) return;
        const body = {
          name: formEl.querySelector('#f_name').value,
          company: formEl.querySelector('#f_company').value,
          vat: formEl.querySelector('#f_vat').value,
          email: formEl.querySelector('#f_email').value,
          phone: formEl.querySelector('#f_phone').value,
          language: formEl.querySelector('#f_language').value,
          language_confirmed: formEl.querySelector('#f_lang_conf').checked,
          address: formEl.querySelector('#f_address').value,
          city: formEl.querySelector('#f_city').value,
          postal_code: formEl.querySelector('#f_postal').value,
          country: formEl.querySelector('#f_country').value,
        };
        body.mobile = (document.getElementById('f_mobile')?.value||'');
        if(currentEdit && currentEdit.type==='invoice') { body.website = (document.getElementById('f_website')?.value||''); body.wa_preferred = document.getElementById('f_wa_pref').checked; }
        else { body.wa_preferred = document.getElementById('f_wa_pref').checked; }
        let url = '';
        if(currentEdit.type==='invoice') url = `/api/prospects/${currentEdit.id}/invoice`;
        else url = `/api/prospects/${currentEdit.id}/delivery/${encodeURIComponent(currentEdit.code||'')}`;
        const r = await fetch(url, { method:'PATCH', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(body) });
        if(!r.ok){ alert('Save failed'); return; }
        modal.classList.add('hidden');
        loadProspects();
      }

      document.getElementById('showArchived').onchange = ()=> { currentPage=1; loadProspects(); };
      document.getElementById('searchBtn').onclick = ()=> { currentPage=1; loadProspects(); };
      document.getElementById('prevPage').onclick = ()=> { if (currentPage>1){ currentPage--; loadProspects(); } };
      document.getElementById('nextPage').onclick = ()=> { const totalPages=Math.max(1, Math.ceil(lastTotal/pageSize)); if (currentPage<totalPages){ currentPage++; loadProspects(); } };
      loadProspects();
    </script>
  </body>
  </html>
