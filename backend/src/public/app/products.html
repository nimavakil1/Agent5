<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Products</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-50">
    <header class="bg-white shadow-sm">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <h1 class="text-lg font-semibold text-slate-800">Products</h1>
        <div class="flex items-center gap-3">
          <a href="/app/agent-studio.html" class="text-sm text-indigo-600 hover:underline">Agent Studio</a>
          <a href="/dashboard.html" class="text-sm text-indigo-600 hover:underline">Dashboard</a>
        </div>
      </div>
    </header>
    <main class="max-w-6xl mx-auto p-4 grid gap-4">
      <section class="bg-white rounded-lg shadow p-4">
        <h2 class="font-medium text-slate-800 mb-2">Allowed List</h2>
        <p class="text-sm text-slate-600 mb-2">Paste SKUs (one per line). To use a variant ID explicitly, prefix with <span class="font-mono">vid:</span> (e.g., <span class="font-mono">vid:40757434318906</span>). Save, then Sync to pull details from Shopify.</p>
        <textarea id="allowed" class="w-full border rounded px-3 py-2 h-28 font-mono" placeholder="e.g.\nP0063\n40757434318906"></textarea>
        <div class="mt-3 flex gap-2">
          <button id="save" class="bg-indigo-600 text-white rounded px-3 py-2">Save Allowed</button>
          <button id="sync" class="bg-emerald-600 text-white rounded px-3 py-2">Sync Now</button>
          <span id="msg" class="text-sm text-slate-600"></span>
        </div>
      </section>
      <section class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-medium text-slate-800">Synced Products</h2>
          <div class="flex gap-2">
            <input id="q" class="border rounded px-2 py-1" placeholder="Search title/SKU" />
            <label class="text-sm text-slate-600 inline-flex items-center gap-1"><input type="checkbox" id="inStock"/> In stock</label>
            <button id="refresh" class="bg-slate-100 rounded px-3 py-1">Refresh</button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead><tr class="text-left text-slate-500"><th class="p-2">Image</th><th class="p-2">Title</th><th class="p-2">SKU</th><th class="p-2">Variant</th><th class="p-2">Price</th><th class="p-2">Stock</th></tr></thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </section>
    </main>
    <script src="/app/shell.js"></script>
    <script>
      async function loadAllowed(){
        const res = await fetch('/api/shopify/allowed', { credentials: 'include' });
        const list = res.ok ? await res.json() : [];
        const lines = list.map(x=> x.sku || String(x.variant_id || '')).filter(Boolean);
        document.getElementById('allowed').value = lines.join('\n');
      }
      async function saveAllowed(){
        const raw = document.getElementById('allowed').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const items = raw.map(s=> {
          if (/^vid:\s*(\d+)$/i.test(s)) { const m = s.match(/^vid:\s*(\d+)$/i); return { variant_id: Number(m[1]) }; }
          return { sku: s };
        });
        const res = await fetch('/api/shopify/allowed', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ items })});
        const data = await res.json(); document.getElementById('msg').textContent = res.ok ? `Saved ${data.saved}` : (data.message||'Error');
      }
      async function syncNow(){
        const res = await fetch('/api/shopify/sync', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({})});
        const data = await res.json(); document.getElementById('msg').textContent = res.ok ? `Synced ${data.synced}` : (data.message||'Error');
        await refreshProducts();
      }
      async function refreshProducts(){
        const q = document.getElementById('q').value.trim();
        const inStock = document.getElementById('inStock').checked ? '&in_stock=1' : '';
        const res = await fetch(`/api/products?q=${encodeURIComponent(q)}${inStock}`, { credentials:'include' });
        const list = res.ok ? await res.json() : [];
        const tbody = document.getElementById('rows'); tbody.innerHTML='';
        for (const p of list){
          const tr = document.createElement('tr'); tr.className='border-t';
          tr.innerHTML = `<td class="p-2"><img src="${p.image||''}" class="w-12 h-12 object-cover rounded"/></td>
            <td class="p-2">${p.title||''}</td>
            <td class="p-2">${p.sku||''}</td>
            <td class="p-2">${p.variant_title||''}<div class="text-xs text-slate-500">${p.variant_id}</div></td>
            <td class="p-2">${p.price||''} ${p.currency||''}</td>
            <td class="p-2">${p.inventory_quantity ?? ''}</td>`;
          tbody.appendChild(tr);
        }
      }
      document.getElementById('save').onclick = saveAllowed;
      document.getElementById('sync').onclick = syncNow;
      document.getElementById('refresh').onclick = refreshProducts;
      loadAllowed().then(refreshProducts);
    </script>
  </body>
  </html>
