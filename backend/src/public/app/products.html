<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Products Â· ACROPAQ AI</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="/app/shell.js"></script>
    <style>
      body { font-family: Inter, "Noto Sans", sans-serif; }
      .card { background:#181C20; border:1px solid #283039; border-radius:.5rem; }
      .inp { background:#111418; border:1px solid #283039; color:#fff; border-radius:.375rem; padding:.5rem .75rem; width:100%; }
      .muted { color:#9cabba; }
      .btn { display:inline-flex; align-items:center; gap:.5rem; border-radius:.5rem; padding:.5rem .75rem; font-weight:500; }
      .btn-primary { background:#0d7ff2; color:#fff; }
      .btn-secondary { background:#0f172a; color:#fff; }
    </style>
  </head>
  <body class="min-h-screen bg-[#111418] text-gray-100">
    <main class="max-w-6xl mx-auto p-6 grid gap-4">
      <section class="card p-4">
        <h2 class="font-medium text-white mb-2">Allowed List</h2>
        <p class="text-sm muted mb-2">Paste SKUs (one per line). To use a variant ID explicitly, prefix with <span class="font-mono">vid:</span> (e.g., <span class="font-mono">vid:40757434318906</span>). Save, then Sync to pull details from Shopify.</p>
        <textarea id="allowed" class="inp h-28 font-mono" placeholder="e.g.\nP0063\n40757434318906"></textarea>
        <div class="mt-3 flex gap-2 items-center">
          <button id="save" class="btn btn-primary">Save Allowed</button>
          <button id="sync" class="btn" style="background:#16a34a;color:#fff;">Sync Now</button>
          <span id="msg" class="text-sm muted"></span>
        </div>
      </section>
      <section class="card p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-medium text-white">Synced Products</h2>
          <div class="flex gap-2 items-center">
            <input id="q" class="inp w-56" placeholder="Search title/SKU" />
            <label class="text-sm muted inline-flex items-center gap-1"><input type="checkbox" id="inStock"/> In stock</label>
            <button id="refresh" class="btn btn-secondary">Refresh</button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead><tr class="text-left muted"><th class="p-2">Image</th><th class="p-2">Title</th><th class="p-2">SKU</th><th class="p-2">Variant</th><th class="p-2">Price</th><th class="p-2">Stock</th></tr></thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </section>
    </main>
    <script>
      async function loadAllowed(){
        const res = await fetch('/api/shopify/allowed', { credentials: 'include' });
        const list = res.ok ? await res.json() : [];
        const lines = list.map(x=> x.sku || String(x.variant_id || '')).filter(Boolean);
        document.getElementById('allowed').value = lines.join('\n');
      }
      async function saveAllowed(){
        const raw = document.getElementById('allowed').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const items = raw.map(s=> {
          if (/^vid:\s*(\d+)$/i.test(s)) { const m = s.match(/^vid:\s*(\d+)$/i); return { variant_id: Number(m[1]) }; }
          return { sku: s };
        });
        const res = await fetch('/api/shopify/allowed', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ items })});
        const data = await res.json(); document.getElementById('msg').textContent = res.ok ? `Saved ${data.saved}` : (data.message||'Error');
      }
      async function syncNow(){
        const res = await fetch('/api/shopify/sync', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({})});
        const data = await res.json(); document.getElementById('msg').textContent = res.ok ? `Synced ${data.synced}` : (data.message||'Error');
        await refreshProducts();
      }
      async function refreshProducts(){
        const q = document.getElementById('q').value.trim();
        const inStock = document.getElementById('inStock').checked ? '&in_stock=1' : '';
        const res = await fetch(`/api/products?q=${encodeURIComponent(q)}${inStock}`, { credentials:'include' });
        const list = res.ok ? await res.json() : [];
        const tbody = document.getElementById('rows'); tbody.innerHTML='';
        for (const p of list){
          const tr = document.createElement('tr'); tr.className='border-t';
          tr.innerHTML = `<td class="p-2"><img src="${p.image||''}" class="w-12 h-12 object-cover rounded"/></td>
            <td class="p-2">${p.title||''}</td>
            <td class="p-2">${p.sku||''}</td>
            <td class="p-2">${p.variant_title||''}<div class="text-xs text-slate-500">${p.variant_id}</div></td>
            <td class="p-2">${p.price||''} ${p.currency||''}</td>
            <td class="p-2">${p.inventory_quantity ?? ''}</td>`;
          tbody.appendChild(tr);
        }
      }
      document.getElementById('save').onclick = saveAllowed;
      document.getElementById('sync').onclick = syncNow;
      document.getElementById('refresh').onclick = refreshProducts;
      loadAllowed().then(refreshProducts);
    </script>
  </body>
  </html>
