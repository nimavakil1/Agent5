<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Call Review & Analysis Â· ACROPAQ AI</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="/app/shell.js"></script>
    <style>
      body { font-family: Inter, "Noto Sans", sans-serif; }
      .card { background:#181C20; border:1px solid #283039; border-radius:.5rem; }
      .inp { background:#111418; border:1px solid #283039; color:#fff; border-radius:.375rem; padding:.5rem .75rem; width:100%; }
      .btn { display:inline-flex; align-items:center; gap:.5rem; border-radius:.5rem; padding:.5rem .75rem; font-weight:500; }
      .btn-primary { background:#0d7ff2; color:#fff; }
      .btn-secondary { background:#0f172a; color:#fff; }
      .muted { color:#9cabba; }
      .transcript-line { 
        padding: 0.5rem; 
        margin: 0.25rem 0; 
        border-left: 3px solid transparent; 
      }
      .transcript-line.agent { 
        background-color: #0b2134; 
        border-left-color: #3b82f6; 
      }
      .transcript-line.user { 
        background-color: #0f2a22; 
        border-left-color: #10b981; 
      }
      .sentiment-positive { color: #10b981; }
      .sentiment-negative { color: #ef4444; }
      .sentiment-neutral { color: #6b7280; }
      .waveform-bar {
        display: inline-block;
        width: 2px;
        margin: 0 1px;
        background: #3b82f6;
        border-radius: 1px;
      }
    </style>
  </head>
  <body class="min-h-screen bg-[#111418] text-gray-100">
    <main class="max-w-7xl mx-auto p-6">
      <!-- Call List Section -->
      <section class="card mb-6">
        <div class="p-4 border-b border-[#283039]">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold text-white">Call History</h2>
            <div class="flex items-center gap-3">
              <input id="searchCalls" class="inp text-sm" placeholder="Search calls..." />
              <select id="filterStatus" class="inp text-sm">
                <option value="">All Status</option>
                <option value="success">Success</option>
                <option value="failed">Failed</option>
                <option value="dropped">Dropped</option>
                <option value="no_answer">No Answer</option>
              </select>
              <button id="refreshCalls" class="btn btn-primary text-sm">Refresh</button>
            </div>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-[#1b2127]">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium text-white">Date</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-white">Customer</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-white">Campaign</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-white">Duration</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-white">Status</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-white">Language</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-white">Actions</th>
              </tr>
            </thead>
            <tbody id="callsTable" class="divide-y divide-[#283039]">
              <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-400">Loading calls...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Call Details Section (Initially Hidden) -->
      <section id="callDetails" class="card hidden">
        <div class="p-4 border-b border-[#283039]">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="font-semibold text-white">Call Details</h2>
              <div class="text-sm muted mt-1">
                <span id="callDetailsTitle">Select a call to view details</span>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button id="exportCall" class="btn text-sm" style="background:#10b981;color:#fff;">Export Report</button>
              <button id="closeDetails" class="btn btn-secondary text-sm">Close</button>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
          <!-- Audio Playback & Waveform -->
          <div class="lg:col-span-2">
            <h3 class="font-medium text-white mb-3">Recording Playback</h3>
            <div class="bg-[#111418] border border-[#283039] rounded-lg p-4 mb-4">
              <audio id="audioPlayer" controls class="w-full mb-3" style="height: 40px;">
                <source type="audio/wav">
                Your browser does not support the audio element.
              </audio>
              <div class="flex items-center justify-between text-sm muted">
                <span>00:00</span>
                <div id="waveform" class="flex-1 mx-4 h-8 flex items-end justify-center">
                  <!-- Waveform bars will be generated here -->
                </div>
                <span id="audioDuration">00:00</span>
              </div>
            </div>
            
            <!-- Transcript -->
            <h3 class="font-medium text-white mb-3">Full Transcript</h3>
            <div class="bg-[#111418] border border-[#283039] rounded-lg p-4 max-h-96 overflow-y-auto" id="fullTranscript">
              <div class="text-gray-400 text-center py-8">No transcript available</div>
            </div>
          </div>
          
          <!-- Call Summary & Sentiment -->
          <div>
            <!-- Call Info -->
            <div class="bg-[#111418] border border-[#283039] rounded-lg p-4 mb-4">
              <h3 class="font-medium text-white mb-3">Call Information</h3>
              <div class="space-y-2 text-sm text-white">
                <div><span class="font-medium">Call ID:</span> <span id="callId">-</span></div>
                <div><span class="font-medium">Customer:</span> <span id="callCustomer">-</span></div>
                <div><span class="font-medium">Campaign:</span> <span id="callCampaign">-</span></div>
                <div><span class="font-medium">Start:</span> <span id="callStart">-</span></div>
                <div><span class="font-medium">End:</span> <span id="callEnd">-</span></div>
                <div><span class="font-medium">Duration:</span> <span id="callDuration">-</span></div>
                <div><span class="font-medium">Language:</span> <span id="callLanguage">-</span></div>
                <div><span class="font-medium">Status:</span> <span id="callStatus">-</span></div>
              </div>
            </div>

            <!-- AI Summary -->
            <div class="bg-[#111418] border border-[#283039] rounded-lg p-4 mb-4">
              <h3 class="font-medium text-white mb-3">AI Summary</h3>
              <div id="callSummary" class="text-sm text-white">
                <div class="text-gray-400 text-center py-4">No summary available</div>
              </div>
              <button id="generateSummary" class="mt-2 text-xs btn btn-primary">Generate Summary</button>
            </div>
            
            <!-- Sentiment Analysis -->
            <div class="bg-[#111418] border border-[#283039] rounded-lg p-4 mb-4">
              <h3 class="font-medium text-white mb-3">Sentiment Analysis</h3>
              <div id="sentimentChart" class="mb-3">
                <div class="flex items-center justify-between text-xs mb-1">
                  <span>Positive</span>
                  <span id="positivePercent">0%</span>
                </div>
                <div class="w-full bg-[#283039] rounded-full h-2 mb-2">
                  <div id="positiveBar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex items-center justify-between text-xs mb-1">
                  <span>Neutral</span>
                  <span id="neutralPercent">0%</span>
                </div>
                <div class="w-full bg-[#283039] rounded-full h-2 mb-2">
                  <div id="neutralBar" class="bg-gray-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex items-center justify-between text-xs mb-1">
                  <span>Negative</span>
                  <span id="negativePercent">0%</span>
                </div>
                <div class="w-full bg-[#283039] rounded-full h-2">
                  <div id="negativeBar" class="bg-red-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
              </div>
              <div class="text-xs muted">
                <span>Overall Sentiment: </span>
                <span id="overallSentiment" class="font-medium">Neutral</span>
              </div>
            </div>
            
            <!-- Offers & Recommendations -->
            <div class="bg-[#111418] border border-[#283039] rounded-lg p-4">
              <h3 class="font-medium text-white mb-3">Offers & Recommendations</h3>
              <div id="offersRecommended" class="space-y-2">
                <div class="text-gray-400 text-center py-4">No offers recommended</div>
              </div>
              <div id="shopifyCartLink" class="mt-3 hidden">
                <a href="#" class="text-sm" style="color:#0d7ff2">View Shopify Cart</a>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    <script>
      // Session info
      fetch('/api/auth/me', { credentials: 'include' }).then(r => r.ok ? r.json() : Promise.reject()).then(u => {
        document.getElementById('who').textContent = u.email;
      }).catch(() => location.href = '/app/login');
      document.getElementById('logout').onclick = async () => { await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }); location.href = '/app/login'; };

      // Global variables
      let allCalls = [];
      let filteredCalls = [];
      let currentCall = null;

      // Load and display calls
      async function loadCalls() {
        try {
          const res = await fetch('/api/calls/log?limit=50', { credentials: 'include' });
          allCalls = res.ok ? await res.json() : [];
          filteredCalls = [...allCalls];
          displayCalls();
        } catch (err) {
          console.error('Failed to load calls:', err);
          showError('Failed to load calls: ' + err.message);
        }
      }

      function displayCalls() {
        const tbody = document.getElementById('callsTable');
        tbody.innerHTML = '';

        if (filteredCalls.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-500">No calls found</td></tr>';
          return;
        }

        for (const call of filteredCalls) {
          const row = document.createElement('tr');
          row.className = 'hover:bg-slate-50 cursor-pointer';
          row.onclick = () => selectCall(call);
          
          const duration = call.end_time && call.start_time ? 
            formatDuration(new Date(call.end_time) - new Date(call.start_time)) : 
            'N/A';
          
          const statusClass = getStatusClass(call.call_status);
          
          row.innerHTML = `
            <td class="px-4 py-3 text-sm">${new Date(call.start_time).toLocaleString()}</td>
            <td class="px-4 py-3 text-sm font-medium">${call.customer_id}</td>
            <td class="px-4 py-3 text-sm">${call.campaign_id}</td>
            <td class="px-4 py-3 text-sm">${duration}</td>
            <td class="px-4 py-3 text-sm">
              <span class="px-2 py-1 rounded-full text-xs ${statusClass}">${call.call_status}</span>
            </td>
            <td class="px-4 py-3 text-sm">${call.language_detected}</td>
            <td class="px-4 py-3 text-sm">
              <button class="text-indigo-600 hover:underline" onclick="selectCall('${call._id}'); event.stopPropagation();">
                View Details
              </button>
            </td>
          `;
          tbody.appendChild(row);
        }
      }

      function getStatusClass(status) {
        const classes = {
          'success': 'bg-green-100 text-green-800',
          'failed': 'bg-red-100 text-red-800',
          'dropped': 'bg-yellow-100 text-yellow-800',
          'no_answer': 'bg-gray-100 text-gray-800'
        };
        return classes[status] || 'bg-gray-100 text-gray-800';
      }

      function formatDuration(ms) {
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
      }

      // Select and display call details
      async function selectCall(call) {
        if (typeof call === 'string') {
          // Find call by ID
          call = allCalls.find(c => c._id === call);
        }
        
        if (!call) return;
        
        currentCall = call;
        document.getElementById('callDetails').classList.remove('hidden');
        
        // Populate call info
        document.getElementById('callDetailsTitle').textContent = 
          `${call.customer_id} - ${new Date(call.start_time).toLocaleDateString()}`;
        document.getElementById('callId').textContent = call.call_id;
        document.getElementById('callCustomer').textContent = call.customer_id;
        document.getElementById('callCampaign').textContent = call.campaign_id;
        document.getElementById('callStart').textContent = new Date(call.start_time).toLocaleString();
        document.getElementById('callEnd').textContent = call.end_time ? new Date(call.end_time).toLocaleString() : 'N/A';
        document.getElementById('callDuration').textContent = call.end_time ? 
          formatDuration(new Date(call.end_time) - new Date(call.start_time)) : 'N/A';
        document.getElementById('callLanguage').textContent = call.language_detected;
        document.getElementById('callStatus').textContent = call.call_status;
        
        // Load audio if available
        loadAudioPlayer(call);
        
        // Display transcript
        displayTranscript(call.transcription || '');
        
        // Display sentiment analysis
        displaySentimentAnalysis(call.sentiment_scores || []);
        
        // Display offers
        displayOffers(call.offers_recommended || [], call.shopify_cart_link);
        
        // Scroll to call details
        document.getElementById('callDetails').scrollIntoView({ behavior: 'smooth' });
      }

      function loadAudioPlayer(call) {
        const audioPlayer = document.getElementById('audioPlayer');
        if (call.audio_recording_url) {
          audioPlayer.src = call.audio_recording_url;
          audioPlayer.style.display = 'block';
          generateWaveform();
        } else {
          audioPlayer.style.display = 'none';
          document.getElementById('waveform').innerHTML = '<span class="text-slate-500 text-sm">No recording available</span>';
        }
      }

      function generateWaveform() {
        // Generate a simple fake waveform for demo purposes
        const waveform = document.getElementById('waveform');
        waveform.innerHTML = '';
        
        for (let i = 0; i < 100; i++) {
          const bar = document.createElement('div');
          bar.className = 'waveform-bar';
          bar.style.height = Math.random() * 30 + 5 + 'px';
          waveform.appendChild(bar);
        }
      }

      function displayTranscript(transcription) {
        const transcriptEl = document.getElementById('fullTranscript');
        
        if (!transcription) {
          transcriptEl.innerHTML = '<div class="text-slate-500 text-center py-8">No transcript available</div>';
          return;
        }

        // Split transcript by speaker (simplified parsing)
        const lines = transcription.split('\n').filter(line => line.trim());
        let transcriptHtml = '';
        
        for (const line of lines) {
          const isAgent = line.toLowerCase().includes('agent:') || line.toLowerCase().includes('ai:');
          const isUser = line.toLowerCase().includes('user:') || line.toLowerCase().includes('customer:');
          
          let className = 'transcript-line';
          if (isAgent) className += ' agent';
          else if (isUser) className += ' user';
          
          transcriptHtml += `<div class="${className}">${line}</div>`;
        }
        
        transcriptEl.innerHTML = transcriptHtml || '<div class="text-slate-500 text-center py-8">Transcript format not recognized</div>';
      }

      function displaySentimentAnalysis(sentimentScores) {
        if (!sentimentScores || sentimentScores.length === 0) {
          document.getElementById('overallSentiment').textContent = 'No sentiment data';
          return;
        }

        // Calculate average sentiment
        const totals = { positive: 0, neutral: 0, negative: 0 };
        let count = 0;

        for (const score of sentimentScores) {
          if (score.sentiment === 'positive') totals.positive += score.score || 1;
          else if (score.sentiment === 'negative') totals.negative += score.score || 1;
          else totals.neutral += score.score || 1;
          count++;
        }

        const total = totals.positive + totals.neutral + totals.negative;
        if (total === 0) return;

        const positivePercent = Math.round((totals.positive / total) * 100);
        const neutralPercent = Math.round((totals.neutral / total) * 100);
        const negativePercent = Math.round((totals.negative / total) * 100);

        document.getElementById('positivePercent').textContent = positivePercent + '%';
        document.getElementById('neutralPercent').textContent = neutralPercent + '%';
        document.getElementById('negativePercent').textContent = negativePercent + '%';

        document.getElementById('positiveBar').style.width = positivePercent + '%';
        document.getElementById('neutralBar').style.width = neutralPercent + '%';
        document.getElementById('negativeBar').style.width = negativePercent + '%';

        // Determine overall sentiment
        let overall = 'Neutral';
        if (positivePercent > neutralPercent && positivePercent > negativePercent) overall = 'Positive';
        else if (negativePercent > positivePercent && negativePercent > neutralPercent) overall = 'Negative';

        const overallEl = document.getElementById('overallSentiment');
        overallEl.textContent = overall;
        overallEl.className = 'font-medium sentiment-' + overall.toLowerCase();
      }

      function displayOffers(offers, cartLink) {
        const offersEl = document.getElementById('offersRecommended');
        
        if (!offers || offers.length === 0) {
          offersEl.innerHTML = '<div class="text-slate-500 text-center py-4">No offers recommended</div>';
        } else {
          offersEl.innerHTML = offers.map(offer => 
            `<div class="bg-white rounded p-2 text-sm border">${offer}</div>`
          ).join('');
        }

        const cartLinkEl = document.getElementById('shopifyCartLink');
        if (cartLink) {
          cartLinkEl.classList.remove('hidden');
          cartLinkEl.querySelector('a').href = cartLink;
        } else {
          cartLinkEl.classList.add('hidden');
        }
      }

      // Search and filter functionality
      document.getElementById('searchCalls').oninput = (e) => {
        const query = e.target.value.toLowerCase();
        filteredCalls = allCalls.filter(call => 
          call.customer_id.toLowerCase().includes(query) ||
          call.campaign_id.toLowerCase().includes(query) ||
          call.call_id.toLowerCase().includes(query)
        );
        applyStatusFilter();
      };

      document.getElementById('filterStatus').onchange = applyStatusFilter;

      function applyStatusFilter() {
        const status = document.getElementById('filterStatus').value;
        if (status) {
          filteredCalls = filteredCalls.filter(call => call.call_status === status);
        }
        displayCalls();
      }

      // Export functionality
      document.getElementById('exportCall').onclick = async () => {
        if (!currentCall) return;
        
        const exportData = {
          call_info: {
            call_id: currentCall.call_id,
            customer: currentCall.customer_id,
            campaign: currentCall.campaign_id,
            start_time: currentCall.start_time,
            end_time: currentCall.end_time,
            duration: currentCall.end_time ? 
              formatDuration(new Date(currentCall.end_time) - new Date(currentCall.start_time)) : 'N/A',
            language: currentCall.language_detected,
            status: currentCall.call_status
          },
          transcript: currentCall.transcription,
          sentiment_analysis: currentCall.sentiment_scores,
          offers_recommended: currentCall.offers_recommended,
          shopify_cart_link: currentCall.shopify_cart_link,
          exported_at: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `call_report_${currentCall.call_id}_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        window.URL.revokeObjectURL(url);
      };

      // Generate summary functionality
      document.getElementById('generateSummary').onclick = async () => {
        if (!currentCall || !currentCall.transcription) {
          alert('No transcript available to generate summary');
          return;
        }

        try {
          document.getElementById('generateSummary').textContent = 'Generating...';
          document.getElementById('generateSummary').disabled = true;

          // This would call an AI service to generate a summary
          // For now, we'll create a simple placeholder
          const summary = generatePlaceholderSummary(currentCall);
          document.getElementById('callSummary').innerHTML = `
            <div class="space-y-2">
              <div><strong>Call Outcome:</strong> ${summary.outcome}</div>
              <div><strong>Key Points:</strong></div>
              <ul class="list-disc pl-5 space-y-1">
                ${summary.keyPoints.map(point => `<li>${point}</li>`).join('')}
              </ul>
              <div><strong>Follow-up Actions:</strong> ${summary.followUp}</div>
            </div>
          `;
        } catch (err) {
          console.error('Failed to generate summary:', err);
          alert('Failed to generate summary: ' + err.message);
        } finally {
          document.getElementById('generateSummary').textContent = 'Generate Summary';
          document.getElementById('generateSummary').disabled = false;
        }
      };

      function generatePlaceholderSummary(call) {
        // Simple placeholder summary generation
        return {
          outcome: call.call_status === 'success' ? 'Successful conversation completed' : 'Call ended without completion',
          keyPoints: [
            'Customer expressed interest in product offerings',
            'Language preference identified as ' + call.language_detected,
            'Duration: ' + (call.end_time ? formatDuration(new Date(call.end_time) - new Date(call.start_time)) : 'N/A')
          ],
          followUp: call.offers_recommended && call.offers_recommended.length > 0 ? 
            'Offers presented, awaiting customer decision' : 
            'No immediate follow-up required'
        };
      }

      function showError(message) {
        // Simple error display - could be enhanced with proper toast notifications
        alert(message);
      }

      // Event listeners
      document.getElementById('refreshCalls').onclick = loadCalls;
      document.getElementById('closeDetails').onclick = () => {
        document.getElementById('callDetails').classList.add('hidden');
        currentCall = null;
      };

      // Initialize
      loadCalls();
    </script>
  </body>
</html>
