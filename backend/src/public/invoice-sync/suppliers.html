<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supplier Config - Invoice Sync</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <script src="/shell-v2.js"></script>
  <style>
    .page { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .page-title { font-size: 24px; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 12px; }
    .page-title .material-symbols-outlined { font-size: 28px; color: #0ea5e9; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-primary { background: #0ea5e9; color: white; }
    .btn-primary:hover { background: #0284c7; }
    .btn-secondary { background: #252532; color: #e4e4e7; border: 1px solid #3f3f50; }
    .btn-secondary:hover { background: #2a2a3a; }
    .btn-success { background: #22c55e; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn .material-symbols-outlined { font-size: 20px; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }

    .card { background: #18181f; border: 1px solid #252532; border-radius: 16px; overflow: hidden; margin-bottom: 24px; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid #252532; display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-size: 16px; font-weight: 600; color: #fff; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 20px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group.full-width { grid-column: 1 / -1; }
    .form-label { font-size: 13px; font-weight: 600; color: #a1a1aa; }
    .form-input, .form-select {
      background: #252532; color: #e4e4e7; border: 1px solid #3f3f50; border-radius: 8px;
      padding: 10px 14px; font-size: 14px; outline: none; transition: border-color 0.15s;
    }
    .form-input:focus, .form-select:focus { border-color: #0ea5e9; }
    .form-hint { font-size: 12px; color: #71717a; }

    .supplier-list { padding: 0; }
    .supplier-item {
      display: grid; grid-template-columns: 2fr 2fr 1fr 1fr 1fr auto;
      align-items: center; gap: 16px; padding: 16px 20px;
      border-bottom: 1px solid #252532; transition: background 0.1s;
    }
    .supplier-item:hover { background: #1a1a28; }
    .supplier-name { font-weight: 600; color: #fff; }
    .supplier-pattern { font-size: 12px; color: #71717a; font-family: monospace; }
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .badge-portal { background: rgba(168, 85, 247, 0.15); color: #c084fc; }
    .badge-odoo { background: rgba(14, 165, 233, 0.15); color: #38bdf8; }
    .badge-active { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .badge-inactive { background: rgba(239, 68, 68, 0.15); color: #f87171; }

    .action-btn { width: 32px; height: 32px; border-radius: 8px; background: #252532; border: none; color: #71717a; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .action-btn:hover { background: #3f3f50; color: #e4e4e7; }

    .toggle { width: 44px; height: 24px; border-radius: 12px; background: #3f3f50; border: none; cursor: pointer; position: relative; transition: background 0.2s; }
    .toggle.on { background: #22c55e; }
    .toggle::after { content: ''; position: absolute; width: 20px; height: 20px; border-radius: 50%; background: white; top: 2px; left: 2px; transition: transform 0.2s; }
    .toggle.on::after { transform: translateX(20px); }

    .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 500; color: white; z-index: 9999; animation: slideIn 0.3s; }
    .toast-success { background: #22c55e; }
    .toast-error { background: #ef4444; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; justify-content: center; align-items: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: #18181f; border: 1px solid #252532; border-radius: 16px; width: 600px; max-width: 90vw; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px; border-bottom: 1px solid #252532; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 18px; font-weight: 700; color: #fff; }
    .modal-body { padding: 0; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid #252532; display: flex; justify-content: flex-end; gap: 12px; }
  </style>
</head>
<body>
  <div class="page">
    <div class="page-header">
      <div class="page-title">
        <span class="material-symbols-outlined">business</span>
        Supplier Configuration
      </div>
      <div style="display: flex; gap: 12px;">
        <button class="btn btn-secondary" onclick="seedDefaults()">
          <span class="material-symbols-outlined">auto_fix_high</span> Seed Defaults
        </button>
        <button class="btn btn-primary" onclick="openAddModal()">
          <span class="material-symbols-outlined">add</span> Add Supplier
        </button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Configured Suppliers</div>
        <span style="color: #71717a; font-size: 13px;" id="countLabel">0 suppliers</span>
      </div>
      <div class="supplier-list" id="supplierList"></div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Add Supplier</div>
        <button class="action-btn" onclick="closeModal()"><span class="material-symbols-outlined">close</span></button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Name</label>
            <input class="form-input" id="formName" placeholder="e.g., Maul">
          </div>
          <div class="form-group">
            <label class="form-label">Destination</label>
            <select class="form-select" id="formDestination">
              <option value="portal">Portal (s.distri-smart.com)</option>
              <option value="odoo">Odoo 14 (Vendor Bill)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Sender Pattern</label>
            <input class="form-input" id="formSender" placeholder="e.g., maul|leitz">
            <span class="form-hint">Regex to match email From field. Use | for alternatives.</span>
          </div>
          <div class="form-group">
            <label class="form-label">Subject Pattern</label>
            <input class="form-input" id="formSubject" placeholder="e.g., rechnung|invoice">
            <span class="form-hint">Regex to match email Subject.</span>
          </div>
          <div class="form-group">
            <label class="form-label">Match Mode</label>
            <select class="form-select" id="formMatchMode">
              <option value="sender">Sender Only</option>
              <option value="subject">Subject Only</option>
              <option value="both">Both (AND)</option>
              <option value="any">Any (OR)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Portal Supplier Name</label>
            <input class="form-input" id="formPortalName" placeholder="Name in portal dropdown">
            <span class="form-hint">Only for portal destination.</span>
          </div>
          <div class="form-group">
            <label class="form-label">Odoo Partner ID</label>
            <input class="form-input" id="formOdooPartner" type="number" placeholder="e.g., 42">
            <span class="form-hint">Only for Odoo destination.</span>
          </div>
          <div class="form-group">
            <label class="form-label">Expense Account Code</label>
            <input class="form-input" id="formAccountCode" value="6770">
            <span class="form-hint">Odoo expense account code.</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveSupplier()" id="saveBtn">Save</button>
      </div>
    </div>
  </div>

  <script>
    const API = '/api/invoice-sync';
    let editingId = null;

    document.addEventListener('DOMContentLoaded', loadSuppliers);

    async function loadSuppliers() {
      try {
        const res = await fetch(`${API}/suppliers`);
        const data = await res.json();
        if (!data.success) return;

        document.getElementById('countLabel').textContent = `${data.count} supplier${data.count !== 1 ? 's' : ''}`;
        const list = document.getElementById('supplierList');

        if (data.suppliers.length === 0) {
          list.innerHTML = '<div style="padding: 40px; text-align: center; color: #71717a;">No suppliers configured. Click "Seed Defaults" or "Add Supplier".</div>';
          return;
        }

        list.innerHTML = data.suppliers.map(s => `
          <div class="supplier-item">
            <div>
              <div class="supplier-name">${esc(s.name)}</div>
              <div class="supplier-pattern">${esc(s.senderPattern || '(no pattern)')}</div>
            </div>
            <div style="font-size: 13px; color: #71717a;">
              ${s.matchMode} | ${s.portalSupplierName ? 'Portal: ' + esc(s.portalSupplierName) : ''}${s.odooPartnerId ? 'Partner ID: ' + s.odooPartnerId : ''}
            </div>
            <div><span class="badge badge-${s.destination}">${s.destination}</span></div>
            <div><span class="badge ${s.isActive ? 'badge-active' : 'badge-inactive'}">${s.isActive ? 'Active' : 'Inactive'}</span></div>
            <div style="color: #71717a; font-size: 13px;">${s.totalInvoicesProcessed || 0} processed</div>
            <div style="display: flex; gap: 4px;">
              <button class="action-btn" onclick="editSupplier('${s._id}')" title="Edit"><span class="material-symbols-outlined">edit</span></button>
              <button class="action-btn" onclick="toggleActive('${s._id}', ${!s.isActive})" title="${s.isActive ? 'Deactivate' : 'Activate'}">
                <span class="material-symbols-outlined">${s.isActive ? 'toggle_on' : 'toggle_off'}</span>
              </button>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error('Failed to load suppliers:', e);
      }
    }

    function openAddModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Add Supplier';
      document.getElementById('formName').value = '';
      document.getElementById('formSender').value = '';
      document.getElementById('formSubject').value = '';
      document.getElementById('formMatchMode').value = 'sender';
      document.getElementById('formDestination').value = 'portal';
      document.getElementById('formPortalName').value = '';
      document.getElementById('formOdooPartner').value = '';
      document.getElementById('formAccountCode').value = '6770';
      document.getElementById('modal').classList.add('active');
    }

    async function editSupplier(id) {
      try {
        const res = await fetch(`${API}/suppliers/${id}`);
        const data = await res.json();
        if (!data.success) return;

        const s = data.supplier;
        editingId = id;
        document.getElementById('modalTitle').textContent = `Edit: ${s.name}`;
        document.getElementById('formName').value = s.name || '';
        document.getElementById('formSender').value = s.senderPattern || '';
        document.getElementById('formSubject').value = s.subjectPattern || '';
        document.getElementById('formMatchMode').value = s.matchMode || 'sender';
        document.getElementById('formDestination').value = s.destination || 'portal';
        document.getElementById('formPortalName').value = s.portalSupplierName || '';
        document.getElementById('formOdooPartner').value = s.odooPartnerId || '';
        document.getElementById('formAccountCode').value = s.odooExpenseAccountCode || '6770';
        document.getElementById('modal').classList.add('active');
      } catch (e) {
        showToast('Failed to load supplier: ' + e.message, 'error');
      }
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      editingId = null;
    }

    async function saveSupplier() {
      const body = {
        name: document.getElementById('formName').value.trim(),
        senderPattern: document.getElementById('formSender').value.trim(),
        subjectPattern: document.getElementById('formSubject').value.trim(),
        matchMode: document.getElementById('formMatchMode').value,
        destination: document.getElementById('formDestination').value,
        portalSupplierName: document.getElementById('formPortalName').value.trim(),
        odooPartnerId: document.getElementById('formOdooPartner').value ? Number(document.getElementById('formOdooPartner').value) : null,
        odooExpenseAccountCode: document.getElementById('formAccountCode').value.trim() || '6770',
      };

      if (!body.name) {
        showToast('Name is required', 'error');
        return;
      }

      try {
        const url = editingId ? `${API}/suppliers/${editingId}` : `${API}/suppliers`;
        const method = editingId ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await res.json();

        if (data.success) {
          showToast(editingId ? 'Supplier updated' : 'Supplier created', 'success');
          closeModal();
          loadSuppliers();
        } else {
          showToast(data.error || 'Save failed', 'error');
        }
      } catch (e) {
        showToast('Save failed: ' + e.message, 'error');
      }
    }

    async function toggleActive(id, isActive) {
      try {
        const res = await fetch(`${API}/suppliers/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isActive }),
        });
        const data = await res.json();
        if (data.success) {
          showToast(`Supplier ${isActive ? 'activated' : 'deactivated'}`, 'success');
          loadSuppliers();
        }
      } catch (e) {
        showToast('Update failed: ' + e.message, 'error');
      }
    }

    async function seedDefaults() {
      try {
        const res = await fetch(`${API}/seed`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showToast(`Seeded ${data.seeded || 0} suppliers (${data.existing || 0} already existed)`, 'success');
          loadSuppliers();
        }
      } catch (e) {
        showToast('Seed failed: ' + e.message, 'error');
      }
    }

    function showToast(msg, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    function esc(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
