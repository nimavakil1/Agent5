<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Sync - SDT</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <script src="/shell-v2.js"></script>
  <style>
    .page { max-width: 1400px; margin: 0 auto; padding: 24px; }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .page-title { font-size: 24px; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 12px; }
    .page-title .material-symbols-outlined { font-size: 28px; color: #0ea5e9; }
    .header-actions { display: flex; gap: 12px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-primary { background: #0ea5e9; color: white; }
    .btn-primary:hover { background: #0284c7; }
    .btn-success { background: #22c55e; color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-secondary { background: #252532; color: #e4e4e7; border: 1px solid #3f3f50; }
    .btn-secondary:hover { background: #2a2a3a; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn .material-symbols-outlined { font-size: 20px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }

    .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
    @media (max-width: 1100px) { .stats-row { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 700px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
    .stat-card { background: #18181f; border: 1px solid #252532; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.15s; }
    .stat-card:hover { border-color: #3f3f50; }
    .stat-card.active { border-color: #0ea5e9; background: rgba(14, 165, 233, 0.1); }
    .stat-value { font-size: 28px; font-weight: 700; color: #fff; margin-bottom: 4px; }
    .stat-label { font-size: 13px; color: #71717a; }
    .stat-card.success .stat-value { color: #4ade80; }
    .stat-card.warning .stat-value { color: #fbbf24; }
    .stat-card.danger .stat-value { color: #f87171; }
    .stat-card.info .stat-value { color: #60a5fa; }

    .tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid #252532; padding-bottom: 12px; }
    .tab { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; color: #71717a; cursor: pointer; transition: all 0.15s; }
    .tab:hover { background: #252532; color: #e4e4e7; }
    .tab.active { background: #0ea5e9; color: white; }
    .tab-badge { background: #3f3f50; color: #e4e4e7; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 8px; }
    .tab.active .tab-badge { background: rgba(255,255,255,0.2); }

    .card { background: #18181f; border: 1px solid #252532; border-radius: 16px; overflow: hidden; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid #252532; display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-size: 16px; font-weight: 600; color: #fff; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 14px 16px; text-align: left; border-bottom: 1px solid #252532; }
    th { background: #12121a; font-size: 12px; font-weight: 600; color: #71717a; text-transform: uppercase; }
    td { font-size: 14px; color: #e4e4e7; }
    tr:hover td { background: #1a1a28; }

    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .badge-pending { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
    .badge-parsed { background: rgba(96, 165, 250, 0.15); color: #60a5fa; }
    .badge-submitted { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .badge-failed { background: rgba(239, 68, 68, 0.15); color: #f87171; }
    .badge-skipped { background: rgba(113, 113, 122, 0.15); color: #a1a1aa; }
    .badge-portal { background: rgba(168, 85, 247, 0.15); color: #c084fc; }
    .badge-odoo { background: rgba(14, 165, 233, 0.15); color: #38bdf8; }

    .action-btn { width: 32px; height: 32px; border-radius: 8px; background: #252532; border: none; color: #71717a; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .action-btn:hover { background: #3f3f50; color: #e4e4e7; }
    .action-btn .material-symbols-outlined { font-size: 18px; }

    .empty-state { padding: 60px 20px; text-align: center; }
    .empty-state .material-symbols-outlined { font-size: 48px; color: #3f3f50; margin-bottom: 16px; }
    .empty-state-title { font-size: 16px; font-weight: 600; color: #e4e4e7; margin-bottom: 8px; }
    .empty-state-desc { font-size: 14px; color: #71717a; }

    .amount { font-family: monospace; font-weight: 600; }

    .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 500; color: white; z-index: 9999; animation: slideIn 0.3s; }
    .toast-success { background: #22c55e; }
    .toast-error { background: #ef4444; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    .scanning-indicator { display: none; align-items: center; gap: 8px; padding: 12px 20px; background: rgba(14, 165, 233, 0.1); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 10px; margin-bottom: 16px; color: #38bdf8; font-size: 14px; }
    .scanning-indicator.active { display: flex; }
    .spinner { width: 18px; height: 18px; border: 2px solid rgba(56, 189, 248, 0.3); border-top: 2px solid #38bdf8; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="page">
    <div class="page-header">
      <div class="page-title">
        <span class="material-symbols-outlined">sync_alt</span>
        Invoice Sync — SDT
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="loadStatus()">
          <span class="material-symbols-outlined">refresh</span> Refresh
        </button>
        <button class="btn btn-primary" onclick="triggerScan()" id="scanBtn">
          <span class="material-symbols-outlined">email</span> Scan Emails
        </button>
      </div>
    </div>

    <div class="scanning-indicator" id="scanningIndicator">
      <div class="spinner"></div>
      <span>Scanning Gmail for invoices...</span>
    </div>

    <!-- Stats -->
    <div class="stats-row" id="statsRow">
      <div class="stat-card" onclick="filterByStatus('all')">
        <div class="stat-value" id="statTotal">-</div>
        <div class="stat-label">Total Invoices</div>
      </div>
      <div class="stat-card warning" onclick="filterByStatus('pending')">
        <div class="stat-value" id="statPending">-</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-card info" onclick="filterByStatus('parsed')">
        <div class="stat-value" id="statParsed">-</div>
        <div class="stat-label">Parsed</div>
      </div>
      <div class="stat-card success" onclick="filterByStatus('submitted')">
        <div class="stat-value" id="statSubmitted">-</div>
        <div class="stat-label">Submitted</div>
      </div>
      <div class="stat-card danger" onclick="filterByStatus('failed')">
        <div class="stat-value" id="statFailed">-</div>
        <div class="stat-label">Failed</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="invoices" onclick="switchTab('invoices')">Invoices</div>
      <div class="tab" data-tab="suppliers" onclick="switchTab('suppliers')">
        Suppliers <span class="tab-badge" id="supplierCount">0</span>
      </div>
    </div>

    <!-- Invoice List -->
    <div id="invoicesTab">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Invoice Queue</div>
          <div style="display: flex; gap: 8px;">
            <select id="statusFilter" onchange="loadInvoices()" style="background: #252532; color: #e4e4e7; border: 1px solid #3f3f50; border-radius: 8px; padding: 8px 12px; font-size: 13px;">
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="parsed">Parsed</option>
              <option value="submitted">Submitted</option>
              <option value="failed">Failed</option>
              <option value="skipped">Skipped</option>
            </select>
            <select id="supplierFilter" onchange="loadInvoices()" style="background: #252532; color: #e4e4e7; border: 1px solid #3f3f50; border-radius: 8px; padding: 8px 12px; font-size: 13px;">
              <option value="">All Suppliers</option>
            </select>
          </div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Supplier</th>
                <th>Invoice #</th>
                <th>Date</th>
                <th>Gross</th>
                <th>PO Numbers</th>
                <th>Destination</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="invoiceTableBody">
              <tr><td colspan="8"><div class="empty-state"><span class="material-symbols-outlined">inbox</span><div class="empty-state-title">No invoices yet</div><div class="empty-state-desc">Click "Scan Emails" to check for new invoices</div></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Suppliers Tab -->
    <div id="suppliersTab" style="display: none;">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Supplier Configurations</div>
          <button class="btn btn-primary btn-sm" onclick="seedSuppliers()">
            <span class="material-symbols-outlined">auto_fix_high</span> Seed Defaults
          </button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Sender Pattern</th>
                <th>Match Mode</th>
                <th>Destination</th>
                <th>Auto-Process</th>
                <th>Active</th>
                <th>Processed</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="supplierTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = '/api/invoice-sync';
    let currentTab = 'invoices';

    // On load
    document.addEventListener('DOMContentLoaded', () => {
      loadStatus();
      loadInvoices();
      loadSuppliers();
    });

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
      document.getElementById('invoicesTab').style.display = tab === 'invoices' ? '' : 'none';
      document.getElementById('suppliersTab').style.display = tab === 'suppliers' ? '' : 'none';
    }

    function filterByStatus(status) {
      document.getElementById('statusFilter').value = status;
      loadInvoices();
    }

    async function loadStatus() {
      try {
        const res = await fetch(`${API}/status`);
        const data = await res.json();
        if (!data.success) return;

        const s = data.invoices?.byStatus || {};
        const total = Object.values(s).reduce((a, b) => a + b, 0);
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statPending').textContent = s.pending || 0;
        document.getElementById('statParsed').textContent = s.parsed || 0;
        document.getElementById('statSubmitted').textContent = s.submitted || 0;
        document.getElementById('statFailed').textContent = (s.failed || 0) + (s.skipped || 0);
      } catch (e) {
        console.error('Failed to load status:', e);
      }
    }

    async function loadInvoices() {
      try {
        const status = document.getElementById('statusFilter').value;
        const supplier = document.getElementById('supplierFilter').value;
        let url = `${API}/invoices?limit=100`;
        if (status && status !== 'all') url += `&status=${status}`;
        if (supplier) url += `&supplier=${encodeURIComponent(supplier)}`;

        const res = await fetch(url);
        const data = await res.json();
        if (!data.success) return;

        const tbody = document.getElementById('invoiceTableBody');

        if (data.invoices.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><span class="material-symbols-outlined">inbox</span><div class="empty-state-title">No invoices found</div><div class="empty-state-desc">Try scanning for new emails or adjusting filters</div></div></td></tr>';
          return;
        }

        tbody.innerHTML = data.invoices.map(inv => `
          <tr>
            <td><strong>${esc(inv.supplierName)}</strong></td>
            <td>${esc(inv.invoiceNumber || '-')}</td>
            <td>${inv.invoiceDate || (inv.emailDate ? new Date(inv.emailDate).toLocaleDateString('de-DE') : '-')}</td>
            <td class="amount">${inv.grossAmount ? '€' + Number(inv.grossAmount).toFixed(2) : '-'}</td>
            <td>${esc(inv.poNumbers || '-')}</td>
            <td><span class="badge badge-${inv.destination || 'portal'}">${inv.destination || '-'}</span></td>
            <td><span class="badge badge-${inv.status}">${inv.status}</span></td>
            <td style="white-space: nowrap;">
              ${inv.status === 'parsed' ? `<button class="action-btn" onclick="submitInvoice('${inv.id}')" title="Submit"><span class="material-symbols-outlined">send</span></button>` : ''}
              ${inv.status === 'parsed' || inv.status === 'pending' ? `<button class="action-btn" onclick="skipInvoice('${inv.id}')" title="Skip"><span class="material-symbols-outlined">skip_next</span></button>` : ''}
              ${inv.status === 'failed' || inv.status === 'pending' ? `<button class="action-btn" onclick="reparseInvoice('${inv.id}')" title="Re-parse"><span class="material-symbols-outlined">refresh</span></button>` : ''}
            </td>
          </tr>
        `).join('');
      } catch (e) {
        console.error('Failed to load invoices:', e);
      }
    }

    async function loadSuppliers() {
      try {
        const res = await fetch(`${API}/suppliers`);
        const data = await res.json();
        if (!data.success) return;

        document.getElementById('supplierCount').textContent = data.count;

        // Populate supplier filter dropdown
        const filter = document.getElementById('supplierFilter');
        const currentVal = filter.value;
        filter.innerHTML = '<option value="">All Suppliers</option>';
        data.suppliers.forEach(s => {
          filter.innerHTML += `<option value="${esc(s.name)}">${esc(s.name)}</option>`;
        });
        filter.value = currentVal;

        // Populate suppliers table
        const tbody = document.getElementById('supplierTableBody');
        if (data.suppliers.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><span class="material-symbols-outlined">business</span><div class="empty-state-title">No suppliers configured</div><div class="empty-state-desc">Click "Seed Defaults" to add the standard suppliers</div></div></td></tr>';
          return;
        }

        tbody.innerHTML = data.suppliers.map(s => `
          <tr>
            <td><strong>${esc(s.name)}</strong></td>
            <td><code style="color: #71717a; font-size: 12px;">${esc(s.senderPattern || '-')}</code></td>
            <td>${s.matchMode}</td>
            <td><span class="badge badge-${s.destination}">${s.destination}</span></td>
            <td>${s.autoProcess ? '<span style="color: #4ade80;">Yes</span>' : '<span style="color: #71717a;">No</span>'}</td>
            <td>${s.isActive ? '<span style="color: #4ade80;">Active</span>' : '<span style="color: #f87171;">Inactive</span>'}</td>
            <td>${s.totalInvoicesProcessed || 0}</td>
            <td>
              <button class="action-btn" onclick="toggleSupplier('${s._id}', ${!s.isActive})" title="${s.isActive ? 'Deactivate' : 'Activate'}">
                <span class="material-symbols-outlined">${s.isActive ? 'toggle_on' : 'toggle_off'}</span>
              </button>
            </td>
          </tr>
        `).join('');
      } catch (e) {
        console.error('Failed to load suppliers:', e);
      }
    }

    async function triggerScan() {
      const btn = document.getElementById('scanBtn');
      const indicator = document.getElementById('scanningIndicator');
      btn.disabled = true;
      indicator.classList.add('active');

      try {
        const res = await fetch(`${API}/scan`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ daysBack: 7 }),
        });
        const data = await res.json();

        if (data.success) {
          showToast(`Scan complete: ${data.result?.newInvoices || 0} new invoices found`, 'success');
          loadStatus();
          loadInvoices();
        } else {
          showToast('Scan failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (e) {
        showToast('Scan failed: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        indicator.classList.remove('active');
      }
    }

    async function submitInvoice(id) {
      try {
        const res = await fetch(`${API}/invoices/${id}/submit`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showToast('Invoice submitted successfully', 'success');
          loadInvoices();
          loadStatus();
        } else {
          showToast('Submit failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (e) {
        showToast('Submit failed: ' + e.message, 'error');
      }
    }

    async function skipInvoice(id) {
      try {
        const res = await fetch(`${API}/invoices/${id}/skip`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason: 'Skipped from UI' }),
        });
        const data = await res.json();
        if (data.success) {
          showToast('Invoice skipped', 'success');
          loadInvoices();
          loadStatus();
        }
      } catch (e) {
        showToast('Skip failed: ' + e.message, 'error');
      }
    }

    async function reparseInvoice(id) {
      try {
        const res = await fetch(`${API}/invoices/${id}/reparse`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showToast('Invoice re-parsed successfully', 'success');
          loadInvoices();
          loadStatus();
        } else {
          showToast('Re-parse failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (e) {
        showToast('Re-parse failed: ' + e.message, 'error');
      }
    }

    async function seedSuppliers() {
      try {
        const res = await fetch(`${API}/seed`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showToast(`Seeded ${data.seeded || 0} suppliers`, 'success');
          loadSuppliers();
        }
      } catch (e) {
        showToast('Seed failed: ' + e.message, 'error');
      }
    }

    async function toggleSupplier(id, isActive) {
      try {
        const res = await fetch(`${API}/suppliers/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isActive }),
        });
        const data = await res.json();
        if (data.success) {
          showToast(`Supplier ${isActive ? 'activated' : 'deactivated'}`, 'success');
          loadSuppliers();
        }
      } catch (e) {
        showToast('Update failed: ' + e.message, 'error');
      }
    }

    function showToast(msg, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    function esc(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
