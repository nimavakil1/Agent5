<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Reports - Amazon Seller</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <script src="/shell-v2.js"></script>
  <style>
    .page { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
    .page-logo-container { background: #fff; border-radius: 10px; padding: 8px 14px; display: flex; align-items: center; justify-content: center; }
    .page-logo { height: 28px; width: auto; }

    .card { background: #18181f; border: 1px solid #252532; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid #252532; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
    .card-title { font-size: 16px; font-weight: 600; color: #fff; margin: 0; }
    .card-body { padding: 20px; }

    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; text-decoration: none; }
    .btn-primary { background: #f59e0b; color: white; }
    .btn-primary:hover { background: #d97706; }
    .btn-success { background: #22c55e; color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-secondary { background: #252532; color: #e4e4e7; border: 1px solid #3f3f50; }
    .btn-secondary:hover { background: #2a2a3a; }
    .btn-purple { background: #8b5cf6; color: white; }
    .btn-purple:hover { background: #7c3aed; }
    .btn-blue { background: #3b82f6; color: white; }
    .btn-blue:hover { background: #2563eb; }
    .btn-red { background: #ef4444; color: white; }
    .btn-red:hover { background: #dc2626; }
    .btn .material-symbols-outlined { font-size: 18px; }

    /* Report Type Selector */
    .report-types { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    @media (max-width: 900px) { .report-types { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 500px) { .report-types { grid-template-columns: 1fr; } }
    .report-type-btn { background: #12121a; border: 1px solid #252532; border-radius: 10px; padding: 20px 16px; cursor: pointer; transition: all 0.15s; display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; }
    .report-type-btn:hover { border-color: #f59e0b; background: #1a1a24; }
    .report-type-btn.active { border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
    .report-type-btn .material-symbols-outlined { font-size: 32px; color: #71717a; }
    .report-type-btn.active .material-symbols-outlined { color: #f59e0b; }
    .report-type-btn.vcs .material-symbols-outlined { color: #a78bfa; }
    .report-type-btn.fba .material-symbols-outlined { color: #4ade80; }
    .report-type-btn.returns .material-symbols-outlined { color: #f87171; }
    .report-type-btn.settlement .material-symbols-outlined { color: #60a5fa; }
    .report-type-name { font-size: 14px; font-weight: 600; color: #fff; }
    .report-type-desc { font-size: 11px; color: #71717a; }

    /* Upload Zone */
    .upload-section { display: none; }
    .upload-section.show { display: block; }
    .upload-zone { border: 2px dashed #3f3f50; border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.15s; }
    .upload-zone:hover, .upload-zone.dragover { border-color: #f59e0b; background: rgba(245, 158, 11, 0.05); }
    .upload-zone .material-symbols-outlined { font-size: 48px; color: #52525b; margin-bottom: 12px; display: block; }
    .upload-zone-text { font-size: 14px; color: #a1a1aa; margin-bottom: 4px; }
    .upload-zone-hint { font-size: 12px; color: #52525b; }
    .upload-zone input { display: none; }

    .upload-progress { display: none; align-items: center; gap: 12px; padding: 16px; background: #12121a; border-radius: 10px; margin-top: 16px; }
    .upload-progress.show { display: flex; }
    .upload-progress .material-symbols-outlined { font-size: 24px; color: #f59e0b; animation: spin 1s linear infinite; }
    .progress-bar { flex: 1; height: 6px; background: #252532; border-radius: 3px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: #f59e0b; width: 50%; }

    .result-box { padding: 16px; border-radius: 10px; margin-top: 16px; display: none; }
    .result-box.show { display: block; }
    .result-box.success { background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; }
    .result-box.error { background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; }
    .result-box-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; }
    .result-box.success .result-box-header { color: #4ade80; }
    .result-box.error .result-box-header { color: #f87171; }
    .result-box-header .material-symbols-outlined { font-size: 20px; }
    .result-box-content { font-size: 13px; color: #e4e4e7; }

    /* Quick Actions */
    .quick-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    @media (max-width: 1100px) { .quick-actions { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .quick-actions { grid-template-columns: 1fr; } }
    .quick-action { background: #18181f; border: 1px solid #252532; border-radius: 12px; padding: 20px; }
    .quick-action-header { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
    .quick-action-header .material-symbols-outlined { font-size: 22px; }
    .quick-action-header.vcs .material-symbols-outlined { color: #a78bfa; }
    .quick-action-header.fba .material-symbols-outlined { color: #4ade80; }
    .quick-action-header.returns .material-symbols-outlined { color: #f87171; }
    .quick-action-header.settlement .material-symbols-outlined { color: #60a5fa; }
    .quick-action-title { font-size: 14px; font-weight: 600; color: #fff; }
    .quick-action-stats { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
    .quick-action-stat { display: flex; justify-content: space-between; font-size: 13px; }
    .quick-action-stat label { color: #71717a; }
    .quick-action-stat span { font-weight: 600; }
    .quick-action-stat span.warning { color: #fbbf24; }
    .quick-action-stat span.success { color: #4ade80; }
    .quick-action-stat span.danger { color: #f87171; }
    .quick-action-warning { display: none; align-items: center; gap: 4px; font-size: 11px; color: #fbbf24; margin-bottom: 12px; }
    .quick-action-warning.show { display: flex; }
    .quick-action-warning .material-symbols-outlined { font-size: 14px; }

    /* Recent Uploads */
    .recent-list { display: flex; flex-direction: column; gap: 10px; }
    .recent-item { display: flex; align-items: center; justify-content: space-between; background: #12121a; border: 1px solid #252532; border-radius: 10px; padding: 12px 16px; }
    .recent-item-info { display: flex; align-items: center; gap: 12px; }
    .recent-item-badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
    .recent-item-badge.vcs { background: rgba(167, 139, 250, 0.2); color: #a78bfa; }
    .recent-item-badge.fba { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
    .recent-item-badge.returns { background: rgba(248, 113, 113, 0.2); color: #f87171; }
    .recent-item-name { font-size: 13px; color: #e4e4e7; }
    .recent-item-date { font-size: 11px; color: #52525b; }
    .recent-item-count { font-size: 13px; color: #71717a; }

    .empty-state { padding: 40px 20px; text-align: center; }
    .empty-state .material-symbols-outlined { font-size: 48px; color: #3f3f50; margin-bottom: 12px; display: block; }
    .empty-state-text { font-size: 14px; color: #71717a; }

    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-overlay.show { display: flex; }
    .modal { background: #18181f; border: 1px solid #252532; border-radius: 16px; width: 100%; max-width: 900px; max-height: 90vh; overflow: hidden; }
    .modal-header { padding: 16px 20px; border-bottom: 1px solid #252532; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 18px; font-weight: 600; color: #fff; }
    .modal-close { background: none; border: none; color: #71717a; cursor: pointer; padding: 4px; }
    .modal-close:hover { color: #fff; }
    .modal-body { padding: 20px; overflow-y: auto; max-height: calc(90vh - 70px); }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #252532; }
    th { background: #12121a; font-size: 11px; font-weight: 600; color: #71717a; text-transform: uppercase; }
    td { font-size: 13px; color: #e4e4e7; }
    td.text-right, th.text-right { text-align: right; }
    td.success { color: #4ade80; }
    td.warning { color: #fbbf24; }
    td.danger { color: #f87171; }
    td.bold { font-weight: 600; }
    .font-mono { font-family: monospace; font-size: 11px; }

    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-header">
      <div class="page-logo-container">
        <img src="/assets/logos/amazon-seller-central.png" alt="Amazon Seller Central" class="page-logo">
      </div>
    </header>

    <!-- Report Type Selector -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Select Report Type</h2>
      </div>
      <div class="card-body">
        <div class="report-types">
          <button class="report-type-btn vcs" id="btn-vcs" onclick="selectReportType('vcs')">
            <span class="material-symbols-outlined">receipt_long</span>
            <span class="report-type-name">VCS Tax Report</span>
            <span class="report-type-desc">VAT Transactions</span>
          </button>
          <button class="report-type-btn fba" id="btn-fba" onclick="selectReportType('fba')">
            <span class="material-symbols-outlined">inventory_2</span>
            <span class="report-type-name">FBA Inventory</span>
            <span class="report-type-desc">Stock Levels</span>
          </button>
          <button class="report-type-btn returns" id="btn-returns" onclick="selectReportType('returns')">
            <span class="material-symbols-outlined">assignment_return</span>
            <span class="report-type-name">Returns</span>
            <span class="report-type-desc">FBA Returns</span>
          </button>
          <button class="report-type-btn settlement" id="btn-settlement" onclick="selectReportType('settlement')">
            <span class="material-symbols-outlined">payments</span>
            <span class="report-type-name">Settlement</span>
            <span class="report-type-desc">Financial Report</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="card upload-section" id="upload-section">
      <div class="card-header">
        <h2 class="card-title" id="upload-title">Upload Report</h2>
        <span id="upload-help" style="font-size:12px;color:#71717a"></span>
      </div>
      <div class="card-body">
        <div class="upload-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
          <span class="material-symbols-outlined">upload_file</span>
          <div class="upload-zone-text">Drag & drop your CSV/TSV file here, or click to browse</div>
          <div class="upload-zone-hint" id="upload-hint"></div>
          <input type="file" id="file-input" accept=".csv,.tsv,.txt">
        </div>
        <div class="upload-progress" id="upload-progress">
          <span class="material-symbols-outlined">sync</span>
          <div class="progress-bar"><div class="progress-bar-fill"></div></div>
          <span style="color:#a1a1aa;font-size:13px">Processing...</span>
        </div>
        <div class="result-box success" id="upload-result">
          <div class="result-box-header">
            <span class="material-symbols-outlined">check_circle</span>
            Report Processed Successfully
          </div>
          <div class="result-box-content" id="result-summary"></div>
        </div>
        <div class="result-box error" id="upload-error">
          <div class="result-box-header">
            <span class="material-symbols-outlined">error</span>
            Upload Failed
          </div>
          <div class="result-box-content" id="error-message"></div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <!-- VCS -->
      <div class="quick-action">
        <div class="quick-action-header vcs">
          <span class="material-symbols-outlined">receipt_long</span>
          <span class="quick-action-title">VCS Tax Reports</span>
        </div>
        <div class="quick-action-stats">
          <div class="quick-action-stat">
            <label>Pending Orders</label>
            <span class="warning" id="vcs-pending">-</span>
          </div>
          <div class="quick-action-stat">
            <label>Invoiced</label>
            <span class="success" id="vcs-invoiced">-</span>
          </div>
        </div>
        <a href="/seller/vcs.html" class="btn btn-purple" style="width:100%;justify-content:center">View VCS Orders</a>
      </div>

      <!-- Settlements -->
      <div class="quick-action">
        <div class="quick-action-header settlement">
          <span class="material-symbols-outlined">payments</span>
          <span class="quick-action-title">Settlements</span>
        </div>
        <div class="quick-action-stats">
          <div class="quick-action-stat">
            <label>Last Settlement</label>
            <span id="settlement-last-date">-</span>
          </div>
          <div class="quick-action-stat">
            <label>Total Amount</label>
            <span class="success" id="settlement-last-amount">-</span>
          </div>
        </div>
        <div class="quick-action-warning" id="settlement-warning">
          <span class="material-symbols-outlined">warning</span>
          <span id="settlement-warning-text"></span>
        </div>
        <button onclick="viewSettlements()" class="btn btn-blue" style="width:100%;justify-content:center">View Settlements</button>
      </div>

      <!-- FBA Inventory -->
      <div class="quick-action">
        <div class="quick-action-header fba">
          <span class="material-symbols-outlined">inventory_2</span>
          <span class="quick-action-title">FBA Inventory</span>
        </div>
        <div class="quick-action-stats">
          <div class="quick-action-stat">
            <label>Total SKUs</label>
            <span id="fba-skus">-</span>
          </div>
          <div class="quick-action-stat">
            <label>Fulfillable</label>
            <span class="success" id="fba-fulfillable">-</span>
          </div>
        </div>
        <button onclick="viewFbaInventory()" class="btn btn-success" style="width:100%;justify-content:center">View Inventory</button>
      </div>

      <!-- Returns -->
      <div class="quick-action">
        <div class="quick-action-header returns">
          <span class="material-symbols-outlined">assignment_return</span>
          <span class="quick-action-title">Returns (30 days)</span>
        </div>
        <div class="quick-action-stats">
          <div class="quick-action-stat">
            <label>Total Returns</label>
            <span class="danger" id="returns-total">-</span>
          </div>
          <div class="quick-action-stat">
            <label>Sellable</label>
            <span class="success" id="returns-sellable">-</span>
          </div>
        </div>
        <button onclick="viewReturns()" class="btn btn-red" style="width:100%;justify-content:center">View Returns</button>
      </div>
    </div>

    <!-- Recent Uploads -->
    <div class="card" style="margin-top:20px">
      <div class="card-header">
        <h2 class="card-title">Recent Uploads</h2>
      </div>
      <div class="card-body">
        <div class="recent-list" id="recent-uploads">
          <div class="empty-state">
            <span class="material-symbols-outlined">hourglass_empty</span>
            <div class="empty-state-text">Loading...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FBA Inventory Modal -->
  <div class="modal-overlay" id="fba-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">FBA Inventory</h3>
        <button class="modal-close" onclick="closeModal('fba-modal')">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="modal-body">
        <table>
          <thead>
            <tr>
              <th>SKU</th>
              <th class="text-right">Fulfillable</th>
              <th class="text-right">Inbound</th>
              <th class="text-right">Reserved</th>
              <th class="text-right">Total</th>
            </tr>
          </thead>
          <tbody id="fba-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Returns Modal -->
  <div class="modal-overlay" id="returns-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Returns (Last 30 Days)</h3>
        <button class="modal-close" onclick="closeModal('returns-modal')">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="modal-body">
        <table>
          <thead>
            <tr>
              <th>SKU</th>
              <th>Product</th>
              <th class="text-right">Returns</th>
              <th class="text-right">Sellable</th>
            </tr>
          </thead>
          <tbody id="returns-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Settlements Modal -->
  <div class="modal-overlay" id="settlements-modal">
    <div class="modal" style="max-width:1000px">
      <div class="modal-header">
        <h3 class="modal-title">Settlement Reports</h3>
        <button class="modal-close" onclick="closeModal('settlements-modal')">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="modal-body" id="settlements-list"></div>
    </div>
  </div>

  <script>
    let selectedType = null;
    const reportConfigs = {
      vcs: { title: 'VCS Tax Report', help: 'Reports > Tax Document Library > VAT Transaction Report', endpoint: '/api/amazon/vcs/upload' },
      fba: { title: 'FBA Inventory Report', help: 'Inventory > Manage FBA Inventory > Download', endpoint: '/api/amazon/fba/upload' },
      returns: { title: 'FBA Returns Report', help: 'Reports > Fulfillment > FBA Customer Returns', endpoint: '/api/amazon/returns/upload' },
      settlement: { title: 'Settlement Report', help: 'Reports > Payments > Settlement Reports', endpoint: '/api/amazon/settlement/upload' }
    };

    document.addEventListener('DOMContentLoaded', () => {
      loadStats();
      loadRecentUploads();
      setupEventListeners();
    });

    function setupEventListeners() {
      const dropZone = document.getElementById('drop-zone');
      const fileInput = document.getElementById('file-input');

      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files[0]) uploadFile(e.dataTransfer.files[0]);
      });
      fileInput.addEventListener('change', (e) => {
        if (e.target.files[0]) uploadFile(e.target.files[0]);
      });
    }

    function selectReportType(type) {
      selectedType = type;
      const config = reportConfigs[type];

      document.querySelectorAll('.report-type-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`btn-${type}`).classList.add('active');

      document.getElementById('upload-section').classList.add('show');
      document.getElementById('upload-title').textContent = `Upload ${config.title}`;
      document.getElementById('upload-help').textContent = config.help;
      document.getElementById('upload-progress').classList.remove('show');
      document.getElementById('upload-result').classList.remove('show');
      document.getElementById('upload-error').classList.remove('show');
    }

    async function uploadFile(file) {
      if (!selectedType) { alert('Please select a report type first'); return; }
      const config = reportConfigs[selectedType];

      document.getElementById('upload-progress').classList.add('show');
      document.getElementById('upload-result').classList.remove('show');
      document.getElementById('upload-error').classList.remove('show');

      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch(config.endpoint, { method: 'POST', body: formData });
        const result = await response.json();
        document.getElementById('upload-progress').classList.remove('show');

        if (response.ok && result.success) {
          document.getElementById('upload-result').classList.add('show');
          document.getElementById('result-summary').innerHTML = result.message || 'Report processed successfully';
          loadStats();
          loadRecentUploads();
        } else {
          document.getElementById('upload-error').classList.add('show');
          document.getElementById('error-message').textContent = result.error || 'Unknown error';
        }
      } catch (error) {
        document.getElementById('upload-progress').classList.remove('show');
        document.getElementById('upload-error').classList.add('show');
        document.getElementById('error-message').textContent = error.message;
      }
    }

    async function loadStats() {
      try {
        const vcsRes = await fetch('/api/amazon/vcs/summary');
        const vcsData = await vcsRes.json();
        document.getElementById('vcs-pending').textContent = vcsData.byStatus?.find(s => s._id === 'pending')?.count || 0;
        document.getElementById('vcs-invoiced').textContent = vcsData.byStatus?.find(s => s._id === 'invoiced')?.count || 0;
      } catch (e) {}

      try {
        const fbaRes = await fetch('/api/amazon/fba/inventory');
        const fbaData = await fbaRes.json();
        document.getElementById('fba-skus').textContent = fbaData.skuCount || 0;
        document.getElementById('fba-fulfillable').textContent = (fbaData.totalFulfillable || 0).toLocaleString();
      } catch (e) {}

      try {
        const retRes = await fetch('/api/amazon/returns/summary?days=30');
        const retData = await retRes.json();
        document.getElementById('returns-total').textContent = retData.totalReturns || 0;
        document.getElementById('returns-sellable').textContent = retData.sellableReturns || 0;
      } catch (e) {}

      try {
        const settRes = await fetch('/api/amazon/settlement-reminders');
        const settData = await settRes.json();
        if (settData.lastSettlement) {
          document.getElementById('settlement-last-date').textContent = formatDateShort(settData.lastSettlement.endDate);
          document.getElementById('settlement-last-amount').textContent = formatCurrency(settData.lastSettlement.totalAmount || 0);
        }
        if (settData.isOverdue) {
          document.getElementById('settlement-warning').classList.add('show');
          document.getElementById('settlement-warning-text').textContent = settData.message;
        }
      } catch (e) {}
    }

    async function loadRecentUploads() {
      const container = document.getElementById('recent-uploads');
      try {
        const [vcsRes, fbaRes, retRes] = await Promise.all([
          fetch('/api/amazon/vcs/reports').then(r => r.json()).catch(() => ({ reports: [] })),
          fetch('/api/amazon/fba/reports').then(r => r.json()).catch(() => ({ reports: [] })),
          fetch('/api/amazon/returns/reports').then(r => r.json()).catch(() => ({ reports: [] }))
        ]);

        const allReports = [
          ...vcsRes.reports.map(r => ({ ...r, type: 'VCS', typeClass: 'vcs' })),
          ...fbaRes.reports.map(r => ({ ...r, type: 'FBA', typeClass: 'fba' })),
          ...retRes.reports.map(r => ({ ...r, type: 'Returns', typeClass: 'returns' }))
        ].sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt)).slice(0, 10);

        if (allReports.length === 0) {
          container.innerHTML = '<div class="empty-state"><span class="material-symbols-outlined">inbox</span><div class="empty-state-text">No reports uploaded yet</div></div>';
          return;
        }

        container.innerHTML = allReports.map(r => `
          <div class="recent-item">
            <div class="recent-item-info">
              <span class="recent-item-badge ${r.typeClass}">${r.type}</span>
              <div>
                <div class="recent-item-name">${r.filename || 'Report'}</div>
                <div class="recent-item-date">${formatDate(r.uploadedAt)}</div>
              </div>
            </div>
            <div class="recent-item-count">${r.orderCount || r.skuCount || r.returnCount || 0} items</div>
          </div>
        `).join('');
      } catch (error) {
        container.innerHTML = '<div class="empty-state"><span class="material-symbols-outlined">error</span><div class="empty-state-text">Error loading reports</div></div>';
      }
    }

    async function viewFbaInventory() {
      const modal = document.getElementById('fba-modal');
      const tbody = document.getElementById('fba-table-body');
      modal.classList.add('show');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:#71717a">Loading...</td></tr>';

      try {
        const res = await fetch('/api/amazon/fba/inventory');
        const data = await res.json();
        if (!data.inventory?.length) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:#71717a">No inventory data</td></tr>';
          return;
        }
        tbody.innerHTML = data.inventory.slice(0, 100).map(item => `
          <tr>
            <td class="font-mono">${item.sku}</td>
            <td class="text-right success">${item.fulfillable}</td>
            <td class="text-right warning">${item.inbound}</td>
            <td class="text-right">${item.reserved}</td>
            <td class="text-right bold">${item.totalQuantity}</td>
          </tr>
        `).join('');
      } catch (error) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:40px;color:#f87171">Error: ${error.message}</td></tr>`;
      }
    }

    async function viewReturns() {
      const modal = document.getElementById('returns-modal');
      const tbody = document.getElementById('returns-table-body');
      modal.classList.add('show');
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;color:#71717a">Loading...</td></tr>';

      try {
        const res = await fetch('/api/amazon/returns/summary?days=30');
        const data = await res.json();
        if (!data.topReturnedSkus?.length) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;color:#71717a">No returns data</td></tr>';
          return;
        }
        tbody.innerHTML = data.topReturnedSkus.map(item => `
          <tr>
            <td class="font-mono">${item.sku}</td>
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${item.productName || '-'}</td>
            <td class="text-right danger">${item.totalReturns}</td>
            <td class="text-right success">${item.sellableReturns || 0}</td>
          </tr>
        `).join('');
      } catch (error) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:40px;color:#f87171">Error: ${error.message}</td></tr>`;
      }
    }

    async function viewSettlements() {
      const modal = document.getElementById('settlements-modal');
      const container = document.getElementById('settlements-list');
      modal.classList.add('show');
      container.innerHTML = '<div style="text-align:center;padding:40px;color:#71717a">Loading...</div>';

      try {
        const res = await fetch('/api/amazon/settlements?limit=20');
        const data = await res.json();
        if (!data.settlements?.length) {
          container.innerHTML = '<div style="text-align:center;padding:40px;color:#71717a">No settlements uploaded yet</div>';
          return;
        }
        container.innerHTML = '<div style="display:flex;flex-direction:column;gap:12px">' + data.settlements.map(s => `
          <div style="background:#12121a;border:1px solid #252532;border-radius:10px;padding:16px;display:flex;justify-content:space-between;align-items:center">
            <div style="display:flex;align-items:center;gap:12px">
              <span class="material-symbols-outlined" style="color:#60a5fa">payments</span>
              <div>
                <div style="font-weight:600;color:#fff">${s.settlementId}</div>
                <div style="font-size:12px;color:#71717a">${formatDateShort(s.settlementStartDate)} - ${formatDateShort(s.settlementEndDate)}</div>
              </div>
            </div>
            <div style="text-align:right">
              <div style="font-size:18px;font-weight:600;color:#4ade80">${formatCurrency(s.totalAmount || 0)}</div>
              <div style="font-size:11px;color:#52525b">${s.transactionCount || 0} transactions</div>
            </div>
          </div>
        `).join('') + '</div>';
      } catch (error) {
        container.innerHTML = `<div style="text-align:center;padding:40px;color:#f87171">Error: ${error.message}</div>`;
      }
    }

    function closeModal(id) { document.getElementById(id).classList.remove('show'); }
    function formatDate(d) { return d ? new Date(d).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'; }
    function formatDateShort(d) { return d ? new Date(d).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : '-'; }
    function formatCurrency(a, c = 'EUR') { return new Intl.NumberFormat('en-GB', { style: 'currency', currency: c }).format(a); }

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.show').forEach(m => m.classList.remove('show')); });
  </script>
</body>
</html>
