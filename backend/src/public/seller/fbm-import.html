<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FBM Import - Amazon Seller</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <script src="/shell-v2.js"></script>
  <style>
    .page { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
    .page-title { font-size: 24px; font-weight: 700; color: #fff; margin: 0; }
    .page-subtitle { font-size: 14px; color: #71717a; margin-top: 4px; }
    .back-link { display: inline-flex; align-items: center; gap: 6px; color: #a1a1aa; text-decoration: none; font-size: 13px; margin-bottom: 16px; }
    .back-link:hover { color: #f59e0b; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 18px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-primary { background: #f59e0b; color: white; }
    .btn-primary:hover { background: #d97706; }
    .btn-success { background: #22c55e; color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-secondary { background: #252532; color: #e4e4e7; border: 1px solid #3f3f50; }
    .btn-secondary:hover { background: #2a2a3a; }
    .btn .material-symbols-outlined { font-size: 20px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn.loading .material-symbols-outlined { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .card { background: #18181f; border: 1px solid #252532; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid #252532; }
    .card-title { font-size: 16px; font-weight: 600; color: #fff; margin: 0; }
    .card-body { padding: 20px; }
    .upload-zone { border: 2px dashed #3f3f50; border-radius: 10px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .upload-zone:hover, .upload-zone.dragover { border-color: #f59e0b; background: rgba(245, 158, 11, 0.05); }
    .upload-zone .material-symbols-outlined { font-size: 48px; color: #52525b; margin-bottom: 12px; }
    .upload-zone-title { font-size: 16px; font-weight: 600; color: #e4e4e7; margin-bottom: 8px; }
    .upload-zone-text { font-size: 13px; color: #71717a; }
    .upload-zone-text a { color: #f59e0b; }
    #file-input { display: none; }
    .file-info { display: flex; align-items: center; gap: 12px; padding: 14px; background: #12121a; border-radius: 8px; margin-top: 16px; }
    .file-info .material-symbols-outlined { font-size: 24px; color: #4ade80; }
    .file-name { font-size: 14px; color: #e4e4e7; flex: 1; }
    .file-size { font-size: 12px; color: #71717a; }
    .file-remove { color: #71717a; cursor: pointer; }
    .file-remove:hover { color: #ef4444; }
    .instructions { margin-top: 20px; }
    .instructions h4 { font-size: 14px; font-weight: 600; color: #fff; margin: 0 0 12px 0; }
    .instructions ol { margin: 0; padding-left: 20px; color: #a1a1aa; font-size: 13px; line-height: 1.8; }
    .instructions code { background: #12121a; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #f59e0b; }
    .preview-section { display: none; }
    .preview-section.show { display: block; }
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
    @media (max-width: 768px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
    .stat-card { background: #12121a; border: 1px solid #252532; border-radius: 8px; padding: 14px; }
    .stat-value { font-size: 24px; font-weight: 700; color: #fff; }
    .stat-label { font-size: 12px; color: #71717a; text-transform: uppercase; }
    .stat-card.success .stat-value { color: #4ade80; }
    .stat-card.warning .stat-value { color: #fbbf24; }
    .stat-card.error .stat-value { color: #f87171; }
    .table-container { overflow-x: auto; max-height: 400px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid #252532; }
    th { background: #12121a; font-size: 11px; font-weight: 600; color: #71717a; text-transform: uppercase; position: sticky; top: 0; }
    td { font-size: 13px; color: #e4e4e7; }
    tr:hover td { background: #1a1a28; }
    .badge { display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 5px; font-size: 11px; font-weight: 600; }
    .badge-created { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .badge-skipped { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
    .badge-error { background: rgba(239, 68, 68, 0.15); color: #f87171; }
    .toast { position: fixed; bottom: 20px; right: 20px; background: #252532; border: 1px solid #3f3f50; border-radius: 10px; padding: 16px 20px; color: #e4e4e7; font-size: 14px; z-index: 1000; display: none; max-width: 400px; }
    .toast.success { border-color: #22c55e; }
    .toast.error { border-color: #ef4444; }
    .toast.show { display: block; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .action-buttons { display: flex; gap: 12px; margin-top: 20px; }
    .import-progress { display: none; margin-top: 20px; }
    .import-progress.show { display: block; }
    .progress-bar { height: 8px; background: #252532; border-radius: 4px; overflow: hidden; margin-bottom: 12px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #f59e0b, #fbbf24); transition: width 0.3s; }
    .progress-text { font-size: 13px; color: #a1a1aa; margin-top: 8px; text-align: center; }
    .progress-log { background: #12121a; border: 1px solid #252532; border-radius: 8px; padding: 12px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    .log-entry { padding: 4px 0; border-bottom: 1px solid #1a1a28; display: flex; align-items: center; gap: 8px; }
    .log-entry:last-child { border-bottom: none; }
    .log-entry .material-symbols-outlined { font-size: 16px; }
    .log-status { color: #a1a1aa; }
    .log-parsing { color: #60a5fa; }
    .log-progress { color: #fbbf24; }
    .log-created { color: #4ade80; }
    .log-skipped { color: #fbbf24; }
    .log-error { color: #f87171; }
    .log-complete { color: #4ade80; font-weight: 600; }
    .progress-stats { display: flex; gap: 20px; margin-bottom: 12px; flex-wrap: wrap; }
    .progress-stat { font-size: 13px; }
    .progress-stat .label { color: #71717a; }
    .progress-stat .value { color: #fff; font-weight: 600; margin-left: 4px; }
    .progress-stat.created .value { color: #4ade80; }
    .progress-stat.skipped .value { color: #fbbf24; }
    .progress-stat.error .value { color: #f87171; }
    .address-cell { font-size: 12px; line-height: 1.4; }
    .address-street { color: #e4e4e7; }
    .address-city { color: #a1a1aa; }
    .sku-fix-row { background: #1a1a28; }
    .sku-fix-input { background: #12121a; border: 1px solid #3f3f50; border-radius: 6px; padding: 6px 10px; color: #e4e4e7; font-size: 13px; width: 120px; margin-right: 8px; }
    .sku-fix-input:focus { border-color: #f59e0b; outline: none; }
    .btn-small { padding: 5px 12px; font-size: 12px; }
    .btn-small .material-symbols-outlined { font-size: 16px; }
    .sku-error-label { color: #f87171; font-weight: 600; }
    .sku-original { color: #71717a; font-family: monospace; }
  </style>
</head>
<body>
  <div class="page">
    <a href="/seller/" class="back-link">
      <span class="material-symbols-outlined">arrow_back</span>
      Back to Orders
    </a>

    <header class="page-header">
      <div>
        <h1 class="page-title">FBM Order Import</h1>
        <p class="page-subtitle">Import Merchant Fulfilled orders from Amazon TSV file</p>
      </div>
    </header>

    <!-- Upload Section -->
    <div class="card" id="upload-section">
      <div class="card-header">
        <h2 class="card-title">Upload Unshipped Orders Report</h2>
      </div>
      <div class="card-body">
        <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
          <span class="material-symbols-outlined">upload_file</span>
          <div class="upload-zone-title">Drop your TSV file here or click to browse</div>
          <div class="upload-zone-text">Accepts .txt or .tsv files from Amazon Seller Central</div>
        </div>
        <input type="file" id="file-input" accept=".txt,.tsv,.csv" onchange="handleFileSelect(event)">

        <div id="file-info" style="display: none;">
          <div class="file-info">
            <span class="material-symbols-outlined">description</span>
            <span class="file-name" id="file-name"></span>
            <span class="file-size" id="file-size"></span>
            <span class="material-symbols-outlined file-remove" onclick="clearFile()">close</span>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" id="preview-btn" onclick="previewFile()" disabled>
            <span class="material-symbols-outlined">preview</span>
            Preview Orders
          </button>
        </div>

        <div class="instructions">
          <h4>How to download the report from Amazon:</h4>
          <ol>
            <li>Go to <a href="https://sellercentral.amazon.de/orders/unshipped" target="_blank">Seller Central → Orders → Manage Orders</a></li>
            <li>Click on <code>Order Reports</code> tab</li>
            <li>Select <code>Unshipped Orders</code> report type</li>
            <li>Click <code>Request .txt Download</code></li>
            <li>Wait for the report to generate, then download it</li>
            <li>Upload the downloaded file here</li>
          </ol>
        </div>
      </div>
    </div>

    <!-- Preview Section -->
    <div class="preview-section" id="preview-section">
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-value" id="preview-total">0</div>
          <div class="stat-label">Orders Found</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="preview-items">0</div>
          <div class="stat-label">Total Items</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="preview-countries">0</div>
          <div class="stat-label">Countries</div>
        </div>
        <div class="stat-card success">
          <div class="stat-value" id="preview-ready">0</div>
          <div class="stat-label">Ready to Import</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Order Preview</h2>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>City</th>
                <th>Country</th>
                <th>Items</th>
                <th>SKUs</th>
              </tr>
            </thead>
            <tbody id="preview-table">
            </tbody>
          </table>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-secondary" onclick="clearPreview()">
          <span class="material-symbols-outlined">arrow_back</span>
          Back
        </button>
        <button class="btn btn-success" id="import-btn" onclick="importOrders()">
          <span class="material-symbols-outlined">cloud_upload</span>
          Import All Orders
        </button>
      </div>

      <div class="import-progress" id="import-progress">
        <div class="progress-stats">
          <div class="progress-stat"><span class="label">Processing:</span><span class="value" id="progress-current">0</span> / <span id="progress-total">0</span></div>
          <div class="progress-stat created"><span class="label">Created:</span><span class="value" id="progress-created">0</span></div>
          <div class="progress-stat skipped"><span class="label">Skipped:</span><span class="value" id="progress-skipped">0</span></div>
          <div class="progress-stat error"><span class="label">Errors:</span><span class="value" id="progress-errors">0</span></div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
        <div class="progress-log" id="progress-log"></div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="preview-section" id="results-section">
      <div class="stats-row">
        <div class="stat-card success">
          <div class="stat-value" id="result-created">0</div>
          <div class="stat-label">Created</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-value" id="result-skipped">0</div>
          <div class="stat-label">Skipped</div>
        </div>
        <div class="stat-card error">
          <div class="stat-value" id="result-errors">0</div>
          <div class="stat-label">Errors</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="result-total">0</div>
          <div class="stat-label">Total Processed</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Import Results</h2>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Status</th>
                <th>Odoo Order</th>
                <th>Customer / Address</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="results-table">
            </tbody>
          </table>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-secondary" onclick="resetImport()">
          <span class="material-symbols-outlined">refresh</span>
          Import Another File
        </button>
        <a href="/seller/" class="btn btn-primary">
          <span class="material-symbols-outlined">list</span>
          View Orders
        </a>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let selectedFile = null;
    let previewData = null;

    // Drag and drop handling
    const uploadZone = document.getElementById('upload-zone');

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) handleFile(file);
    }

    function handleFile(file) {
      if (!file.name.endsWith('.txt') && !file.name.endsWith('.tsv') && !file.name.endsWith('.csv')) {
        showToast('Please upload a .txt or .tsv file', 'error');
        return;
      }

      selectedFile = file;
      document.getElementById('file-name').textContent = file.name;
      document.getElementById('file-size').textContent = formatFileSize(file.size);
      document.getElementById('file-info').style.display = 'block';
      document.getElementById('preview-btn').disabled = false;
    }

    function clearFile() {
      selectedFile = null;
      document.getElementById('file-input').value = '';
      document.getElementById('file-info').style.display = 'none';
      document.getElementById('preview-btn').disabled = true;
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 4000);
    }

    async function previewFile() {
      if (!selectedFile) return;

      const btn = document.getElementById('preview-btn');
      btn.disabled = true;
      btn.classList.add('loading');

      try {
        const formData = new FormData();
        formData.append('file', selectedFile);

        const res = await fetch('/api/seller/orders/preview-fbm', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (!data.success) {
          throw new Error(data.error || 'Preview failed');
        }

        previewData = data;
        showPreview(data);

      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
      }
    }

    function showPreview(data) {
      document.getElementById('upload-section').style.display = 'none';
      document.getElementById('preview-section').classList.add('show');

      // Calculate stats
      const orders = data.orders || [];
      const totalItems = orders.reduce((sum, o) => sum + o.itemCount, 0);
      const countries = [...new Set(orders.map(o => o.country))];

      document.getElementById('preview-total').textContent = orders.length;
      document.getElementById('preview-items').textContent = totalItems;
      document.getElementById('preview-countries').textContent = countries.length;
      document.getElementById('preview-ready').textContent = orders.length;

      // Render table
      const tbody = document.getElementById('preview-table');
      tbody.innerHTML = orders.map(order => {
        const skus = order.items.map(i => `${i.resolvedSku} x${i.quantity}`).join(', ');
        return `
          <tr>
            <td>${order.orderId}</td>
            <td>${order.customer}</td>
            <td>${order.city}</td>
            <td>${order.country}</td>
            <td>${order.itemCount}</td>
            <td>${skus}</td>
          </tr>
        `;
      }).join('');
    }

    function clearPreview() {
      document.getElementById('preview-section').classList.remove('show');
      document.getElementById('upload-section').style.display = 'block';
      previewData = null;
    }

    async function importOrders() {
      if (!selectedFile) return;

      const btn = document.getElementById('import-btn');
      btn.disabled = true;
      btn.classList.add('loading');

      const progress = document.getElementById('import-progress');
      progress.classList.add('show');

      // Reset progress stats
      document.getElementById('progress-fill').style.width = '0%';
      document.getElementById('progress-current').textContent = '0';
      document.getElementById('progress-total').textContent = '0';
      document.getElementById('progress-created').textContent = '0';
      document.getElementById('progress-skipped').textContent = '0';
      document.getElementById('progress-errors').textContent = '0';
      document.getElementById('progress-log').innerHTML = '';

      let createdCount = 0;
      let skippedCount = 0;
      let errorCount = 0;
      let finalData = null;

      const addLogEntry = (icon, className, message) => {
        const log = document.getElementById('progress-log');
        const entry = document.createElement('div');
        entry.className = 'log-entry ' + className;
        entry.innerHTML = `<span class="material-symbols-outlined">${icon}</span><span>${message}</span>`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
      };

      try {
        const formData = new FormData();
        formData.append('file', selectedFile);

        // Use fetch with streaming response for SSE
        const response = await fetch('/api/seller/orders/import-fbm-stream', {
          method: 'POST',
          body: formData
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop(); // Keep incomplete line in buffer

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                handleStreamEvent(data);
              } catch (e) {
                console.error('Failed to parse SSE data:', line);
              }
            }
          }
        }

        function handleStreamEvent(data) {
          switch (data.type) {
            case 'status':
              addLogEntry('info', 'log-status', data.message);
              if (data.total) {
                document.getElementById('progress-total').textContent = data.total;
              }
              break;

            case 'parsing':
              addLogEntry('description', 'log-parsing', data.message);
              document.getElementById('progress-total').textContent = data.count;
              break;

            case 'imported':
              addLogEntry('database', 'log-status', data.message);
              break;

            case 'progress':
              document.getElementById('progress-current').textContent = data.current;
              document.getElementById('progress-total').textContent = data.total;
              document.getElementById('progress-fill').style.width = data.percent + '%';
              addLogEntry('sync', 'log-progress', `Processing ${data.orderId} - ${data.customer} (${data.city})`);
              break;

            case 'result':
              if (data.status === 'created') {
                createdCount++;
                document.getElementById('progress-created').textContent = createdCount;
                addLogEntry('check_circle', 'log-created', `✓ Created ${data.odooName} - ${data.customer}`);
              } else if (data.status === 'skipped') {
                skippedCount++;
                document.getElementById('progress-skipped').textContent = skippedCount;
                addLogEntry('skip_next', 'log-skipped', `⊘ Skipped ${data.orderId} - ${data.reason || 'Already exists'}`);
              } else {
                errorCount++;
                document.getElementById('progress-errors').textContent = errorCount;
                addLogEntry('error', 'log-error', `✗ Error ${data.orderId} - ${data.error || data.reason}`);
              }
              break;

            case 'complete':
              document.getElementById('progress-fill').style.width = '100%';
              addLogEntry('done_all', 'log-complete', `Import complete: ${data.created} created, ${data.skipped} skipped, ${data.errors} errors`);
              finalData = data;
              break;

            case 'error':
              addLogEntry('error', 'log-error', `Error: ${data.error}`);
              showToast('Error: ' + data.error, 'error');
              break;
          }
        }

        // Show results after a short delay
        setTimeout(() => {
          if (finalData) {
            progress.classList.remove('show');
            showResults({
              success: true,
              parsed: finalData.parsed,
              created: finalData.created,
              skipped: finalData.skipped,
              errors: finalData.orders?.filter(o => o.status === 'error') || [],
              orders: finalData.orders || []
            });
          }
        }, 1000);

      } catch (e) {
        showToast('Error: ' + e.message, 'error');
        addLogEntry('error', 'log-error', `Fatal error: ${e.message}`);
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
      }
    }

    // Store error data for retries
    let pendingErrors = [];

    function formatAddress(addr) {
      if (!addr) return '-';
      const parts = [];
      if (addr.street) parts.push(`<span class="address-street">${addr.street}</span>`);
      const cityLine = [addr.postalCode, addr.city, addr.country].filter(Boolean).join(' ');
      if (cityLine) parts.push(`<span class="address-city">${cityLine}</span>`);
      return parts.length > 0 ? `<div class="address-cell">${parts.join('<br>')}</div>` : '-';
    }

    function showResults(data) {
      document.getElementById('preview-section').classList.remove('show');
      document.getElementById('results-section').classList.add('show');

      document.getElementById('result-created').textContent = data.created || 0;
      document.getElementById('result-skipped').textContent = data.skipped || 0;
      document.getElementById('result-errors').textContent = data.errors?.length || 0;
      document.getElementById('result-total').textContent = data.parsed || 0;

      const tbody = document.getElementById('results-table');
      const orders = data.orders || [];

      // Store errors for potential retry
      pendingErrors = (data.errors || []).filter(e => e.errorType === 'sku_not_found');

      let html = orders.map(order => {
        let statusBadge, details;
        const customerCell = order.customer
          ? `<strong>${order.customer}</strong><br>${formatAddress(order.address)}`
          : formatAddress(order.address);

        if (order.status === 'created') {
          statusBadge = '<span class="badge badge-created">Created</span>';
          details = '';
        } else if (order.status === 'skipped') {
          statusBadge = '<span class="badge badge-skipped">Skipped</span>';
          details = order.reason || 'Already exists';
        } else {
          statusBadge = '<span class="badge badge-error">Error</span>';
          details = order.error || 'Unknown error';
        }

        return `
          <tr>
            <td>${order.orderId}</td>
            <td>${statusBadge}</td>
            <td>${order.odooName || '-'}</td>
            <td>${customerCell}</td>
            <td>${details}</td>
          </tr>
        `;
      }).join('');

      // Add SKU errors with correction UI
      if (data.errors && data.errors.length > 0) {
        data.errors.forEach((err, index) => {
          const customerCell = err.customer
            ? `<strong>${err.customer}</strong><br>${formatAddress(err.address)}`
            : formatAddress(err.address);

          if (err.errorType === 'sku_not_found') {
            // SKU not found error - show correction UI
            html += `
              <tr class="sku-fix-row" id="error-row-${index}">
                <td>${err.orderId || '-'}</td>
                <td><span class="badge badge-error">Error</span></td>
                <td>-</td>
                <td>${customerCell}</td>
                <td>
                  <div class="sku-error-label">SKU not found:</div>
                  <code class="sku-original">${err.sku}</code>
                  <div style="margin-top: 8px;">
                    <span style="color: #a1a1aa;">Correct SKU:</span>
                    <input type="text" class="sku-fix-input" id="sku-input-${index}" placeholder="e.g. ${err.resolvedSku || err.sku}">
                    <button class="btn btn-primary btn-small" onclick="retrySku(${index})">
                      <span class="material-symbols-outlined">save</span>
                      Save
                    </button>
                  </div>
                </td>
              </tr>
            `;
          } else {
            // Other errors
            html += `
              <tr>
                <td>${err.orderId || '-'}</td>
                <td><span class="badge badge-error">Error</span></td>
                <td>-</td>
                <td>${customerCell}</td>
                <td>${err.error}</td>
              </tr>
            `;
          }
        });
      }

      tbody.innerHTML = html;
      showToast(`Import complete: ${data.created} created, ${data.skipped} skipped`);
    }

    async function retrySku(errorIndex) {
      const error = pendingErrors[errorIndex];
      if (!error || !error.orderData) {
        showToast('Error: Missing order data for retry', 'error');
        return;
      }

      const inputEl = document.getElementById(`sku-input-${errorIndex}`);
      const correctedSku = inputEl?.value?.trim();

      if (!correctedSku) {
        showToast('Please enter a correct SKU', 'error');
        return;
      }

      const rowEl = document.getElementById(`error-row-${errorIndex}`);
      const btn = rowEl.querySelector('button');
      btn.disabled = true;
      btn.innerHTML = '<span class="material-symbols-outlined" style="animation: spin 1s linear infinite;">sync</span> Saving...';

      try {
        const res = await fetch('/api/seller/orders/retry-fbm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            orderData: error.orderData,
            skuMappings: { [error.sku]: correctedSku }
          })
        });

        const result = await res.json();

        if (result.success && result.status === 'created') {
          // Success! Update the row
          const customerCell = result.customer
            ? `<strong>${result.customer}</strong><br>${formatAddress(result.address)}`
            : formatAddress(result.address);

          rowEl.className = '';
          rowEl.innerHTML = `
            <td>${result.orderId}</td>
            <td><span class="badge badge-created">Created</span></td>
            <td>${result.odooName || '-'}</td>
            <td>${customerCell}</td>
            <td>Fixed: ${error.sku} → ${correctedSku}</td>
          `;

          // Update counts
          const createdEl = document.getElementById('result-created');
          const errorsEl = document.getElementById('result-errors');
          createdEl.textContent = parseInt(createdEl.textContent) + 1;
          errorsEl.textContent = Math.max(0, parseInt(errorsEl.textContent) - 1);

          showToast(`Order ${result.odooName} created successfully!`, 'success');
        } else {
          // Still error - show new error message
          const errMsg = result.error || 'Unknown error';
          btn.disabled = false;
          btn.innerHTML = '<span class="material-symbols-outlined">save</span> Save';
          showToast(`Error: ${errMsg}`, 'error');

          // Update the error label if SKU still not found
          if (result.errorType === 'sku_not_found') {
            const label = rowEl.querySelector('.sku-error-label');
            if (label) label.textContent = `SKU "${correctedSku}" not found. Try again:`;
          }
        }
      } catch (e) {
        btn.disabled = false;
        btn.innerHTML = '<span class="material-symbols-outlined">save</span> Save';
        showToast(`Error: ${e.message}`, 'error');
      }
    }

    function resetImport() {
      document.getElementById('results-section').classList.remove('show');
      document.getElementById('upload-section').style.display = 'block';
      clearFile();
      previewData = null;
    }
  </script>
</body>
</html>
