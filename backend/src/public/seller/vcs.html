<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VCS Tax Reports - Amazon Seller</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <script src="/shell-v2.js"></script>
  <style>
    .page { max-width: 1600px; margin: 0 auto; padding: 20px; }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
    .page-logo-container { background: #fff; border-radius: 10px; padding: 8px 14px; display: flex; align-items: center; justify-content: center; }
    .page-logo { height: 28px; width: auto; }
    .status-indicator { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #a1a1aa; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #4ade80; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-primary { background: #f59e0b; color: white; }
    .btn-primary:hover { background: #d97706; }
    .btn-success { background: #22c55e; color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-secondary { background: #252532; color: #e4e4e7; border: 1px solid #3f3f50; }
    .btn-secondary:hover { background: #2a2a3a; }
    .btn-blue { background: #3b82f6; color: white; }
    .btn-blue:hover { background: #2563eb; }
    .btn-purple { background: #8b5cf6; color: white; }
    .btn-purple:hover { background: #7c3aed; }
    .btn-amber { background: #f59e0b; color: white; }
    .btn-amber:hover { background: #d97706; }
    .btn-orange { background: #f97316; color: white; }
    .btn-orange:hover { background: #ea580c; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }
    .btn .material-symbols-outlined { font-size: 18px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    .card { background: #18181f; border: 1px solid #252532; border-radius: 12px; overflow: hidden; margin-bottom: 16px; }
    .card-header { padding: 12px 16px; border-bottom: 1px solid #252532; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .card-title { font-size: 14px; font-weight: 600; color: #fff; margin: 0; display: flex; align-items: center; gap: 8px; }
    .card-body { padding: 16px; }
    .upload-zone { background: #12121a; border: 2px dashed #3f3f50; border-radius: 10px; padding: 32px; text-align: center; cursor: pointer; transition: border-color 0.15s; }
    .upload-zone:hover { border-color: #4ade80; }
    .upload-zone.active { border-color: #4ade80; }
    .upload-zone .material-symbols-outlined { font-size: 40px; color: #52525b; margin-bottom: 8px; }
    .upload-zone p { color: #71717a; margin: 4px 0; font-size: 13px; }
    .upload-progress { display: none; }
    .upload-progress.show { display: flex; align-items: center; gap: 12px; margin-top: 12px; }
    .progress-bar-container { flex: 1; height: 8px; background: #252532; border-radius: 4px; overflow: hidden; }
    .progress-bar { height: 100%; background: #4ade80; width: 0%; transition: width 0.3s; }
    .alert { padding: 12px 16px; border-radius: 8px; margin-top: 12px; display: none; }
    .alert.show { display: block; }
    .alert-success { background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.3); }
    .alert-success .alert-icon { color: #4ade80; }
    .alert-error { background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); }
    .alert-error .alert-icon { color: #f87171; }
    .alert-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .alert-title { font-weight: 600; font-size: 13px; }
    .alert-success .alert-title { color: #4ade80; }
    .alert-error .alert-title { color: #f87171; }
    .alert-body { font-size: 13px; color: #e4e4e7; }
    .help-text { font-size: 12px; color: #71717a; margin-top: 12px; }
    .help-text strong { color: #a1a1aa; }
    .reports-list { display: flex; flex-direction: column; gap: 8px; }
    .report-card { padding: 12px 16px; border-radius: 8px; border: 1px solid #3f3f50; background: #252532; cursor: pointer; transition: all 0.15s; }
    .report-card:hover { border-color: #52525b; }
    .report-card.selected { border-color: #4ade80; background: rgba(34, 197, 94, 0.1); }
    .report-card-content { display: flex; align-items: center; justify-content: space-between; }
    .report-info { display: flex; align-items: center; gap: 12px; }
    .report-info .material-symbols-outlined { color: #52525b; }
    .report-card.selected .report-info .material-symbols-outlined { color: #4ade80; }
    .report-name { font-size: 13px; font-weight: 600; color: #fff; }
    .report-date { font-size: 12px; color: #71717a; }
    .report-stats { display: flex; gap: 16px; font-size: 12px; }
    .stat-pending { color: #fbbf24; }
    .stat-returns { color: #fb923c; }
    .stat-invoiced { color: #4ade80; }
    .filters-bar { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; align-items: center; }
    .filter-select { padding: 6px 10px; background: #12121a; border: 1px solid #252532; border-radius: 6px; color: #e4e4e7; font-size: 12px; }
    .filter-select:focus { outline: none; border-color: #f59e0b; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid #252532; }
    th { background: #12121a; font-size: 11px; font-weight: 600; color: #71717a; text-transform: uppercase; letter-spacing: 0.05em; }
    th.sortable { cursor: pointer; transition: color 0.15s; }
    th.sortable:hover { color: #e4e4e7; }
    td { font-size: 13px; color: #e4e4e7; }
    tr:hover td { background: #1a1a28; }
    .filter-row th { padding: 6px 8px; background: #12121a; vertical-align: middle; }
    .filter-input { padding: 6px 8px; background: #12121a; border: 1px solid #252532; border-radius: 6px; color: #e4e4e7; font-size: 12px; width: 100%; box-sizing: border-box; }
    .filter-input:focus { outline: none; border-color: #f59e0b; }
    .filter-input::placeholder { color: #52525b; }
    .order-id { font-family: monospace; font-size: 12px; }
    .badge { display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 5px; font-size: 11px; font-weight: 600; }
    .badge-country { display: inline-flex; align-items: center; background: rgba(113, 113, 122, 0.2); color: #a1a1aa; }
    .badge-scheme-oss { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .badge-scheme-b2b { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
    .badge-scheme-export { background: rgba(251, 146, 60, 0.2); color: #fb923c; }
    .badge-scheme-domestic { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .badge-scheme-cross { background: rgba(34, 211, 238, 0.2); color: #22d3ee; }
    .badge-scheme-deemed { background: rgba(113, 113, 122, 0.2); color: #a1a1aa; }
    .badge-scheme-ch { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .badge-scheme-default { background: rgba(113, 113, 122, 0.2); color: #a1a1aa; }
    .badge-odoo { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .badge-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; display: flex; align-items: center; gap: 4px; }
    .badge-warning .material-symbols-outlined { font-size: 14px; }
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .font-mono { font-family: monospace; }
    .text-muted { color: #71717a; }
    .link { color: #60a5fa; text-decoration: none; }
    .link:hover { text-decoration: underline; }
    .pagination { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; border-top: 1px solid #252532; }
    .pagination-left { display: flex; align-items: center; gap: 16px; }
    .pagination-info { font-size: 12px; color: #71717a; }
    .selection-info { font-size: 12px; color: #a1a1aa; }
    .selection-info .count { color: #4ade80; font-weight: 600; }
    .selection-info .total { color: #e4e4e7; }
    .selection-info .select-all-link { color: #60a5fa; cursor: pointer; margin-left: 8px; }
    .selection-info .select-all-link:hover { text-decoration: underline; }
    .pagination-buttons { display: flex; gap: 6px; }
    .page-size-select { padding: 4px 8px; background: #252532; border: 1px solid #3f3f50; border-radius: 4px; color: #e4e4e7; font-size: 12px; }
    .empty-state { padding: 40px 20px; text-align: center; }
    .empty-state .material-symbols-outlined { font-size: 40px; color: #3f3f50; margin-bottom: 12px; display: block; }
    .empty-state-title { font-size: 14px; color: #71717a; }
    .actions-bar { display: flex; gap: 8px; flex-wrap: wrap; }
    .returns-section { border-color: rgba(249, 115, 22, 0.3); }
    .returns-section .card-title .material-symbols-outlined { color: #fb923c; }
    .checkbox { width: 16px; height: 16px; border-radius: 4px; cursor: pointer; }
    /* Modal styles */
    .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
    .modal-content { background: #18181f; border: 1px solid #252532; border-radius: 12px; max-width: 1000px; width: calc(100% - 32px); max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
    .modal-header { padding: 12px 16px; border-bottom: 1px solid #252532; display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 16px; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 8px; }
    .modal-subtitle { font-size: 12px; color: #71717a; }
    .modal-close { background: none; border: none; color: #71717a; cursor: pointer; padding: 4px; }
    .modal-close:hover { color: #fff; }
    .modal-body { padding: 16px; overflow-y: auto; flex: 1; }
    .modal-footer { padding: 12px 16px; border-top: 1px solid #252532; display: flex; justify-content: flex-end; gap: 8px; }
    .summary-chips { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .summary-chip { background: #252532; border-radius: 6px; padding: 8px 12px; display: flex; align-items: center; gap: 8px; font-size: 12px; }
    .summary-chip .value { font-weight: 700; }
    .summary-chip .label { color: #71717a; }
    .summary-chip.success .value { color: #4ade80; }
    .summary-chip.warning .value { color: #fbbf24; }
    .summary-chip.error .value { color: #f87171; }
    .summary-chip.orange .value { color: #fb923c; }
    .invoice-card { background: #252532; border-radius: 8px; padding: 12px; margin-bottom: 8px; border-left: 4px solid #4ade80; }
    .invoice-card.credit-note { border-left-color: #fb923c; }
    .invoice-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .invoice-order-id { font-family: monospace; font-size: 13px; font-weight: 600; color: #fff; }
    .invoice-ref { font-size: 12px; color: #71717a; margin-left: 8px; }
    .invoice-badge { background: rgba(34, 197, 94, 0.2); color: #4ade80; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
    .invoice-card.credit-note .invoice-badge { background: rgba(251, 146, 60, 0.2); color: #fb923c; }
    .invoice-meta { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 8px; }
    .invoice-meta-item { background: #1a1a28; border-radius: 4px; padding: 6px 8px; font-size: 11px; }
    .invoice-meta-item .label { color: #52525b; }
    .invoice-meta-item .value { color: #e4e4e7; margin-left: 4px; }
    .invoice-totals { display: flex; align-items: center; justify-content: space-between; background: #1a1a28; border-radius: 4px; padding: 8px; font-size: 12px; }
    .invoice-totals .label { color: #71717a; }
    .invoice-totals .amount { margin-left: 4px; }
    .invoice-totals .net { color: #fff; }
    .invoice-totals .vat { color: #fbbf24; }
    .invoice-totals .total { color: #4ade80; font-weight: 600; }
    .invoice-card.credit-note .invoice-totals .net { color: #fb923c; }
    .invoice-card.credit-note .invoice-totals .total { color: #fb923c; }
    .invoice-lines { background: #1a1a28; border-radius: 4px; padding: 8px; margin-top: 8px; }
    .invoice-lines table { font-size: 11px; }
    .invoice-lines th { background: transparent; padding: 4px 8px; color: #52525b; }
    .invoice-lines td { padding: 4px 8px; border-bottom: none; color: #a1a1aa; }
    .errors-section { margin-top: 16px; }
    .errors-title { font-size: 13px; font-weight: 600; color: #f87171; margin-bottom: 8px; }
    .error-item { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; padding: 8px 12px; margin-bottom: 4px; font-size: 12px; }
    .error-item .order-id { color: #e4e4e7; font-family: monospace; }
    .error-item .error-msg { color: #f87171; margin-left: 8px; }
    .progress-modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
    .progress-modal-content { background: #18181f; border: 1px solid #252532; border-radius: 12px; padding: 24px; max-width: 400px; width: calc(100% - 32px); text-align: center; }
    .progress-modal-title { font-size: 16px; font-weight: 600; color: #fff; margin-bottom: 16px; }
    .progress-modal-bar { height: 12px; background: #252532; border-radius: 6px; overflow: hidden; margin-bottom: 12px; }
    .progress-modal-fill { height: 100%; background: #4ade80; width: 0%; transition: width 0.3s; }
    .progress-modal-text { font-size: 13px; color: #e4e4e7; margin-bottom: 8px; }
    .progress-modal-stats { display: flex; justify-content: center; gap: 16px; font-size: 12px; }
    .progress-modal-stats .stat { display: flex; align-items: center; gap: 4px; }
    .progress-modal-stats .created { color: #4ade80; }
    .progress-modal-stats .skipped { color: #71717a; }
    .progress-modal-stats .errors { color: #f87171; }
    .progress-modal-order { font-size: 11px; color: #52525b; margin-top: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="page">
    <!-- Page Header -->
    <header class="page-header">
      <div class="page-logo-container">
        <img src="/assets/logos/amazon-seller-central.png" alt="Amazon Seller Central" class="page-logo">
      </div>
      <div class="status-indicator" id="status-indicator">
        <span class="status-dot"></span>
        Ready
      </div>
    </header>

    <!-- Upload Section -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <span class="material-symbols-outlined" style="color: #4ade80;">upload_file</span>
          Upload VCS Tax Report
        </h2>
      </div>
      <div class="card-body">
        <div id="drop-zone" class="upload-zone">
          <span class="material-symbols-outlined">upload_file</span>
          <p style="color: #a1a1aa;">Drag & drop your VCS Tax Report CSV here</p>
          <p>or click to browse</p>
          <input type="file" id="file-input" accept=".csv,.tsv,.txt" style="display: none;">
        </div>

        <div id="upload-progress" class="upload-progress">
          <span class="material-symbols-outlined animate-spin" style="color: #4ade80;">progress_activity</span>
          <span style="color: #e4e4e7; font-size: 13px;">Processing report...</span>
          <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar"></div>
          </div>
        </div>

        <div id="upload-result" class="alert alert-success">
          <div class="alert-header">
            <span class="material-symbols-outlined alert-icon">check_circle</span>
            <span class="alert-title">Report Processed Successfully</span>
          </div>
          <div id="result-summary" class="alert-body"></div>
        </div>

        <div id="upload-error" class="alert alert-error">
          <div class="alert-header">
            <span class="material-symbols-outlined alert-icon">error</span>
            <span class="alert-title">Upload Failed</span>
          </div>
          <div id="error-message" class="alert-body"></div>
        </div>

        <p class="help-text">
          <strong>How to get this report:</strong> Amazon Seller Central → Reports → Tax Document Library → Download VAT Transaction Report
        </p>
      </div>
    </div>

    <!-- Report Selector -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <span class="material-symbols-outlined" style="color: #f59e0b;">description</span>
          Select VCS Report
        </h2>
      </div>
      <div class="card-body">
        <p style="font-size: 13px; color: #71717a; margin-bottom: 12px;">Choose a report to view its pending orders and returns. Select "All Reports" to see pending items from all uploaded reports.</p>
        <div id="reports-list" class="reports-list">
          <div style="color: #71717a; font-size: 13px;">Loading reports...</div>
        </div>
      </div>
    </div>

    <!-- Summary Stats (Hidden) -->
    <div id="summary-section" class="card hidden">
      <div class="card-header">
        <h2 class="card-title">Summary</h2>
      </div>
      <div class="card-body">
        <div id="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
          <div style="background: #252532; border-radius: 8px; padding: 16px; text-align: center;">
            <div id="stat-pending" style="font-size: 28px; font-weight: 700; color: #fbbf24;">-</div>
            <div style="font-size: 12px; color: #71717a;">Pending</div>
          </div>
          <div style="background: #252532; border-radius: 8px; padding: 16px; text-align: center;">
            <div id="stat-invoiced" style="font-size: 28px; font-weight: 700; color: #4ade80;">-</div>
            <div style="font-size: 12px; color: #71717a;">Invoiced</div>
          </div>
          <div style="background: #252532; border-radius: 8px; padding: 16px; text-align: center;">
            <div id="stat-skipped" style="font-size: 28px; font-weight: 700; color: #71717a;">-</div>
            <div style="font-size: 12px; color: #71717a;">Skipped</div>
          </div>
          <div style="background: #252532; border-radius: 8px; padding: 16px; text-align: center;">
            <div id="stat-total" style="font-size: 28px; font-weight: 700; color: #fff;">-</div>
            <div style="font-size: 12px; color: #71717a;">Total Orders</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pending Orders -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Pending Orders</h2>
        <div class="actions-bar">
          <button id="refresh-btn" class="btn btn-secondary">
            <span class="material-symbols-outlined">refresh</span>Refresh
          </button>
          <button id="export-btn" class="btn btn-secondary">
            <span class="material-symbols-outlined">download</span>Export CSV
          </button>
          <button id="preview-invoices-btn" class="btn btn-blue">
            <span class="material-symbols-outlined">preview</span>Preview Invoices
          </button>
          <button id="create-invoices-btn" class="btn btn-success">
            <span class="material-symbols-outlined">receipt</span>Create Invoices in Odoo
          </button>
          <button id="create-orders-btn" class="btn btn-amber">
            <span class="material-symbols-outlined">add_shopping_cart</span>Create Orders in Odoo
          </button>
          <button id="check-odoo-btn" class="btn btn-purple">
            <span class="material-symbols-outlined">sync</span>Check Odoo Orders
          </button>
        </div>
      </div>

      <!-- Filters -->
      <div style="padding: 12px 16px; border-bottom: 1px solid #252532;">
        <div class="filters-bar">
          <select id="filter-country" class="filter-select">
            <option value="">All Countries</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
            <option value="IT">Italy</option>
            <option value="ES">Spain</option>
            <option value="NL">Netherlands</option>
            <option value="BE">Belgium</option>
            <option value="AT">Austria</option>
            <option value="PL">Poland</option>
            <option value="GB">United Kingdom</option>
          </select>
          <select id="filter-scheme" class="filter-select">
            <option value="">All Schemes</option>
            <option value="OSS">OSS</option>
            <option value="B2B">B2B (Reverse Charge)</option>
            <option value="EXPORT">Export</option>
            <option value="DOMESTIC">All Domestic</option>
            <option value="DOMESTIC_DE">Domestic DE</option>
            <option value="DOMESTIC_FR">Domestic FR</option>
            <option value="DOMESTIC_IT">Domestic IT</option>
            <option value="DOMESTIC_NL">Domestic NL</option>
            <option value="DOMESTIC_PL">Domestic PL</option>
            <option value="DOMESTIC_CZ">Domestic CZ</option>
            <option value="DOMESTIC_BE">Domestic BE</option>
            <option value="DOMESTIC_GB">Domestic GB</option>
          </select>
          <select id="filter-odoo-status" class="filter-select">
            <option value="">All Odoo Status</option>
            <option value="has-order">Has Odoo Order</option>
            <option value="missing-order">Missing Odoo Order</option>
          </select>
          <select id="filter-currency" class="filter-select">
            <option value="">All Currencies</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
            <option value="PLN">PLN</option>
            <option value="CZK">CZK</option>
            <option value="SEK">SEK</option>
          </select>
        </div>
      </div>

      <!-- Orders Table -->
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width: 40px; padding-left: 16px;">
                <input type="checkbox" id="select-all" class="checkbox">
              </th>
              <th class="sortable" onclick="sortOrdersBy('orderId')">
                Order ID <span id="sort-orderId"></span>
              </th>
              <th class="sortable" onclick="sortOrdersBy('orderDate')">
                Date <span id="sort-orderDate"></span>
              </th>
              <th class="sortable" onclick="sortOrdersBy('shipToCountry')">
                Country <span id="sort-shipToCountry"></span>
              </th>
              <th class="sortable" onclick="sortOrdersBy('scheme')">
                Scheme <span id="sort-scheme"></span>
              </th>
              <th class="sortable" onclick="sortOrdersBy('items')">
                Items <span id="sort-items"></span>
              </th>
              <th class="sortable text-right" onclick="sortOrdersBy('totalExclusive')">
                Net <span id="sort-totalExclusive"></span>
              </th>
              <th class="sortable text-right" onclick="sortOrdersBy('totalTax')">
                VAT <span id="sort-totalTax"></span>
              </th>
              <th class="sortable text-right" onclick="sortOrdersBy('totalInclusive')">
                Total <span id="sort-totalInclusive"></span>
              </th>
              <th class="sortable" onclick="sortOrdersBy('odooOrder')">
                Odoo Order <span id="sort-odooOrder"></span>
              </th>
              <th class="text-center">URL</th>
            </tr>
            <tr class="filter-row">
              <th></th>
              <th><input type="text" placeholder="Search..." class="orders-col-filter filter-input" data-column="orderId"></th>
              <th><input type="text" placeholder="Search..." class="orders-col-filter filter-input" data-column="orderDate"></th>
              <th><input type="text" placeholder="Search..." class="orders-col-filter filter-input" data-column="shipToCountry"></th>
              <th><input type="text" placeholder="Search..." class="orders-col-filter filter-input" data-column="scheme"></th>
              <th></th>
              <th></th>
              <th></th>
              <th></th>
              <th><input type="text" placeholder="Search..." class="orders-col-filter filter-input" data-column="odooOrder"></th>
              <th></th>
            </tr>
          </thead>
          <tbody id="orders-table-body">
            <tr>
              <td colspan="11" class="empty-state">
                <span class="material-symbols-outlined">inbox</span>
                <div class="empty-state-title">Loading orders...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination">
        <div class="pagination-left">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 12px; color: #71717a;">Show</span>
            <select id="orders-page-size" class="page-size-select">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="250">250</option>
              <option value="500">500</option>
            </select>
            <span style="font-size: 12px; color: #71717a;">per page</span>
          </div>
          <div id="pagination-info" class="pagination-info">Showing 0 orders</div>
          <div class="selection-info">
            <span id="selection-count" class="count">0</span>
            <span> of </span>
            <span id="total-filtered" class="total">0</span>
            <span> selected</span>
            <span class="select-all-link" id="select-all-btn">Select All</span>
          </div>
        </div>
        <div class="pagination-buttons">
          <button id="prev-page" class="btn btn-secondary btn-sm" disabled>Previous</button>
          <button id="next-page" class="btn btn-secondary btn-sm" disabled>Next</button>
        </div>
      </div>
    </div>

    <!-- Pending Returns (Credit Notes) -->
    <div id="returns-section" class="card returns-section hidden">
      <div class="card-header">
        <h2 class="card-title">
          <span class="material-symbols-outlined">undo</span>
          Pending Returns (Credit Notes)
        </h2>
        <div class="actions-bar">
          <button id="refresh-returns-btn" class="btn btn-secondary">
            <span class="material-symbols-outlined">refresh</span>Refresh
          </button>
          <button id="preview-credit-notes-btn" class="btn btn-blue">
            <span class="material-symbols-outlined">preview</span>Preview Credit Notes
          </button>
          <button id="create-credit-notes-btn" class="btn btn-orange">
            <span class="material-symbols-outlined">receipt_long</span>Create Credit Notes in Odoo
          </button>
        </div>
      </div>

      <!-- Returns Filters -->
      <div style="padding: 12px 16px; border-bottom: 1px solid #252532;">
        <div class="filters-bar">
          <select id="filter-returns-currency" class="filter-select">
            <option value="">All Currencies</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
            <option value="PLN">PLN</option>
            <option value="CZK">CZK</option>
            <option value="SEK">SEK</option>
          </select>
        </div>
      </div>

      <!-- Returns Table -->
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width: 40px; padding-left: 16px;">
                <input type="checkbox" id="select-all-returns" class="checkbox">
              </th>
              <th class="sortable" onclick="sortReturnsBy('orderId')">
                Order ID <span id="ret-sort-orderId"></span>
              </th>
              <th class="sortable" onclick="sortReturnsBy('returnDate')">
                Return Date <span id="ret-sort-returnDate"></span>
              </th>
              <th class="sortable" onclick="sortReturnsBy('shipToCountry')">
                Country <span id="ret-sort-shipToCountry"></span>
              </th>
              <th class="sortable" onclick="sortReturnsBy('items')">
                Items <span id="ret-sort-items"></span>
              </th>
              <th class="sortable text-right" onclick="sortReturnsBy('totalExclusive')">
                Total (excl) <span id="ret-sort-totalExclusive"></span>
              </th>
              <th class="sortable text-right" onclick="sortReturnsBy('totalTax')">
                VAT <span id="ret-sort-totalTax"></span>
              </th>
              <th class="sortable" onclick="sortReturnsBy('scheme')">
                Scheme <span id="ret-sort-scheme"></span>
              </th>
            </tr>
            <tr class="filter-row">
              <th></th>
              <th><input type="text" placeholder="Search..." class="returns-col-filter filter-input" data-column="orderId"></th>
              <th><input type="text" placeholder="Search..." class="returns-col-filter filter-input" data-column="returnDate"></th>
              <th><input type="text" placeholder="Search..." class="returns-col-filter filter-input" data-column="shipToCountry"></th>
              <th></th>
              <th></th>
              <th></th>
              <th><input type="text" placeholder="Search..." class="returns-col-filter filter-input" data-column="scheme"></th>
            </tr>
          </thead>
          <tbody id="returns-table-body">
            <!-- Returns loaded dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Returns Pagination -->
      <div class="pagination">
        <div class="pagination-left">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 12px; color: #71717a;">Show</span>
            <select id="returns-page-size" class="page-size-select">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="250">250</option>
            </select>
            <span style="font-size: 12px; color: #71717a;">per page</span>
          </div>
          <div id="returns-count" class="pagination-info"></div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <span id="returns-pagination-info" class="pagination-info"></span>
          <div class="pagination-buttons">
            <button id="returns-prev-page" class="btn btn-secondary btn-sm" disabled>Previous</button>
            <button id="returns-next-page" class="btn btn-secondary btn-sm" disabled>Next</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Country flags
    const COUNTRY_FLAGS = { DE: 'de', FR: 'fr', IT: 'it', ES: 'es', NL: 'nl', BE: 'be', PL: 'pl', SE: 'se', UK: 'gb', GB: 'gb', CZ: 'cz', AT: 'at', CH: 'ch', DK: 'dk', FI: 'fi', IE: 'ie', PT: 'pt', LU: 'lu', GR: 'gr' };
    function getFlagImg(code) {
      const flag = COUNTRY_FLAGS[code];
      if (!flag) return code || '-';
      return '<img src="https://flagcdn.com/w40/' + flag + '.png" alt="' + code + '" style="width:24px;height:16px;object-fit:cover;border-radius:2px;vertical-align:middle;margin-right:4px;">' + code;
    }

    // State
    let pendingOrders = [];
    let pendingReturns = [];
    let vcsReports = [];
    let selectedReportId = null;
    let odooOrders = {}; // Map of orderId -> Odoo order info
    let currentPage = 1;
    let pageSize = 50;
    let selectedOrderIds = new Set(); // Track selected order IDs across pages
    let allFilteredSelected = false; // Whether all filtered orders are selected
    let selectedReturnIds = new Set(); // Track selected return IDs
    let returnsPage = 1;
    let returnsPageSize = 50;

    // Sorting state
    let ordersSortColumn = null;
    let ordersSortDirection = 'asc'; // 'asc' or 'desc'
    let returnsSortColumn = null;
    let returnsSortDirection = 'asc';

    // Column search filters
    let ordersColumnFilters = {};
    let returnsColumnFilters = {};

    // DOM Elements
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const uploadProgress = document.getElementById('upload-progress');
    const uploadResult = document.getElementById('upload-result');
    const uploadError = document.getElementById('upload-error');
    const ordersTableBody = document.getElementById('orders-table-body');

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadReports();
      loadSummary();
      loadPendingOrders();
      loadPendingReturns();
      setupEventListeners();
    });

    function setupEventListeners() {
      // File upload
      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('active');
      });
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('active');
      });
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('active');
        const file = e.dataTransfer.files[0];
        if (file) uploadFile(file);
      });
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) uploadFile(file);
      });

      // Refresh button
      document.getElementById('refresh-btn').addEventListener('click', () => {
        loadSummary();
        loadPendingOrders();
      });

      // Export button
      document.getElementById('export-btn').addEventListener('click', exportToCSV);

      // Invoice buttons
      document.getElementById('preview-invoices-btn').addEventListener('click', () => createInvoices(true));
      document.getElementById('create-invoices-btn').addEventListener('click', () => createInvoices(false));

      // Create orders button
      document.getElementById('create-orders-btn').addEventListener('click', () => createOdooOrders());

      // Check Odoo orders button - clears cache and fetches fresh data
      document.getElementById('check-odoo-btn').addEventListener('click', async () => {
        const btn = document.getElementById('check-odoo-btn');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span> Checking...';

        // Clear the cache to force fresh data
        odooOrders = {};

        // Re-check all orders from Odoo (force refresh to bypass cache)
        await checkOdooOrders(true);

        btn.disabled = false;
        btn.innerHTML = originalHtml;
      });

      // Select all checkbox (header checkbox - only affects current page)
      document.getElementById('select-all').addEventListener('change', (e) => {
        const filtered = getFilteredOrders();
        const start = (currentPage - 1) * pageSize;
        const pageOrders = filtered.slice(start, start + pageSize);

        pageOrders.forEach(order => {
          if (e.target.checked) {
            selectedOrderIds.add(order._id);
          } else {
            selectedOrderIds.delete(order._id);
            allFilteredSelected = false;
          }
        });
        document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = e.target.checked);
        updateSelectionInfo();
      });

      // Select All button (selects all filtered orders across all pages)
      document.getElementById('select-all-btn').addEventListener('click', () => {
        const filtered = getFilteredOrders();
        if (allFilteredSelected) {
          // Deselect all
          selectedOrderIds.clear();
          allFilteredSelected = false;
        } else {
          // Select all filtered
          filtered.forEach(order => selectedOrderIds.add(order._id));
          allFilteredSelected = true;
        }
        // Update checkboxes on current page
        document.querySelectorAll('.order-checkbox').forEach(cb => {
          cb.checked = selectedOrderIds.has(cb.dataset.id);
        });
        document.getElementById('select-all').checked = allFilteredSelected;
        updateSelectionInfo();
      });

      // Filters
      document.getElementById('filter-country').addEventListener('change', applyFilters);
      document.getElementById('filter-scheme').addEventListener('change', applyFilters);
      document.getElementById('filter-odoo-status').addEventListener('change', applyFilters);
      document.getElementById('filter-currency').addEventListener('change', applyFilters);
      document.getElementById('filter-returns-currency').addEventListener('change', applyReturnsFilters);

      // Pagination
      document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderOrders();
        }
      });
      document.getElementById('next-page').addEventListener('click', () => {
        const filtered = getFilteredOrders();
        const maxPage = Math.ceil(filtered.length / pageSize);
        if (currentPage < maxPage) {
          currentPage++;
          renderOrders();
        }
      });

      // Returns section event listeners
      document.getElementById('refresh-returns-btn')?.addEventListener('click', loadPendingReturns);
      document.getElementById('preview-credit-notes-btn')?.addEventListener('click', () => createCreditNotes(true));
      document.getElementById('create-credit-notes-btn')?.addEventListener('click', () => createCreditNotes(false));

      // Select all returns checkbox
      document.getElementById('select-all-returns')?.addEventListener('change', (e) => {
        pendingReturns.forEach(ret => {
          if (e.target.checked) {
            selectedReturnIds.add(ret._id);
          } else {
            selectedReturnIds.delete(ret._id);
          }
        });
        document.querySelectorAll('.return-checkbox').forEach(cb => cb.checked = e.target.checked);
        renderReturns();
      });

      // Returns pagination
      document.getElementById('returns-prev-page')?.addEventListener('click', () => {
        if (returnsPage > 1) {
          returnsPage--;
          renderReturns();
        }
      });
      document.getElementById('returns-next-page')?.addEventListener('click', () => {
        const maxPage = Math.ceil(getFilteredReturns().length / returnsPageSize);
        if (returnsPage < maxPage) {
          returnsPage++;
          renderReturns();
        }
      });

      // Page size selectors
      document.getElementById('orders-page-size')?.addEventListener('change', (e) => {
        pageSize = parseInt(e.target.value);
        currentPage = 1;
        renderOrders();
      });
      document.getElementById('returns-page-size')?.addEventListener('change', (e) => {
        returnsPageSize = parseInt(e.target.value);
        returnsPage = 1;
        renderReturns();
      });

      // Column search filters for orders
      document.querySelectorAll('.orders-col-filter').forEach(input => {
        input.addEventListener('input', (e) => {
          const column = e.target.dataset.column;
          const value = e.target.value.trim().toLowerCase();
          if (value) {
            ordersColumnFilters[column] = value;
          } else {
            delete ordersColumnFilters[column];
          }
          currentPage = 1;
          renderOrders();
        });
      });

      // Column search filters for returns
      document.querySelectorAll('.returns-col-filter').forEach(input => {
        input.addEventListener('input', (e) => {
          const column = e.target.dataset.column;
          const value = e.target.value.trim().toLowerCase();
          if (value) {
            returnsColumnFilters[column] = value;
          } else {
            delete returnsColumnFilters[column];
          }
          returnsPage = 1;
          renderReturns();
        });
      });
    }

    // Sorting functions
    function sortOrdersBy(column) {
      if (ordersSortColumn === column) {
        ordersSortDirection = ordersSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        ordersSortColumn = column;
        ordersSortDirection = 'asc';
      }
      updateSortIndicators('orders');
      renderOrders();
    }

    function sortReturnsBy(column) {
      if (returnsSortColumn === column) {
        returnsSortDirection = returnsSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        returnsSortColumn = column;
        returnsSortDirection = 'asc';
      }
      updateSortIndicators('returns');
      renderReturns();
    }

    function updateSortIndicators(tableType) {
      if (tableType === 'orders') {
        // Clear all order sort indicators
        ['orderId', 'orderDate', 'shipToCountry', 'scheme', 'items', 'totalExclusive', 'totalTax', 'totalInclusive', 'odooOrder'].forEach(col => {
          const el = document.getElementById(`sort-${col}`);
          if (el) el.textContent = '';
        });
        // Set active indicator
        if (ordersSortColumn) {
          const el = document.getElementById(`sort-${ordersSortColumn}`);
          if (el) el.textContent = ordersSortDirection === 'asc' ? '▲' : '▼';
        }
      } else {
        // Clear all return sort indicators
        ['orderId', 'returnDate', 'shipToCountry', 'items', 'totalExclusive', 'totalTax', 'scheme'].forEach(col => {
          const el = document.getElementById(`ret-sort-${col}`);
          if (el) el.textContent = '';
        });
        // Set active indicator
        if (returnsSortColumn) {
          const el = document.getElementById(`ret-sort-${returnsSortColumn}`);
          if (el) el.textContent = returnsSortDirection === 'asc' ? '▲' : '▼';
        }
      }
    }

    // Get filtered returns with column filters and sorting
    function getFilteredReturns() {
      const returnsCurrency = document.getElementById('filter-returns-currency').value;

      let filtered = [...pendingReturns];

      // Apply currency filter
      if (returnsCurrency) {
        filtered = filtered.filter(r => r.currency === returnsCurrency);
      }

      // Apply column filters
      Object.entries(returnsColumnFilters).forEach(([column, searchValue]) => {
        filtered = filtered.filter(ret => {
          let fieldValue = '';
          if (column === 'orderId') fieldValue = ret.orderId || '';
          else if (column === 'returnDate') fieldValue = formatDate(ret.returnDate || ret.shipmentDate) || '';
          else if (column === 'shipToCountry') fieldValue = ret.shipToCountry || '';
          else if (column === 'scheme') fieldValue = getSchemeLabel(ret) || '';
          return fieldValue.toLowerCase().includes(searchValue);
        });
      });

      // Apply sorting
      if (returnsSortColumn) {
        filtered.sort((a, b) => {
          let valA, valB;
          if (returnsSortColumn === 'orderId') {
            valA = a.orderId || '';
            valB = b.orderId || '';
          } else if (returnsSortColumn === 'returnDate') {
            valA = new Date(a.returnDate || a.shipmentDate || 0);
            valB = new Date(b.returnDate || b.shipmentDate || 0);
            return returnsSortDirection === 'asc' ? valA - valB : valB - valA;
          } else if (returnsSortColumn === 'shipToCountry') {
            valA = a.shipToCountry || '';
            valB = b.shipToCountry || '';
          } else if (returnsSortColumn === 'items') {
            valA = a.items?.length || 0;
            valB = b.items?.length || 0;
            return returnsSortDirection === 'asc' ? valA - valB : valB - valA;
          } else if (returnsSortColumn === 'totalExclusive') {
            valA = parseFloat(a.totalExclusive) || 0;
            valB = parseFloat(b.totalExclusive) || 0;
            return returnsSortDirection === 'asc' ? valA - valB : valB - valA;
          } else if (returnsSortColumn === 'totalTax') {
            valA = parseFloat(a.totalTax) || 0;
            valB = parseFloat(b.totalTax) || 0;
            return returnsSortDirection === 'asc' ? valA - valB : valB - valA;
          } else if (returnsSortColumn === 'scheme') {
            valA = getSchemeLabel(a) || '';
            valB = getSchemeLabel(b) || '';
          } else {
            return 0;
          }
          // String comparison
          if (typeof valA === 'string') {
            return returnsSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          }
          return 0;
        });
      }

      return filtered;
    }

    // Shared filter logic
    function getFilteredOrders() {
      const country = document.getElementById('filter-country').value;
      const scheme = document.getElementById('filter-scheme').value;
      const odooStatus = document.getElementById('filter-odoo-status').value;
      const currency = document.getElementById('filter-currency').value;

      let filtered = [...pendingOrders];

      // Apply dropdown filters
      if (country) filtered = filtered.filter(o => o.shipToCountry === country);
      if (currency) filtered = filtered.filter(o => o.currency === currency);
      if (scheme) {
        filtered = filtered.filter(o => {
          const isOSS = o.taxReportingScheme === 'VCS_EU_OSS';
          const isB2B = !!o.buyerTaxRegistration;
          const isExport = o.exportOutsideEu === 'true' || o.exportOutsideEu === true;
          const isDomestic = o.shipFromCountry && o.shipFromCountry === o.shipToCountry && !isOSS && !isB2B && !isExport;

          if (scheme === 'OSS') return isOSS;
          if (scheme === 'B2B') return isB2B;
          if (scheme === 'EXPORT') return isExport;
          if (scheme === 'DOMESTIC') return isDomestic;
          if (scheme.startsWith('DOMESTIC_')) {
            const domesticCountry = scheme.replace('DOMESTIC_', '');
            return isDomestic && o.shipFromCountry === domesticCountry;
          }
          return true;
        });
      }

      // Apply Odoo status filter
      if (odooStatus === 'has-order') {
        filtered = filtered.filter(o => odooOrders[o.orderId]);
      } else if (odooStatus === 'missing-order') {
        filtered = filtered.filter(o => !odooOrders[o.orderId]);
      }

      // Apply column search filters
      Object.entries(ordersColumnFilters).forEach(([column, searchValue]) => {
        filtered = filtered.filter(order => {
          let fieldValue = '';
          if (column === 'orderId') fieldValue = order.orderId || '';
          else if (column === 'orderDate') fieldValue = formatDate(order.orderDate) || '';
          else if (column === 'shipToCountry') fieldValue = order.shipToCountry || '';
          else if (column === 'scheme') fieldValue = getSchemeLabel(order) || '';
          else if (column === 'odooOrder') fieldValue = odooOrders[order.orderId]?.orderNumber || '';
          return fieldValue.toLowerCase().includes(searchValue);
        });
      });

      // Apply sorting
      if (ordersSortColumn) {
        filtered.sort((a, b) => {
          let valA, valB;
          if (ordersSortColumn === 'orderId') {
            valA = a.orderId || '';
            valB = b.orderId || '';
          } else if (ordersSortColumn === 'orderDate') {
            valA = new Date(a.orderDate || 0);
            valB = new Date(b.orderDate || 0);
            return ordersSortDirection === 'asc' ? valA - valB : valB - valA;
          } else if (ordersSortColumn === 'shipToCountry') {
            valA = a.shipToCountry || '';
            valB = b.shipToCountry || '';
          } else if (ordersSortColumn === 'scheme') {
            valA = getSchemeLabel(a) || '';
            valB = getSchemeLabel(b) || '';
          } else if (ordersSortColumn === 'items') {
            valA = a.items?.length || 0;
            valB = b.items?.length || 0;
            return ordersSortDirection === 'asc' ? valA - valB : valB - valA;
          } else if (ordersSortColumn === 'totalExclusive') {
            valA = parseFloat(a.totalExclusive) || 0;
            valB = parseFloat(b.totalExclusive) || 0;
            return ordersSortDirection === 'asc' ? valA - valB : valB - valA;
          } else if (ordersSortColumn === 'totalTax') {
            valA = parseFloat(a.totalTax) || 0;
            valB = parseFloat(b.totalTax) || 0;
            return ordersSortDirection === 'asc' ? valA - valB : valB - valA;
          } else if (ordersSortColumn === 'totalInclusive') {
            valA = parseFloat(a.totalInclusive) || 0;
            valB = parseFloat(b.totalInclusive) || 0;
            return ordersSortDirection === 'asc' ? valA - valB : valB - valA;
          } else if (ordersSortColumn === 'odooOrder') {
            valA = odooOrders[a.orderId]?.orderNumber || '';
            valB = odooOrders[b.orderId]?.orderNumber || '';
          } else {
            return 0;
          }
          // String comparison
          if (typeof valA === 'string') {
            return ordersSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          }
          return 0;
        });
      }

      return filtered;
    }

    async function uploadFile(file) {
      uploadProgress.classList.add('show');
      uploadResult.classList.remove('show');
      uploadError.classList.remove('show');

      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch('/api/amazon/vcs/upload', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        uploadProgress.classList.remove('show');

        if (response.ok && result.success) {
          uploadResult.classList.add('show');
          document.getElementById('result-summary').innerHTML = `
            <p>Imported <strong>${result.orderCount}</strong> orders</p>
          `;
          loadSummary();
          loadPendingOrders();
          loadReports();
        } else {
          uploadError.classList.add('show');
          document.getElementById('error-message').textContent = result.error || 'Unknown error';
        }
      } catch (error) {
        uploadProgress.classList.remove('show');
        uploadError.classList.add('show');
        document.getElementById('error-message').textContent = error.message;
      }
    }

    async function loadSummary() {
      try {
        const response = await fetch('/api/amazon/vcs/summary');
        const data = await response.json();

        let pending = 0, invoiced = 0, skipped = 0;
        data.byStatus?.forEach(s => {
          if (s._id === 'pending') pending = s.count;
          if (s._id === 'invoiced') invoiced = s.count;
          if (s._id === 'skipped') skipped = s.count;
        });

        document.getElementById('stat-pending').textContent = pending;
        document.getElementById('stat-invoiced').textContent = invoiced;
        document.getElementById('stat-skipped').textContent = skipped;
        document.getElementById('stat-total').textContent = pending + invoiced + skipped;
      } catch (error) {
        console.error('Error loading summary:', error);
      }
    }

    async function loadPendingOrders() {
      try {
        const url = selectedReportId
          ? `/api/amazon/vcs/orders/pending?reportId=${selectedReportId}`
          : '/api/amazon/vcs/orders/pending';
        const response = await fetch(url);
        const data = await response.json();
        pendingOrders = data.orders || [];
        renderOrders();

        // Check Odoo for existing orders (async, updates UI when done)
        if (pendingOrders.length > 0) {
          checkOdooOrders();
        }
      } catch (error) {
        console.error('Error loading orders:', error);
        ordersTableBody.innerHTML = `
          <tr>
            <td colspan="11" class="empty-state">
              <span class="material-symbols-outlined" style="color: #f87171;">error</span>
              <div class="empty-state-title" style="color: #f87171;">Error loading orders: ${error.message}</div>
            </td>
          </tr>
        `;
      }
    }

    async function checkOdooOrders(forceRefresh = false) {
      try {
        const orderIds = pendingOrders.map(o => o.orderId);
        const response = await fetch('/api/amazon/vcs/check-odoo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderIds, forceRefresh })
        });
        const data = await response.json();
        if (data.success && data.orders) {
          odooOrders = data.orders;
          renderOrders(); // Re-render with order data

          // Count matched orders
          const matchedCount = Object.keys(data.orders).length;
          const totalCount = pendingOrders.length;
          console.log(`Odoo check complete: ${matchedCount}/${totalCount} orders found in Odoo`);
        }
      } catch (error) {
        console.error('Error checking Odoo:', error);
      }
    }

    async function loadPendingReturns() {
      try {
        const url = selectedReportId
          ? `/api/amazon/vcs/returns/pending?reportId=${selectedReportId}`
          : '/api/amazon/vcs/returns/pending';
        const response = await fetch(url);
        const data = await response.json();
        pendingReturns = data.orders || [];

        // Show/hide returns section based on whether we have returns
        const returnsSection = document.getElementById('returns-section');
        if (pendingReturns.length > 0) {
          returnsSection.classList.remove('hidden');
          renderReturns();
        } else {
          returnsSection.classList.add('hidden');
        }
      } catch (error) {
        console.error('Error loading returns:', error);
      }
    }

    async function loadReports() {
      try {
        const response = await fetch('/api/amazon/vcs/reports');
        const data = await response.json();
        vcsReports = data.reports || [];
        renderReports();
      } catch (error) {
        console.error('Error loading reports:', error);
        document.getElementById('reports-list').innerHTML = '<div style="color: #f87171; font-size: 13px;">Error loading reports</div>';
      }
    }

    function renderReports() {
      const container = document.getElementById('reports-list');

      // Filter out reports with all zero counts (deleted uploads)
      const activeReports = vcsReports.filter(r =>
        (r.pendingOrders || 0) > 0 || (r.pendingReturns || 0) > 0 || (r.invoicedCount || 0) > 0
      );

      if (activeReports.length === 0) {
        container.innerHTML = '<div style="color: #71717a; font-size: 13px;">No reports uploaded yet. Upload a VCS Tax Report above to get started.</div>';
        return;
      }

      // Create "All Reports" option + individual report cards
      const allReportsHtml = `
        <div onclick="selectReport(null)" class="report-card ${selectedReportId === null ? 'selected' : ''}">
          <div class="report-card-content">
            <div class="report-info">
              <span class="material-symbols-outlined">select_all</span>
              <div>
                <div class="report-name">All Reports</div>
                <div class="report-date">View pending items from all uploaded reports</div>
              </div>
            </div>
            <div class="report-stats">
              <span class="stat-pending">${activeReports.reduce((sum, r) => sum + (r.pendingOrders || 0), 0)} pending orders</span>
              <span class="stat-returns">${activeReports.reduce((sum, r) => sum + (r.pendingReturns || 0), 0)} pending returns</span>
            </div>
          </div>
        </div>
      `;

      const reportsHtml = activeReports.map(report => {
        const isSelected = selectedReportId === report._id;
        const uploadDate = new Date(report.uploadedAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        const uploadTime = new Date(report.uploadedAt).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

        return `
          <div class="report-card ${isSelected ? 'selected' : ''}">
            <div class="report-card-content">
              <div onclick="selectReport('${report._id}')" class="report-info" style="cursor: pointer; flex: 1;">
                <span class="material-symbols-outlined">description</span>
                <div>
                  <div class="report-name">${report.filename || 'VCS Report'}</div>
                  <div class="report-date">Uploaded ${uploadDate} at ${uploadTime}</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 16px;">
                <div class="report-stats">
                  <span class="stat-pending">${report.pendingOrders || 0} pending</span>
                  <span class="stat-returns">${report.pendingReturns || 0} returns</span>
                  <span class="stat-invoiced">${report.invoicedCount || 0} invoiced</span>
                </div>
                <button onclick="event.stopPropagation(); downloadReportCsv('${report.uploadId || report._id}')" class="btn btn-secondary btn-sm">
                  <span class="material-symbols-outlined">download</span>CSV
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = allReportsHtml + reportsHtml;
    }

    function downloadReportCsv(uploadId) {
      window.location.href = `/api/amazon/vcs/uploads/${uploadId}/download`;
    }

    function selectReport(reportId) {
      selectedReportId = reportId;
      // Clear selections when switching reports
      selectedOrderIds.clear();
      selectedReturnIds.clear();
      allFilteredSelected = false;
      currentPage = 1;
      returnsPage = 1;
      // Re-render reports to show selection
      renderReports();
      // Reload orders and returns for the selected report
      loadPendingOrders();
      loadPendingReturns();
    }

    function renderReturns() {
      const tbody = document.getElementById('returns-table-body');
      const countDiv = document.getElementById('returns-count');
      const paginationInfo = document.getElementById('returns-pagination-info');
      const prevBtn = document.getElementById('returns-prev-page');
      const nextBtn = document.getElementById('returns-next-page');

      const filteredReturns = getFilteredReturns();

      if (filteredReturns.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="empty-state"><span class="material-symbols-outlined">inbox</span><div class="empty-state-title">No pending returns</div></td></tr>`;
        countDiv.textContent = pendingReturns.length > 0 ? `0 of ${pendingReturns.length} returns match filters` : '';
        paginationInfo.textContent = '';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }

      const formatCurrencyLocal = (val) => {
        const num = Math.abs(parseFloat(val) || 0);
        return num.toFixed(2);
      };

      const formatDateLocal = (dateStr) => {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-GB');
      };

      const getSchemeLabelLocal = (order) => {
        if (order.taxReportingScheme === 'VCS_EU_OSS') return 'OSS';
        if (order.taxReportingScheme === 'DEEMED_RESELLER') return 'Deemed';
        if (order.buyerTaxRegistration) return 'B2B';
        if (order.exportOutsideEu) return 'Export';
        return 'Standard';
      };

      // Pagination logic
      const totalReturns = filteredReturns.length;
      const totalPages = Math.ceil(totalReturns / returnsPageSize);
      const startIndex = (returnsPage - 1) * returnsPageSize;
      const endIndex = Math.min(startIndex + returnsPageSize, totalReturns);
      const pageReturns = filteredReturns.slice(startIndex, endIndex);

      tbody.innerHTML = pageReturns.map(ret => `
        <tr>
          <td style="padding-left: 16px;">
            <input type="checkbox" class="return-checkbox checkbox" data-id="${ret._id}"
                   ${selectedReturnIds.has(ret._id) ? 'checked' : ''}
                   onchange="toggleReturn('${ret._id}', this.checked)">
          </td>
          <td class="order-id">${ret.orderId}</td>
          <td class="text-muted" style="font-size: 12px;">${formatDateLocal(ret.returnDate || ret.shipmentDate)}</td>
          <td><span class="badge badge-country">${getFlagImg(ret.shipToCountry)}</span></td>
          <td class="text-muted">${ret.items?.length || 0}</td>
          <td class="text-right font-mono" style="color: #fb923c;">-${formatCurrencyLocal(ret.totalExclusive)}</td>
          <td class="text-right font-mono text-muted">-${formatCurrencyLocal(ret.totalTax)}</td>
          <td><span class="badge" style="background: rgba(251, 146, 60, 0.2); color: #fb923c;">${getSchemeLabelLocal(ret)}</span></td>
        </tr>
      `).join('');

      countDiv.textContent = `${totalReturns} pending return${totalReturns !== 1 ? 's' : ''} (${selectedReturnIds.size} selected)${pendingReturns.length !== totalReturns ? ` · filtered from ${pendingReturns.length}` : ''}`;
      paginationInfo.textContent = `Page ${returnsPage} of ${totalPages} (${startIndex + 1}-${endIndex} of ${totalReturns})`;
      prevBtn.disabled = returnsPage <= 1;
      nextBtn.disabled = returnsPage >= totalPages;
    }

    function toggleReturn(returnId, checked) {
      if (checked) {
        selectedReturnIds.add(returnId);
      } else {
        selectedReturnIds.delete(returnId);
      }
      document.getElementById('returns-count').textContent =
        `${pendingReturns.length} pending return${pendingReturns.length !== 1 ? 's' : ''} (${selectedReturnIds.size} selected)`;
    }

    async function createCreditNotes(dryRun = true) {
      const orderIds = Array.from(selectedReturnIds);
      if (orderIds.length === 0) {
        alert('Please select at least one return order');
        return;
      }

      const btn = dryRun ? document.getElementById('preview-credit-notes-btn') : document.getElementById('create-credit-notes-btn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = `<span class="material-symbols-outlined animate-spin">progress_activity</span> ${dryRun ? 'Previewing...' : 'Creating...'}`;

      try {
        const response = await fetch('/api/amazon/vcs/create-credit-notes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderIds, dryRun })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Show result modal (same style as invoices)
          showCreditNoteResult(result, dryRun);

          // Refresh if real creation
          if (!dryRun) {
            selectedReturnIds.clear();
            loadPendingReturns();
            loadUploadHistory();
          }
        } else {
          alert(`Error: ${result.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error creating credit notes:', error);
        alert('Error creating credit notes: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function showCreditNoteResult(result, dryRun) {
      const wouldCreateCount = dryRun ? (result.creditNotes?.length || result.created || 0) : (result.created || 0);

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h3 class="modal-title">${dryRun ? 'Credit Note Preview' : 'Credit Notes Created'}</h3>
              ${dryRun ? `<span class="modal-subtitle">Click "Create Credit Notes Now" to create them in Odoo</span>` : ''}
            </div>
            <button onclick="this.closest('.modal').remove()" class="modal-close">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- Summary Chips -->
            <div class="summary-chips">
              <div class="summary-chip">
                <span class="value">${result.processed || 0}</span>
                <span class="label">Processed</span>
              </div>
              <div class="summary-chip orange">
                <span class="value">${wouldCreateCount}</span>
                <span class="label">${dryRun ? 'Would Create' : 'Created'}</span>
              </div>
              <div class="summary-chip">
                <span class="value" style="color: #71717a;">${result.skipped || 0}</span>
                <span class="label">Skipped</span>
              </div>
              <div class="summary-chip error">
                <span class="value">${result.errors?.length || 0}</span>
                <span class="label">Errors</span>
              </div>
            </div>

            <!-- Credit Notes list with details -->
            ${result.creditNotes && result.creditNotes.length > 0 ? `
              <div>
                ${result.creditNotes.slice(0, 30).map(cn => {
                  const data = cn.wouldCreate || cn;
                  const preview = cn.preview || {};
                  const lines = data.invoice_line_ids || [];
                  return `
                    <div class="invoice-card credit-note">
                      <div class="invoice-header">
                        <div>
                          <span class="invoice-order-id">${cn.orderId}</span>
                          ${cn.originalInvoice ? `<span class="invoice-ref">reverses ${cn.originalInvoice}</span>` : ''}
                        </div>
                        ${!dryRun && cn.name ? `<span class="invoice-badge">${cn.name}</span>` : ''}
                      </div>
                      ${dryRun && preview ? `
                        <!-- Credit note metadata - compact 4 column layout -->
                        <div class="invoice-meta">
                          <div class="invoice-meta-item">
                            <span class="label">Journal:</span>
                            <span class="value">${preview.journalName || '-'}</span>
                          </div>
                          <div class="invoice-meta-item">
                            <span class="label">Fiscal:</span>
                            <span class="value">${preview.fiscalPositionName || '-'}</span>
                          </div>
                          <div class="invoice-meta-item">
                            <span class="label">Route:</span>
                            <span class="value">${preview.shipFrom || '-'} → ${preview.shipTo || '-'}</span>
                          </div>
                          <div class="invoice-meta-item">
                            <span class="label">Scheme:</span>
                            <span class="value">${preview.taxScheme || '-'}</span>
                          </div>
                        </div>
                        <!-- Totals - inline -->
                        <div class="invoice-totals">
                          <div>
                            <span class="label">Net:</span><span class="amount net">-${Math.abs(preview.totalExclVat || 0).toFixed(2)} ${preview.currency || 'EUR'}</span>
                            <span class="label" style="margin-left: 12px;">VAT:</span><span class="amount vat">-${Math.abs(preview.vatAmount || 0).toFixed(2)} ${preview.currency || 'EUR'}</span>
                          </div>
                          <div>
                            <span class="label">Total:</span><span class="amount total">-${Math.abs(preview.totalInclVat || 0).toFixed(2)} ${preview.currency || 'EUR'}</span>
                          </div>
                        </div>
                      ` : ''}
                      ${dryRun && lines.length > 0 ? `
                        <div class="invoice-lines">
                          <table>
                            <thead>
                              <tr>
                                <th>Product</th>
                                <th class="text-right">Qty</th>
                                <th class="text-right">Price</th>
                              </tr>
                            </thead>
                            <tbody>
                              ${lines.map(line => {
                                const lineData = line[2] || {};
                                return `
                                  <tr>
                                    <td>${lineData.name || 'Product'}</td>
                                    <td class="text-right">${lineData.quantity || 1}</td>
                                    <td class="text-right" style="color: #fb923c;">-${Math.abs(lineData.price_unit || 0).toFixed(2)} €</td>
                                  </tr>
                                `;
                              }).join('')}
                            </tbody>
                          </table>
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
                ${result.creditNotes.length > 30 ? `<div style="text-align: center; color: #52525b; font-size: 12px; padding: 8px;">... and ${result.creditNotes.length - 30} more</div>` : ''}
              </div>
            ` : ''}

            <!-- Errors -->
            ${result.errors && result.errors.length > 0 ? `
              <div class="errors-section">
                <h4 class="errors-title">Errors:</h4>
                <div style="max-height: 128px; overflow-y: auto;">
                  ${result.errors.map(err => `
                    <div class="error-item">
                      <span class="order-id">${err.orderId}</span>
                      <span class="error-msg">${err.error}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
          <div class="modal-footer">
            <button onclick="this.closest('.modal').remove()" class="btn btn-secondary">Close</button>
            ${dryRun ? `
              <button onclick="this.closest('.modal').remove(); createCreditNotes(false);" class="btn btn-orange">
                Create Credit Notes Now
              </button>
            ` : ''}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    function renderOrders() {
      const filtered = getFilteredOrders();

      if (filtered.length === 0) {
        ordersTableBody.innerHTML = `
          <tr>
            <td colspan="11" class="empty-state">
              <span class="material-symbols-outlined">inbox</span>
              <div class="empty-state-title">No pending orders</div>
            </td>
          </tr>
        `;
        document.getElementById('pagination-info').textContent = 'No orders';
        updateSelectionInfo();
        return;
      }

      const start = (currentPage - 1) * pageSize;
      const pageOrders = filtered.slice(start, start + pageSize);

      ordersTableBody.innerHTML = pageOrders.map(order => {
        // First check cached odooOrderNumber from MongoDB, then fall back to odooOrders map
        const odooOrder = odooOrders[order.orderId];
        const displayOrderNumber = order.odooOrderNumber || (odooOrder && odooOrder.orderNumber);
        const odooOrderCell = displayOrderNumber
          ? `<span class="badge badge-odoo">${displayOrderNumber}</span>`
          : `<span class="badge badge-warning"><span class="material-symbols-outlined">warning</span> Missing</span>`;
        const isChecked = selectedOrderIds.has(order._id) ? 'checked' : '';

        return `
          <tr>
            <td style="padding-left: 16px;">
              <input type="checkbox" class="order-checkbox checkbox" data-id="${order._id}" ${isChecked}>
            </td>
            <td class="order-id">${order.orderId}</td>
            <td>${formatDate(order.orderDate)}</td>
            <td><span class="badge badge-country">${getFlagImg(order.shipToCountry)}</span></td>
            <td><span class="badge ${getSchemeClass(order)}">${getSchemeLabel(order)}</span></td>
            <td>${order.items?.length || 0}</td>
            <td class="text-right font-mono">${formatCurrency(order.totalExclusive, order.currency)}</td>
            <td class="text-right font-mono">${formatCurrency(order.totalTax, order.currency)}</td>
            <td class="text-right font-mono" style="font-weight: 600;">${formatCurrency(order.totalInclusive, order.currency)}</td>
            <td>${odooOrderCell}</td>
            <td class="text-center">${order.invoiceUrl ? `<a href="${order.invoiceUrl}" target="_blank" class="link">View</a>` : '-'}</td>
          </tr>
        `;
      }).join('');

      // Add event listeners to individual checkboxes
      document.querySelectorAll('.order-checkbox').forEach(cb => {
        cb.addEventListener('change', (e) => {
          if (e.target.checked) {
            selectedOrderIds.add(e.target.dataset.id);
          } else {
            selectedOrderIds.delete(e.target.dataset.id);
            allFilteredSelected = false;
          }
          updateSelectionInfo();
        });
      });

      // Update header checkbox state
      const allPageChecked = pageOrders.every(o => selectedOrderIds.has(o._id));
      document.getElementById('select-all').checked = allPageChecked;

      document.getElementById('pagination-info').textContent = `Showing ${start + 1}-${Math.min(start + pageSize, filtered.length)} of ${filtered.length} orders`;
      document.getElementById('prev-page').disabled = currentPage === 1;
      document.getElementById('next-page').disabled = start + pageSize >= filtered.length;
      updateSelectionInfo();
    }

    function updateSelectionInfo() {
      const filtered = getFilteredOrders();
      const selectionCount = selectedOrderIds.size;
      const totalFiltered = filtered.length;

      document.getElementById('selection-count').textContent = selectionCount;
      document.getElementById('total-filtered').textContent = totalFiltered;

      const selectAllBtn = document.getElementById('select-all-btn');
      if (allFilteredSelected || selectionCount === totalFiltered) {
        selectAllBtn.textContent = 'Deselect All';
      } else {
        selectAllBtn.textContent = 'Select All';
      }
    }

    function applyFilters() {
      currentPage = 1;
      // Reset selection when filters change
      selectedOrderIds.clear();
      allFilteredSelected = false;
      renderOrders();
    }

    function applyReturnsFilters() {
      returnsPage = 1;
      // Reset selection when filters change
      selectedReturnIds.clear();
      renderReturns();
    }

    async function loadUploadHistory() {
      try {
        const response = await fetch('/api/amazon/vcs/uploads');
        const data = await response.json();

        const uploadsList = document.getElementById('uploads-list');
        if (!uploadsList) return;

        if (!data.uploads || data.uploads.length === 0) {
          uploadsList.innerHTML = '<div style="color: #52525b; font-size: 13px;">No files uploaded yet</div>';
          return;
        }

        uploadsList.innerHTML = data.uploads.map(upload => `
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: #252532; border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span class="material-symbols-outlined" style="color: #4ade80;">description</span>
              <div>
                <div style="color: #e4e4e7; font-size: 13px; font-weight: 500;">${upload.originalFilename || 'VCS Report'}</div>
                <div style="color: #52525b; font-size: 12px;">
                  ${formatDate(upload.uploadedAt)} · ${formatFileSize(upload.fileSize)}
                </div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
              <!-- Stats -->
              <div style="text-align: right;">
                <div style="color: #e4e4e7; font-size: 13px;">${upload.transactionCount || 0} lines → ${(upload.pendingOrders || 0) + (upload.invoicedOrders || 0)} shipments${(upload.pendingReturns || 0) + (upload.creditedReturns || 0) > 0 ? ` + ${(upload.pendingReturns || 0) + (upload.creditedReturns || 0)} returns` : ''}</div>
                <div style="font-size: 12px;">
                  <span style="color: #fbbf24;">${upload.pendingOrders || 0} pending</span>
                  <span style="color: #52525b; margin: 0 4px;">·</span>
                  <span style="color: #4ade80;">${upload.invoicedOrders || 0} invoiced</span>
                  ${(upload.pendingReturns || 0) > 0 || (upload.creditedReturns || 0) > 0 ? `<span style="color: #52525b; margin: 0 4px;">·</span><span style="color: #fb923c;">${upload.pendingReturns || 0} ret. pending</span><span style="color: #52525b; margin: 0 4px;">·</span><span style="color: #fdba74;">${upload.creditedReturns || 0} credited</span>` : ''}
                </div>
              </div>
              <!-- Download button -->
              <a href="/api/amazon/vcs/uploads/${upload._id}/download"
                 class="btn btn-secondary btn-sm"
                 data-tooltip="Download original file">
                <span class="material-symbols-outlined">download</span>CSV
              </a>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading upload history:', error);
        const uploadsList = document.getElementById('uploads-list');
        if (uploadsList) {
          uploadsList.innerHTML = '<div style="color: #f87171; font-size: 13px;">Error loading history</div>';
        }
      }
    }

    function formatFileSize(bytes) {
      if (!bytes) return '0 B';
      const units = ['B', 'KB', 'MB', 'GB'];
      let i = 0;
      while (bytes >= 1024 && i < units.length - 1) {
        bytes /= 1024;
        i++;
      }
      return bytes.toFixed(1) + ' ' + units[i];
    }

    function exportToCSV() {
      if (pendingOrders.length === 0) {
        alert('No orders to export');
        return;
      }

      const headers = ['Order ID', 'Date', 'Country', 'Scheme', 'SKUs', 'Net', 'VAT', 'Total', 'Currency'];
      const rows = pendingOrders.map(o => [
        o.orderId,
        formatDate(o.orderDate),
        o.shipToCountry,
        getSchemeLabel(o),
        o.items?.map(i => i.sku).join('; '),
        o.totalExclusive?.toFixed(2),
        o.totalTax?.toFixed(2),
        o.totalInclusive?.toFixed(2),
        o.currency
      ]);

      const csv = [headers, ...rows].map(row => row.map(cell => `"${cell || ''}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `vcs-pending-orders-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    async function createInvoices(dryRun = true) {
      const btn = dryRun ? document.getElementById('preview-invoices-btn') : document.getElementById('create-invoices-btn');
      const originalText = btn.innerHTML;

      // Get selected order IDs from the Set (works across all pages)
      const selectedIds = Array.from(selectedOrderIds);

      if (selectedIds.length === 0) {
        alert('Please select at least one order to process.');
        return;
      }

      // Confirmation for actual creation
      if (!dryRun) {
        if (!confirm(`Are you sure you want to create invoices in Odoo for ${selectedIds.length} selected order(s)?\n\nThis action cannot be undone.`)) {
          return;
        }
      }

      // Show progress modal
      const progressModal = showProgressModal(selectedIds.length, dryRun);
      btn.disabled = true;

      try {
        // Use fetch with streaming for real-time progress (POST to handle large payloads)
        const response = await fetch('/api/amazon/vcs/create-invoices-stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderIds: selectedIds, dryRun })
        });

        if (!response.ok) {
          throw new Error(`HTTP error: ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let finalResult = null;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });

          // Parse SSE events from buffer
          const lines = buffer.split('\n');
          buffer = lines.pop() || ''; // Keep incomplete line in buffer

          let eventType = null;
          for (const line of lines) {
            if (line.startsWith('event: ')) {
              eventType = line.slice(7).trim();
            } else if (line.startsWith('data: ') && eventType) {
              try {
                const data = JSON.parse(line.slice(6));

                if (eventType === 'start') {
                  updateProgress(progressModal, { phase: 'start', total: data.total });
                } else if (eventType === 'progress') {
                  updateProgress(progressModal, data);
                } else if (eventType === 'complete') {
                  finalResult = data;
                  closeProgressModal(progressModal);
                  showInvoiceResult(data, dryRun);

                  // Refresh if real creation
                  if (!dryRun) {
                    selectedOrderIds.clear();
                    allFilteredSelected = false;
                    loadSummary();
                    loadPendingOrders();
                  }
                } else if (eventType === 'error') {
                  alert(`Error: ${data.message}`);
                  closeProgressModal(progressModal);
                }
              } catch (parseErr) {
                console.error('Failed to parse SSE data:', parseErr);
              }
              eventType = null;
            }
          }
        }

        if (!finalResult) {
          closeProgressModal(progressModal);
          alert('Connection closed unexpectedly. Please check results and try again if needed.');
        }

      } catch (error) {
        closeProgressModal(progressModal);
        alert(`Error: ${error.message}`);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function showProgressModal(total, dryRun) {
      const modal = document.createElement('div');
      modal.id = 'progress-modal';
      modal.className = 'progress-modal';
      modal.innerHTML = `
        <div class="progress-modal-content">
          <h3 class="progress-modal-title">${dryRun ? 'Generating Preview' : 'Creating Invoices'}</h3>
          <div class="progress-modal-bar">
            <div id="progress-bar-fill" class="progress-modal-fill"></div>
          </div>
          <div id="progress-text" class="progress-modal-text">Connecting...</div>
          <div class="progress-modal-stats">
            <span class="stat created">Created: <span id="stat-created">0</span></span>
            <span class="stat skipped">Skipped: <span id="stat-skipped">0</span></span>
            <span class="stat errors">Errors: <span id="stat-errors">0</span></span>
          </div>
          <div id="progress-order" class="progress-modal-order"></div>
        </div>
      `;
      document.body.appendChild(modal);
      return modal;
    }

    function updateProgress(modal, data) {
      const progressBar = modal.querySelector('#progress-bar-fill');
      const progressText = modal.querySelector('#progress-text');
      const progressOrder = modal.querySelector('#progress-order');
      const statCreated = modal.querySelector('#stat-created');
      const statSkipped = modal.querySelector('#stat-skipped');
      const statErrors = modal.querySelector('#stat-errors');

      if (data.phase === 'init') {
        progressText.textContent = data.message;
      } else if (data.phase === 'prefetch') {
        progressText.textContent = data.message;
      } else if (data.phase === 'processing') {
        const percent = Math.round((data.current / data.total) * 100);
        progressBar.style.width = `${percent}%`;
        progressText.textContent = `Processing ${data.current} of ${data.total}`;
        if (data.orderId) {
          progressOrder.textContent = data.orderId;
        }
        if (statCreated) statCreated.textContent = data.created || 0;
        if (statSkipped) statSkipped.textContent = data.skipped || 0;
        if (statErrors) statErrors.textContent = data.errors || 0;
      }
    }

    function closeProgressModal(modal) {
      if (modal && modal.parentNode) {
        modal.parentNode.removeChild(modal);
      }
    }

    function showInvoiceResult(result, dryRun) {
      // For dry run, count invoices array; for real, use created count
      const wouldCreateCount = dryRun ? (result.invoices?.length || 0) : (result.created || 0);

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h3 class="modal-title">${dryRun ? 'Invoice Preview' : 'Invoices Created'}</h3>
              ${dryRun ? `<span class="modal-subtitle">Click "Create Invoices Now" to create them in Odoo</span>` : ''}
            </div>
            <button onclick="this.closest('.modal').remove()" class="modal-close">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- Summary Chips -->
            <div class="summary-chips">
              <div class="summary-chip">
                <span class="value">${result.processed || 0}</span>
                <span class="label">Processed</span>
              </div>
              <div class="summary-chip success">
                <span class="value">${wouldCreateCount}</span>
                <span class="label">${dryRun ? 'Would Create' : 'Created'}</span>
              </div>
              <div class="summary-chip">
                <span class="value" style="color: #71717a;">${result.skipped || 0}</span>
                <span class="label">Skipped</span>
              </div>
              <div class="summary-chip error">
                <span class="value">${result.errors?.length || 0}</span>
                <span class="label">Errors</span>
              </div>
            </div>

            <!-- Invoices list with details -->
            ${result.invoices && result.invoices.length > 0 ? `
              <div style="max-height: 400px; overflow-y: auto;">
                ${result.invoices.map(inv => {
                  const data = inv.wouldCreate || inv;
                  const preview = inv.preview || {};
                  const lines = data.invoice_line_ids || [];
                  return `
                    <div class="invoice-card">
                      <div class="invoice-header">
                        <div>
                          <span class="invoice-order-id">${inv.orderId}</span>
                          ${inv.odooOrderName || inv.saleOrderName ? `<span class="invoice-ref">→ ${inv.odooOrderName || inv.saleOrderName}</span>` : ''}
                        </div>
                        ${!dryRun && inv.name ? `<span class="invoice-badge">${inv.name}</span>` : ''}
                      </div>
                      ${dryRun && preview ? `
                        <!-- Invoice metadata - compact 4 column layout -->
                        <div class="invoice-meta">
                          <div class="invoice-meta-item">
                            <span class="label">Journal:</span>
                            <span class="value">${preview.journalName || '-'}</span>
                          </div>
                          <div class="invoice-meta-item">
                            <span class="label">Fiscal:</span>
                            <span class="value">${preview.fiscalPositionName || '-'}</span>
                          </div>
                          <div class="invoice-meta-item">
                            <span class="label">Route:</span>
                            <span class="value">${preview.shipFrom || '-'} → ${preview.shipTo || '-'}</span>
                          </div>
                          <div class="invoice-meta-item">
                            <span class="label">Scheme:</span>
                            <span class="value">${preview.taxScheme || '-'}</span>
                          </div>
                        </div>
                        <!-- Totals - inline -->
                        <div class="invoice-totals">
                          <div>
                            <span class="label">Net:</span><span class="amount net">${(preview.totalExclVat || 0).toFixed(2)} ${preview.currency || 'EUR'}</span>
                            <span class="label" style="margin-left: 12px;">VAT:</span><span class="amount vat">${(preview.vatAmount || 0).toFixed(2)} ${preview.currency || 'EUR'}</span>
                          </div>
                          <div>
                            <span class="label">Total:</span><span class="amount total">${(preview.totalInclVat || 0).toFixed(2)} ${preview.currency || 'EUR'}</span>
                          </div>
                        </div>
                      ` : ''}
                      ${dryRun && lines.length > 0 ? `
                        <div class="invoice-lines">
                          <table>
                            <thead>
                              <tr>
                                <th>Product</th>
                                <th class="text-right">Qty</th>
                                <th class="text-right">Price</th>
                              </tr>
                            </thead>
                            <tbody>
                              ${lines.map(line => {
                                const lineData = line[2] || {};
                                return `
                                  <tr>
                                    <td>${lineData.name || 'Product'}</td>
                                    <td class="text-right">${lineData.quantity || 1}</td>
                                    <td class="text-right">${(lineData.price_unit || 0).toFixed(2)} €</td>
                                  </tr>
                                `;
                              }).join('')}
                            </tbody>
                          </table>
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            ` : ''}

            <!-- Skipped Orders with reasons -->
            ${result.skippedOrders && result.skippedOrders.length > 0 ? `
              <div class="errors-section" style="margin-top: 16px;">
                <h4 class="errors-title" style="color: #a1a1aa;">Skipped Orders (${result.skippedOrders.length}):</h4>
                <div style="max-height: 200px; overflow-y: auto;">
                  ${result.skippedOrders.map(skip => `
                    <div class="error-item" style="background: #27272a;">
                      <span class="order-id">${skip.orderId}</span>
                      ${skip.customerName ? `<span style="color: #a1a1aa; font-size: 11px;">${skip.customerName}</span>` : ''}
                      <span style="color: #71717a; font-size: 12px;">${skip.reason}</span>
                      ${skip.odooOrderName ? `<span class="invoice-badge" style="font-size: 10px;">${skip.odooOrderName}</span>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            <!-- Errors -->
            ${result.errors && result.errors.length > 0 ? `
              <div class="errors-section">
                <h4 class="errors-title">Errors:</h4>
                <div style="max-height: 128px; overflow-y: auto;">
                  ${result.errors.map(err => `
                    <div class="error-item">
                      <span class="order-id">${err.orderId}</span>
                      <span class="error-msg">${err.error}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
          <div class="modal-footer">
            <button onclick="this.closest('.modal').remove()" class="btn btn-secondary">Close</button>
            ${dryRun ? `
              <button onclick="this.closest('.modal').remove(); createInvoices(false);" class="btn btn-success">
                Create Invoices Now
              </button>
            ` : ''}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    // Helpers
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function formatCurrency(amount, currency = 'EUR') {
      if (amount === undefined || amount === null) return '-';
      return new Intl.NumberFormat('de-DE', { style: 'currency', currency: currency || 'EUR' }).format(amount);
    }

    function getSchemeLabel(order) {
      if (order.taxReportingScheme === 'VCS_EU_OSS') return 'OSS';
      if (order.taxReportingScheme === 'DEEMED_RESELLER') return 'Deemed';
      if (order.taxReportingScheme === 'CH_VOEC') return 'CH VOEC';
      if (order.buyerTaxRegistration) return 'B2B';
      if (order.exportOutsideEu === 'true' || order.exportOutsideEu === true) return 'Export';
      // Domestic = shipFrom === shipTo (same country, B2C)
      if (order.shipFromCountry && order.shipFromCountry === order.shipToCountry) {
        return `Domestic ${order.shipFromCountry}`;
      }
      // Cross-border without OSS scheme (FBM shipments)
      if (order.shipFromCountry && order.shipToCountry && order.shipFromCountry !== order.shipToCountry) {
        return `${order.shipFromCountry} → ${order.shipToCountry}`;
      }
      return 'Standard';
    }

    function getSchemeClass(order) {
      if (order.taxReportingScheme === 'VCS_EU_OSS') return 'badge-scheme-oss';
      if (order.taxReportingScheme === 'DEEMED_RESELLER') return 'badge-scheme-deemed';
      if (order.taxReportingScheme === 'CH_VOEC') return 'badge-scheme-ch';
      if (order.buyerTaxRegistration) return 'badge-scheme-b2b';
      if (order.exportOutsideEu === 'true' || order.exportOutsideEu === true) return 'badge-scheme-export';
      // Domestic - green
      if (order.shipFromCountry && order.shipFromCountry === order.shipToCountry) {
        return 'badge-scheme-domestic';
      }
      // Cross-border - cyan
      if (order.shipFromCountry && order.shipToCountry && order.shipFromCountry !== order.shipToCountry) {
        return 'badge-scheme-cross';
      }
      return 'badge-scheme-default';
    }

    // Create Odoo orders from VCS data
    async function createOdooOrders(dryRun = true) {
      const btn = document.getElementById('create-orders-btn');
      const originalText = btn.innerHTML;

      // Get selected order IDs
      const selectedIds = Array.from(selectedOrderIds);

      // Filter to only orders that are missing from Odoo
      const missingOrderIds = selectedIds.filter(id => {
        const order = pendingOrders.find(o => o._id === id);
        return order && !odooOrders[order.orderId];
      });

      if (missingOrderIds.length === 0) {
        // Check if user selected orders that already have Odoo orders
        if (selectedIds.length > 0) {
          alert('All selected orders already have Odoo orders. Please select orders that are missing from Odoo (marked with warning icon).');
        } else {
          alert('Please select at least one order that is missing from Odoo.');
        }
        return;
      }

      // First do a dry run to preview
      btn.disabled = true;
      btn.innerHTML = `<span class="material-symbols-outlined animate-spin">progress_activity</span> ${dryRun ? 'Previewing...' : 'Creating...'}`;

      try {
        const response = await fetch('/api/amazon/vcs/create-orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderIds: missingOrderIds, dryRun })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to create orders');
        }

        // Show results modal
        showCreateOrdersResult(result, dryRun);

        // If not dry run and successful, refresh the data
        if (!dryRun && result.created > 0) {
          selectedOrderIds.clear();
          allFilteredSelected = false;
          loadPendingOrders();
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function showCreateOrdersResult(result, dryRun) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h3 class="modal-title">${dryRun ? 'Order Creation Preview' : 'Orders Created in Odoo'}</h3>
              ${dryRun ? `<span class="modal-subtitle">Click "Create Orders Now" to create them in Odoo</span>` : ''}
            </div>
            <button onclick="this.closest('.modal').remove()" class="modal-close">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- Summary -->
            <div class="summary-chips">
              <div class="summary-chip">
                <span class="value">${result.processed || 0}</span>
                <span class="label">Processed</span>
              </div>
              <div class="summary-chip success">
                <span class="value">${result.created || 0}</span>
                <span class="label">${dryRun ? 'Would Create' : 'Created'}</span>
              </div>
              <div class="summary-chip">
                <span class="value" style="color: #71717a;">${result.skipped || 0}</span>
                <span class="label">Skipped</span>
              </div>
              <div class="summary-chip error">
                <span class="value">${result.errors?.length || 0}</span>
                <span class="label">Errors</span>
              </div>
            </div>

            <!-- Orders list -->
            ${result.orders && result.orders.length > 0 ? `
              <div>
                ${result.orders.slice(0, 30).map(ord => `
                  <div class="invoice-card">
                    <div class="invoice-header">
                      <div>
                        <span class="invoice-order-id">${ord.amazonOrderId || ord.orderId}</span>
                        ${ord.customerName ? `<span class="invoice-ref">→ ${ord.customerName}</span>` : ''}
                      </div>
                      ${ord.odooOrderNumber ? `
                        <span class="invoice-badge">${ord.odooOrderNumber}</span>
                      ` : ord.status === 'would_create' ? `
                        <span class="badge badge-warning">Would create</span>
                      ` : ''}
                    </div>
                    ${ord.lines && ord.lines.length > 0 ? `
                      <div style="margin-top: 8px; font-size: 12px; color: #71717a;">
                        ${ord.lines.map(l => `<span style="margin-right: 8px;">${l.sku || l.productName}: ${l.quantity}x</span>`).join('')}
                      </div>
                    ` : ''}
                    ${ord.error ? `
                      <div style="margin-top: 8px; font-size: 12px; color: #f87171;">${ord.error}</div>
                    ` : ''}
                  </div>
                `).join('')}
                ${result.orders.length > 30 ? `<div style="text-align: center; color: #52525b; font-size: 12px; padding: 8px;">... and ${result.orders.length - 30} more</div>` : ''}
              </div>
            ` : ''}

            <!-- Errors -->
            ${result.errors && result.errors.length > 0 ? `
              <div class="errors-section">
                <h4 class="errors-title">Errors:</h4>
                <div style="max-height: 128px; overflow-y: auto;">
                  ${result.errors.map(err => `
                    <div class="error-item">
                      <span class="order-id">${err.orderId || err.amazonOrderId}</span>
                      <span class="error-msg">${err.error}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
          <div class="modal-footer">
            <button onclick="this.closest('.modal').remove()" class="btn btn-secondary">Close</button>
            ${dryRun ? `
              <button onclick="this.closest('.modal').remove(); createOdooOrders(false);" class="btn btn-amber">
                Create Orders Now
              </button>
            ` : ''}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }
  </script>
</body>
</html>
