<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reviews - Amazon Seller</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <script src="/shell-v2.js"></script>
  <style>
    .page { max-width: 1600px; margin: 0 auto; padding: 20px; }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
    .page-title { font-size: 24px; font-weight: 700; color: #fff; margin: 0; }
    .page-logo-container { background: #fff; border-radius: 10px; padding: 8px 14px; display: flex; align-items: center; justify-content: center; }
    .page-logo { height: 28px; width: auto; }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-primary { background: #f59e0b; color: white; }
    .btn-primary:hover { background: #d97706; }
    .btn-secondary { background: #252532; color: #e4e4e7; border: 1px solid #3f3f50; }
    .btn-secondary:hover { background: #2a2a3a; }
    .btn .material-symbols-outlined { font-size: 18px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn.loading .material-symbols-outlined { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 16px; }
    @media (max-width: 1200px) { .stats-row { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
    .stat-card { background: #18181f; border: 1px solid #252532; border-radius: 10px; padding: 14px 18px; cursor: pointer; transition: border-color 0.15s; }
    .stat-card:hover { border-color: #f59e0b; }
    .stat-value { font-size: 28px; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 6px; }
    .stat-label { font-size: 11px; color: #71717a; text-transform: uppercase; letter-spacing: 0.02em; margin-top: 4px; }
    .stat-card.success .stat-value { color: #4ade80; }
    .stat-card.warning .stat-value { color: #fbbf24; }
    .stat-card.danger .stat-value { color: #f87171; }
    .stat-card.info .stat-value { color: #60a5fa; }

    .rating-distribution { display: flex; gap: 10px; margin-bottom: 16px; }
    .rating-bar { flex: 1; background: #18181f; border: 1px solid #252532; border-radius: 10px; padding: 12px; cursor: pointer; transition: border-color 0.15s; }
    .rating-bar:hover { border-color: #f59e0b; }
    .rating-bar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .rating-stars { display: flex; align-items: center; gap: 2px; color: #fbbf24; }
    .rating-stars .material-symbols-outlined { font-size: 16px; font-variation-settings: 'FILL' 1; }
    .rating-count { font-size: 14px; font-weight: 600; color: #e4e4e7; }
    .rating-progress { height: 6px; background: #252532; border-radius: 3px; overflow: hidden; }
    .rating-progress-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
    .rating-progress-fill.star-5 { background: #22c55e; }
    .rating-progress-fill.star-4 { background: #84cc16; }
    .rating-progress-fill.star-3 { background: #fbbf24; }
    .rating-progress-fill.star-2 { background: #fb923c; }
    .rating-progress-fill.star-1 { background: #ef4444; }

    .marketplace-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-bottom: 16px; }
    .marketplace-stat { background: #18181f; border: 1px solid #252532; border-radius: 8px; padding: 12px; cursor: pointer; transition: border-color 0.15s; }
    .marketplace-stat:hover { border-color: #f59e0b; }
    .marketplace-stat-header { display: flex; justify-content: space-between; align-items: center; }
    .marketplace-flag { font-size: 20px; }
    .marketplace-rating { font-size: 14px; font-weight: 600; color: #fbbf24; display: flex; align-items: center; gap: 4px; }
    .marketplace-rating .material-symbols-outlined { font-size: 14px; font-variation-settings: 'FILL' 1; }
    .marketplace-count { font-size: 12px; color: #71717a; margin-top: 4px; }

    .card { background: #18181f; border: 1px solid #252532; border-radius: 12px; overflow: hidden; }
    .card-header { padding: 14px 18px; border-bottom: 1px solid #252532; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .card-title { font-size: 15px; font-weight: 600; color: #fff; margin: 0; }

    .filters-bar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .filter-select, .filter-input { padding: 6px 10px; background: #12121a; border: 1px solid #252532; border-radius: 6px; color: #e4e4e7; font-size: 12px; }
    .filter-select:focus, .filter-input:focus { outline: none; border-color: #f59e0b; }

    .reviews-list { padding: 0; }
    .review-item { padding: 16px 18px; border-bottom: 1px solid #252532; transition: background 0.15s; }
    .review-item:last-child { border-bottom: none; }
    .review-item:hover { background: rgba(245, 158, 11, 0.03); }
    .review-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; gap: 12px; flex-wrap: wrap; }
    .review-info { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .review-rating { display: flex; align-items: center; gap: 2px; }
    .review-rating .material-symbols-outlined { font-size: 18px; }
    .review-rating .material-symbols-outlined.filled { color: #fbbf24; font-variation-settings: 'FILL' 1; }
    .review-rating .material-symbols-outlined.empty { color: #3f3f50; }
    .review-order { font-size: 13px; color: #f59e0b; cursor: pointer; font-weight: 500; }
    .review-order:hover { text-decoration: underline; }
    .review-date { font-size: 12px; color: #71717a; }
    .review-marketplace { display: flex; align-items: center; gap: 4px; font-size: 12px; color: #a1a1aa; }
    .review-marketplace .flag { font-size: 14px; }
    .review-comments { font-size: 14px; color: #e4e4e7; line-height: 1.5; margin-top: 8px; padding: 12px; background: #12121a; border-radius: 8px; border-left: 3px solid #3f3f50; }
    .review-comments.positive { border-left-color: #22c55e; }
    .review-comments.neutral { border-left-color: #fbbf24; }
    .review-comments.negative { border-left-color: #ef4444; }
    .review-response { margin-top: 8px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 3px solid #818cf8; }
    .review-response-label { font-size: 11px; color: #818cf8; font-weight: 600; text-transform: uppercase; margin-bottom: 4px; }
    .review-response-text { font-size: 13px; color: #c4b5fd; line-height: 1.4; }

    .empty-state { padding: 60px 20px; text-align: center; }
    .empty-state .material-symbols-outlined { font-size: 48px; color: #3f3f50; margin-bottom: 16px; }
    .empty-state-title { font-size: 16px; font-weight: 600; color: #e4e4e7; margin-bottom: 8px; }
    .empty-state-text { font-size: 14px; color: #71717a; max-width: 400px; margin: 0 auto 16px; }

    .pagination { display: flex; justify-content: space-between; align-items: center; padding: 12px 18px; border-top: 1px solid #252532; }
    .pagination-info { font-size: 12px; color: #71717a; }
    .pagination-buttons { display: flex; gap: 6px; }

    .status-bar { background: #12121a; border: 1px solid #252532; border-radius: 8px; padding: 6px 12px; display: flex; align-items: center; gap: 12px; font-size: 12px; color: #a1a1aa; }

    .back-link { display: flex; align-items: center; gap: 6px; color: #a1a1aa; text-decoration: none; font-size: 13px; margin-bottom: 16px; }
    .back-link:hover { color: #f59e0b; }
    .back-link .material-symbols-outlined { font-size: 18px; }

    .toast { position: fixed; bottom: 20px; right: 20px; background: #252532; border: 1px solid #3f3f50; border-radius: 10px; padding: 16px 20px; color: #e4e4e7; font-size: 14px; z-index: 1000; display: none; }
    .toast.success { border-color: #22c55e; }
    .toast.error { border-color: #ef4444; }
    .toast.show { display: block; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>
  <div class="page">
    <a href="/seller/" class="back-link">
      <span class="material-symbols-outlined">arrow_back</span>
      Back to Orders
    </a>

    <header class="page-header">
      <div class="page-logo-container">
        <img src="/assets/logos/amazon-seller-central.png" alt="Amazon Seller Central" class="page-logo">
      </div>
      <h1 class="page-title">Seller Reviews</h1>
      <div class="header-actions">
        <div class="status-bar" id="status-bar">
          <span>Last sync: <span id="last-sync">--</span></span>
          <span>Total: <span id="total-reviews">--</span></span>
        </div>
        <button class="btn btn-primary" id="sync-btn" onclick="syncReviews()">
          <span class="material-symbols-outlined">sync</span>Sync Reviews
        </button>
      </div>
    </header>

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-card success" onclick="filterByRating('')">
        <div class="stat-value">
          <span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1; color: #fbbf24;">star</span>
          <span id="stat-avg">--</span>
        </div>
        <div class="stat-label">Average Rating</div>
      </div>
      <div class="stat-card" onclick="filterByRating('')">
        <div class="stat-value" id="stat-total">--</div>
        <div class="stat-label">Total Reviews</div>
      </div>
      <div class="stat-card info" onclick="filterByRating('')">
        <div class="stat-value" id="stat-comments">--</div>
        <div class="stat-label">With Comments</div>
      </div>
      <div class="stat-card danger" onclick="filterByRating('1,2')">
        <div class="stat-value" id="stat-negative">--</div>
        <div class="stat-label">Negative (1-2 stars)</div>
      </div>
    </div>

    <!-- Rating Distribution -->
    <div class="rating-distribution" id="rating-distribution">
      <!-- Generated by JS -->
    </div>

    <!-- Marketplace Stats -->
    <div class="marketplace-stats" id="marketplace-stats">
      <!-- Generated by JS -->
    </div>

    <!-- Reviews List -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Reviews</h2>
        <div class="filters-bar">
          <select class="filter-select" id="filter-rating" onchange="applyFilters()">
            <option value="">All Ratings</option>
            <option value="5">5 Stars</option>
            <option value="4">4 Stars</option>
            <option value="3">3 Stars</option>
            <option value="2">2 Stars</option>
            <option value="1">1 Star</option>
          </select>
          <select class="filter-select" id="filter-marketplace" onchange="applyFilters()">
            <option value="">All Marketplaces</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
            <option value="IT">Italy</option>
            <option value="ES">Spain</option>
            <option value="NL">Netherlands</option>
            <option value="BE">Belgium</option>
            <option value="PL">Poland</option>
            <option value="SE">Sweden</option>
          </select>
          <select class="filter-select" id="filter-comments" onchange="applyFilters()">
            <option value="">All</option>
            <option value="true">With Comments</option>
          </select>
          <input type="text" class="filter-input" id="filter-order" placeholder="Order ID..." onkeyup="debounceFilter()" style="width: 160px;">
        </div>
      </div>
      <div class="reviews-list" id="reviews-list">
        <div class="empty-state">
          <span class="material-symbols-outlined">hourglass_empty</span>
          <div class="empty-state-title">Loading reviews...</div>
        </div>
      </div>
      <div class="pagination" id="pagination" style="display: none;">
        <div class="pagination-info">
          Showing <span id="showing-from">0</span>-<span id="showing-to">0</span> of <span id="total-count">0</span>
        </div>
        <div class="pagination-buttons">
          <button class="btn btn-secondary" id="prev-btn" onclick="prevPage()" disabled>
            <span class="material-symbols-outlined">chevron_left</span>Prev
          </button>
          <button class="btn btn-secondary" id="next-btn" onclick="nextPage()">
            Next<span class="material-symbols-outlined">chevron_right</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Country flags
    const FLAGS = {
      DE: 'ðŸ‡©ðŸ‡ª', FR: 'ðŸ‡«ðŸ‡·', IT: 'ðŸ‡®ðŸ‡¹', ES: 'ðŸ‡ªðŸ‡¸', NL: 'ðŸ‡³ðŸ‡±',
      BE: 'ðŸ‡§ðŸ‡ª', PL: 'ðŸ‡µðŸ‡±', SE: 'ðŸ‡¸ðŸ‡ª', UK: 'ðŸ‡¬ðŸ‡§', US: 'ðŸ‡ºðŸ‡¸'
    };

    let currentPage = 0;
    const pageSize = 20;
    let totalCount = 0;
    let filterDebounceTimer = null;

    async function init() {
      await Promise.all([
        loadStats(),
        loadReviews()
      ]);
      loadStatus();
    }

    async function loadStatus() {
      try {
        const res = await fetch('/api/seller/reviews/status');
        const data = await res.json();
        if (data.success && data.status) {
          document.getElementById('last-sync').textContent = data.status.lastSync
            ? new Date(data.status.lastSync).toLocaleString()
            : 'Never';
          document.getElementById('total-reviews').textContent = data.status.totalReviews || 0;
        }
      } catch (e) {
        console.error('Error loading status:', e);
      }
    }

    async function loadStats() {
      try {
        const res = await fetch('/api/seller/reviews/stats');
        const data = await res.json();
        if (data.success && data.stats) {
          const stats = data.stats;
          document.getElementById('stat-avg').textContent = stats.averageRating || '0.0';
          document.getElementById('stat-total').textContent = stats.total || 0;
          document.getElementById('stat-comments').textContent = stats.withComments || 0;
          document.getElementById('stat-negative').textContent = stats.negative || 0;

          // Rating distribution
          renderRatingDistribution(stats.byRating, stats.total);

          // Marketplace stats
          renderMarketplaceStats(stats.byMarketplace);
        }
      } catch (e) {
        console.error('Error loading stats:', e);
      }
    }

    function renderRatingDistribution(byRating, total) {
      const container = document.getElementById('rating-distribution');
      container.innerHTML = '';

      for (let star = 5; star >= 1; star--) {
        const count = byRating[star] || 0;
        const pct = total > 0 ? (count / total * 100) : 0;

        container.innerHTML += `
          <div class="rating-bar" onclick="filterByRating('${star}')">
            <div class="rating-bar-header">
              <div class="rating-stars">
                ${Array(star).fill('<span class="material-symbols-outlined">star</span>').join('')}
              </div>
              <div class="rating-count">${count}</div>
            </div>
            <div class="rating-progress">
              <div class="rating-progress-fill star-${star}" style="width: ${pct}%"></div>
            </div>
          </div>
        `;
      }
    }

    function renderMarketplaceStats(byMarketplace) {
      const container = document.getElementById('marketplace-stats');
      container.innerHTML = '';

      if (!byMarketplace || byMarketplace.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'grid';
      for (const mp of byMarketplace) {
        container.innerHTML += `
          <div class="marketplace-stat" onclick="filterByMarketplace('${mp.country}')">
            <div class="marketplace-stat-header">
              <span class="marketplace-flag">${FLAGS[mp.country] || mp.country}</span>
              <div class="marketplace-rating">
                <span class="material-symbols-outlined">star</span>
                ${mp.avgRating}
              </div>
            </div>
            <div class="marketplace-count">${mp.count} reviews</div>
          </div>
        `;
      }
    }

    async function loadReviews() {
      const filters = getFilters();
      const params = new URLSearchParams({
        ...filters,
        limit: pageSize,
        skip: currentPage * pageSize
      });

      try {
        const res = await fetch(`/api/seller/reviews?${params}`);
        const data = await res.json();

        if (data.success) {
          totalCount = data.total;
          renderReviews(data.reviews);
          updatePagination();
        }
      } catch (e) {
        console.error('Error loading reviews:', e);
        document.getElementById('reviews-list').innerHTML = `
          <div class="empty-state">
            <span class="material-symbols-outlined">error</span>
            <div class="empty-state-title">Error loading reviews</div>
            <div class="empty-state-text">${e.message}</div>
          </div>
        `;
      }
    }

    function getFilters() {
      const filters = {};
      const rating = document.getElementById('filter-rating').value;
      const marketplace = document.getElementById('filter-marketplace').value;
      const comments = document.getElementById('filter-comments').value;
      const orderId = document.getElementById('filter-order').value;

      if (rating) filters.rating = rating;
      if (marketplace) filters.marketplace = marketplace;
      if (comments) filters.hasComments = comments;
      if (orderId) filters.orderId = orderId;

      return filters;
    }

    function renderReviews(reviews) {
      const container = document.getElementById('reviews-list');

      if (!reviews || reviews.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <span class="material-symbols-outlined">reviews</span>
            <div class="empty-state-title">No reviews found</div>
            <div class="empty-state-text">Click "Sync Reviews" to import seller feedback from Amazon.</div>
            <button class="btn btn-primary" onclick="syncReviews()">
              <span class="material-symbols-outlined">sync</span>Sync Reviews
            </button>
          </div>
        `;
        return;
      }

      container.innerHTML = reviews.map(r => {
        const stars = renderStars(r.rating);
        const commentClass = r.rating >= 4 ? 'positive' : (r.rating >= 3 ? 'neutral' : 'negative');

        return `
          <div class="review-item">
            <div class="review-header">
              <div class="review-info">
                <div class="review-rating">${stars}</div>
                <a class="review-order" href="/seller/?orderId=${r.orderId}" target="_blank">${r.orderId}</a>
                ${r.marketplaceCountry ? `
                  <div class="review-marketplace">
                    <span class="flag">${FLAGS[r.marketplaceCountry] || ''}</span>
                    ${r.marketplaceCountry}
                  </div>
                ` : ''}
              </div>
              <div class="review-date">${formatDate(r.feedbackDate)}</div>
            </div>
            ${r.comments ? `
              <div class="review-comments ${commentClass}">${escapeHtml(r.comments)}</div>
            ` : ''}
            ${r.response ? `
              <div class="review-response">
                <div class="review-response-label">Your Response</div>
                <div class="review-response-text">${escapeHtml(r.response)}</div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function renderStars(rating) {
      let html = '';
      for (let i = 1; i <= 5; i++) {
        html += `<span class="material-symbols-outlined ${i <= rating ? 'filled' : 'empty'}">star</span>`;
      }
      return html;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '--';
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updatePagination() {
      const pag = document.getElementById('pagination');
      const from = currentPage * pageSize + 1;
      const to = Math.min((currentPage + 1) * pageSize, totalCount);

      if (totalCount > 0) {
        pag.style.display = 'flex';
        document.getElementById('showing-from').textContent = from;
        document.getElementById('showing-to').textContent = to;
        document.getElementById('total-count').textContent = totalCount;

        document.getElementById('prev-btn').disabled = currentPage === 0;
        document.getElementById('next-btn').disabled = to >= totalCount;
      } else {
        pag.style.display = 'none';
      }
    }

    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        loadReviews();
      }
    }

    function nextPage() {
      if ((currentPage + 1) * pageSize < totalCount) {
        currentPage++;
        loadReviews();
      }
    }

    function applyFilters() {
      currentPage = 0;
      loadReviews();
    }

    function debounceFilter() {
      clearTimeout(filterDebounceTimer);
      filterDebounceTimer = setTimeout(applyFilters, 300);
    }

    function filterByRating(rating) {
      document.getElementById('filter-rating').value = rating.split(',')[0] || '';
      applyFilters();
    }

    function filterByMarketplace(marketplace) {
      document.getElementById('filter-marketplace').value = marketplace;
      applyFilters();
    }

    async function syncReviews() {
      const btn = document.getElementById('sync-btn');
      btn.classList.add('loading');
      btn.disabled = true;

      try {
        const res = await fetch('/api/seller/reviews/sync', { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          showToast(`Sync complete: ${data.reviewsImported} reviews imported`, 'success');
          await Promise.all([loadStats(), loadReviews(), loadStatus()]);
        } else {
          showToast(data.error || 'Sync failed', 'error');
        }
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type + ' show';
      setTimeout(() => toast.classList.remove('show'), 4000);
    }

    init();
  </script>
</body>
</html>
