<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purchasing Intelligence - Agent5</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    .urgency-critical { background-color: #fee2e2; border-left: 4px solid #ef4444; }
    .urgency-high { background-color: #fef3c7; border-left: 4px solid #f59e0b; }
    .urgency-moderate { background-color: #dbeafe; border-left: 4px solid #3b82f6; }
    .urgency-none { background-color: #f0fdf4; border-left: 4px solid #22c55e; }
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .season-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <a href="/app/dashboard.html" class="text-gray-500 hover:text-gray-700 mr-4">
            <i class="fas fa-arrow-left"></i>
          </a>
          <h1 class="text-xl font-semibold text-gray-900">
            <i class="fas fa-brain text-purple-600 mr-2"></i>
            Purchasing Intelligence
          </h1>
        </div>
        <div class="flex items-center space-x-4">
          <button onclick="downloadExcel()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
            <i class="fas fa-file-excel mr-2"></i>Export Excel
          </button>
          <button onclick="refreshDashboard()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
            <i class="fas fa-sync-alt mr-2"></i>Refresh
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Status Banner -->
    <div id="statusBanner" class="hidden mb-6 p-4 rounded-lg"></div>

    <!-- Supply Chain Alert -->
    <div id="supplyChainAlert" class="hidden mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
      <div class="flex items-center">
        <i class="fas fa-exclamation-triangle text-red-600 text-xl mr-3"></i>
        <div>
          <h3 class="text-red-800 font-semibold" id="alertTitle">Supply Chain Alert</h3>
          <p class="text-red-700" id="alertMessage"></p>
        </div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Critical Actions</p>
            <p class="text-3xl font-bold text-red-600" id="criticalCount">-</p>
          </div>
          <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
            <i class="fas fa-exclamation-circle text-red-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">High Priority</p>
            <p class="text-3xl font-bold text-amber-600" id="highCount">-</p>
          </div>
          <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
            <i class="fas fa-exclamation text-amber-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Days to CNY</p>
            <p class="text-3xl font-bold text-purple-600" id="daysToCNY">-</p>
          </div>
          <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
            <i class="fas fa-dragon text-purple-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Sea Freight Lead Time</p>
            <p class="text-3xl font-bold text-blue-600" id="leadTime">-</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
            <i class="fas fa-ship text-blue-600 text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column - Recommendations -->
      <div class="lg:col-span-2">
        <!-- Purchasing Recommendations -->
        <div class="bg-white rounded-lg shadow mb-8">
          <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-900">
              <i class="fas fa-shopping-cart text-purple-600 mr-2"></i>
              Purchasing Recommendations
            </h2>
            <div class="flex space-x-2">
              <button onclick="filterRecommendations('all')" class="filter-btn px-3 py-1 text-sm rounded bg-purple-600 text-white" data-filter="all">All</button>
              <button onclick="filterRecommendations('critical')" class="filter-btn px-3 py-1 text-sm rounded bg-gray-200 text-gray-700" data-filter="critical">Critical</button>
              <button onclick="filterRecommendations('high')" class="filter-btn px-3 py-1 text-sm rounded bg-gray-200 text-gray-700" data-filter="high">High</button>
            </div>
          </div>
          <div class="p-6">
            <div id="recommendationsLoading" class="flex justify-center py-8">
              <div class="loading-spinner"></div>
            </div>
            <div id="recommendationsList" class="space-y-4 hidden"></div>
            <div id="noRecommendations" class="hidden text-center py-8 text-gray-500">
              <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
              <p>All products are well-stocked!</p>
            </div>
          </div>
        </div>

        <!-- Sales Trends -->
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">
              <i class="fas fa-chart-line text-green-600 mr-2"></i>
              Sales Trends
            </h2>
          </div>
          <div class="p-6">
            <div id="trendsLoading" class="flex justify-center py-8">
              <div class="loading-spinner"></div>
            </div>
            <div id="trendsList" class="hidden">
              <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="text-center p-3 bg-green-50 rounded-lg">
                  <p class="text-2xl font-bold text-green-600" id="trendIncreasing">0</p>
                  <p class="text-sm text-gray-500">Increasing</p>
                </div>
                <div class="text-center p-3 bg-red-50 rounded-lg">
                  <p class="text-2xl font-bold text-red-600" id="trendDecreasing">0</p>
                  <p class="text-sm text-gray-500">Decreasing</p>
                </div>
                <div class="text-center p-3 bg-blue-50 rounded-lg">
                  <p class="text-2xl font-bold text-blue-600" id="trendNew">0</p>
                  <p class="text-sm text-gray-500">New Demand</p>
                </div>
              </div>
              <div id="trendsTable" class="max-h-64 overflow-y-auto"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Calendar & CNY -->
      <div class="lg:col-span-1">
        <!-- CNY Preparation -->
        <div class="bg-white rounded-lg shadow mb-8">
          <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-red-500 to-yellow-500 rounded-t-lg">
            <h2 class="text-lg font-semibold text-white">
              <i class="fas fa-dragon mr-2"></i>
              Chinese New Year Prep
            </h2>
          </div>
          <div class="p-6">
            <div id="cnyInfo" class="space-y-4">
              <div class="text-center">
                <p class="text-sm text-gray-500">CNY Date</p>
                <p class="text-xl font-bold text-red-600" id="cnyDate">Loading...</p>
              </div>
              <div class="border-t pt-4">
                <p class="text-sm text-gray-500 mb-2">Order Deadline</p>
                <p class="text-lg font-semibold text-gray-900" id="orderDeadline">-</p>
                <p class="text-sm text-gray-500" id="deadlineUrgency">-</p>
              </div>
              <div class="border-t pt-4">
                <p class="text-sm text-gray-500 mb-2">Factory Closure</p>
                <p class="text-sm text-gray-700" id="closurePeriod">-</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Upcoming Seasons -->
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">
              <i class="fas fa-calendar-alt text-blue-600 mr-2"></i>
              Upcoming Seasons
            </h2>
          </div>
          <div class="p-6">
            <div id="seasonsLoading" class="flex justify-center py-4">
              <div class="loading-spinner"></div>
            </div>
            <div id="seasonsList" class="space-y-3 hidden"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Calculators Section - Hidden for now -->
    <div class="mt-8 bg-white rounded-lg shadow hidden">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-calculator text-purple-600 mr-2"></i>
          Supply Chain Calculators
        </h2>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Reorder Point Calculator -->
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold text-gray-900 mb-4">Reorder Point</h3>
            <div class="space-y-3">
              <div>
                <label class="text-sm text-gray-500">Avg Daily Demand</label>
                <input type="number" id="ropDailyDemand" class="w-full border rounded px-3 py-2" placeholder="Units/day">
              </div>
              <div>
                <label class="text-sm text-gray-500">Demand Std Dev</label>
                <input type="number" id="ropStdDev" class="w-full border rounded px-3 py-2" placeholder="Optional">
              </div>
              <div>
                <label class="text-sm text-gray-500">Service Level</label>
                <select id="ropServiceLevel" class="w-full border rounded px-3 py-2">
                  <option value="0.90">90%</option>
                  <option value="0.95" selected>95%</option>
                  <option value="0.98">98%</option>
                  <option value="0.99">99%</option>
                </select>
              </div>
              <button onclick="calculateReorderPoint()" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700 transition">
                Calculate
              </button>
              <div id="ropResult" class="hidden p-3 bg-purple-50 rounded text-sm"></div>
            </div>
          </div>

          <!-- EOQ Calculator -->
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold text-gray-900 mb-4">Economic Order Quantity</h3>
            <div class="space-y-3">
              <div>
                <label class="text-sm text-gray-500">Annual Demand</label>
                <input type="number" id="eoqAnnualDemand" class="w-full border rounded px-3 py-2" placeholder="Units/year">
              </div>
              <div>
                <label class="text-sm text-gray-500">Unit Cost (€)</label>
                <input type="number" id="eoqUnitCost" class="w-full border rounded px-3 py-2" placeholder="€">
              </div>
              <div>
                <label class="text-sm text-gray-500">Min Order Qty</label>
                <input type="number" id="eoqMOQ" class="w-full border rounded px-3 py-2" placeholder="MOQ" value="1">
              </div>
              <button onclick="calculateEOQ()" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700 transition">
                Calculate
              </button>
              <div id="eoqResult" class="hidden p-3 bg-purple-50 rounded text-sm"></div>
            </div>
          </div>

          <!-- Stockout Cost Calculator -->
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold text-gray-900 mb-4">Stockout Cost</h3>
            <div class="space-y-3">
              <div>
                <label class="text-sm text-gray-500">Stockout Days</label>
                <input type="number" id="stockoutDays" class="w-full border rounded px-3 py-2" placeholder="Days">
              </div>
              <div>
                <label class="text-sm text-gray-500">Avg Daily Sales</label>
                <input type="number" id="stockoutDailySales" class="w-full border rounded px-3 py-2" placeholder="Units/day">
              </div>
              <div>
                <label class="text-sm text-gray-500">Selling Price (€)</label>
                <input type="number" id="stockoutPrice" class="w-full border rounded px-3 py-2" placeholder="€">
              </div>
              <button onclick="calculateStockoutCost()" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 transition">
                Calculate Loss
              </button>
              <div id="stockoutResult" class="hidden p-3 bg-red-50 rounded text-sm"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Chat Section -->
    <div class="mt-8 bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-robot text-purple-600 mr-2"></i>
          Ask the Purchasing Agent
        </h2>
      </div>
      <div class="p-6">
        <div id="chatMessages" class="h-48 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg">
          <div class="text-gray-500 text-sm">
            Ask questions about inventory, forecasting, or purchasing recommendations...
          </div>
        </div>
        <div class="flex space-x-2">
          <input type="text" id="chatInput" class="flex-1 border rounded-lg px-4 py-2" placeholder="e.g., Which products need to be ordered before CNY?">
          <button onclick="sendChatMessage()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Agent Training Section -->
    <div class="mt-8 bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200 cursor-pointer flex justify-between items-center" onclick="toggleTrainingSection()">
        <h2 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-graduation-cap text-indigo-600 mr-2"></i>
          Train the Agent - Business Context
        </h2>
        <i id="trainingToggleIcon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
      </div>
      <div id="trainingSection" class="hidden p-6">
        <p class="text-sm text-gray-500 mb-6">
          Help the agent make better predictions by providing context about special situations like recurring customer orders,
          product substitutions, and one-time events.
        </p>

        <!-- Tab Navigation -->
        <div class="border-b border-gray-200 mb-6">
          <nav class="flex space-x-4">
            <button onclick="showTrainingTab('recurring')" class="training-tab px-4 py-2 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600" data-tab="recurring">
              <i class="fas fa-calendar-alt mr-2"></i>Recurring Orders
            </button>
            <button onclick="showTrainingTab('substitutes')" class="training-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="substitutes">
              <i class="fas fa-exchange-alt mr-2"></i>Substitutes
            </button>
            <button onclick="showTrainingTab('onetime')" class="training-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="onetime">
              <i class="fas fa-star mr-2"></i>One-Time Orders
            </button>
            <button onclick="showTrainingTab('history')" class="training-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="history">
              <i class="fas fa-history mr-2"></i>View History
            </button>
          </nav>
        </div>

        <!-- Tab: Recurring Customer Orders -->
        <div id="tab-recurring" class="training-tab-content">
          <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-indigo-800">
              <i class="fas fa-info-circle mr-2"></i>
              <strong>Use this for:</strong> Customers who place orders on a predictable schedule (e.g., once a year, quarterly).
              This helps the agent forecast demand without treating these orders as trends.
            </p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Product SKU or ID *</label>
              <input type="text" id="recurringProductId" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., P0222 or 12345">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
              <input type="text" id="recurringProductName" class="w-full border rounded-lg px-3 py-2" placeholder="Optional - for reference">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Customer ID *</label>
              <input type="text" id="recurringCustomerId" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., C1234">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
              <input type="text" id="recurringCustomerName" class="w-full border rounded-lg px-3 py-2" placeholder="Optional - for reference">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Frequency *</label>
              <select id="recurringFrequency" class="w-full border rounded-lg px-3 py-2">
                <option value="annual">Annual (once a year)</option>
                <option value="semi-annual">Semi-Annual (twice a year)</option>
                <option value="quarterly">Quarterly (4x a year)</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Typical Quantity *</label>
              <input type="number" id="recurringQuantity" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., 500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Typical Month (for annual)</label>
              <select id="recurringMonth" class="w-full border rounded-lg px-3 py-2">
                <option value="">Not specified</option>
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
              <input type="text" id="recurringNotes" class="w-full border rounded-lg px-3 py-2" placeholder="Optional notes">
            </div>
          </div>
          <button onclick="saveRecurringOrder()" class="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
            <i class="fas fa-save mr-2"></i>Save Recurring Order Pattern
          </button>
        </div>

        <!-- Tab: Substitute Relationships -->
        <div id="tab-substitutes" class="training-tab-content hidden">
          <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-amber-800">
              <i class="fas fa-info-circle mr-2"></i>
              <strong>Use this for:</strong> Products that can substitute for each other when one is out of stock.
              Example: When #18009 is out of stock, customers buy #18010 instead.
            </p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Primary Product ID * (the main product)</label>
              <input type="text" id="primaryProductId" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., 18009">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Primary Product Name</label>
              <input type="text" id="primaryProductName" class="w-full border rounded-lg px-3 py-2" placeholder="Optional">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Substitute Product ID * (the replacement)</label>
              <input type="text" id="substituteProductId" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., 18010">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Substitute Product Name</label>
              <input type="text" id="substituteProductName" class="w-full border rounded-lg px-3 py-2" placeholder="Optional">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Direction</label>
              <select id="substituteDirection" class="w-full border rounded-lg px-3 py-2">
                <option value="one-way">One-way (substitute can replace primary only)</option>
                <option value="bidirectional">Bidirectional (can substitute each other)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
              <input type="text" id="substituteNotes" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., Sold at primary product price">
            </div>
          </div>
          <button onclick="saveSubstituteRelationship()" class="mt-4 px-6 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition">
            <i class="fas fa-save mr-2"></i>Save Substitute Relationship
          </button>
        </div>

        <!-- Tab: One-Time Orders -->
        <div id="tab-onetime" class="training-tab-content hidden">
          <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-green-800">
              <i class="fas fa-info-circle mr-2"></i>
              <strong>Use this for:</strong> Large one-time orders that shouldn't affect normal demand forecasting.
              Example: A promotional giveaway or a one-time bulk purchase for an event.
            </p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Order Date *</label>
              <input type="date" id="onetimeDate" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Product ID *</label>
              <input type="text" id="onetimeProductId" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., 12345">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
              <input type="text" id="onetimeProductName" class="w-full border rounded-lg px-3 py-2" placeholder="Optional">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Quantity *</label>
              <input type="number" id="onetimeQuantity" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., 1000">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Customer ID</label>
              <input type="text" id="onetimeCustomerId" class="w-full border rounded-lg px-3 py-2" placeholder="Optional">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
              <input type="text" id="onetimeCustomerName" class="w-full border rounded-lg px-3 py-2" placeholder="Optional">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Reason *</label>
              <input type="text" id="onetimeReason" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., Trade show giveaway, one-time bulk order">
            </div>
            <div>
              <label class="flex items-center">
                <input type="checkbox" id="onetimeExclude" checked class="mr-2">
                <span class="text-sm text-gray-700">Exclude from demand forecast</span>
              </label>
            </div>
          </div>
          <button onclick="saveOneTimeOrder()" class="mt-4 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
            <i class="fas fa-save mr-2"></i>Save One-Time Order
          </button>
        </div>

        <!-- Tab: History -->
        <div id="tab-history" class="training-tab-content hidden">
          <div class="flex justify-between items-center mb-4">
            <p class="text-sm text-gray-500">Recently added business context:</p>
            <button onclick="loadContextHistory()" class="text-sm text-indigo-600 hover:text-indigo-800">
              <i class="fas fa-sync-alt mr-1"></i>Refresh
            </button>
          </div>
          <div id="contextHistory" class="space-y-3 max-h-96 overflow-y-auto">
            <p class="text-gray-400 text-sm">Click "Refresh" to load history...</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let allRecommendations = [];
    let currentFilter = 'all';

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
      refreshDashboard();

      // Enter key for chat
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChatMessage();
      });
    });

    async function refreshDashboard() {
      await Promise.all([
        loadRecommendations(),
        loadCNYInfo(),
        loadSeasons(),
        loadTrends(),
        loadLeadTime(),
      ]);
    }

    async function loadRecommendations() {
      document.getElementById('recommendationsLoading').classList.remove('hidden');
      document.getElementById('recommendationsList').classList.add('hidden');
      document.getElementById('noRecommendations').classList.add('hidden');

      try {
        const response = await fetch('/api/purchasing/recommendations?limit=30');
        const data = await response.json();

        if (data.success && data.data.recommendations) {
          allRecommendations = data.data.recommendations;

          // Update counts
          document.getElementById('criticalCount').textContent = data.data.summary?.critical || 0;
          document.getElementById('highCount').textContent = data.data.summary?.high || 0;

          // Check supply chain status
          if (data.data.supplyChainStatus?.impacted) {
            showSupplyChainAlert(data.data.supplyChainStatus);
          }

          filterRecommendations(currentFilter);
        }
      } catch (error) {
        console.error('Error loading recommendations:', error);
        showStatus('Error loading recommendations', 'error');
      }

      document.getElementById('recommendationsLoading').classList.add('hidden');
    }

    function filterRecommendations(filter) {
      currentFilter = filter;

      // Update button styles
      document.querySelectorAll('.filter-btn').forEach(btn => {
        if (btn.dataset.filter === filter) {
          btn.classList.remove('bg-gray-200', 'text-gray-700');
          btn.classList.add('bg-purple-600', 'text-white');
        } else {
          btn.classList.remove('bg-purple-600', 'text-white');
          btn.classList.add('bg-gray-200', 'text-gray-700');
        }
      });

      let filtered = allRecommendations;
      if (filter !== 'all') {
        filtered = allRecommendations.filter(r => r.urgency === filter);
      }

      const container = document.getElementById('recommendationsList');
      const noRecs = document.getElementById('noRecommendations');

      if (filtered.length === 0) {
        container.classList.add('hidden');
        noRecs.classList.remove('hidden');
        return;
      }

      container.classList.remove('hidden');
      noRecs.classList.add('hidden');

      container.innerHTML = filtered.map(rec => {
        // Data comes from nested objects: currentState and calculations
        const currentStock = rec.currentState?.currentStock ?? rec.product?.currentStock ?? 0;
        const incoming = rec.currentState?.incoming ?? 0;
        const daysOfStock = rec.currentState?.daysOfStock ?? 0;
        const avgDailySales = rec.calculations?.avgDailySales?.toFixed(2) ?? '0';
        const orderQty = rec.orderQuantity ?? rec.recommendation?.orderQuantity ?? 0;

        return `
        <div class="urgency-${rec.urgency} rounded-lg p-4 transition hover:shadow-md">
          <div class="flex justify-between items-start">
            <div>
              <h4 class="font-semibold text-gray-900">${rec.product?.name || 'Unknown Product'}</h4>
              <p class="text-sm text-gray-500">${rec.product?.sku || ''}</p>
            </div>
            <span class="px-2 py-1 text-xs font-medium rounded ${getUrgencyBadgeClass(rec.urgency)}">
              ${rec.urgency?.toUpperCase()}
            </span>
          </div>
          <div class="mt-3 grid grid-cols-5 gap-4 text-sm">
            <div>
              <p class="text-gray-500">Stock</p>
              <p class="font-semibold">${currentStock}</p>
            </div>
            <div>
              <p class="text-gray-500">Incoming</p>
              <p class="font-semibold">${incoming}</p>
            </div>
            <div>
              <p class="text-gray-500">Days Left</p>
              <p class="font-semibold ${daysOfStock < 14 ? 'text-red-600' : daysOfStock < 30 ? 'text-amber-600' : ''}">${daysOfStock}d</p>
            </div>
            <div>
              <p class="text-gray-500">Daily Sales</p>
              <p class="font-semibold">${avgDailySales}</p>
            </div>
            <div>
              <p class="text-gray-500">Order Qty</p>
              <p class="font-semibold text-purple-600">${orderQty > 0 ? orderQty : '-'}</p>
            </div>
          </div>
          ${rec.reasoning ? `
            <div class="mt-3 p-2 bg-white bg-opacity-50 rounded text-sm">
              <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
              ${rec.reasoning.substring(0, 200)}${rec.reasoning.length > 200 ? '...' : ''}
            </div>
          ` : ''}
        </div>
      `;}).join('');
    }

    function getUrgencyBadgeClass(urgency) {
      switch (urgency) {
        case 'critical': return 'bg-red-100 text-red-800';
        case 'high': return 'bg-amber-100 text-amber-800';
        case 'moderate': return 'bg-blue-100 text-blue-800';
        default: return 'bg-green-100 text-green-800';
      }
    }

    async function loadCNYInfo() {
      try {
        const response = await fetch('/api/purchasing/calendar/cny');
        const data = await response.json();

        if (data.success && data.data) {
          const cny = data.data.cny;
          const deadline = data.data.orderDeadline;

          // CNY Date
          const cnyDate = new Date(cny.cnyDate);
          document.getElementById('cnyDate').textContent = cnyDate.toLocaleDateString('en-GB', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
          });

          // Days until CNY
          const daysUntilCNY = Math.ceil((cnyDate - new Date()) / (1000 * 60 * 60 * 24));
          document.getElementById('daysToCNY').textContent = daysUntilCNY > 0 ? daysUntilCNY : 'Passed';

          // Order deadline
          if (deadline?.orderDeadline) {
            const deadlineDate = new Date(deadline.orderDeadline);
            document.getElementById('orderDeadline').textContent = deadlineDate.toLocaleDateString('en-GB');
            document.getElementById('deadlineUrgency').textContent =
              deadline.daysUntilDeadline > 0
                ? `${deadline.daysUntilDeadline} days remaining`
                : 'DEADLINE PASSED!';

            if (deadline.daysUntilDeadline <= 0) {
              document.getElementById('deadlineUrgency').classList.add('text-red-600', 'font-bold');
            } else if (deadline.daysUntilDeadline <= 14) {
              document.getElementById('deadlineUrgency').classList.add('text-amber-600', 'font-semibold');
            }
          }

          // Closure period
          if (cny.closureStart && cny.closureEnd) {
            const start = new Date(cny.closureStart).toLocaleDateString('en-GB');
            const end = new Date(cny.closureEnd).toLocaleDateString('en-GB');
            document.getElementById('closurePeriod').textContent = `${start} - ${end} (${cny.totalClosureDays} days)`;
          }
        }
      } catch (error) {
        console.error('Error loading CNY info:', error);
      }
    }

    async function loadSeasons() {
      document.getElementById('seasonsLoading').classList.remove('hidden');
      document.getElementById('seasonsList').classList.add('hidden');

      try {
        const response = await fetch('/api/purchasing/calendar/seasons?months=6');
        const data = await response.json();

        if (data.success && data.data.seasons) {
          const container = document.getElementById('seasonsList');
          container.innerHTML = data.data.seasons.slice(0, 6).map(season => {
            const startDate = new Date(season.startDate);
            const daysUntil = Math.ceil((startDate - new Date()) / (1000 * 60 * 60 * 24));

            return `
              <div class="season-card border rounded-lg p-3 transition cursor-pointer hover:bg-gray-50">
                <div class="flex justify-between items-center">
                  <div>
                    <h4 class="font-medium text-gray-900">${season.name}</h4>
                    <p class="text-xs text-gray-500">${startDate.toLocaleDateString('en-GB')}</p>
                  </div>
                  <div class="text-right">
                    <span class="text-sm font-semibold ${daysUntil <= 30 ? 'text-amber-600' : 'text-gray-600'}">
                      ${daysUntil > 0 ? `${daysUntil}d` : 'Now'}
                    </span>
                    <p class="text-xs text-gray-500">${season.demandMultiplier}x</p>
                  </div>
                </div>
              </div>
            `;
          }).join('');

          document.getElementById('seasonsList').classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error loading seasons:', error);
      }

      document.getElementById('seasonsLoading').classList.add('hidden');
    }

    async function loadTrends() {
      document.getElementById('trendsLoading').classList.remove('hidden');
      document.getElementById('trendsList').classList.add('hidden');

      try {
        const response = await fetch('/api/purchasing/trends?threshold=20&weeks=4');
        const data = await response.json();

        if (data.success && data.data) {
          document.getElementById('trendIncreasing').textContent = data.data.summary?.increasing || 0;
          document.getElementById('trendDecreasing').textContent = data.data.summary?.decreasing || 0;
          document.getElementById('trendNew').textContent = data.data.summary?.newDemand || 0;

          const trends = data.data.trends?.slice(0, 10) || [];
          const table = document.getElementById('trendsTable');

          if (trends.length > 0) {
            table.innerHTML = `
              <table class="w-full text-sm">
                <thead>
                  <tr class="text-left text-gray-500">
                    <th class="py-2">Product</th>
                    <th class="py-2">Change</th>
                    <th class="py-2">Trend</th>
                  </tr>
                </thead>
                <tbody>
                  ${trends.map(t => `
                    <tr class="border-t">
                      <td class="py-2">#${t.productId}</td>
                      <td class="py-2 ${t.changePercent > 0 ? 'text-green-600' : 'text-red-600'}">
                        ${t.changePercent > 0 ? '+' : ''}${t.changePercent}%
                      </td>
                      <td class="py-2">
                        <i class="fas ${t.trend === 'increasing' ? 'fa-arrow-up text-green-500' : t.trend === 'decreasing' ? 'fa-arrow-down text-red-500' : 'fa-star text-blue-500'}"></i>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          } else {
            table.innerHTML = '<p class="text-gray-500 text-center py-4">No significant trends detected</p>';
          }

          document.getElementById('trendsList').classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error loading trends:', error);
      }

      document.getElementById('trendsLoading').classList.add('hidden');
    }

    async function loadLeadTime() {
      try {
        const response = await fetch('/api/purchasing/lead-time?shipping_method=sea');
        const data = await response.json();

        if (data.success && data.data) {
          document.getElementById('leadTime').textContent = `${data.data.totalDays}d`;
        }
      } catch (error) {
        console.error('Error loading lead time:', error);
      }
    }

    function showSupplyChainAlert(status) {
      const alert = document.getElementById('supplyChainAlert');
      document.getElementById('alertTitle').textContent = status.reason || 'Supply Chain Alert';
      document.getElementById('alertMessage').textContent =
        status.daysUntilClosure
          ? `${status.daysUntilClosure} days until factory closure. Order now!`
          : status.details?.description || '';

      alert.classList.remove('hidden');
    }

    // Calculator functions
    async function calculateReorderPoint() {
      const dailyDemand = parseFloat(document.getElementById('ropDailyDemand').value);
      const stdDev = parseFloat(document.getElementById('ropStdDev').value) || undefined;
      const serviceLevel = parseFloat(document.getElementById('ropServiceLevel').value);

      if (!dailyDemand) {
        showStatus('Please enter daily demand', 'error');
        return;
      }

      try {
        const response = await fetch('/api/purchasing/calculate/reorder-point', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            avg_daily_demand: dailyDemand,
            demand_std_dev: stdDev,
            service_level: serviceLevel,
          }),
        });

        const data = await response.json();
        if (data.success) {
          const result = document.getElementById('ropResult');
          result.innerHTML = `
            <p><strong>Reorder Point:</strong> ${data.data.reorderPoint} units</p>
            <p><strong>Safety Stock:</strong> ${data.data.safetyStock} units</p>
            <p><strong>Lead Time:</strong> ${data.data.leadTime?.totalDays} days</p>
          `;
          result.classList.remove('hidden');
        }
      } catch (error) {
        showStatus('Calculation error', 'error');
      }
    }

    async function calculateEOQ() {
      const annualDemand = parseFloat(document.getElementById('eoqAnnualDemand').value);
      const unitCost = parseFloat(document.getElementById('eoqUnitCost').value);
      const moq = parseInt(document.getElementById('eoqMOQ').value) || 1;

      if (!annualDemand || !unitCost) {
        showStatus('Please enter annual demand and unit cost', 'error');
        return;
      }

      try {
        const response = await fetch('/api/purchasing/calculate/eoq', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            annual_demand: annualDemand,
            unit_cost: unitCost,
            min_order_qty: moq,
          }),
        });

        const data = await response.json();
        if (data.success) {
          const result = document.getElementById('eoqResult');
          result.innerHTML = `
            <p><strong>Optimal Order Qty:</strong> ${data.data.eoq} units</p>
            <p><strong>Orders/Year:</strong> ${data.data.ordersPerYear}</p>
            <p><strong>Annual Cost:</strong> €${Math.round(data.data.totalAnnualCost)}</p>
          `;
          result.classList.remove('hidden');
        }
      } catch (error) {
        showStatus('Calculation error', 'error');
      }
    }

    async function calculateStockoutCost() {
      const days = parseInt(document.getElementById('stockoutDays').value);
      const dailySales = parseFloat(document.getElementById('stockoutDailySales').value);
      const price = parseFloat(document.getElementById('stockoutPrice').value);

      if (!days || !dailySales || !price) {
        showStatus('Please fill all fields', 'error');
        return;
      }

      try {
        const response = await fetch('/api/purchasing/stockout/cost', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            stockout_days: days,
            avg_daily_sales: dailySales,
            avg_selling_price: price,
          }),
        });

        const data = await response.json();
        if (data.success) {
          const result = document.getElementById('stockoutResult');
          result.innerHTML = `
            <p><strong>Lost Units:</strong> ${data.data.directImpact?.lostUnits}</p>
            <p><strong>Lost Revenue:</strong> €${data.data.directImpact?.lostRevenue}</p>
            <p><strong>Lost Profit:</strong> €${data.data.directImpact?.lostProfit}</p>
            <p class="text-red-600 font-semibold mt-2">Daily Cost: €${data.data.dailyCost}/day</p>
          `;
          result.classList.remove('hidden');
        }
      } catch (error) {
        showStatus('Calculation error', 'error');
      }
    }

    // Chat function
    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();

      if (!message) return;

      const chatContainer = document.getElementById('chatMessages');

      // Add user message
      chatContainer.innerHTML += `
        <div class="mb-3 text-right">
          <span class="inline-block px-3 py-2 bg-purple-600 text-white rounded-lg">${message}</span>
        </div>
      `;

      input.value = '';
      chatContainer.scrollTop = chatContainer.scrollHeight;

      // Show loading
      chatContainer.innerHTML += `
        <div id="chatLoading" class="mb-3">
          <span class="inline-block px-3 py-2 bg-gray-200 rounded-lg">
            <div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
          </span>
        </div>
      `;

      try {
        const response = await fetch('/api/purchasing/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message }),
        });

        const data = await response.json();

        // Remove loading
        document.getElementById('chatLoading')?.remove();

        if (data.success) {
          const aiResponse = typeof data.data.response === 'string'
            ? data.data.response
            : JSON.stringify(data.data.response, null, 2);

          chatContainer.innerHTML += `
            <div class="mb-3">
              <span class="inline-block px-3 py-2 bg-gray-200 rounded-lg text-sm whitespace-pre-wrap">${aiResponse}</span>
            </div>
          `;
        } else {
          chatContainer.innerHTML += `
            <div class="mb-3">
              <span class="inline-block px-3 py-2 bg-red-100 text-red-700 rounded-lg">Error: ${data.error || 'Unknown error'}</span>
            </div>
          `;
        }
      } catch (error) {
        document.getElementById('chatLoading')?.remove();
        chatContainer.innerHTML += `
          <div class="mb-3">
            <span class="inline-block px-3 py-2 bg-red-100 text-red-700 rounded-lg">Connection error</span>
          </div>
        `;
      }

      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function showStatus(message, type = 'info') {
      const banner = document.getElementById('statusBanner');
      banner.textContent = message;
      const colorClasses = {
        error: 'bg-red-100 text-red-700',
        success: 'bg-green-100 text-green-700',
        info: 'bg-blue-100 text-blue-700',
      };
      banner.className = `mb-6 p-4 rounded-lg ${colorClasses[type] || colorClasses.info}`;
      banner.classList.remove('hidden');

      setTimeout(() => banner.classList.add('hidden'), 5000);
    }

    // ==================== TRAINING SECTION ====================

    function toggleTrainingSection() {
      const section = document.getElementById('trainingSection');
      const icon = document.getElementById('trainingToggleIcon');
      section.classList.toggle('hidden');
      icon.style.transform = section.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
    }

    function showTrainingTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.training-tab').forEach(btn => {
        if (btn.dataset.tab === tabName) {
          btn.classList.add('border-indigo-600', 'text-indigo-600');
          btn.classList.remove('border-transparent', 'text-gray-500');
        } else {
          btn.classList.remove('border-indigo-600', 'text-indigo-600');
          btn.classList.add('border-transparent', 'text-gray-500');
        }
      });

      // Show/hide tab content
      document.querySelectorAll('.training-tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`tab-${tabName}`).classList.remove('hidden');

      // Load history when that tab is shown
      if (tabName === 'history') {
        loadContextHistory();
      }
    }

    async function saveRecurringOrder() {
      const productId = document.getElementById('recurringProductId').value.trim();
      const productName = document.getElementById('recurringProductName').value.trim();
      const customerId = document.getElementById('recurringCustomerId').value.trim();
      const customerName = document.getElementById('recurringCustomerName').value.trim();
      const frequency = document.getElementById('recurringFrequency').value;
      const quantity = parseInt(document.getElementById('recurringQuantity').value);
      const month = document.getElementById('recurringMonth').value;
      const notes = document.getElementById('recurringNotes').value.trim();

      if (!productId || !customerId || !quantity) {
        showStatus('Please fill in all required fields', 'error');
        return;
      }

      try {
        const response = await fetch('/api/purchasing/context/recurring-customer-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            product_id: productId,
            product_name: productName || undefined,
            customer_id: customerId,
            customer_name: customerName || undefined,
            frequency,
            typical_quantity: quantity,
            typical_month: month ? parseInt(month) : undefined,
            notes: notes || undefined,
          }),
        });

        const data = await response.json();
        if (data.success) {
          showStatus(data.message, 'success');
          // Clear form
          document.getElementById('recurringProductId').value = '';
          document.getElementById('recurringProductName').value = '';
          document.getElementById('recurringCustomerId').value = '';
          document.getElementById('recurringCustomerName').value = '';
          document.getElementById('recurringQuantity').value = '';
          document.getElementById('recurringMonth').value = '';
          document.getElementById('recurringNotes').value = '';
        } else {
          showStatus(data.error || 'Failed to save', 'error');
        }
      } catch (error) {
        showStatus('Error saving recurring order: ' + error.message, 'error');
      }
    }

    async function saveSubstituteRelationship() {
      const primaryProductId = document.getElementById('primaryProductId').value.trim();
      const primaryProductName = document.getElementById('primaryProductName').value.trim();
      const substituteProductId = document.getElementById('substituteProductId').value.trim();
      const substituteProductName = document.getElementById('substituteProductName').value.trim();
      const direction = document.getElementById('substituteDirection').value;
      const notes = document.getElementById('substituteNotes').value.trim();

      if (!primaryProductId || !substituteProductId) {
        showStatus('Please fill in both product IDs', 'error');
        return;
      }

      try {
        const response = await fetch('/api/purchasing/context/substitute-relationship', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            primary_product_id: primaryProductId,
            primary_product_name: primaryProductName || undefined,
            substitute_product_id: substituteProductId,
            substitute_product_name: substituteProductName || undefined,
            direction,
            notes: notes || undefined,
          }),
        });

        const data = await response.json();
        if (data.success) {
          showStatus(data.message, 'success');
          // Clear form
          document.getElementById('primaryProductId').value = '';
          document.getElementById('primaryProductName').value = '';
          document.getElementById('substituteProductId').value = '';
          document.getElementById('substituteProductName').value = '';
          document.getElementById('substituteNotes').value = '';
        } else {
          showStatus(data.error || 'Failed to save', 'error');
        }
      } catch (error) {
        showStatus('Error saving substitute relationship: ' + error.message, 'error');
      }
    }

    async function saveOneTimeOrder() {
      const date = document.getElementById('onetimeDate').value;
      const productId = document.getElementById('onetimeProductId').value.trim();
      const productName = document.getElementById('onetimeProductName').value.trim();
      const quantity = parseInt(document.getElementById('onetimeQuantity').value);
      const customerId = document.getElementById('onetimeCustomerId').value.trim();
      const customerName = document.getElementById('onetimeCustomerName').value.trim();
      const reason = document.getElementById('onetimeReason').value.trim();
      const excludeFromForecast = document.getElementById('onetimeExclude').checked;

      if (!date || !productId || !quantity || !reason) {
        showStatus('Please fill in all required fields', 'error');
        return;
      }

      try {
        const response = await fetch('/api/purchasing/context/one-time-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            date,
            product_id: productId,
            product_name: productName || undefined,
            quantity,
            customer_id: customerId || undefined,
            customer_name: customerName || undefined,
            reason,
            exclude_from_forecast: excludeFromForecast,
          }),
        });

        const data = await response.json();
        if (data.success) {
          showStatus(data.message, 'success');
          // Clear form
          document.getElementById('onetimeDate').value = '';
          document.getElementById('onetimeProductId').value = '';
          document.getElementById('onetimeProductName').value = '';
          document.getElementById('onetimeQuantity').value = '';
          document.getElementById('onetimeCustomerId').value = '';
          document.getElementById('onetimeCustomerName').value = '';
          document.getElementById('onetimeReason').value = '';
        } else {
          showStatus(data.error || 'Failed to save', 'error');
        }
      } catch (error) {
        showStatus('Error saving one-time order: ' + error.message, 'error');
      }
    }

    async function loadContextHistory() {
      const container = document.getElementById('contextHistory');
      container.innerHTML = '<div class="loading-spinner mx-auto"></div>';

      try {
        const response = await fetch('/api/purchasing/context/recent?limit=30');
        const data = await response.json();

        if (data.success && data.data.length > 0) {
          container.innerHTML = data.data.map(ctx => {
            const typeLabel = getContextTypeLabel(ctx.type);
            const typeColor = getContextTypeColor(ctx.type);
            const description = getContextDescription(ctx);
            const date = new Date(ctx.createdAt).toLocaleDateString('en-GB');

            return `
              <div class="border rounded-lg p-3 ${typeColor}">
                <div class="flex justify-between items-start">
                  <div>
                    <span class="text-xs font-medium px-2 py-1 rounded ${typeColor}">${typeLabel}</span>
                    <span class="text-xs text-gray-500 ml-2">${date}</span>
                  </div>
                  <button onclick="deleteContext('${ctx._id}')" class="text-red-500 hover:text-red-700 text-xs">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
                <p class="text-sm mt-2">${description}</p>
              </div>
            `;
          }).join('');
        } else {
          container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No context recorded yet. Add some using the forms above.</p>';
        }
      } catch (error) {
        container.innerHTML = `<p class="text-red-500 text-sm">Error loading history: ${error.message}</p>`;
      }
    }

    function getContextTypeLabel(type) {
      const labels = {
        'recurring_customer_order': 'Recurring Order',
        'substitute_relationship': 'Substitute',
        'one_time_order': 'One-Time',
        'substitution': 'Substitution Event',
        'promotion': 'Promotion',
        'supply_disruption': 'Disruption',
        'product_note': 'Note',
      };
      return labels[type] || type;
    }

    function getContextTypeColor(type) {
      const colors = {
        'recurring_customer_order': 'bg-indigo-50 border-indigo-200',
        'substitute_relationship': 'bg-amber-50 border-amber-200',
        'one_time_order': 'bg-green-50 border-green-200',
        'substitution': 'bg-orange-50 border-orange-200',
        'promotion': 'bg-purple-50 border-purple-200',
        'supply_disruption': 'bg-red-50 border-red-200',
        'product_note': 'bg-gray-50 border-gray-200',
      };
      return colors[type] || 'bg-gray-50 border-gray-200';
    }

    function getContextDescription(ctx) {
      switch (ctx.type) {
        case 'recurring_customer_order':
          return `<strong>${ctx.customer?.name || ctx.customer?.id}</strong> buys ` +
            `<strong>${ctx.pattern?.typicalQuantity}</strong> units of ` +
            `<strong>${ctx.product?.name || ctx.product?.id}</strong> ${ctx.pattern?.frequency}` +
            (ctx.pattern?.typicalMonth ? ` (month ${ctx.pattern.typicalMonth})` : '');
        case 'substitute_relationship':
          return `<strong>${ctx.substituteProduct?.name || ctx.substituteProduct?.id}</strong> ` +
            `can substitute for <strong>${ctx.primaryProduct?.name || ctx.primaryProduct?.id}</strong>` +
            (ctx.direction === 'bidirectional' ? ' (bidirectional)' : '');
        case 'one_time_order':
          return `One-time order of <strong>${ctx.quantity}</strong> units of ` +
            `<strong>${ctx.product?.name || ctx.product?.id}</strong>: ${ctx.reason}`;
        case 'substitution':
          return `Delivered <strong>${ctx.quantity}</strong> units of ` +
            `<strong>${ctx.substitutedProduct?.name || ctx.substitutedProduct?.id}</strong> ` +
            `instead of <strong>${ctx.originalProduct?.name || ctx.originalProduct?.id}</strong>`;
        default:
          return ctx.note || ctx.reason || JSON.stringify(ctx).substring(0, 100);
      }
    }

    async function deleteContext(contextId) {
      if (!confirm('Are you sure you want to delete this context entry?')) return;

      try {
        const response = await fetch(`/api/purchasing/context/${contextId}`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (data.success) {
          showStatus('Context deleted successfully', 'success');
          loadContextHistory();
        } else {
          showStatus(data.error || 'Failed to delete', 'error');
        }
      } catch (error) {
        showStatus('Error deleting context: ' + error.message, 'error');
      }
    }

    // ==================== END TRAINING SECTION ====================

    function downloadExcel() {
      if (allRecommendations.length === 0) {
        showStatus('No recommendations to export', 'error');
        return;
      }

      // Build CSV content (Excel compatible)
      const headers = ['Product Name', 'SKU', 'Urgency', 'Current Stock', 'Incoming', 'Days of Stock', 'Avg Daily Sales', 'Recommended Order Qty', 'MOQ', 'Reorder Point', 'Safety Stock', 'Supplier Lead Time', 'Total Lead Time (days)'];

      const rows = allRecommendations.map(rec => {
        const currentStock = rec.currentState?.currentStock ?? rec.product?.currentStock ?? 0;
        const incoming = rec.currentState?.incoming ?? 0;
        const daysOfStock = rec.currentState?.daysOfStock ?? 0;
        const avgDailySales = rec.calculations?.avgDailySales?.toFixed(2) ?? '0';
        const orderQty = rec.orderQuantity ?? rec.recommendation?.orderQuantity ?? 0;
        const moq = rec.calculations?.moq ?? 1;
        const reorderPoint = rec.calculations?.reorderPoint ?? '';
        const safetyStock = rec.calculations?.safetyStock ?? '';
        const supplierLeadTime = rec.calculations?.supplierLeadTimeDays ?? 'default';
        const leadTime = rec.calculations?.leadTimeDays ?? '';

        return [
          `"${(rec.product?.name || '').replace(/"/g, '""')}"`,
          `"${rec.product?.sku || ''}"`,
          rec.urgency || '',
          currentStock,
          incoming,
          daysOfStock,
          avgDailySales,
          orderQty,
          moq,
          reorderPoint,
          safetyStock,
          supplierLeadTime,
          leadTime
        ].join(',');
      });

      const csvContent = [headers.join(','), ...rows].join('\n');

      // Add BOM for Excel UTF-8 compatibility
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });

      // Create download link
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `purchasing_recommendations_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showStatus('Excel file downloaded', 'info');
    }
  </script>
</body>
</html>
