<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent5</title>
  <script src="/test/app/shell-v2.js"></script>
  <style>
    .home {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 32px;
    }

    .home-header {
      margin-bottom: 48px;
    }

    .home-greeting {
      font-size: 32px;
      font-weight: 700;
      color: #fff;
      margin: 0 0 8px 0;
    }

    .home-subtitle {
      font-size: 16px;
      color: #71717a;
    }

    /* Module Grid */
    .modules-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 48px;
    }

    @media (max-width: 1200px) {
      .modules-grid { grid-template-columns: repeat(3, 1fr); }
    }

    @media (max-width: 900px) {
      .modules-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 600px) {
      .modules-grid { grid-template-columns: 1fr; }
    }

    .module-tile {
      position: relative;
      background: linear-gradient(135deg, #18181f 0%, #1a1a24 100%);
      border: 1px solid #252532;
      border-radius: 20px;
      padding: 28px;
      text-decoration: none;
      transition: all 0.25s ease;
      overflow: hidden;
    }

    .module-tile::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--module-color), transparent);
      opacity: 0;
      transition: opacity 0.25s;
    }

    .module-tile:hover {
      transform: translateY(-4px);
      border-color: var(--module-color);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3), 0 0 0 1px var(--module-color);
    }

    .module-tile:hover::before {
      opacity: 1;
    }

    .module-tile.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .module-icon {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: color-mix(in srgb, var(--module-color) 15%, transparent);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }

    .module-icon .material-symbols-outlined {
      font-size: 28px;
      color: var(--module-color);
    }

    .module-icon img {
      width: 32px;
      height: 32px;
      object-fit: contain;
    }

    .module-name {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 6px;
    }

    .module-desc {
      font-size: 13px;
      color: #71717a;
      line-height: 1.5;
      margin-bottom: 16px;
    }

    .module-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: #ef4444;
    }

    .module-badge.success {
      background: rgba(34, 197, 94, 0.15);
      border-color: rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }

    .module-badge .material-symbols-outlined {
      font-size: 14px;
    }

    /* Activity Section */
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title .material-symbols-outlined {
      font-size: 22px;
      color: #6366f1;
    }

    .activity-feed {
      background: #18181f;
      border: 1px solid #252532;
      border-radius: 16px;
      overflow: hidden;
    }

    .activity-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      border-bottom: 1px solid #252532;
      transition: background 0.15s;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-item:hover {
      background: #1a1a28;
    }

    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .activity-icon .material-symbols-outlined {
      font-size: 20px;
    }

    .activity-content {
      flex: 1;
      min-width: 0;
    }

    .activity-title {
      font-size: 14px;
      font-weight: 500;
      color: #fff;
      margin-bottom: 2px;
    }

    .activity-meta {
      font-size: 12px;
      color: #71717a;
    }

    .activity-time {
      font-size: 12px;
      color: #71717a;
      flex-shrink: 0;
    }

    .activity-empty {
      padding: 40px;
      text-align: center;
      color: #71717a;
    }

    .activity-empty .material-symbols-outlined {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Stats Row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 48px;
    }

    @media (max-width: 900px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
    }

    .stat-card {
      background: #18181f;
      border: 1px solid #252532;
      border-radius: 12px;
      padding: 20px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 13px;
      color: #71717a;
    }

    /* No Access State */
    .no-access {
      text-align: center;
      padding: 80px 20px;
    }

    .no-access-icon {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      background: rgba(99, 102, 241, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }

    .no-access-icon .material-symbols-outlined {
      font-size: 40px;
      color: #6366f1;
    }

    .no-access-title {
      font-size: 24px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
    }

    .no-access-text {
      font-size: 15px;
      color: #71717a;
      max-width: 400px;
      margin: 0 auto;
    }

    /* Loading */
    .skeleton {
      background: linear-gradient(90deg, #252532 25%, #2a2a38 50%, #252532 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body>
  <div class="home">
    <header class="home-header">
      <h1 class="home-greeting" id="greeting">Welcome</h1>
      <p class="home-subtitle">Select a module to get started</p>
    </header>

    <!-- Module Grid -->
    <div class="modules-grid" id="modules-grid">
      <!-- Modules will be injected here -->
    </div>

    <!-- Quick Stats -->
    <div class="stats-row" id="stats-row">
      <div class="stat-card">
        <div class="stat-value" id="stat-pos">--</div>
        <div class="stat-label">Pending Vendor POs</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-orders">--</div>
        <div class="stat-label">Amazon Orders Today</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-products">--</div>
        <div class="stat-label">Products in Odoo</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-agents">12</div>
        <div class="stat-label">AI Agents Active</div>
      </div>
    </div>

    <!-- Recent Activity -->
    <h2 class="section-title">
      <span class="material-symbols-outlined">history</span>
      Recent Activity
    </h2>
    <div class="activity-feed" id="activity-feed">
      <div class="activity-empty">
        <span class="material-symbols-outlined">pending_actions</span>
        <div>Loading activity...</div>
      </div>
    </div>
  </div>

  <script>
    // Module definitions (should match shell-v2.js)
    // Use 'logo' for PNG image URL, or 'icon' for Material Symbol name
    const MODULES = [
      {
        id: 'ai-agents', name: 'AI Agents', icon: 'smart_toy', color: '#6366f1',
        // logo: '/assets/logos/ai-agents.png',  // Optional: use PNG instead of icon
        description: 'Chat with AI agents, train models, orchestrate workflows',
        path: '/test/app/ai/',
        notificationEndpoint: '/api/ai/notifications'
      },
      {
        id: 'call-center', name: 'Call Center', icon: 'headset_mic', color: '#22c55e',
        description: 'Voice AI calls, campaigns, and contact management',
        path: '/test/app/calls/',
        notificationEndpoint: '/api/calls/notifications'
      },
      {
        id: 'amazon-seller', name: 'Amazon Seller', icon: 'storefront', color: '#f59e0b',
        description: 'Seller Central orders, settlements, and reports',
        path: '/test/app/seller/',
        notificationEndpoint: '/api/amazon/notifications'
      },
      {
        id: 'amazon-vendor', name: 'Amazon Vendor', icon: 'local_shipping', color: '#f97316',
        description: 'Vendor Central purchase orders, invoices, shipments',
        path: '/test/app/vendor/',
        notificationEndpoint: '/api/vendor/notifications'
      },
      {
        id: 'inventory', name: 'Inventory', icon: 'inventory_2', color: '#8b5cf6',
        description: 'Products, purchasing intelligence, stock optimization',
        path: '/test/app/inventory/',
        notificationEndpoint: '/api/inventory/notifications'
      },
      {
        id: 'accounting', name: 'Accounting', icon: 'account_balance', color: '#14b8a6',
        description: 'VCS invoicing, remittances, and chargebacks',
        path: '/test/app/accounting/',
        notificationEndpoint: '/api/accounting/notifications'
      },
      {
        id: 'analytics', name: 'Analytics', icon: 'analytics', color: '#ec4899',
        description: 'Dashboards, reports, and KPIs',
        path: '/test/app/analytics/',
        notificationEndpoint: null
      },
      {
        id: 'settings', name: 'Settings', icon: 'settings', color: '#64748b',
        description: 'Users, roles, integrations, and configuration',
        path: '/test/app/settings/',
        notificationEndpoint: null,
        adminOnly: true
      }
    ];

    let currentUser = null;
    let userModules = []; // Modules user has access to

    async function init() {
      // Wait for shell to load user
      await new Promise(resolve => {
        const check = () => {
          if (window.Agent5Shell && window.Agent5Shell.getCurrentUser()) {
            resolve();
          } else {
            setTimeout(check, 100);
          }
        };
        check();
      });

      currentUser = window.Agent5Shell.getCurrentUser();

      // Set greeting
      const hour = new Date().getHours();
      let greeting = 'Good morning';
      if (hour >= 12 && hour < 17) greeting = 'Good afternoon';
      else if (hour >= 17) greeting = 'Good evening';
      const name = currentUser?.email?.split('@')[0] || 'there';
      document.getElementById('greeting').textContent = `${greeting}, ${name}`;

      // For now, show all modules (permissions will be added later)
      // In the future, this will filter based on user permissions
      userModules = MODULES.filter(m => {
        // Hide admin-only modules for non-admins
        if (m.adminOnly && !['admin', 'superadmin'].includes(currentUser?.role)) {
          return false;
        }
        return true;
      });

      renderModules();
      loadStats();
      loadActivity();
      loadNotifications();
    }

    function renderModules() {
      const grid = document.getElementById('modules-grid');

      if (userModules.length === 0) {
        grid.innerHTML = `
          <div class="no-access" style="grid-column: 1 / -1;">
            <div class="no-access-icon">
              <span class="material-symbols-outlined">lock</span>
            </div>
            <h2 class="no-access-title">No Module Access</h2>
            <p class="no-access-text">
              You don't have access to any modules yet. Please contact your administrator to get access.
            </p>
          </div>
        `;
        return;
      }

      grid.innerHTML = userModules.map(m => `
        <a href="${m.path}" class="module-tile" style="--module-color: ${m.color};">
          <div class="module-icon">
            ${m.logo
              ? `<img src="${m.logo}" alt="${m.name}">`
              : `<span class="material-symbols-outlined">${m.icon}</span>`
            }
          </div>
          <div class="module-name">${m.name}</div>
          <div class="module-desc">${m.description}</div>
          <div class="module-badge-container" id="badge-${m.id}"></div>
        </a>
      `).join('');
    }

    async function loadStats() {
      // Load vendor POs
      try {
        const res = await fetch('/api/vendor/orders?status=New&limit=1', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('stat-pos').textContent = data.total || 0;
        }
      } catch (e) {
        document.getElementById('stat-pos').textContent = '--';
      }

      // Load Amazon orders
      try {
        const res = await fetch('/api/amazon/orders?limit=1', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('stat-orders').textContent = data.total || 0;
        }
      } catch (e) {
        document.getElementById('stat-orders').textContent = '--';
      }

      // Load Odoo products
      try {
        const res = await fetch('/api/odoo/dashboard', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('stat-products').textContent = data.products || 0;
        }
      } catch (e) {
        document.getElementById('stat-products').textContent = '--';
      }
    }

    async function loadActivity() {
      const feed = document.getElementById('activity-feed');
      const activities = [];

      // Try to load recent vendor orders
      try {
        const res = await fetch('/api/vendor/orders?limit=3', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          if (data.orders) {
            data.orders.forEach(po => {
              activities.push({
                icon: 'local_shipping',
                iconBg: 'rgba(249, 115, 22, 0.15)',
                iconColor: '#f97316',
                title: `Vendor PO: ${po.purchaseOrderNumber}`,
                meta: `${po.marketplace || 'EU'} · ${po.purchaseOrderState}`,
                time: formatTime(po.purchaseOrderDate)
              });
            });
          }
        }
      } catch (e) {}

      // Try to load recent Amazon orders
      try {
        const res = await fetch('/api/amazon/orders?limit=3', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          if (data.orders) {
            data.orders.forEach(order => {
              activities.push({
                icon: 'shopping_cart',
                iconBg: 'rgba(245, 158, 11, 0.15)',
                iconColor: '#f59e0b',
                title: `Order: ${order.amazonOrderId}`,
                meta: `${order.salesChannel} · ${order.orderStatus}`,
                time: formatTime(order.purchaseDate)
              });
            });
          }
        }
      } catch (e) {}

      // Sort by time and take top 5
      activities.sort((a, b) => new Date(b.rawTime || 0) - new Date(a.rawTime || 0));

      if (activities.length === 0) {
        feed.innerHTML = `
          <div class="activity-empty">
            <span class="material-symbols-outlined">inbox</span>
            <div>No recent activity</div>
          </div>
        `;
        return;
      }

      feed.innerHTML = activities.slice(0, 5).map(a => `
        <div class="activity-item">
          <div class="activity-icon" style="background: ${a.iconBg};">
            <span class="material-symbols-outlined" style="color: ${a.iconColor};">${a.icon}</span>
          </div>
          <div class="activity-content">
            <div class="activity-title">${a.title}</div>
            <div class="activity-meta">${a.meta}</div>
          </div>
          <div class="activity-time">${a.time}</div>
        </div>
      `).join('');
    }

    async function loadNotifications() {
      // Load notification counts for each module
      for (const m of userModules) {
        if (!m.notificationEndpoint) continue;

        try {
          const res = await fetch(m.notificationEndpoint, { credentials: 'include' });
          if (res.ok) {
            const data = await res.json();
            if (data.count > 0) {
              const badgeContainer = document.getElementById(`badge-${m.id}`);
              if (badgeContainer) {
                badgeContainer.innerHTML = `
                  <div class="module-badge">
                    <span class="material-symbols-outlined">notifications</span>
                    ${data.count} pending
                  </div>
                `;
              }
            }
          }
        } catch (e) {
          // Ignore notification errors
        }
      }
    }

    function formatTime(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;

      return date.toLocaleDateString();
    }

    init();
  </script>
</body>
</html>
