<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - Amazon Vendor</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <script src="/test/app/shell-v2.js"></script>
  <style>
    .page { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .page-title { font-size: 24px; font-weight: 700; color: #fff; margin: 0; }
    .header-actions { display: flex; gap: 12px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-primary { background: #f97316; color: white; }
    .btn-primary:hover { background: #ea580c; }
    .btn-secondary { background: #252532; color: #e4e4e7; border: 1px solid #3f3f50; }
    .btn-secondary:hover { background: #2a2a3a; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .btn .material-symbols-outlined { font-size: 20px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .card { background: #18181f; border: 1px solid #252532; border-radius: 16px; overflow: hidden; margin-bottom: 24px; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid #252532; display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-size: 16px; font-weight: 600; color: #fff; margin: 0; }
    .card-body { padding: 20px; }
    .marketplace-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
    .marketplace-card { background: #12121a; border: 1px solid #252532; border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px; }
    .marketplace-icon { width: 40px; height: 40px; border-radius: 10px; background: #252532; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; color: #a1a1aa; }
    .marketplace-icon.active { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .marketplace-info { flex: 1; }
    .marketplace-name { font-size: 14px; font-weight: 600; color: #e4e4e7; margin-bottom: 2px; }
    .marketplace-status { font-size: 12px; color: #71717a; }
    .marketplace-status.active { color: #4ade80; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 14px 16px; text-align: left; border-bottom: 1px solid #252532; }
    th { background: #12121a; font-size: 12px; font-weight: 600; color: #71717a; text-transform: uppercase; }
    td { font-size: 14px; color: #e4e4e7; }
    tr:hover td { background: #1a1a28; }
    .badge { display: inline-flex; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .badge-success { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .badge-warning { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
    .empty-state { padding: 40px 20px; text-align: center; }
    .empty-state .material-symbols-outlined { font-size: 48px; color: #3f3f50; margin-bottom: 16px; }
    .empty-state-title { font-size: 16px; font-weight: 600; color: #e4e4e7; margin-bottom: 8px; }
    .empty-state-desc { font-size: 14px; color: #71717a; }
    .action-btn { width: 32px; height: 32px; border-radius: 8px; background: #252532; border: none; color: #71717a; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .action-btn:hover { background: #3f3f50; color: #e4e4e7; }
    .action-btn.danger:hover { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .action-btn .material-symbols-outlined { font-size: 18px; }
    .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px; }
    .stat-card { background: #12121a; border: 1px solid #252532; border-radius: 10px; padding: 16px; text-align: center; }
    .stat-value { font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 4px; }
    .stat-label { font-size: 12px; color: #71717a; }
    .stat-card.warning .stat-value { color: #fbbf24; }
    .stat-card.success .stat-value { color: #4ade80; }
    /* Modal */
    .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal-backdrop.show { display: flex; }
    .modal { background: #18181f; border: 1px solid #252532; border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow: hidden; }
    .modal-header { padding: 16px 20px; border-bottom: 1px solid #252532; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 18px; font-weight: 600; color: #fff; margin: 0; }
    .modal-close { width: 32px; height: 32px; border-radius: 8px; background: transparent; border: none; color: #71717a; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { background: #252532; color: #e4e4e7; }
    .modal-body { padding: 20px; overflow-y: auto; max-height: calc(90vh - 140px); }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; font-weight: 500; color: #a1a1aa; margin-bottom: 6px; }
    .form-input, .form-select { width: 100%; padding: 10px 14px; background: #12121a; border: 1px solid #252532; border-radius: 8px; color: #e4e4e7; font-size: 14px; }
    .form-input:focus, .form-select:focus { outline: none; border-color: #f97316; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid #252532; display: flex; justify-content: flex-end; gap: 12px; }
    .search-results { max-height: 200px; overflow-y: auto; border: 1px solid #252532; border-radius: 8px; margin-top: 8px; }
    .search-result { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #252532; }
    .search-result:last-child { border-bottom: none; }
    .search-result:hover { background: #252532; }
    .search-result-name { font-size: 14px; color: #e4e4e7; }
    .search-result-ref { font-size: 12px; color: #71717a; }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-header">
      <h1 class="page-title">Vendor Central Settings</h1>
    </header>

    <!-- Marketplace Configuration -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Marketplace Configuration</h3>
      </div>
      <div class="card-body">
        <div class="marketplace-grid" id="marketplace-grid">
          <div class="empty-state"><span class="material-symbols-outlined">hourglass_empty</span><div class="empty-state-title">Loading...</div></div>
        </div>
      </div>
    </div>

    <!-- Party Mappings -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Amazon Party → Odoo Partner Mappings</h3>
        <div class="header-actions">
          <button class="btn btn-secondary btn-sm" onclick="importFromOdoo()" id="import-btn">
            <span class="material-symbols-outlined">download</span>Import from Odoo
          </button>
          <button class="btn btn-primary btn-sm" onclick="showAddMappingModal()">
            <span class="material-symbols-outlined">add</span>Add Mapping
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="stats-row">
          <div class="stat-card success"><div class="stat-value" id="stat-mapped">--</div><div class="stat-label">Mapped Parties</div></div>
          <div class="stat-card warning"><div class="stat-value" id="stat-unmapped">--</div><div class="stat-label">Unmapped Parties</div></div>
          <div class="stat-card"><div class="stat-value" id="stat-total">--</div><div class="stat-label">Total</div></div>
        </div>
        <div class="table-container">
          <table>
            <thead><tr><th>Amazon Party ID</th><th>Party Name</th><th>Marketplace</th><th>Odoo Partner</th><th>Actions</th></tr></thead>
            <tbody id="mappings-table"><tr><td colspan="5"><div class="empty-state"><span class="material-symbols-outlined">hourglass_empty</span><div class="empty-state-title">Loading...</div></div></td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Unmapped Parties -->
    <div class="card" id="unmapped-section" style="display: none;">
      <div class="card-header">
        <h3 class="card-title">Unmapped Parties (Need Attention)</h3>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table>
            <thead><tr><th>Amazon Party ID</th><th>Party Name</th><th>Marketplace</th><th>Last Seen</th><th>Actions</th></tr></thead>
            <tbody id="unmapped-table"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Mapping Modal -->
  <div class="modal-backdrop" id="mapping-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">Add Party Mapping</h3>
        <button class="modal-close" onclick="closeModal()"><span class="material-symbols-outlined">close</span></button>
      </div>
      <div class="modal-body">
        <form id="mapping-form" onsubmit="saveMapping(event)">
          <div class="form-group">
            <label class="form-label">Amazon Party ID *</label>
            <input type="text" class="form-input" id="party-id" required placeholder="e.g., ATVPDKIKX0DER">
          </div>
          <div class="form-group">
            <label class="form-label">Party Name</label>
            <input type="text" class="form-input" id="party-name" placeholder="e.g., Amazon EU S.à r.l.">
          </div>
          <div class="form-group">
            <label class="form-label">Marketplace</label>
            <select class="form-select" id="party-marketplace">
              <option value="">Select...</option>
              <option value="DE">Germany (DE)</option>
              <option value="FR">France (FR)</option>
              <option value="IT">Italy (IT)</option>
              <option value="ES">Spain (ES)</option>
              <option value="NL">Netherlands (NL)</option>
              <option value="BE">Belgium (BE)</option>
              <option value="PL">Poland (PL)</option>
              <option value="SE">Sweden (SE)</option>
              <option value="UK">United Kingdom (UK)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Odoo Partner</label>
            <input type="text" class="form-input" id="odoo-search" placeholder="Search Odoo partners..." oninput="searchOdooPartners(this.value)">
            <input type="hidden" id="odoo-partner-id">
            <div class="search-results" id="odoo-results" style="display: none;"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="document.getElementById('mapping-form').requestSubmit()">Save</button>
      </div>
    </div>
  </div>

  <script>
    const MARKETPLACES = ['DE', 'FR', 'IT', 'ES', 'NL', 'BE', 'PL', 'SE', 'UK'];
    const MARKETPLACE_NAMES = { DE: 'Germany', FR: 'France', IT: 'Italy', ES: 'Spain', NL: 'Netherlands', BE: 'Belgium', PL: 'Poland', SE: 'Sweden', UK: 'United Kingdom' };
    const MARKETPLACE_CODES = { DE: 'de', FR: 'fr', IT: 'it', ES: 'es', NL: 'nl', BE: 'be', PL: 'pl', SE: 'se', UK: 'gb' };

    function getFlagUrl(mp) {
      var code = MARKETPLACE_CODES[mp];
      return code ? 'https://flagcdn.com/w80/' + code + '.png' : null;
    }
    function getFlagImg(mp, size) {
      var code = MARKETPLACE_CODES[mp];
      if (!code) return mp;
      var w = size || 24;
      var h = Math.round(w * 0.67);
      return '<img src="https://flagcdn.com/w80/' + code + '.png" alt="' + mp + '" style="width:' + w + 'px;height:' + h + 'px;object-fit:cover;border-radius:3px;vertical-align:middle;">';
    }

    async function init() {
      await Promise.all([loadConfig(), loadMappings(), loadUnmapped(), loadMappingStats()]);
    }

    async function loadConfig() {
      try {
        const res = await fetch('/api/vendor/config', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        const configured = data.config?.configuredMarketplaces || [];
        const grid = document.getElementById('marketplace-grid');
        grid.innerHTML = MARKETPLACES.map(mp => {
          const active = configured.includes(mp);
          const flagUrl = getFlagUrl(mp);
          return '<div class="marketplace-card">' +
            '<div class="marketplace-icon ' + (active ? 'active' : '') + '" style="background-image: url(' + flagUrl + '); background-size: cover; background-position: center;"></div>' +
            '<div class="marketplace-info">' +
              '<div class="marketplace-name">' + MARKETPLACE_NAMES[mp] + '</div>' +
              '<div class="marketplace-status ' + (active ? 'active' : '') + '">' + (active ? 'Configured' : 'Not configured') + '</div>' +
            '</div>' +
          '</div>';
        }).join('');
      } catch (e) {
        document.getElementById('marketplace-grid').innerHTML = '<div class="empty-state"><span class="material-symbols-outlined">error</span><div class="empty-state-title">Failed to load</div></div>';
      }
    }

    async function loadMappingStats() {
      try {
        const res = await fetch('/api/vendor/party-mappings/stats', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        const s = data.stats || {};
        document.getElementById('stat-mapped').textContent = s.mapped || 0;
        document.getElementById('stat-unmapped').textContent = s.unmapped || 0;
        document.getElementById('stat-total').textContent = s.total || 0;
      } catch (e) { console.error(e); }
    }

    async function loadMappings() {
      try {
        const res = await fetch('/api/vendor/party-mappings', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        const mappings = data.mappings || [];
        const tbody = document.getElementById('mappings-table');
        if (mappings.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><span class="material-symbols-outlined">link_off</span><div class="empty-state-title">No party mappings</div><div class="empty-state-desc">Add mappings to link Amazon parties to Odoo partners</div></div></td></tr>';
          return;
        }
        tbody.innerHTML = mappings.map(function(m) {
          var pid = m.partyId || m.amazonPartyId || '-';
          var mp = m.marketplace || m.marketplaceId || '-';
          return '<tr>' +
            '<td><code>' + pid + '</code></td>' +
            '<td>' + (m.partyName || m.odooPartnerName || '-') + '</td>' +
            '<td>' + getFlagImg(mp) + ' ' + mp + '</td>' +
            '<td>' + (m.odooPartnerId ? (m.odooPartnerName || '') + ' (' + m.odooPartnerId + ')' : '<span class="badge badge-warning">Not linked</span>') + '</td>' +
            '<td>' +
              '<button class="action-btn" onclick="editMapping(\'' + pid + '\')" title="Edit"><span class="material-symbols-outlined">edit</span></button>' +
              '<button class="action-btn danger" onclick="deleteMapping(\'' + pid + '\')" title="Delete"><span class="material-symbols-outlined">delete</span></button>' +
            '</td>' +
          '</tr>';
        }).join('');
      } catch (e) {
        document.getElementById('mappings-table').innerHTML = '<tr><td colspan="5"><div class="empty-state"><span class="material-symbols-outlined">error</span><div class="empty-state-title">Failed to load</div></div></td></tr>';
      }
    }

    async function loadUnmapped() {
      try {
        const res = await fetch('/api/vendor/party-mappings/unmapped', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        const unmapped = data.unmapped || [];
        const section = document.getElementById('unmapped-section');
        if (unmapped.length === 0) { section.style.display = 'none'; return; }
        section.style.display = 'block';
        document.getElementById('unmapped-table').innerHTML = unmapped.map(function(u) {
          var pid = u.partyId || u.amazonPartyId || '-';
          var mp = u.marketplace || u.marketplaceId || '-';
          return '<tr>' +
            '<td><code>' + pid + '</code></td>' +
            '<td>' + (u.partyName || '-') + '</td>' +
            '<td>' + getFlagImg(mp) + ' ' + mp + '</td>' +
            '<td>' + formatDate(u.lastSeen) + '</td>' +
            '<td><button class="action-btn" onclick="mapParty(\'' + pid + '\', \'' + (u.partyName || '').replace(/'/g, "\\'") + '\', \'' + mp + '\')" title="Map"><span class="material-symbols-outlined">link</span></button></td>' +
          '</tr>';
        }).join('');
      } catch (e) { console.error(e); }
    }

    function formatDate(d) { return d ? new Date(d).toLocaleDateString('en-GB') : '-'; }

    function showAddMappingModal() {
      document.getElementById('modal-title').textContent = 'Add Party Mapping';
      document.getElementById('mapping-form').reset();
      document.getElementById('odoo-partner-id').value = '';
      document.getElementById('odoo-results').style.display = 'none';
      document.getElementById('mapping-modal').classList.add('show');
    }

    function mapParty(partyId, partyName, marketplace) {
      document.getElementById('modal-title').textContent = 'Map Party';
      document.getElementById('party-id').value = partyId;
      document.getElementById('party-name').value = partyName;
      document.getElementById('party-marketplace').value = marketplace;
      document.getElementById('odoo-partner-id').value = '';
      document.getElementById('odoo-search').value = '';
      document.getElementById('odoo-results').style.display = 'none';
      document.getElementById('mapping-modal').classList.add('show');
    }

    async function editMapping(partyId) {
      try {
        const res = await fetch('/api/vendor/party-mappings/' + encodeURIComponent(partyId), { credentials: 'include' });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        const m = data.mapping;
        document.getElementById('modal-title').textContent = 'Edit Party Mapping';
        document.getElementById('party-id').value = m.partyId || m.amazonPartyId || '';
        document.getElementById('party-name').value = m.partyName || m.odooPartnerName || '';
        document.getElementById('party-marketplace').value = m.marketplace || m.marketplaceId || '';
        document.getElementById('odoo-partner-id').value = m.odooPartnerId || '';
        document.getElementById('odoo-search').value = m.odooPartnerName || '';
        document.getElementById('mapping-modal').classList.add('show');
      } catch (e) { window.Agent5Shell?.showToast?.('Error: ' + e.message, 'error'); }
    }

    function closeModal() {
      document.getElementById('mapping-modal').classList.remove('show');
    }

    var searchTimeout;
    async function searchOdooPartners(query) {
      clearTimeout(searchTimeout);
      if (query.length < 2) {
        document.getElementById('odoo-results').style.display = 'none';
        return;
      }
      searchTimeout = setTimeout(async function() {
        try {
          const res = await fetch('/api/vendor/party-mappings/search-odoo?q=' + encodeURIComponent(query), { credentials: 'include' });
          if (!res.ok) return;
          const data = await res.json();
          const partners = data.partners || [];
          const resultsEl = document.getElementById('odoo-results');
          if (partners.length === 0) {
            resultsEl.innerHTML = '<div class="search-result"><div class="search-result-name">No partners found</div></div>';
          } else {
            resultsEl.innerHTML = partners.map(function(p) {
              return '<div class="search-result" onclick="selectOdooPartner(' + p.id + ', \'' + (p.name || '').replace(/'/g, "\\'") + '\')">' +
                '<div class="search-result-name">' + p.name + '</div>' +
                '<div class="search-result-ref">' + (p.ref || '') + ' ' + (p.vat || '') + '</div>' +
              '</div>';
            }).join('');
          }
          resultsEl.style.display = 'block';
        } catch (e) { console.error(e); }
      }, 300);
    }

    function selectOdooPartner(id, name) {
      document.getElementById('odoo-partner-id').value = id;
      document.getElementById('odoo-search').value = name;
      document.getElementById('odoo-results').style.display = 'none';
    }

    async function saveMapping(e) {
      e.preventDefault();
      var partyId = document.getElementById('party-id').value;
      var payload = {
        partyId: partyId,
        partyName: document.getElementById('party-name').value || null,
        marketplace: document.getElementById('party-marketplace').value || null,
        odooPartnerId: parseInt(document.getElementById('odoo-partner-id').value) || null,
        odooPartnerName: document.getElementById('odoo-search').value || null
      };
      try {
        const res = await fetch('/api/vendor/party-mappings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        if (!res.ok) { const d = await res.json(); throw new Error(d.error || 'Failed'); }
        window.Agent5Shell?.showToast?.('Mapping saved', 'success');
        closeModal();
        await Promise.all([loadMappings(), loadUnmapped(), loadMappingStats()]);
      } catch (e) { window.Agent5Shell?.showToast?.('Error: ' + e.message, 'error'); }
    }

    async function deleteMapping(partyId) {
      if (!confirm('Delete mapping for ' + partyId + '?')) return;
      try {
        const res = await fetch('/api/vendor/party-mappings/' + encodeURIComponent(partyId), {
          method: 'DELETE',
          credentials: 'include'
        });
        if (!res.ok) throw new Error('Failed');
        window.Agent5Shell?.showToast?.('Mapping deleted', 'success');
        await Promise.all([loadMappings(), loadUnmapped(), loadMappingStats()]);
      } catch (e) { window.Agent5Shell?.showToast?.('Error: ' + e.message, 'error'); }
    }

    async function importFromOdoo() {
      if (!confirm('Import party mappings from existing Odoo partners? This will search for partners with Amazon-related references.')) return;
      var btn = document.getElementById('import-btn');
      btn.disabled = true;
      try {
        const res = await fetch('/api/vendor/party-mappings/import-odoo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        window.Agent5Shell?.showToast?.('Imported ' + (data.imported || 0) + ' mappings', 'success');
        await Promise.all([loadMappings(), loadUnmapped(), loadMappingStats()]);
      } catch (e) { window.Agent5Shell?.showToast?.('Error: ' + e.message, 'error'); }
      finally { btn.disabled = false; }
    }

    init();
  </script>
</body>
</html>
