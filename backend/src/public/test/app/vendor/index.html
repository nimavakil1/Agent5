<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purchase Orders - Amazon Vendor</title>
  <script src="/test/app/shell-v2.js"></script>
  <style>
    .page {
      max-width: 1600px;
      margin: 0 auto;
      padding: 32px;
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      margin: 0;
    }

    .page-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
      text-decoration: none;
    }

    .btn .material-symbols-outlined {
      font-size: 20px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .btn-secondary {
      background: #252536;
      color: #e4e4e7;
      border: 1px solid #3f3f5a;
    }

    .btn-secondary:hover {
      background: #2a2a40;
      border-color: #6366f1;
    }

    .btn-success {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-label {
      font-size: 13px;
      color: #71717a;
      font-weight: 500;
    }

    .filter-select, .filter-input {
      background: #18181f;
      border: 1px solid #252532;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      color: #e4e4e7;
      min-width: 140px;
    }

    .filter-select:focus, .filter-input:focus {
      outline: none;
      border-color: #6366f1;
    }

    /* Stats Cards */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 1000px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
    }

    .stat-card {
      background: #18181f;
      border: 1px solid #252532;
      border-radius: 12px;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--stat-color, #6366f1);
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 13px;
      color: #71717a;
    }

    /* Table */
    .table-container {
      background: #18181f;
      border: 1px solid #252532;
      border-radius: 16px;
      overflow: hidden;
    }

    .table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid #252532;
    }

    .table-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }

    .table-count {
      font-size: 13px;
      color: #71717a;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #71717a;
      background: #1a1a24;
      border-bottom: 1px solid #252532;
    }

    td {
      padding: 16px;
      font-size: 14px;
      color: #e4e4e7;
      border-bottom: 1px solid #252532;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover {
      background: #1a1a28;
    }

    .po-number {
      font-weight: 600;
      color: #fff;
    }

    .po-number a {
      color: #6366f1;
      text-decoration: none;
    }

    .po-number a:hover {
      text-decoration: underline;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-badge.new {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
    }

    .status-badge.acknowledged {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .status-badge.closed {
      background: rgba(113, 113, 122, 0.15);
      color: #71717a;
    }

    .status-badge.shipped {
      background: rgba(139, 92, 246, 0.15);
      color: #8b5cf6;
    }

    /* Marketplace Badge */
    .marketplace-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      background: #252532;
      color: #a1a1aa;
    }

    /* Actions */
    .row-actions {
      display: flex;
      gap: 8px;
    }

    .row-action {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: #252536;
      border: 1px solid #3f3f5a;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #a1a1aa;
      transition: all 0.15s;
    }

    .row-action:hover {
      background: #6366f1;
      border-color: #6366f1;
      color: white;
    }

    .row-action .material-symbols-outlined {
      font-size: 18px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-icon {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      background: rgba(99, 102, 241, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
    }

    .empty-icon .material-symbols-outlined {
      font-size: 32px;
      color: #6366f1;
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 14px;
      color: #71717a;
    }

    /* Pagination */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-top: 1px solid #252532;
    }

    .pagination-info {
      font-size: 13px;
      color: #71717a;
    }

    .pagination-buttons {
      display: flex;
      gap: 8px;
    }

    .pagination-btn {
      padding: 8px 16px;
      border-radius: 8px;
      background: #252536;
      border: 1px solid #3f3f5a;
      color: #e4e4e7;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .pagination-btn:hover:not(:disabled) {
      background: #2a2a40;
      border-color: #6366f1;
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Loading */
    .loading-row td {
      padding: 20px;
    }

    .skeleton {
      background: linear-gradient(90deg, #252532 25%, #2a2a38 50%, #252532 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
      height: 20px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 20px;
      background: #18181f;
      border: 1px solid #252532;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-color: #22c55e;
    }

    .toast.error {
      border-color: #ef4444;
    }

    .toast-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toast.success .toast-icon {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .toast.error .toast-icon {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .toast-message {
      font-size: 14px;
      color: #e4e4e7;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-header">
      <h1 class="page-title">Purchase Orders</h1>
      <div class="page-actions">
        <button class="btn btn-secondary" id="btn-refresh">
          <span class="material-symbols-outlined">refresh</span>
          Refresh
        </button>
        <button class="btn btn-primary" id="btn-poll">
          <span class="material-symbols-outlined">cloud_download</span>
          Poll Amazon
        </button>
      </div>
    </header>

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-card" style="--stat-color: #3b82f6;">
        <div class="stat-value" id="stat-new">--</div>
        <div class="stat-label">New Orders</div>
      </div>
      <div class="stat-card" style="--stat-color: #22c55e;">
        <div class="stat-value" id="stat-ack">--</div>
        <div class="stat-label">Acknowledged</div>
      </div>
      <div class="stat-card" style="--stat-color: #8b5cf6;">
        <div class="stat-value" id="stat-shipped">--</div>
        <div class="stat-label">Shipped</div>
      </div>
      <div class="stat-card" style="--stat-color: #71717a;">
        <div class="stat-value" id="stat-total">--</div>
        <div class="stat-label">Total Orders</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <span class="filter-label">Status:</span>
        <select class="filter-select" id="filter-status">
          <option value="">All</option>
          <option value="New">New</option>
          <option value="Acknowledged">Acknowledged</option>
          <option value="Shipped">Shipped</option>
          <option value="Closed">Closed</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Marketplace:</span>
        <select class="filter-select" id="filter-marketplace">
          <option value="">All</option>
          <option value="DE">Germany</option>
          <option value="FR">France</option>
          <option value="NL">Netherlands</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Search:</span>
        <input type="text" class="filter-input" id="filter-search" placeholder="PO number...">
      </div>
    </div>

    <!-- Table -->
    <div class="table-container">
      <div class="table-header">
        <div class="table-title">Orders</div>
        <div class="table-count" id="table-count">Loading...</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>PO Number</th>
            <th>Marketplace</th>
            <th>Status</th>
            <th>Ship To</th>
            <th>Items</th>
            <th>Order Date</th>
            <th>Delivery Window</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="orders-tbody">
          <tr class="loading-row">
            <td colspan="8">
              <div class="skeleton" style="width: 100%;"></div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="pagination">
        <div class="pagination-info" id="pagination-info">Showing 0 of 0</div>
        <div class="pagination-buttons">
          <button class="pagination-btn" id="btn-prev" disabled>Previous</button>
          <button class="pagination-btn" id="btn-next" disabled>Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="toast-icon">
      <span class="material-symbols-outlined">check_circle</span>
    </div>
    <div class="toast-message" id="toast-message"></div>
  </div>

  <script>
    let orders = [];
    let page = 1;
    const limit = 20;
    let total = 0;

    async function loadOrders() {
      const tbody = document.getElementById('orders-tbody');
      tbody.innerHTML = `
        <tr class="loading-row">
          <td colspan="8"><div class="skeleton" style="width: 100%;"></div></td>
        </tr>
        <tr class="loading-row">
          <td colspan="8"><div class="skeleton" style="width: 80%;"></div></td>
        </tr>
        <tr class="loading-row">
          <td colspan="8"><div class="skeleton" style="width: 90%;"></div></td>
        </tr>
      `;

      const status = document.getElementById('filter-status').value;
      const marketplace = document.getElementById('filter-marketplace').value;
      const search = document.getElementById('filter-search').value;

      let url = `/api/vendor/orders?page=${page}&limit=${limit}`;
      if (status) url += `&status=${status}`;
      if (marketplace) url += `&marketplace=${marketplace}`;
      if (search) url += `&search=${search}`;

      try {
        const res = await fetch(url, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load orders');

        const data = await res.json();
        orders = data.orders || [];
        total = data.total || 0;

        renderOrders();
        updatePagination();
        loadStats();
      } catch (e) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <div class="empty-icon">
                  <span class="material-symbols-outlined">error</span>
                </div>
                <div class="empty-title">Failed to load orders</div>
                <div class="empty-text">${e.message}</div>
              </div>
            </td>
          </tr>
        `;
      }
    }

    function renderOrders() {
      const tbody = document.getElementById('orders-tbody');

      if (orders.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <div class="empty-icon">
                  <span class="material-symbols-outlined">inbox</span>
                </div>
                <div class="empty-title">No orders found</div>
                <div class="empty-text">Try adjusting your filters or poll Amazon for new orders.</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = orders.map(o => `
        <tr>
          <td class="po-number">
            <a href="/test/app/vendor/order?id=${o.purchaseOrderNumber}">${o.purchaseOrderNumber}</a>
          </td>
          <td><span class="marketplace-badge">${o.marketplace || 'EU'}</span></td>
          <td><span class="status-badge ${(o.purchaseOrderState || '').toLowerCase()}">${o.purchaseOrderState}</span></td>
          <td>${o.shipToParty?.partyId || '--'}</td>
          <td>${o.items?.length || 0} items</td>
          <td>${formatDate(o.purchaseOrderDate)}</td>
          <td>${formatDate(o.deliveryWindow?.startDate)} - ${formatDate(o.deliveryWindow?.endDate)}</td>
          <td>
            <div class="row-actions">
              ${o.purchaseOrderState === 'New' ? `
                <button class="row-action" title="Acknowledge" onclick="acknowledgePO('${o.purchaseOrderNumber}')">
                  <span class="material-symbols-outlined">check_circle</span>
                </button>
              ` : ''}
              ${!o.odoo?.saleOrderId ? `
                <button class="row-action" title="Create Odoo Order" onclick="createOdooOrder('${o.purchaseOrderNumber}')">
                  <span class="material-symbols-outlined">add_shopping_cart</span>
                </button>
              ` : `
                <button class="row-action" title="View in Odoo" onclick="openOdoo(${o.odoo.saleOrderId})">
                  <span class="material-symbols-outlined">open_in_new</span>
                </button>
              `}
            </div>
          </td>
        </tr>
      `).join('');
    }

    async function loadStats() {
      try {
        const res = await fetch('/api/vendor/stats', { credentials: 'include' });
        if (res.ok) {
          const stats = await res.json();
          document.getElementById('stat-new').textContent = stats.new || 0;
          document.getElementById('stat-ack').textContent = stats.acknowledged || 0;
          document.getElementById('stat-shipped').textContent = stats.shipped || 0;
          document.getElementById('stat-total').textContent = stats.total || 0;
        }
      } catch (e) {}
    }

    function updatePagination() {
      const start = (page - 1) * limit + 1;
      const end = Math.min(page * limit, total);
      document.getElementById('table-count').textContent = `${total} orders`;
      document.getElementById('pagination-info').textContent = `Showing ${start}-${end} of ${total}`;
      document.getElementById('btn-prev').disabled = page <= 1;
      document.getElementById('btn-next').disabled = page * limit >= total;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '--';
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    async function pollAmazon() {
      showToast('Polling Amazon for new orders...', 'success');
      try {
        const res = await fetch('/api/vendor/orders/poll', {
          method: 'POST',
          credentials: 'include'
        });
        if (res.ok) {
          const data = await res.json();
          showToast(`Found ${data.newOrders || 0} new orders`, 'success');
          loadOrders();
        } else {
          throw new Error('Poll failed');
        }
      } catch (e) {
        showToast('Failed to poll Amazon', 'error');
      }
    }

    async function acknowledgePO(poNumber) {
      try {
        const res = await fetch(`/api/vendor/orders/${poNumber}/acknowledge`, {
          method: 'POST',
          credentials: 'include'
        });
        if (res.ok) {
          showToast(`PO ${poNumber} acknowledged`, 'success');
          loadOrders();
        } else {
          throw new Error('Failed to acknowledge');
        }
      } catch (e) {
        showToast(`Failed to acknowledge ${poNumber}`, 'error');
      }
    }

    async function createOdooOrder(poNumber) {
      try {
        const res = await fetch(`/api/vendor/orders/${poNumber}/create-odoo`, {
          method: 'POST',
          credentials: 'include'
        });
        if (res.ok) {
          const data = await res.json();
          showToast(`Created Odoo order ${data.saleOrderName}`, 'success');
          loadOrders();
        } else {
          const err = await res.json();
          throw new Error(err.error || 'Failed to create order');
        }
      } catch (e) {
        showToast(e.message, 'error');
      }
    }

    function openOdoo(orderId) {
      window.open(`https://acropaq.odoo.com/web#id=${orderId}&model=sale.order&view_type=form`, '_blank');
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const icon = toast.querySelector('.toast-icon .material-symbols-outlined');
      document.getElementById('toast-message').textContent = message;
      toast.className = `toast ${type}`;
      icon.textContent = type === 'success' ? 'check_circle' : 'error';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Event listeners
    document.getElementById('btn-refresh').onclick = loadOrders;
    document.getElementById('btn-poll').onclick = pollAmazon;
    document.getElementById('btn-prev').onclick = () => { page--; loadOrders(); };
    document.getElementById('btn-next').onclick = () => { page++; loadOrders(); };
    document.getElementById('filter-status').onchange = () => { page = 1; loadOrders(); };
    document.getElementById('filter-marketplace').onchange = () => { page = 1; loadOrders(); };

    let searchTimeout;
    document.getElementById('filter-search').oninput = () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => { page = 1; loadOrders(); }, 300);
    };

    // Initial load
    loadOrders();
  </script>
</body>
</html>
