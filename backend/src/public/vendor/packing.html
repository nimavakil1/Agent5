<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Packing Workflow - Amazon Vendor</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <script src="/shell-v2.js"></script>
  <style>
    .page { max-width: 1400px; margin: 0 auto; padding: 24px; }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .page-title { font-size: 24px; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 12px; }
    .page-title .material-symbols-outlined { font-size: 32px; color: #f97316; }
    .header-actions { display: flex; gap: 12px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-primary { background: #f97316; color: white; }
    .btn-primary:hover { background: #ea580c; }
    .btn-secondary { background: #252532; color: #e4e4e7; border: 1px solid #3f3f50; }
    .btn-secondary:hover { background: #2a2a3a; }
    .btn-success { background: #22c55e; color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .btn-lg { padding: 14px 28px; font-size: 16px; }
    .btn .material-symbols-outlined { font-size: 20px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Cards */
    .card { background: #18181f; border: 1px solid #252532; border-radius: 16px; overflow: hidden; margin-bottom: 24px; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid #252532; display: flex; align-items: center; justify-content: space-between; }
    .card-title { font-size: 16px; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 8px; }
    .card-title .material-symbols-outlined { color: #f97316; }
    .card-body { padding: 20px; }

    /* Workflow Steps */
    .workflow-steps { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
    .workflow-step { display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: #252532; border-radius: 10px; color: #71717a; }
    .workflow-step.active { background: #f97316; color: white; }
    .workflow-step.completed { background: #22c55e; color: white; }
    .workflow-step .step-number { width: 24px; height: 24px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; }
    .workflow-step.active .step-number { background: rgba(255,255,255,0.3); }
    .workflow-step.completed .step-number { background: rgba(255,255,255,0.3); }

    /* Group Info */
    .group-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .info-item { background: #1a1a28; padding: 16px; border-radius: 10px; }
    .info-label { font-size: 12px; color: #71717a; margin-bottom: 4px; }
    .info-value { font-size: 16px; font-weight: 600; color: #fff; }

    /* Parcel Setup */
    .parcel-count-input { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
    .parcel-count-input label { font-size: 16px; color: #e4e4e7; }
    .parcel-count-input input { width: 80px; padding: 12px 16px; background: #252532; border: 1px solid #3f3f50; border-radius: 10px; color: #fff; font-size: 18px; text-align: center; }
    .parcel-count-input input:focus { outline: none; border-color: #f97316; }

    /* Parcels Grid */
    .parcels-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; }
    .parcel-card { background: #1a1a28; border: 2px solid #252532; border-radius: 12px; overflow: hidden; }
    .parcel-card.ready { border-color: #22c55e; }
    .parcel-card.error { border-color: #ef4444; }
    .parcel-card.active { border-color: #f97316; }
    .parcel-card.overweight { border-color: #ef4444; background: #1a1218; }
    .overweight-warning { background: #ef444420; color: #f87171; padding: 8px 12px; border-radius: 6px; font-size: 12px; margin-top: 12px; display: flex; align-items: center; gap: 6px; }
    .overweight-warning .material-symbols-outlined { font-size: 18px; }
    .parcel-header { padding: 16px; background: #12121a; display: flex; justify-content: space-between; align-items: center; }
    .parcel-title { font-size: 16px; font-weight: 600; color: #fff; }
    .parcel-status { font-size: 12px; padding: 4px 10px; border-radius: 20px; }
    .parcel-status.pending { background: #3f3f50; color: #a1a1aa; }
    .parcel-status.ready { background: #22c55e20; color: #4ade80; }
    .parcel-status.error { background: #ef444420; color: #f87171; }
    .parcel-body { padding: 16px; }
    .parcel-field { margin-bottom: 16px; }
    .parcel-field label { display: block; font-size: 12px; color: #71717a; margin-bottom: 6px; }
    .parcel-field input, .parcel-field select { width: 100%; padding: 10px 14px; background: #252532; border: 1px solid #3f3f50; border-radius: 8px; color: #fff; font-size: 14px; }
    .parcel-field input:focus, .parcel-field select:focus { outline: none; border-color: #f97316; }
    .weight-row { display: flex; gap: 12px; }
    .weight-row .parcel-field { flex: 1; }
    .estimated-weight { font-size: 12px; color: #71717a; margin-top: 4px; }
    .parcel-items { max-height: 200px; overflow-y: auto; }
    .parcel-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 6px; background: #252532; border-radius: 6px; font-size: 13px; }
    .parcel-item:last-child { margin-bottom: 0; }
    .parcel-item-info { flex: 1; }
    .parcel-item-sku { color: #e4e4e7; font-weight: 500; }
    .parcel-item-name { color: #71717a; font-size: 11px; margin-top: 2px; }
    .parcel-item-qty { color: #4ade80; font-weight: 600; margin: 0 12px; }
    .parcel-item-remove { background: none; border: none; color: #ef4444; cursor: pointer; padding: 4px; border-radius: 4px; }
    .parcel-item-remove:hover { background: #ef444420; }
    .add-item-btn { width: 100%; padding: 10px; background: #252532; border: 2px dashed #3f3f50; border-radius: 8px; color: #71717a; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 12px; }
    .add-item-btn:hover { border-color: #f97316; color: #f97316; }

    /* Add Item Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.open { display: flex; }
    .modal { background: #18181f; border: 1px solid #252532; border-radius: 16px; width: 850px; max-width: 95%; max-height: 85vh; overflow: hidden; }
    .modal-header { padding: 16px 20px; border-bottom: 1px solid #252532; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 18px; font-weight: 600; color: #fff; }
    .modal-close { background: none; border: none; color: #71717a; cursor: pointer; font-size: 24px; }
    .modal-body { padding: 20px; max-height: 500px; overflow-y: auto; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid #252532; display: flex; justify-content: flex-end; gap: 12px; }
    .item-select-row { display: flex; align-items: center; gap: 12px; padding: 14px; background: #1a1a28; border-radius: 8px; margin-bottom: 10px; }
    .item-select-row:hover { background: #252532; }
    .item-select-info { flex: 1; min-width: 0; }
    .item-select-sku { color: #e4e4e7; font-weight: 500; }
    .item-select-name { color: #71717a; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-select-available { color: #71717a; font-size: 11px; }
    .item-select-available span { color: #4ade80; font-weight: 600; }
    .item-select-controls { display: flex; align-items: center; gap: 8px; }
    .item-select-badges { display: flex; gap: 6px; align-items: center; }
    .qty-badge { padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .qty-badge.packaging { background: #3f3f50; color: #e4e4e7; }
    .qty-badge.packaging:hover:not(.disabled) { background: #4f4f60; color: #fff; }
    .qty-badge.all-rest { background: #f9731630; color: #f97316; }
    .qty-badge.all-rest:hover:not(.disabled) { background: #f9731650; }
    .qty-badge.disabled { opacity: 0.3; cursor: not-allowed; }
    .qty-input-wrapper { display: flex; align-items: center; gap: 4px; }
    .item-select-qty { width: 70px; padding: 8px; background: #252532; border: 1px solid #3f3f50; border-radius: 6px; color: #fff; text-align: center; font-size: 14px; font-weight: 600; }
    .item-select-qty:focus { outline: none; border-color: #f97316; }
    .qty-clear-btn { background: #ef444430; border: none; color: #ef4444; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .qty-clear-btn:hover { background: #ef444450; }
    .qty-clear-btn .material-symbols-outlined { font-size: 16px; }

    /* Labels Section */
    .labels-section { margin-top: 24px; }
    .labels-info { display: flex; gap: 24px; margin-bottom: 16px; flex-wrap: wrap; }
    .label-stat { background: #1a1a28; padding: 16px 24px; border-radius: 10px; text-align: center; }
    .label-stat-value { font-size: 24px; font-weight: 700; color: #fff; }
    .label-stat-label { font-size: 12px; color: #71717a; }
    .label-stat.success .label-stat-value { color: #4ade80; }
    .label-stat.warning .label-stat-value { color: #fbbf24; }

    /* Action Bar */
    .action-bar { position: sticky; bottom: 0; background: #18181f; border-top: 1px solid #252532; padding: 16px 24px; margin: 24px -24px -24px; display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap; }
    .action-bar-status { color: #71717a; font-size: 14px; }
    .action-bar-buttons { display: flex; gap: 12px; }

    /* Items Table */
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #252532; }
    th { font-size: 11px; font-weight: 600; color: #71717a; text-transform: uppercase; background: #12121a; }
    td { font-size: 13px; color: #e4e4e7; }
    .qty-cell { text-align: center; color: #4ade80; font-weight: 600; }

    /* Toast */
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 14px 20px; background: #22c55e; color: white; border-radius: 10px; font-weight: 600; display: none; z-index: 3000; }
    .toast.error { background: #ef4444; }
    .toast.show { display: flex; align-items: center; gap: 8px; }

    /* Loading */
    .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: #71717a; }
    .loading .material-symbols-outlined { animation: spin 1s linear infinite; margin-right: 8px; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* GLS Status */
    .gls-status { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #1a1a28; border-radius: 8px; margin-bottom: 16px; }
    .gls-status.configured { border-left: 3px solid #22c55e; }
    .gls-status.not-configured { border-left: 3px solid #fbbf24; }
    .gls-status .material-symbols-outlined { font-size: 20px; }
    .gls-status.configured .material-symbols-outlined { color: #22c55e; }
    .gls-status.not-configured .material-symbols-outlined { color: #fbbf24; }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-header">
      <h1 class="page-title">
        <span class="material-symbols-outlined">package_2</span>
        Packing Workflow
      </h1>
      <div class="header-actions">
        <a href="/vendor/consolidate.html" class="btn btn-secondary">
          <span class="material-symbols-outlined">arrow_back</span>Back to Consolidation
        </a>
      </div>
    </header>

    <!-- Workflow Steps -->
    <div class="workflow-steps">
      <div class="workflow-step" id="step-1">
        <span class="step-number">1</span>
        <span>Setup Parcels</span>
      </div>
      <div class="workflow-step" id="step-2">
        <span class="step-number">2</span>
        <span>Generate Labels</span>
      </div>
      <div class="workflow-step" id="step-3">
        <span class="step-number">3</span>
        <span>Print Labels</span>
      </div>
      <div class="workflow-step" id="step-4">
        <span class="step-number">4</span>
        <span>Submit ASN</span>
      </div>
    </div>

    <!-- GLS Status -->
    <div class="gls-status" id="gls-status">
      <span class="material-symbols-outlined">local_shipping</span>
      <span id="gls-status-text">Checking GLS integration...</span>
    </div>

    <!-- Group Info -->
    <div class="card" id="group-card">
      <div class="card-header">
        <div class="card-title">
          <span class="material-symbols-outlined">inventory_2</span>
          Consolidation Group
        </div>
      </div>
      <div class="card-body">
        <div class="loading" id="group-loading">
          <span class="material-symbols-outlined">sync</span>
          Loading group details...
        </div>
        <div id="group-content" style="display: none;">
          <div class="group-info">
            <div class="info-item">
              <div class="info-label">Fulfillment Center</div>
              <div class="info-value" id="info-fc">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Delivery Date</div>
              <div class="info-value" id="info-delivery">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Orders</div>
              <div class="info-value" id="info-orders">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Total Units</div>
              <div class="info-value" id="info-units">-</div>
            </div>
          </div>

          <!-- Items Table -->
          <div style="margin-top: 20px;">
            <h3 style="font-size: 14px; color: #a1a1aa; margin-bottom: 12px;">Items to Pack</h3>
            <table>
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>EAN</th>
                  <th>Product</th>
                  <th class="qty-cell">Weight</th>
                  <th class="qty-cell">Total</th>
                  <th class="qty-cell">Packed</th>
                  <th class="qty-cell">Remaining</th>
                </tr>
              </thead>
              <tbody id="items-table">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Parcel Setup -->
    <div class="card" id="parcels-card">
      <div class="card-header">
        <div class="card-title">
          <span class="material-symbols-outlined">deployed_code</span>
          Parcel Configuration
        </div>
      </div>
      <div class="card-body">
        <div class="parcel-count-input">
          <label>Number of Parcels:</label>
          <input type="number" id="parcel-count" min="1" max="50" value="1" onchange="validateParcelCount()">
          <button class="btn btn-secondary btn-sm" id="update-parcels-btn" onclick="updateParcels()">
            <span class="material-symbols-outlined">refresh</span>Update
          </button>
          <button class="btn btn-primary btn-sm" id="auto-distribute-btn" onclick="autoDistributeItems()">
            <span class="material-symbols-outlined">auto_fix_high</span>Auto-Distribute Items
          </button>
          <span id="all-packed-msg" style="display: none; color: #4ade80; font-size: 13px; margin-left: 12px;">
            <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle;">check_circle</span>
            All items packed
          </span>
        </div>

        <div class="parcels-grid" id="parcels-grid">
          <!-- Parcels will be rendered here -->
        </div>
      </div>
    </div>

    <!-- Labels Section -->
    <div class="card" id="labels-card" style="display: none;">
      <div class="card-header">
        <div class="card-title">
          <span class="material-symbols-outlined">qr_code_2</span>
          Generated Labels
        </div>
      </div>
      <div class="card-body">
        <div class="labels-info" id="labels-info">
          <!-- Labels stats will be rendered here -->
        </div>
      </div>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <div class="action-bar-status" id="action-status">
        Configure parcels and generate labels
      </div>
      <div class="action-bar-buttons">
        <button class="btn btn-primary btn-lg" id="generate-btn" onclick="generateLabels()">
          <span class="material-symbols-outlined">qr_code_2</span>
          Generate Labels (GLS + SSCC)
        </button>
        <button class="btn btn-success btn-lg" id="print-btn" onclick="printLabels()" disabled>
          <span class="material-symbols-outlined">print</span>
          Print All Labels
        </button>
        <button class="btn btn-secondary btn-lg" id="asn-btn" onclick="submitASN()" disabled>
          <span class="material-symbols-outlined">send</span>
          Update Odoo & submit ASN to Amazon Vendor Central
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Add Items Modal -->
  <div class="modal-overlay" id="add-items-modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Add Items to Parcel <span id="modal-parcel-num"></span></div>
        <button class="modal-close" onclick="closeAddItemsModal()">&times;</button>
      </div>
      <div class="modal-body" id="modal-items-list">
        <!-- Items will be rendered here -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddItemsModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmAddItems()">
          <span class="material-symbols-outlined">add</span>Add Selected Items
        </button>
      </div>
    </div>
  </div>

  <script>
    let groupId = null;
    let groupData = null;
    let currentShipmentId = null;
    let parcels = [];
    let glsConfigured = false;
    let itemsRemaining = {}; // Track remaining qty for each item
    let currentModalParcelIndex = -1; // Which parcel we're adding items to
    let packagingCache = {}; // Cache packaging data by SKU

    // Fetch packaging for a product by SKU
    async function fetchPackaging(sku) {
      if (!sku) return [];
      if (packagingCache[sku]) return packagingCache[sku];

      try {
        const res = await fetch(`/api/vendor/products/${encodeURIComponent(sku)}/packaging`, { credentials: 'include' });
        const data = await res.json();
        if (data.success && data.packaging) {
          // Sort by qty descending so larger packages come first
          packagingCache[sku] = data.packaging.sort((a, b) => b.qty - a.qty);
          return packagingCache[sku];
        }
      } catch (err) {
        console.error('Failed to fetch packaging for product', sku, err);
      }
      packagingCache[sku] = [];
      return [];
    }

    // Pre-fetch all packaging when modal opens
    async function prefetchAllPackaging() {
      if (!groupData) return;
      const skus = [...new Set(groupData.consolidatedItems
        .map(item => item.odooSku || item.vendorProductIdentifier)
        .filter(Boolean))];
      await Promise.all(skus.map(sku => fetchPackaging(sku)));
    }

    // Show toast
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show' + (isError ? ' error' : '');
      setTimeout(() => toast.className = 'toast', 3000);
    }

    // Update workflow step
    function setWorkflowStep(step) {
      for (let i = 1; i <= 4; i++) {
        const el = document.getElementById(`step-${i}`);
        el.classList.remove('active', 'completed');
        if (i < step) el.classList.add('completed');
        if (i === step) el.classList.add('active');
      }
    }

    // Calculate remaining quantities
    function calculateRemaining() {
      if (!groupData) return;

      // Reset to total quantities
      itemsRemaining = {};
      for (const item of groupData.consolidatedItems) {
        const key = item.odooSku || item.vendorProductIdentifier;
        itemsRemaining[key] = item.totalQty;
      }

      // Subtract what's already in parcels
      for (const parcel of parcels) {
        for (const pItem of parcel.items) {
          const key = pItem.sku || pItem.ean;
          if (itemsRemaining[key] !== undefined) {
            itemsRemaining[key] -= pItem.quantity;
          }
        }
      }
    }

    // Get remaining qty for an item
    function getRemainingQty(sku) {
      return itemsRemaining[sku] || 0;
    }

    // Check if all items are packed
    function allItemsPacked() {
      calculateRemaining();
      return Object.values(itemsRemaining).every(qty => qty <= 0);
    }

    // Update parcel controls based on packing status
    function updateParcelControls() {
      const allPacked = allItemsPacked();
      const parcelCountInput = document.getElementById('parcel-count');
      const updateBtn = document.getElementById('update-parcels-btn');
      const autoDistributeBtn = document.getElementById('auto-distribute-btn');
      const allPackedMsg = document.getElementById('all-packed-msg');

      if (allPacked) {
        // Disable adding more parcels
        parcelCountInput.max = parcels.length;
        parcelCountInput.value = parcels.length;
        updateBtn.disabled = true;
        autoDistributeBtn.disabled = true;
        allPackedMsg.style.display = 'inline';
      } else {
        // Allow adding parcels
        parcelCountInput.max = 50;
        updateBtn.disabled = false;
        autoDistributeBtn.disabled = false;
        allPackedMsg.style.display = 'none';
      }
    }

    // Validate parcel count input
    function validateParcelCount() {
      const input = document.getElementById('parcel-count');
      const newCount = parseInt(input.value) || 1;

      if (allItemsPacked() && newCount > parcels.length) {
        input.value = parcels.length;
        showToast('All items are already packed - cannot add more parcels', true);
        return;
      }

      updateParcels();
    }

    // Open add items modal
    async function openAddItemsModal(parcelIndex) {
      currentModalParcelIndex = parcelIndex;
      calculateRemaining();

      document.getElementById('modal-parcel-num').textContent = parcelIndex + 1;

      // Show loading state
      const modalBody = document.getElementById('modal-items-list');
      modalBody.innerHTML = '<div class="loading"><span class="material-symbols-outlined">sync</span>Loading packaging info...</div>';
      document.getElementById('add-items-modal').classList.add('open');

      // Pre-fetch all packaging data
      await prefetchAllPackaging();

      // Render items with packaging badges
      modalBody.innerHTML = groupData.consolidatedItems.map((item, itemIndex) => {
        const key = item.odooSku || item.vendorProductIdentifier;
        const remaining = getRemainingQty(key);
        const weight = item.weight || 0.5;
        const packaging = packagingCache[key] || [];
        const isAllPacked = remaining === 0;

        // Build packaging badges HTML
        const packagingBadges = packaging.map(pkg => {
          const disabled = pkg.qty > remaining;
          return `<button type="button" class="qty-badge packaging ${disabled ? 'disabled' : ''}"
                          onclick="${disabled ? '' : `addQtyBadge(${itemIndex}, ${pkg.qty})`}"
                          title="${pkg.name}">${pkg.qty}</button>`;
        }).join('');

        // ALL or REST badge
        const allRestLabel = remaining === item.totalQty ? `ALL ${remaining}` : `REST ${remaining}`;
        const allRestBadge = remaining > 0
          ? `<button type="button" class="qty-badge all-rest" onclick="addQtyBadge(${itemIndex}, ${remaining})">${allRestLabel}</button>`
          : '';

        return `
          <div class="item-select-row" data-item-index="${itemIndex}" style="${isAllPacked ? 'opacity: 0.4;' : ''}">
            <div class="item-select-info">
              <div class="item-select-sku">${item.odooSku || '-'} <span style="color: #71717a; font-size: 11px;">(${weight}kg)</span></div>
              <div class="item-select-name">${item.odooProductName || 'Unknown'}</div>
              <div class="item-select-available">Available: <span>${remaining}</span> of ${item.totalQty}</div>
            </div>
            <div class="item-select-controls">
              <div class="item-select-badges" id="badges-${itemIndex}">
                ${packagingBadges}
                ${allRestBadge}
              </div>
              <div class="qty-input-wrapper">
                <input type="number" class="item-select-qty" id="qty-input-${itemIndex}"
                       data-sku="${item.odooSku || ''}"
                       data-ean="${item.vendorProductIdentifier || ''}"
                       data-name="${item.odooProductName || ''}"
                       data-weight="${weight}"
                       data-remaining="${remaining}"
                       min="0" max="${remaining}" value="0"
                       onchange="updateBadgeStates(${itemIndex})"
                       ${isAllPacked ? 'disabled' : ''}>
                <button type="button" class="qty-clear-btn" onclick="clearQtyInput(${itemIndex})" title="Clear">
                  <span class="material-symbols-outlined">close</span>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Add quantity from badge click
    function addQtyBadge(itemIndex, qty) {
      const input = document.getElementById(`qty-input-${itemIndex}`);
      if (!input || input.disabled) return;

      const remaining = parseInt(input.dataset.remaining) || 0;
      const currentVal = parseInt(input.value) || 0;
      const newVal = Math.min(currentVal + qty, remaining);

      input.value = newVal;
      updateBadgeStates(itemIndex);
    }

    // Clear qty input
    function clearQtyInput(itemIndex) {
      const input = document.getElementById(`qty-input-${itemIndex}`);
      if (!input) return;
      input.value = 0;
      updateBadgeStates(itemIndex);
    }

    // Update badge states based on current qty
    function updateBadgeStates(itemIndex) {
      const input = document.getElementById(`qty-input-${itemIndex}`);
      const badgesContainer = document.getElementById(`badges-${itemIndex}`);
      if (!input || !badgesContainer) return;

      const totalRemaining = parseInt(input.dataset.remaining) || 0;
      const currentVal = parseInt(input.value) || 0;
      const stillAvailable = totalRemaining - currentVal;

      // Get the item to access packaging
      const item = groupData.consolidatedItems[itemIndex];
      const sku = item?.odooSku || item?.vendorProductIdentifier;
      const packaging = packagingCache[sku] || [];

      // Rebuild badges with updated disabled states
      const packagingBadges = packaging.map(pkg => {
        const disabled = pkg.qty > stillAvailable;
        return `<button type="button" class="qty-badge packaging ${disabled ? 'disabled' : ''}"
                        onclick="${disabled ? '' : `addQtyBadge(${itemIndex}, ${pkg.qty})`}"
                        title="${pkg.name}">${pkg.qty}</button>`;
      }).join('');

      // ALL or REST badge
      const isOriginal = currentVal === 0;
      const allRestLabel = isOriginal ? `ALL ${totalRemaining}` : `REST ${stillAvailable}`;
      const allRestBadge = stillAvailable > 0
        ? `<button type="button" class="qty-badge all-rest" onclick="addQtyBadge(${itemIndex}, ${stillAvailable})">${allRestLabel}</button>`
        : '';

      badgesContainer.innerHTML = packagingBadges + allRestBadge;
    }

    // Close add items modal
    function closeAddItemsModal() {
      document.getElementById('add-items-modal').classList.remove('open');
      currentModalParcelIndex = -1;
    }

    // Confirm adding items from modal
    async function confirmAddItems() {
      if (currentModalParcelIndex < 0) return;

      const inputs = document.querySelectorAll('.item-select-qty');
      let addedCount = 0;

      inputs.forEach(input => {
        const qty = parseInt(input.value) || 0;
        if (qty > 0) {
          const sku = input.dataset.sku;
          const ean = input.dataset.ean;
          const name = input.dataset.name;
          const weight = parseFloat(input.dataset.weight) || 0.5;

          // Check if item already exists in parcel
          const existing = parcels[currentModalParcelIndex].items.find(i =>
            (i.sku && i.sku === sku) || (i.ean && i.ean === ean)
          );

          if (existing) {
            existing.quantity += qty;
          } else {
            parcels[currentModalParcelIndex].items.push({
              sku, ean, name, quantity: qty, weight
            });
          }
          addedCount += qty;
        }
      });

      if (addedCount > 0) {
        // Recalculate weight for this parcel (await to ensure weight is updated before render)
        await recalculateParcelWeight(currentModalParcelIndex);
        renderParcels();
        renderItemsTable();
        showToast(`Added ${addedCount} units to Parcel ${currentModalParcelIndex + 1}`);
      }

      closeAddItemsModal();
    }

    // Remove item from parcel
    async function removeItemFromParcel(parcelIndex, itemIndex) {
      parcels[parcelIndex].items.splice(itemIndex, 1);
      await recalculateParcelWeight(parcelIndex);
      renderParcels();
      renderItemsTable();
    }

    // Recalculate parcel weight
    async function recalculateParcelWeight(parcelIndex) {
      const parcel = parcels[parcelIndex];
      try {
        const res = await fetch('/api/vendor/packing/estimate-weight', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ items: parcel.items })
        });
        const data = await res.json();
        if (data.success) {
          parcel.estimatedWeight = data.estimatedWeight;
          parcel.weight = data.estimatedWeight;
        }
      } catch (err) {
        console.error('Failed to estimate weight:', err);
      }
    }

    // Check GLS status
    async function checkGLSStatus() {
      try {
        const res = await fetch('/api/vendor/packing/gls-status', { credentials: 'include' });
        const data = await res.json();

        glsConfigured = data.glsConfigured;
        const statusEl = document.getElementById('gls-status');
        const textEl = document.getElementById('gls-status-text');

        if (data.glsConfigured) {
          statusEl.classList.add('configured');
          statusEl.classList.remove('not-configured');
          textEl.textContent = 'GLS integration is configured - shipping labels will be generated automatically';
        } else {
          statusEl.classList.add('not-configured');
          statusEl.classList.remove('configured');
          textEl.textContent = 'GLS not configured - only SSCC labels will be generated (configure GLS_USER_ID and GLS_PASSWORD in .env)';
        }
      } catch (err) {
        console.error('Failed to check GLS status:', err);
      }
    }

    // Load group data
    async function loadGroupData() {
      const params = new URLSearchParams(window.location.search);
      groupId = params.get('group');

      if (!groupId) {
        document.getElementById('group-loading').innerHTML = `
          <div style="text-align: center;">
            <span class="material-symbols-outlined" style="font-size: 48px; color: #ef4444;">error</span>
            <p style="color: #f87171; margin-top: 12px;">No consolidation group specified</p>
            <a href="/vendor/consolidate.html" class="btn btn-primary" style="margin-top: 16px;">Go to Consolidation</a>
          </div>
        `;
        return;
      }

      try {
        const res = await fetch(`/api/vendor/orders/consolidate/${encodeURIComponent(groupId)}`, { credentials: 'include' });
        const data = await res.json();

        if (!data.success) throw new Error(data.error);

        groupData = data;
        renderGroupInfo();
        setWorkflowStep(1);
      } catch (err) {
        document.getElementById('group-loading').innerHTML = `
          <div style="text-align: center;">
            <span class="material-symbols-outlined" style="font-size: 48px; color: #ef4444;">error</span>
            <p style="color: #f87171; margin-top: 12px;">${err.message}</p>
          </div>
        `;
      }
    }

    // Render group info
    function renderGroupInfo() {
      document.getElementById('group-loading').style.display = 'none';
      document.getElementById('group-content').style.display = 'block';

      document.getElementById('info-fc').textContent = groupData.fcName;
      document.getElementById('info-delivery').textContent = new Date(groupData.deliveryWindow?.endDate).toLocaleDateString();
      document.getElementById('info-orders').textContent = groupData.orders.map(o => o.purchaseOrderNumber).join(', ');
      document.getElementById('info-units').textContent = groupData.summary.totalUnits;

      // Render items table
      renderItemsTable();

      // Initialize parcels
      updateParcels();
    }

    // Render items table with packed/remaining counts
    function renderItemsTable() {
      calculateRemaining();
      const tbody = document.getElementById('items-table');
      tbody.innerHTML = groupData.consolidatedItems.map(item => {
        const key = item.odooSku || item.vendorProductIdentifier;
        const remaining = getRemainingQty(key);
        const packed = item.totalQty - remaining;
        const isComplete = remaining === 0;
        const weight = item.weight || 0;
        const totalWeight = weight * item.totalQty;

        return `
          <tr style="${isComplete ? 'opacity: 0.5;' : ''}">
            <td>${item.odooSku || '-'}</td>
            <td style="font-family: monospace; font-size: 12px;">${item.vendorProductIdentifier || '-'}</td>
            <td>${item.odooProductName || 'Unknown'}</td>
            <td class="qty-cell" style="color: #71717a;">${weight}kg <span style="font-size: 10px;">(${totalWeight.toFixed(1)}kg total)</span></td>
            <td class="qty-cell">${item.totalQty}</td>
            <td class="qty-cell" style="color: ${packed > 0 ? '#4ade80' : '#71717a'};">${packed}</td>
            <td class="qty-cell" style="color: ${remaining > 0 ? '#f97316' : '#4ade80'}; font-weight: ${remaining > 0 ? '600' : '400'};">
              ${remaining}${isComplete ? ' ✓' : ''}
            </td>
          </tr>
        `;
      }).join('');
    }

    // Update parcels
    function updateParcels() {
      const count = parseInt(document.getElementById('parcel-count').value) || 1;

      // Create or update parcels array
      while (parcels.length < count) {
        parcels.push({
          items: [],
          weight: 1.0,
          estimatedWeight: 1.0
        });
      }
      while (parcels.length > count) {
        parcels.pop();
      }

      renderParcels();
    }

    // Auto-distribute items across parcels
    function autoDistributeItems() {
      if (!groupData) return;

      const count = parseInt(document.getElementById('parcel-count').value) || 1;
      const items = groupData.consolidatedItems;
      const totalUnits = items.reduce((sum, i) => sum + i.totalQty, 0);
      const unitsPerParcel = Math.ceil(totalUnits / count);

      // Reset parcels
      parcels = Array.from({ length: count }, () => ({
        items: [],
        weight: 0,
        estimatedWeight: 0
      }));

      // Distribute items
      let currentParcel = 0;
      let currentUnits = 0;

      for (const item of items) {
        let remaining = item.totalQty;

        while (remaining > 0) {
          const spaceInParcel = unitsPerParcel - currentUnits;
          const toAdd = Math.min(remaining, spaceInParcel);

          parcels[currentParcel].items.push({
            sku: item.odooSku,
            ean: item.vendorProductIdentifier,
            name: item.odooProductName,
            quantity: toAdd
          });

          remaining -= toAdd;
          currentUnits += toAdd;

          if (currentUnits >= unitsPerParcel && currentParcel < count - 1) {
            currentParcel++;
            currentUnits = 0;
          }
        }
      }

      // Estimate weights for each parcel
      for (const parcel of parcels) {
        estimateParcelWeight(parcel);
      }

      renderParcels();
      showToast(`Items distributed across ${count} parcels`);
    }

    // Estimate parcel weight
    async function estimateParcelWeight(parcel) {
      try {
        const res = await fetch('/api/vendor/packing/estimate-weight', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ items: parcel.items })
        });
        const data = await res.json();
        if (data.success) {
          parcel.estimatedWeight = data.estimatedWeight;
          parcel.weight = data.estimatedWeight;
        }
      } catch (err) {
        console.error('Failed to estimate weight:', err);
      }
    }

    // Render parcels
    function renderParcels() {
      calculateRemaining();
      const grid = document.getElementById('parcels-grid');
      const hasRemainingItems = Object.values(itemsRemaining).some(qty => qty > 0);

      const MAX_PARCEL_WEIGHT = 15; // kg - Amazon limit

      grid.innerHTML = parcels.map((parcel, idx) => {
        const status = parcel.sscc ? 'ready' : 'pending';
        const isOverweight = parcel.weight > MAX_PARCEL_WEIGHT;
        const itemsHtml = parcel.items.length > 0
          ? parcel.items.map((item, itemIdx) => `
              <div class="parcel-item">
                <div class="parcel-item-info">
                  <div class="parcel-item-sku">${item.sku || item.ean || '-'}</div>
                  <div class="parcel-item-name">${item.name || ''}</div>
                </div>
                <span class="parcel-item-qty">${item.quantity}x</span>
                <button class="parcel-item-remove" onclick="removeItemFromParcel(${idx}, ${itemIdx})" title="Remove item">
                  <span class="material-symbols-outlined" style="font-size: 16px;">close</span>
                </button>
              </div>
            `).join('')
          : '<div style="color: #71717a; font-style: italic; padding: 8px 0;">No items assigned - click "Add Items" below</div>';

        return `
          <div class="parcel-card ${status} ${isOverweight ? 'overweight' : ''}">
            <div class="parcel-header">
              <span class="parcel-title">Parcel ${idx + 1}</span>
              <span class="parcel-status ${status}">${status === 'ready' ? 'Ready' : isOverweight ? 'Overweight!' : 'Pending'}</span>
            </div>
            <div class="parcel-body">
              <div class="weight-row">
                <div class="parcel-field">
                  <label>Weight (kg)</label>
                  <input type="number" step="0.1" min="0.1" max="50" value="${parcel.weight.toFixed(1)}"
                         onchange="updateParcelWeight(${idx}, this.value)">
                  <div class="estimated-weight">Estimated: ${parcel.estimatedWeight.toFixed(1)} kg</div>
                </div>
              </div>
              <div class="parcel-field">
                <label>Items (${parcel.items.reduce((sum, i) => sum + i.quantity, 0)} units)</label>
                <div class="parcel-items">${itemsHtml}</div>
                ${hasRemainingItems ? `
                  <button class="add-item-btn" onclick="openAddItemsModal(${idx})">
                    <span class="material-symbols-outlined">add</span>Add Items
                  </button>
                ` : `
                  <div style="text-align: center; padding: 10px; color: #4ade80; font-size: 12px;">
                    <span class="material-symbols-outlined" style="font-size: 14px; vertical-align: middle;">check_circle</span>
                    All items distributed
                  </div>
                `}
                ${isOverweight ? `
                  <div class="overweight-warning">
                    <span class="material-symbols-outlined">warning</span>
                    <span>Parcel exceeds ${MAX_PARCEL_WEIGHT}kg limit! Split items into multiple parcels.</span>
                  </div>
                ` : ''}
              </div>
              ${parcel.sscc ? `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #252532;">
                  <div style="font-size: 11px; color: #71717a;">SSCC</div>
                  <div style="font-family: monospace; font-size: 12px; color: #4ade80;">${parcel.ssccFormatted || parcel.sscc}</div>
                  ${parcel.glsTrackingNumber ? `
                    <div style="font-size: 11px; color: #71717a; margin-top: 8px;">GLS Tracking</div>
                    <div style="font-family: monospace; font-size: 12px; color: #fbbf24;">${parcel.glsTrackingNumber}</div>
                  ` : ''}
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');

      // Update parcel controls based on packing status
      updateParcelControls();
    }

    // Update parcel weight
    function updateParcelWeight(index, value) {
      parcels[index].weight = parseFloat(value) || 1.0;
    }

    // Generate labels
    async function generateLabels() {
      if (!groupData || parcels.length === 0) {
        showToast('Please configure parcels first', true);
        return;
      }

      // Check if all parcels have items
      const emptyParcels = parcels.filter(p => p.items.length === 0);
      if (emptyParcels.length > 0) {
        showToast(`${emptyParcels.length} parcel(s) have no items assigned`, true);
        return;
      }

      // Check if all items are packed
      calculateRemaining();
      const unpackedItems = Object.entries(itemsRemaining).filter(([key, qty]) => qty > 0);
      if (unpackedItems.length > 0) {
        const totalUnpacked = unpackedItems.reduce((sum, [, qty]) => sum + qty, 0);
        if (!confirm(`Warning: ${totalUnpacked} units are not yet assigned to any parcel.\n\nDo you want to continue anyway?`)) {
          return;
        }
      }

      // Check for overweight parcels
      const MAX_WEIGHT = 15;
      const overweightParcels = parcels.filter(p => p.weight > MAX_WEIGHT);
      if (overweightParcels.length > 0) {
        const overweightList = overweightParcels.map((p, i) =>
          `Parcel ${parcels.indexOf(p) + 1}: ${p.weight.toFixed(1)}kg`
        ).join('\n');

        if (!confirm(`⚠️ WARNING: ${overweightParcels.length} parcel(s) exceed the ${MAX_WEIGHT}kg limit!\n\n${overweightList}\n\nAmazon may reject or fine overweight parcels.\n\nDo you want to continue anyway?`)) {
          return;
        }
      }

      const generateBtn = document.getElementById('generate-btn');
      generateBtn.disabled = true;
      generateBtn.innerHTML = '<span class="material-symbols-outlined" style="animation: spin 1s linear infinite;">sync</span>Generating...';
      document.getElementById('action-status').textContent = 'Generating labels...';

      try {
        // Step 1: Create shipment
        const createRes = await fetch('/api/vendor/packing/create-shipment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            groupId,
            parcels: parcels.map(p => ({
              items: p.items,
              weight: p.weight,
              estimatedWeight: p.estimatedWeight
            })),
            fcAddress: groupData.fcAddress,
            fcName: groupData.fcName,
            purchaseOrders: groupData.orders.map(o => o.purchaseOrderNumber)
          })
        });

        const createData = await createRes.json();
        if (!createData.success) throw new Error(createData.error);

        currentShipmentId = createData.shipment.shipmentId;

        // Step 2: Generate labels
        const labelsRes = await fetch(`/api/vendor/packing/${currentShipmentId}/generate-labels`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });

        const labelsData = await labelsRes.json();
        if (!labelsData.success) throw new Error(labelsData.error);

        // Update parcels with generated labels
        for (let i = 0; i < labelsData.parcels.length; i++) {
          const result = labelsData.parcels[i];
          parcels[i].sscc = result.sscc;
          parcels[i].ssccFormatted = result.ssccFormatted;
          parcels[i].glsTrackingNumber = result.glsTrackingNumber;
          parcels[i].glsError = result.glsError;
        }

        // Update UI
        renderParcels();
        setWorkflowStep(3);
        document.getElementById('print-btn').disabled = false;
        document.getElementById('asn-btn').disabled = false;
        document.getElementById('labels-card').style.display = 'block';

        // Render labels info
        const ssccCount = labelsData.parcels.filter(p => p.sscc).length;
        const glsCount = labelsData.parcels.filter(p => p.glsTrackingNumber).length;
        document.getElementById('labels-info').innerHTML = `
          <div class="label-stat success">
            <div class="label-stat-value">${ssccCount}/${parcels.length}</div>
            <div class="label-stat-label">SSCC Labels</div>
          </div>
          <div class="label-stat ${glsCount === parcels.length ? 'success' : 'warning'}">
            <div class="label-stat-value">${glsCount}/${parcels.length}</div>
            <div class="label-stat-label">GLS Labels</div>
          </div>
          <div class="label-stat">
            <div class="label-stat-value">${currentShipmentId}</div>
            <div class="label-stat-label">Shipment ID</div>
          </div>
        `;

        document.getElementById('action-status').textContent = `Labels generated: ${ssccCount} SSCC, ${glsCount} GLS`;
        showToast('Labels generated successfully!');

      } catch (err) {
        showToast('Error: ' + err.message, true);
        document.getElementById('action-status').textContent = 'Error generating labels';
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<span class="material-symbols-outlined">qr_code_2</span>Generate Labels (GLS + SSCC)';
      }
    }

    // Print labels
    function printLabels() {
      if (!currentShipmentId) {
        showToast('Generate labels first', true);
        return;
      }

      window.open(`/api/vendor/packing/${currentShipmentId}/labels`, '_blank');
      showToast('Labels opened for printing');
    }

    // Submit ASN
    async function submitASN() {
      if (!currentShipmentId) {
        showToast('Generate labels first', true);
        return;
      }

      const asnBtn = document.getElementById('asn-btn');
      asnBtn.disabled = true;
      asnBtn.innerHTML = '<span class="material-symbols-outlined" style="animation: spin 1s linear infinite;">sync</span>Submitting...';

      try {
        const res = await fetch(`/api/vendor/packing/${currentShipmentId}/submit-asn`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });

        const data = await res.json();
        if (!data.success) throw new Error(data.error);

        setWorkflowStep(4);

        // Show comprehensive status message from the server
        const statusMsg = data.message || 'Completed';
        document.getElementById('action-status').textContent = statusMsg;

        // Show different toast based on what was accomplished
        if (data.amazon?.invoicesSubmitted?.length > 0) {
          showToast('Deliveries validated, invoices created & submitted to Amazon!');
        } else if (data.amazon?.asnSubmitted) {
          showToast('ASN submitted. Check errors for invoice details.');
        } else {
          showToast('Completed with some errors. Check console.');
        }

        // Update button based on final status
        const btnText = data.status === 'invoiced' ? 'Invoiced' : 'Completed';
        asnBtn.innerHTML = `<span class="material-symbols-outlined">check_circle</span>${btnText}`;
        asnBtn.classList.remove('btn-secondary');
        asnBtn.classList.add('btn-success');

        // Log any errors for debugging
        if (data.odoo?.errors?.length > 0 || data.amazon?.errors?.length > 0) {
          console.log('Odoo errors:', data.odoo?.errors);
          console.log('Amazon errors:', data.amazon?.errors);
        }

      } catch (err) {
        showToast('Error: ' + err.message, true);
        asnBtn.disabled = false;
        asnBtn.innerHTML = '<span class="material-symbols-outlined">send</span>Update Odoo & submit ASN to Amazon Vendor Central';
      }
    }

    // Initialize
    async function init() {
      await checkGLSStatus();
      await loadGroupData();
    }

    init();
  </script>
</body>
</html>
