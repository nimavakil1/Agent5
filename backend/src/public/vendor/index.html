<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purchase Orders - Amazon Vendor</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <script src="/shell-v2.js"></script>
  <style>
    .page { max-width: 1600px; margin: 0 auto; padding: 24px; }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .page-logo-container { background: #fff; border-radius: 10px; padding: 8px 14px; display: flex; align-items: center; justify-content: center; }
    .page-logo { height: 28px; width: auto; }
    .header-actions { display: flex; gap: 12px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-primary { background: #f97316; color: white; }
    .btn-primary:hover { background: #ea580c; }
    .btn-secondary { background: #252532; color: #e4e4e7; border: 1px solid #3f3f50; }
    .btn-secondary:hover { background: #2a2a3a; }
    .btn-success { background: #22c55e; color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-blue { background: #6366f1; color: white; }
    .btn-blue:hover { background: #4f46e5; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .btn .material-symbols-outlined { font-size: 20px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
    @media (max-width: 1200px) { .stats-row { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
    .stat-card { background: #18181f; border: 1px solid #252532; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.15s; }
    .stat-card:hover { border-color: #f97316; }
    .stat-card.active { border-color: #f97316; background: rgba(249, 115, 22, 0.1); }
    .stat-value { font-size: 28px; font-weight: 700; color: #fff; margin-bottom: 4px; }
    .stat-label { font-size: 13px; color: #71717a; }
    .stat-card.warning .stat-value { color: #fbbf24; }
    .stat-card.success .stat-value { color: #4ade80; }
    .filters-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
    .filter-select, .filter-input { padding: 10px 14px; background: #18181f; border: 1px solid #252532; border-radius: 10px; color: #e4e4e7; font-size: 14px; }
    .filter-select:focus, .filter-input:focus { outline: none; border-color: #f97316; }
    .filter-input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(70%) sepia(50%) saturate(1000%) hue-rotate(350deg); cursor: pointer; }
    .filter-input[type="date"]::-webkit-calendar-picker-indicator:hover { filter: invert(60%) sepia(90%) saturate(1500%) hue-rotate(350deg); }
    .card { background: #18181f; border: 1px solid #252532; border-radius: 16px; overflow: hidden; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 14px 16px; text-align: left; border-bottom: 1px solid #252532; }
    th { background: #12121a; font-size: 12px; font-weight: 600; color: #71717a; text-transform: uppercase; letter-spacing: 0.05em; }
    td { font-size: 14px; color: #e4e4e7; }
    tr:hover td { background: #1a1a28; }
    .po-number { font-weight: 600; color: #f97316; text-decoration: none; }
    .po-number:hover { text-decoration: underline; }
    .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .badge-new { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
    .badge-acknowledged { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .badge-closed { background: rgba(113, 113, 122, 0.15); color: #a1a1aa; }
    .marketplace-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; background: #252532; color: #a1a1aa; }
    .odoo-link { color: #818cf8; text-decoration: none; }
    .odoo-link:hover { text-decoration: underline; }
    .actions { display: flex; gap: 6px; }
    .action-btn { width: 32px; height: 32px; border-radius: 8px; background: #252532; border: none; color: #71717a; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    .action-btn:hover { background: #3f3f50; color: #e4e4e7; }
    .action-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .action-btn .material-symbols-outlined { font-size: 18px; }
    .edit-qty-btn { background: transparent; border: none; color: #71717a; cursor: pointer; padding: 2px; margin-left: 4px; vertical-align: middle; transition: color 0.15s; }
    .edit-qty-btn:hover { color: #f97316; }
    .edit-qty-btn .material-symbols-outlined { font-size: 16px; }
    .qty-edit-container { display: inline-flex; align-items: center; gap: 4px; }
    .qty-edit-input { width: 60px; padding: 4px 6px; background: #12121a; border: 1px solid #f97316; border-radius: 4px; color: #e4e4e7; text-align: center; font-size: 13px; }
    .qty-save-btn, .qty-cancel-btn { background: transparent; border: none; cursor: pointer; padding: 2px; }
    .qty-save-btn { color: #4ade80; }
    .qty-save-btn:hover { color: #22c55e; }
    .qty-cancel-btn { color: #ef4444; }
    .qty-cancel-btn:hover { color: #dc2626; }
    .qty-save-btn .material-symbols-outlined, .qty-cancel-btn .material-symbols-outlined { font-size: 18px; }
    .stock-loading { color: #71717a; font-style: italic; }
    .loading-overlay { position: absolute; inset: 0; background: rgba(24, 24, 31, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; border-radius: 20px; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid #252532; border-top-color: #f97316; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { margin-top: 16px; color: #a1a1aa; font-size: 14px; }
    .empty-state { padding: 60px 20px; text-align: center; }
    .empty-state .material-symbols-outlined { font-size: 48px; color: #3f3f50; margin-bottom: 16px; }
    .empty-state-title { font-size: 16px; font-weight: 600; color: #e4e4e7; margin-bottom: 4px; }
    .empty-state-text { font-size: 14px; color: #71717a; }
    .empty-state-link { color: #f97316; cursor: pointer; text-decoration: underline; }
    .empty-state-link:hover { color: #fb923c; }
    .empty-state-success .material-symbols-outlined { color: #4ade80; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal-overlay.open { display: flex; }
    .modal { background: #18181f; border: 1px solid #252532; border-radius: 20px; width: 100%; max-width: 1100px; max-height: 90vh; overflow-y: auto; position: relative; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid #252532; display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 18px; font-weight: 600; color: #fff; margin: 0; }
    .modal-close { width: 32px; height: 32px; border-radius: 8px; background: transparent; border: none; color: #71717a; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { background: #252532; color: #e4e4e7; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid #252532; display: flex; justify-content: flex-end; gap: 12px; }
    .po-detail-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
    .po-detail-info h3 { font-size: 20px; font-weight: 600; color: #fff; margin: 0 0 8px 0; }
    .po-detail-meta { display: flex; gap: 16px; color: #71717a; font-size: 13px; }
    .po-items-table { margin-top: 20px; }
    .po-items-table th { background: #1a1a28; }
    .totals-row { background: #12121a; font-weight: 600; }
    .totals-row td { border-bottom: none; }
    .pagination { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-top: 1px solid #252532; }
    .pagination-info { font-size: 13px; color: #71717a; }
    .pagination-buttons { display: flex; gap: 8px; }
    .column-filter { padding: 6px 8px; background: #12121a; border: 1px solid #252532; border-radius: 6px; color: #e4e4e7; font-size: 12px; width: 100%; margin-top: 6px; outline: none; }
    .column-filter:focus { border-color: #f97316; }
    .column-filter::placeholder { color: #52525b; }
    th.filterable { vertical-align: top; }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-header">
      <div class="page-logo-container">
        <img src="/assets/logos/amazon_vendor.png" alt="Amazon Vendor Central" class="page-logo">
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="syncShipmentStatus()" id="sync-shipments-btn" title="Sync shipment status from Odoo">
          <span class="material-symbols-outlined">local_shipping</span>Sync from Odoo
        </button>
        <button class="btn btn-blue" onclick="pollOrders()" id="poll-btn">
          <span class="material-symbols-outlined">sync</span>Poll Amazon
        </button>
      </div>
    </header>
    <div class="stats-row">
      <div class="stat-card" onclick="filterByStat('new')" id="stat-new"><div class="stat-value" id="stat-new-value">--</div><div class="stat-label">New Orders</div></div>
      <div class="stat-card warning" onclick="filterByStat('action-required')" id="stat-action"><div class="stat-value" id="stat-action-value">--</div><div class="stat-label">Action Required</div></div>
      <div class="stat-card" onclick="filterByStat('not-shipped')" id="stat-notshipped"><div class="stat-value" id="stat-ship-value">--</div><div class="stat-label">Not Shipped</div></div>
      <div class="stat-card" onclick="filterByStat('invoice-pending')" id="stat-invoicepending"><div class="stat-value" id="stat-invoice-value">--</div><div class="stat-label">Invoice Pending</div></div>
      <div class="stat-card success" onclick="filterByStat('closed')" id="stat-closed"><div class="stat-value" id="stat-closed-value">--</div><div class="stat-label">Closed</div></div>
    </div>
    <div class="filters-bar">
      <input type="date" class="filter-input" id="filter-date-from" onchange="loadOrders()">
      <input type="date" class="filter-input" id="filter-date-to" onchange="loadOrders()">
      <button class="btn btn-secondary btn-sm" onclick="clearFilters()"><span class="material-symbols-outlined">clear</span>Clear</button>
    </div>
    <div class="card">
      <div class="table-container">
        <table id="orders-table-element">
          <thead>
            <tr>
              <th class="filterable">PO Number<br><input type="text" class="column-filter" id="col-filter-po" placeholder="Filter..." oninput="applyColumnFilters()"></th>
              <th class="filterable">Marketplace<br>
                <select class="column-filter" id="col-filter-marketplace" onchange="applyColumnFilters()">
                  <option value="">All</option>
                  <option value="DE">DE</option>
                  <option value="FR">FR</option>
                  <option value="IT">IT</option>
                  <option value="ES">ES</option>
                  <option value="NL">NL</option>
                  <option value="BE">BE</option>
                  <option value="PL">PL</option>
                  <option value="SE">SE</option>
                </select>
              </th>
              <th>Date</th>
              <th class="filterable">State<br>
                <select class="column-filter" id="col-filter-state" onchange="applyColumnFilters()">
                  <option value="">All</option>
                  <option value="New">New</option>
                  <option value="Acknowledged">Acknowledged</option>
                  <option value="Closed">Closed</option>
                </select>
              </th>
              <th class="filterable">Shipping<br>
                <select class="column-filter" id="col-filter-shipping" onchange="applyColumnFilters()">
                  <option value="">All</option>
                  <option value="Not Shipped">Not Shipped</option>
                  <option value="Partial">Partial</option>
                  <option value="Shipped">Shipped</option>
                </select>
              </th>
              <th>Items</th>
              <th>Total</th>
              <th class="filterable">Odoo Order<br><input type="text" class="column-filter" id="col-filter-odoo" placeholder="Filter..." oninput="applyColumnFilters()"></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="orders-table"><tr><td colspan="9"><div class="empty-state"><span class="material-symbols-outlined">hourglass_empty</span><div class="empty-state-title">Loading orders...</div></div></td></tr></tbody>
        </table>
      </div>
      <div class="pagination">
        <div class="pagination-info" id="pagination-info">Showing 0 of 0 orders</div>
        <div class="pagination-buttons">
          <button class="btn btn-secondary btn-sm" onclick="prevPage()" id="prev-btn" disabled><span class="material-symbols-outlined">chevron_left</span></button>
          <button class="btn btn-secondary btn-sm" onclick="nextPage()" id="next-btn" disabled><span class="material-symbols-outlined">chevron_right</span></button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="po-modal">
    <div class="modal">
      <div class="loading-overlay" id="modal-loading" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading order details...</div>
      </div>
      <div class="modal-header"><h2 class="modal-title">Purchase Order Details</h2><button class="modal-close" onclick="closeModal()"><span class="material-symbols-outlined">close</span></button></div>
      <div class="modal-body" id="po-modal-body"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        <button class="btn btn-success" onclick="createOdooOrder(currentPO)" id="modal-create-odoo"><span class="material-symbols-outlined">add_shopping_cart</span>Create Odoo Order</button>
        <button class="btn btn-primary" onclick="acknowledgePO(currentPO)" id="modal-ack"><span class="material-symbols-outlined">check_circle</span>Acknowledge</button>
      </div>
    </div>
  </div>
  <script>
    const MARKETPLACE_FLAGS = { DE: 'de', FR: 'fr', IT: 'it', ES: 'es', NL: 'nl', BE: 'be', PL: 'pl', SE: 'se', UK: 'gb', GB: 'gb', CZ: 'cz', AT: 'at' };
    function getFlagImg(mp) {
      const code = MARKETPLACE_FLAGS[mp];
      if (!code) return mp || '-';
      return '<img src="https://flagcdn.com/w40/' + code + '.png" alt="' + mp + '" style="width:24px;height:16px;object-fit:cover;border-radius:2px;vertical-align:middle;"> ' + mp;
    }
    let orders = [], stats = {}, currentPage = 0, pageSize = 50, totalOrders = 0, currentPO = null, currentStatFilter = null;
    let currentPOData = null; // Full PO data with stock info
    async function init() {
      // Set default column filters: New + Not Shipped
      document.getElementById('col-filter-state').value = 'New';
      document.getElementById('col-filter-shipping').value = 'Not Shipped';
      await Promise.all([loadStats(), loadOrders()]);
    }
    async function loadStats() {
      try {
        const res = await fetch('/api/vendor/stats', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        const summary = data.stats?.summary || {};
        document.getElementById('stat-new-value').textContent = summary.new || 0;
        document.getElementById('stat-action-value').textContent = (summary.new || 0) + (summary.openOrders || 0);
        document.getElementById('stat-ship-value').textContent = summary.notShipped || 0;
        document.getElementById('stat-invoice-value').textContent = summary.invoicePending || 0;
        document.getElementById('stat-closed-value').textContent = summary.closed || 0;
      } catch (e) { console.error('Error loading stats:', e); }
    }
    async function loadOrders() {
      try {
        const params = new URLSearchParams();
        params.append('limit', pageSize);
        params.append('skip', currentPage * pageSize);
        if (currentStatFilter) { params.append('statFilter', currentStatFilter); }
        else {
          const df = document.getElementById('filter-date-from').value;
          const dt = document.getElementById('filter-date-to').value;
          if (df) params.append('dateFrom', df);
          if (dt) params.append('dateTo', dt);
        }
        const res = await fetch('/api/vendor/orders?' + params, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        orders = data.orders || [];
        totalOrders = data.total || 0;
        renderOrders();
        updatePagination();
      } catch (e) {
        console.error('Error:', e);
        document.getElementById('orders-table').innerHTML = '<tr><td colspan="9"><div class="empty-state"><span class="material-symbols-outlined">error</span><div class="empty-state-title">Failed to load</div></div></td></tr>';
      }
    }
    function getShippingStatus(o) {
      const status = o.shipmentStatus || 'not_shipped';
      if (status === 'fully_shipped') return 'Shipped';
      if (status === 'partially_shipped') return 'Partial';
      return 'Not Shipped';
    }
    function renderOrders() {
      const tbody = document.getElementById('orders-table');
      if (orders.length === 0) {
        // Check if default filters are active (New + Not Shipped)
        const stateFilter = document.getElementById('col-filter-state').value;
        const shippingFilter = document.getElementById('col-filter-shipping').value;
        const isDefaultFilter = stateFilter === 'New' && shippingFilter === 'Not Shipped';
        if (isDefaultFilter) {
          tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state empty-state-success"><span class="material-symbols-outlined">check_circle</span><div class="empty-state-title">Great job! All orders are acknowledged and shipped - <span class="empty-state-link" onclick="clearFilters()">show all orders</span></div></div></td></tr>';
        } else {
          tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><span class="material-symbols-outlined">inventory_2</span><div class="empty-state-title">No orders found</div></div></td></tr>';
        }
        return;
      }
      tbody.innerHTML = orders.map(o => {
        const shipStatus = getShippingStatus(o);
        const shipClass = shipStatus === 'Shipped' ? 'badge-acknowledged' : (shipStatus === 'Partial' ? 'badge-new' : 'badge-closed');
        return '<tr><td><a href="#" class="po-number" onclick="viewOrder(\'' + o.purchaseOrderNumber + '\'); return false;">' + o.purchaseOrderNumber + '</a></td><td><span class="marketplace-badge">' + getFlagImg(o.marketplaceId) + '</span></td><td>' + formatDate(o.purchaseOrderDate) + '</td><td><span class="badge badge-' + o.purchaseOrderState.toLowerCase() + '">' + o.purchaseOrderState + '</span></td><td><span class="badge ' + shipClass + '">' + shipStatus + '</span></td><td>' + o.itemCount + ' items</td><td>' + formatCurrency(o.totals?.totalAmount, o.totals?.currency) + '</td><td>' + (o.odoo?.saleOrderName ? '<a href="https://acropaq.odoo.com/web#id=' + o.odoo.saleOrderId + '&model=sale.order&view_type=form" target="_blank" class="odoo-link">' + o.odoo.saleOrderName + '</a>' : '-') + '</td><td><button class="action-btn" onclick="viewOrder(\'' + o.purchaseOrderNumber + '\')" data-tooltip="View Details"><span class="material-symbols-outlined">visibility</span></button></td></tr>';
      }).join('');
      applyColumnFilters();
    }
    function formatDate(d) { return d ? new Date(d).toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' }) : '-'; }
    function formatCurrency(a, c) { return a != null ? new Intl.NumberFormat('en-EU', { style: 'currency', currency: c || 'EUR' }).format(a) : '-'; }
    function updatePagination() {
      const s = currentPage * pageSize + 1, e = Math.min((currentPage + 1) * pageSize, totalOrders);
      document.getElementById('pagination-info').textContent = totalOrders > 0 ? 'Showing ' + s + '-' + e + ' of ' + totalOrders : 'No orders';
      document.getElementById('prev-btn').disabled = currentPage === 0;
      document.getElementById('next-btn').disabled = e >= totalOrders;
    }
    function prevPage() { if (currentPage > 0) { currentPage--; loadOrders(); } }
    function nextPage() { if ((currentPage + 1) * pageSize < totalOrders) { currentPage++; loadOrders(); } }
    function filterByStat(s) {
      document.querySelectorAll('.stat-card').forEach(el => el.classList.remove('active'));
      if (currentStatFilter === s) { currentStatFilter = null; } else { currentStatFilter = s; const id = s.replace(/-/g, ''); document.getElementById('stat-' + id)?.classList.add('active'); }
      currentPage = 0; loadOrders();
    }
    function clearFilters() {
      document.getElementById('filter-date-from').value = '';
      document.getElementById('filter-date-to').value = '';
      document.getElementById('col-filter-po').value = '';
      document.getElementById('col-filter-marketplace').value = '';
      document.getElementById('col-filter-state').value = '';
      document.getElementById('col-filter-shipping').value = '';
      document.getElementById('col-filter-odoo').value = '';
      document.querySelectorAll('.stat-card').forEach(el => el.classList.remove('active'));
      currentStatFilter = null; currentPage = 0; loadOrders();
    }
    function applyColumnFilters() {
      const poFilter = document.getElementById('col-filter-po').value.toLowerCase();
      const mpFilter = document.getElementById('col-filter-marketplace').value;
      const stateFilter = document.getElementById('col-filter-state').value;
      const shippingFilter = document.getElementById('col-filter-shipping').value;
      const odooFilter = document.getElementById('col-filter-odoo').value.toLowerCase();
      const tbody = document.getElementById('orders-table');
      const rows = tbody.querySelectorAll('tr');
      let visibleCount = 0;
      rows.forEach(row => {
        if (row.querySelector('.empty-state')) return;
        const cells = row.querySelectorAll('td');
        if (cells.length < 8) return;
        const po = cells[0].textContent.toLowerCase();
        const mp = cells[1].textContent.trim();
        const state = cells[3].textContent.trim();
        const shipping = cells[4].textContent.trim();
        const odoo = cells[7].textContent.toLowerCase();
        let visible = true;
        if (poFilter && !po.includes(poFilter)) visible = false;
        if (mpFilter && !mp.includes(mpFilter)) visible = false;
        if (stateFilter && state !== stateFilter) visible = false;
        if (shippingFilter && shipping !== shippingFilter) visible = false;
        if (odooFilter && !odoo.includes(odooFilter)) visible = false;
        row.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
      });
      // Update pagination to show filtered count
      const hasFilters = poFilter || mpFilter || stateFilter || shippingFilter || odooFilter;
      if (hasFilters) {
        document.getElementById('pagination-info').textContent = visibleCount > 0 ? 'Showing ' + visibleCount + ' filtered orders' : 'No matching orders';
      } else {
        updatePagination();
      }
      // Show success message when default filters result in no visible rows
      if (visibleCount === 0 && stateFilter === 'New' && shippingFilter === 'Not Shipped') {
        tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state empty-state-success"><span class="material-symbols-outlined">check_circle</span><div class="empty-state-title">Great job! All orders are acknowledged and shipped - <span class="empty-state-link" onclick="clearFilters()">show all orders</span></div></div></td></tr>';
      }
    }
    async function viewOrder(po) {
      // Show modal with loading state immediately
      document.getElementById('po-modal-body').innerHTML = '';
      document.getElementById('modal-loading').style.display = 'flex';
      document.getElementById('po-modal').classList.add('open');

      try {
        // Get basic order info
        const res = await fetch('/api/vendor/orders/' + po, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load order');
        const data = await res.json();
        const o = data.order;
        currentPO = po;
        currentPOData = o;

        // Check if already acknowledged
        const isAcknowledged = o.purchaseOrderState === 'Acknowledged' || o.acknowledgment?.acknowledged;

        // Hide loading, render modal with data
        document.getElementById('modal-loading').style.display = 'none';
        renderOrderModal(o, isAcknowledged, !isAcknowledged);

        // Lazy load fresh stock info in background (only for non-acknowledged orders)
        if (!isAcknowledged) {
          loadStockInBackground(po);
        }
      } catch (e) {
        document.getElementById('modal-loading').style.display = 'none';
        document.getElementById('po-modal-body').innerHTML = '<div class="empty-state"><span class="material-symbols-outlined">error</span><div class="empty-state-title">Failed to load order</div><div class="empty-state-text">' + e.message + '</div></div>';
      }
    }

    function renderOrderModal(o, isAcknowledged, stockLoading) {
      // Build modal content
      const headerHtml = '<div class="po-detail-header"><div class="po-detail-info"><h3>' + o.purchaseOrderNumber + '</h3><div class="po-detail-meta"><span class="marketplace-badge">' + getFlagImg(o.marketplaceId) + '</span><span>Date: ' + formatDate(o.purchaseOrderDate) + '</span><span>Type: ' + (o.purchaseOrderType || 'Regular') + '</span></div></div><span class="badge badge-' + o.purchaseOrderState.toLowerCase() + '">' + o.purchaseOrderState + '</span></div>';

      const deliveryHtml = o.deliveryWindow ? '<div style="margin-bottom:20px;padding:16px;background:#12121a;border-radius:10px;"><strong style="color:#a1a1aa;">Delivery Window:</strong><span style="color:#e4e4e7;margin-left:8px;">' + formatDate(o.deliveryWindow.startDate) + ' - ' + formatDate(o.deliveryWindow.endDate) + '</span></div>' : '';

      // Build items table
      let tableHtml = '<div class="po-items-table"><table><thead><tr><th>#</th><th>SKU</th><th>Product</th><th>Ordered</th>';
      if (!isAcknowledged) {
        tableHtml += '<th>CW Stock' + (stockLoading ? ' <span class="stock-loading">(loading...)</span>' : '') + '</th><th>Accept Qty</th>';
      } else {
        tableHtml += '<th>Accepted</th><th>Shipped</th>';
      }
      tableHtml += '<th>Unit Price</th><th>Total</th></tr></thead><tbody>';

      (o.items || []).forEach((it, i) => {
        const vendorId = it.vendorProductIdentifier || '-';
        // Use cached product info if available
        const sku = it.odooSku || vendorId;
        const orderedQty = it.orderedQuantity?.amount || 0;
        const cwStock = it.qtyAvailable ?? 0;
        const productName = it.odooProductName || '';
        const currentAckQty = it.acknowledgeQty ?? orderedQty;

        tableHtml += '<tr data-ean="' + vendorId + '" data-ordered="' + orderedQty + '"><td>' + (i+1) + '</td><td style="font-family:monospace;font-size:12px;">' + sku + '</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + productName + '">' + (productName || '-') + '</td><td>' + orderedQty + '</td>';

        if (!isAcknowledged) {
          const stockColor = cwStock >= orderedQty ? '#4ade80' : (cwStock > 0 ? '#fbbf24' : '#ef4444');
          const stockDisplay = it.odooProductId ? cwStock : (stockLoading ? '<span class="stock-loading">...</span>' : '-');
          tableHtml += '<td class="stock-cell" style="color:' + stockColor + ';font-weight:600;" data-ean="' + vendorId + '">' + stockDisplay + '</td>';
          tableHtml += '<td><input type="number" class="ack-qty-input" data-ean="' + vendorId + '" value="' + currentAckQty + '" min="0" max="' + orderedQty + '" style="width:60px;padding:6px 8px;background:#12121a;border:1px solid #252532;border-radius:6px;color:#e4e4e7;text-align:center;"></td>';
        } else {
          // For acknowledged orders: show accepted qty with pencil icon
          const acceptedQty = getAcceptedQty(it, o);
          tableHtml += '<td class="accepted-qty-cell" data-ean="' + vendorId + '" data-accepted="' + acceptedQty + '">';
          tableHtml += '<span class="accepted-qty-value">' + acceptedQty + '</span>';
          tableHtml += '<button class="edit-qty-btn" onclick="editAcceptedQty(this, \'' + vendorId + '\', ' + orderedQty + ')" title="Edit accepted quantity"><span class="material-symbols-outlined">edit</span></button>';
          tableHtml += '</td>';
          tableHtml += '<td>' + (it.shippedQuantity?.amount ?? it.receivingStatus?.receivedQuantity?.amount ?? '-') + '</td>';
        }

        tableHtml += '<td>' + formatCurrency(it.netCost?.amount, it.netCost?.currencyCode) + '</td>';
        tableHtml += '<td>' + formatCurrency(orderedQty * (it.netCost?.amount || 0), it.netCost?.currencyCode) + '</td></tr>';
      });

      tableHtml += '<tr class="totals-row"><td colspan="7" style="text-align:right;">Total:</td><td>' + formatCurrency(o.totals?.totalAmount, o.totals?.currency) + '</td></tr></tbody></table></div>';

      // Auto-fill button (only if not acknowledged)
      const autoFillHtml = !isAcknowledged ? '<div style="margin-top:16px;display:flex;gap:12px;"><button class="btn btn-secondary" onclick="autoFillFromStock()" title="Fill Accept Qty with available CW stock (min of ordered vs available)"><span class="material-symbols-outlined">auto_fix</span>Auto-fill from CW Stock</button><button class="btn btn-secondary" onclick="fillAllOrdered()" title="Accept all ordered QTYs - good when you KNOW there will be availability before shipment. This just fills the Accept Qty fields."><span class="material-symbols-outlined">select_all</span>Accept All Ordered</button></div>' : '';

      const odooHtml = o.odoo?.saleOrderId ? '<div style="margin-top:20px;padding:16px;background:rgba(99,102,241,0.1);border-radius:10px;border:1px solid rgba(99,102,241,0.3);"><strong style="color:#818cf8;">Odoo Order:</strong><a href="https://acropaq.odoo.com/web#id=' + o.odoo.saleOrderId + '&model=sale.order&view_type=form" target="_blank" class="odoo-link" style="margin-left:8px;">' + o.odoo.saleOrderName + '</a></div>' : '';

      document.getElementById('po-modal-body').innerHTML = headerHtml + deliveryHtml + tableHtml + autoFillHtml + odooHtml;
      document.getElementById('modal-create-odoo').disabled = !!o.odoo?.saleOrderId;
      document.getElementById('modal-ack').disabled = isAcknowledged;
    }

    async function loadStockInBackground(po) {
      try {
        const stockRes = await fetch('/api/vendor/orders/' + po + '/check-stock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ warehouseCode: 'CW' })
        });
        if (stockRes.ok && currentPO === po) {
          const stockData = await stockRes.json();
          // Update stock cells in the current modal
          (stockData.items || []).forEach(item => {
            const cell = document.querySelector('.stock-cell[data-ean="' + item.vendorProductIdentifier + '"]');
            if (cell) {
              const row = cell.closest('tr');
              const orderedQty = parseInt(row.dataset.ordered) || 0;
              const stock = item.qtyAvailable ?? 0;
              const stockColor = stock >= orderedQty ? '#4ade80' : (stock > 0 ? '#fbbf24' : '#ef4444');
              cell.style.color = stockColor;
              cell.textContent = stock;
            }
            // Also update product name if it was missing
            const row = document.querySelector('tr[data-ean="' + item.vendorProductIdentifier + '"]');
            if (row && item.odooProductName) {
              const nameCell = row.cells[2];
              if (nameCell.textContent === '-') {
                nameCell.textContent = item.odooProductName;
                nameCell.title = item.odooProductName;
              }
              // Update SKU too
              if (item.odooSku) {
                const skuCell = row.cells[1];
                if (skuCell.textContent === item.vendorProductIdentifier) {
                  skuCell.textContent = item.odooSku;
                }
              }
            }
          });
          // Update cached PO data
          if (currentPOData) {
            currentPOData.items = currentPOData.items.map(it => {
              const updated = stockData.items.find(s => s.vendorProductIdentifier === it.vendorProductIdentifier);
              return updated ? { ...it, ...updated } : it;
            });
          }
        }
      } catch (e) { console.warn('Background stock check failed:', e); }
    }

    function editAcceptedQty(btn, ean, maxQty) {
      const cell = btn.closest('.accepted-qty-cell');
      const currentQty = cell.dataset.accepted;
      cell.innerHTML = '<div class="qty-edit-container">' +
        '<input type="number" class="qty-edit-input" value="' + currentQty + '" min="0" max="' + maxQty + '" data-ean="' + ean + '" data-original="' + currentQty + '">' +
        '<button class="qty-save-btn" onclick="saveEditedQty(\'' + ean + '\')" title="Save"><span class="material-symbols-outlined">check</span></button>' +
        '<button class="qty-cancel-btn" onclick="cancelEditQty(\'' + ean + '\', ' + currentQty + ', ' + maxQty + ')" title="Cancel"><span class="material-symbols-outlined">close</span></button>' +
        '</div>';
      cell.querySelector('.qty-edit-input').focus();
    }

    function cancelEditQty(ean, originalQty, maxQty) {
      const cell = document.querySelector('.accepted-qty-cell[data-ean="' + ean + '"]');
      cell.innerHTML = '<span class="accepted-qty-value">' + originalQty + '</span>' +
        '<button class="edit-qty-btn" onclick="editAcceptedQty(this, \'' + ean + '\', ' + maxQty + ')" title="Edit accepted quantity"><span class="material-symbols-outlined">edit</span></button>';
    }

    async function saveEditedQty(ean) {
      const input = document.querySelector('.qty-edit-input[data-ean="' + ean + '"]');
      const newQty = parseInt(input.value) || 0;
      const originalQty = parseInt(input.dataset.original) || 0;

      if (newQty === originalQty) {
        cancelEditQty(ean, originalQty, parseInt(input.max));
        return;
      }

      // Find item and prepare update
      const item = currentPOData.items.find(it => it.vendorProductIdentifier === ean);
      if (!item) return;

      const orderedQty = item.orderedQuantity?.amount || 0;
      const updateItems = [{
        vendorProductIdentifier: ean,
        acknowledgeQty: newQty,
        backorderQty: 0,
        productAvailability: newQty > 0 ? 'accepted' : 'rejected_TemporarilyUnavailable'
      }];

      try {
        // Save to MongoDB
        const saveRes = await fetch('/api/vendor/orders/' + currentPO + '/update-acknowledgments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ items: updateItems })
        });
        if (!saveRes.ok) throw new Error('Failed to save');

        // Re-send acknowledgment to Amazon
        const ackRes = await fetch('/api/vendor/orders/' + currentPO + '/acknowledge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ status: 'Accepted' })
        });
        if (!ackRes.ok) throw new Error('Failed to re-acknowledge');

        // Update UI
        const cell = document.querySelector('.accepted-qty-cell[data-ean="' + ean + '"]');
        cell.dataset.accepted = newQty;
        cell.innerHTML = '<span class="accepted-qty-value">' + newQty + '</span>' +
          '<button class="edit-qty-btn" onclick="editAcceptedQty(this, \'' + ean + '\', ' + orderedQty + ')" title="Edit accepted quantity"><span class="material-symbols-outlined">edit</span></button>';

        window.Agent5Shell?.showToast?.('Quantity updated and re-acknowledged', 'success');
      } catch (e) {
        window.Agent5Shell?.showToast?.('Error: ' + e.message, 'error');
        cancelEditQty(ean, originalQty, parseInt(input.max));
      }
    }

    function autoFillFromStock() {
      // Set each input to min(ordered, cwStock)
      document.querySelectorAll('.ack-qty-input').forEach(input => {
        const ean = input.dataset.ean;
        const row = input.closest('tr');
        const orderedQty = parseInt(row.cells[3].textContent) || 0;
        const cwStock = parseInt(row.cells[4].textContent) || 0;
        input.value = Math.min(orderedQty, cwStock);
      });
      window.Agent5Shell?.showToast?.('Quantities set based on CW stock', 'success');
    }

    function fillAllOrdered() {
      document.querySelectorAll('.ack-qty-input').forEach(input => {
        const row = input.closest('tr');
        const orderedQty = parseInt(row.cells[3].textContent) || 0;
        input.value = orderedQty;
      });
      window.Agent5Shell?.showToast?.('All quantities set to ordered amount', 'success');
    }
    function closeModal() { document.getElementById('po-modal').classList.remove('open'); currentPO = null; currentPOData = null; }
    async function syncShipmentStatus() {
      const btn = document.getElementById('sync-shipments-btn');
      btn.disabled = true; btn.innerHTML = '<span class="material-symbols-outlined">local_shipping</span>Syncing...';
      try {
        const res = await fetch('/api/vendor/orders/sync-shipment-status', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ limit: 500 }) });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        window.Agent5Shell?.showToast?.('Synced: ' + (data.updated || 0) + ' orders updated', 'success');
        await Promise.all([loadStats(), loadOrders()]);
      } catch (e) { window.Agent5Shell?.showToast?.('Sync failed: ' + e.message, 'error'); }
      finally { btn.disabled = false; btn.innerHTML = '<span class="material-symbols-outlined">local_shipping</span>Sync from Odoo'; }
    }

    async function pollOrders() {
      const btn = document.getElementById('poll-btn');
      btn.disabled = true; btn.innerHTML = '<span class="material-symbols-outlined">sync</span>Polling...';
      try {
        const res = await fetch('/api/vendor/orders/poll', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ daysBack: 7 }) });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        window.Agent5Shell?.showToast?.('Polled: ' + (data.result?.totalNew || 0) + ' new, ' + (data.result?.totalUpdated || 0) + ' updated', 'success');
        await Promise.all([loadStats(), loadOrders()]);
      } catch (e) { window.Agent5Shell?.showToast?.('Poll failed: ' + e.message, 'error'); }
      finally { btn.disabled = false; btn.innerHTML = '<span class="material-symbols-outlined">sync</span>Poll Amazon'; }
    }
    async function createOdooOrder(po) {
      if (!confirm('Create Odoo order for ' + po + '?')) return;
      try {
        const res = await fetch('/api/vendor/orders/' + po + '/create-odoo', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ confirm: true }) });
        if (!res.ok) { const d = await res.json(); throw new Error(d.error || d.errors?.join(', ') || 'Failed'); }
        const data = await res.json();
        window.Agent5Shell?.showToast?.(data.skipped ? 'Skipped: ' + data.skipReason : 'Created: ' + data.odooOrderName, data.skipped ? 'info' : 'success');
        await Promise.all([loadStats(), loadOrders()]); closeModal();
      } catch (e) { window.Agent5Shell?.showToast?.('Error: ' + e.message, 'error'); }
    }
    async function createPendingOdooOrders() {
      if (!confirm('Create Odoo orders for all pending POs?')) return;
      const btn = document.getElementById('create-odoo-btn'); btn.disabled = true;
      try {
        const res = await fetch('/api/vendor/orders/create-pending', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ confirm: true }) });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        window.Agent5Shell?.showToast?.('Created ' + (data.created || 0) + ', skipped ' + (data.skipped || 0), 'success');
        await Promise.all([loadStats(), loadOrders()]);
      } catch (e) { window.Agent5Shell?.showToast?.('Error: ' + e.message, 'error'); }
      finally { btn.disabled = false; }
    }
    async function acknowledgePO(po) {
      // Collect quantities from inputs if modal is open
      const inputs = document.querySelectorAll('.ack-qty-input');
      if (inputs.length > 0) {
        const items = [];
        let hasPartial = false;
        inputs.forEach(input => {
          const ean = input.dataset.ean;
          const ackQty = parseInt(input.value) || 0;
          const row = input.closest('tr');
          const orderedQty = parseInt(row.cells[3].textContent) || 0;
          if (ackQty < orderedQty) hasPartial = true;
          items.push({
            vendorProductIdentifier: ean,
            acknowledgeQty: ackQty,
            backorderQty: 0,
            productAvailability: ackQty > 0 ? 'accepted' : 'rejected_TemporarilyUnavailable'
          });
        });

        // Confirm with user
        const confirmMsg = hasPartial
          ? 'Some items have reduced quantities. Acknowledge ' + po + ' with these quantities?'
          : 'Acknowledge ' + po + ' with all items accepted?';
        if (!confirm(confirmMsg)) return;

        // First save the quantities
        try {
          const saveRes = await fetch('/api/vendor/orders/' + po + '/update-acknowledgments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ items })
          });
          if (!saveRes.ok) {
            const d = await saveRes.json();
            throw new Error('Failed to save quantities: ' + (d.error || 'Unknown error'));
          }
        } catch (e) {
          window.Agent5Shell?.showToast?.('Error saving quantities: ' + e.message, 'error');
          return;
        }
      } else {
        if (!confirm('Acknowledge ' + po + '?')) return;
      }

      // Now send acknowledgment to Amazon
      try {
        const res = await fetch('/api/vendor/orders/' + po + '/acknowledge', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ status: 'Accepted' }) });
        if (!res.ok) { const d = await res.json(); throw new Error(d.error || d.errors?.join(', ') || 'Failed'); }
        const data = await res.json();
        window.Agent5Shell?.showToast?.(data.skipped ? 'Skipped: ' + data.skipReason : 'Acknowledged successfully!', data.skipped ? 'info' : 'success');
        await Promise.all([loadStats(), loadOrders()]); closeModal();
      } catch (e) { window.Agent5Shell?.showToast?.('Error: ' + e.message, 'error'); }
    }
    async function acknowledgePending() {
      if (!confirm('Acknowledge all pending POs?')) return;
      const btn = document.getElementById('ack-btn'); btn.disabled = true;
      try {
        const res = await fetch('/api/vendor/orders/acknowledge-pending', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ status: 'Accepted' }) });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        window.Agent5Shell?.showToast?.('Acknowledged ' + (data.acknowledged || 0) + ', skipped ' + (data.skipped || 0), 'success');
        await Promise.all([loadStats(), loadOrders()]);
      } catch (e) { window.Agent5Shell?.showToast?.('Error: ' + e.message, 'error'); }
      finally { btn.disabled = false; }
    }
    function getAcceptedQty(item, order) {
      // If explicitly acknowledged with a quantity, use that
      if (item.acknowledgeQty && item.acknowledgeQty > 0) {
        return item.acknowledgeQty;
      }
      // If order is acknowledged and item was accepted, show ordered quantity
      if (order.purchaseOrderState === 'Acknowledged' &&
          (!item.productAvailability || item.productAvailability === 'accepted')) {
        return item.orderedQuantity?.amount || 0;
      }
      // Otherwise show dash
      return '-';
    }
    init();
  </script>
</body>
</html>
