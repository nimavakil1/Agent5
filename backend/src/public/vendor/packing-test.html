<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Packing Test - Mock Data</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f5f5f5; padding: 20px; }
    .card { margin-bottom: 20px; }
    .order-item { padding: 10px; border-bottom: 1px solid #eee; }
    .order-item:last-child { border-bottom: none; }
    .parcel-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
    .sku-badge { background: #e9ecef; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px; }

    /* Dachser mode styles */
    .dachser-banner {
      background: linear-gradient(135deg, #0033a0 0%, #0056b3 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    .dachser-banner.active { display: block; }
    .dachser-banner h5 { margin: 0; font-weight: 600; }
    .dachser-banner small { opacity: 0.9; }

    .pallet-config {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: none;
    }
    .pallet-config.active { display: block; }

    .pallet-weight-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding: 8px;
      background: #fffbeb;
      border-radius: 4px;
    }

    .suggest-btn {
      background: #198754;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .suggest-btn:hover { background: #157347; }

    .type-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 8px;
    }
    .type-badge.master { background: #0d6efd; color: white; }
    .type-badge.inner { background: #6c757d; color: white; }
    .type-badge.mixed { background: #dc3545; color: white; }
    .type-badge.manual { background: #ffc107; color: black; }

    .delete-parcel-btn {
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
      padding: 0 5px;
    }

    .remaining-items {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: none;
    }
    .remaining-items.active { display: block; }

    .mock-label {
      background: white;
      border: 2px solid #333;
      padding: 15px;
      margin: 10px 0;
      font-family: monospace;
    }
    .mock-label .barcode {
      background: repeating-linear-gradient(90deg, #000 0px, #000 2px, #fff 2px, #fff 4px);
      height: 40px;
      margin: 10px 0;
    }

    .log-panel {
      background: #1e1e1e;
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      padding: 15px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .log-panel .log-entry { margin-bottom: 5px; }
    .log-panel .log-api { color: #0ff; }
    .log-panel .log-success { color: #0f0; }
    .log-panel .log-info { color: #ff0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="alert alert-warning">
      <strong>TEST MODE</strong> - This page uses mock data. No real API calls are made.
    </div>

    <!-- Consolidation Group Info -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Consolidation Group: EU_XMS1_2025-02-10</h5>
        <span class="badge bg-primary">3 Orders</span>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <strong>Destination:</strong> Amazon XMS1<br>
            <small class="text-muted">
              Amazon Fulfillment Center<br>
              Amazonstra√üe 1<br>
              36251 Bad Hersfeld, Germany
            </small>
          </div>
          <div class="col-md-6">
            <strong>Delivery Window:</strong> 2025-02-08 to 2025-02-10<br>
            <strong>Total Items:</strong> 156 units
          </div>
        </div>

        <!-- Carrier Selection -->
        <div class="row mb-3">
          <div class="col-md-4">
            <label class="form-label"><strong>Carrier:</strong></label>
            <select class="form-select" id="carrierSelect" onchange="onCarrierChange()">
              <option value="gls">GLS (Parcels)</option>
              <option value="dachser">Dachser (Pallets)</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Dachser Banner -->
    <div class="dachser-banner" id="dachserBanner">
      <h5>üöõ Dachser Freight Mode</h5>
      <small>Pallet shipment to Amazon FC. SSCC labels will be generated for each carton.</small>
    </div>

    <!-- Orders in this group -->
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">Orders</h6>
      </div>
      <div class="card-body p-0">
        <div class="order-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>PO: 4GF5EXAMPLE1</strong>
              <span class="badge bg-secondary ms-2">DE</span>
            </div>
            <span>48 units</span>
          </div>
          <small class="text-muted">
            <span class="sku-badge">ACR-CALC-001 x24</span>
            <span class="sku-badge">ACR-LABEL-002 x24</span>
          </small>
        </div>
        <div class="order-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>PO: 4GF5EXAMPLE2</strong>
              <span class="badge bg-secondary ms-2">DE</span>
            </div>
            <span>60 units</span>
          </div>
          <small class="text-muted">
            <span class="sku-badge">ACR-CALC-001 x36</span>
            <span class="sku-badge">ACR-STAPLER-003 x24</span>
          </small>
        </div>
        <div class="order-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>PO: 4GF5EXAMPLE3</strong>
              <span class="badge bg-secondary ms-2">DE</span>
            </div>
            <span>48 units</span>
          </div>
          <small class="text-muted">
            <span class="sku-badge">ACR-LABEL-002 x48</span>
          </small>
        </div>
      </div>
    </div>

    <!-- Pallet Configuration (Dachser only) -->
    <div class="pallet-config" id="palletConfig">
      <h6>üì¶ Pallet Configuration</h6>
      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">Number of Pallets:</label>
          <input type="number" class="form-control" id="palletCount" value="1" min="1" max="10" onchange="updatePalletWeightFields()">
        </div>
        <div class="col-md-3">
          <label class="form-label">Pallet Type:</label>
          <select class="form-select" id="palletType">
            <option value="EU">Euro Pallet (80x120)</option>
          </select>
        </div>
      </div>
      <div id="palletWeights">
        <!-- Pallet weight fields will be inserted here -->
      </div>
      <div class="mt-2">
        <small class="text-muted">
          <strong>Estimated total:</strong> <span id="estimatedWeight">~45 kg</span> |
          <strong>Your total:</strong> <span id="actualWeight">0 kg</span>
        </small>
      </div>
    </div>

    <!-- Suggest Cartons Button (Dachser only) -->
    <div id="suggestSection" style="display: none;">
      <button class="suggest-btn mb-3" onclick="suggestCartons()">
        ‚ú® Suggest Cartons from Odoo Packaging
      </button>
    </div>

    <!-- Remaining Items (after suggestions) -->
    <div class="remaining-items" id="remainingItems">
      <h6>‚ö†Ô∏è Remaining Items (add manually)</h6>
      <div id="remainingList"></div>
    </div>

    <!-- Parcels/Cartons -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0" id="parcelsTitle">Parcels</h6>
        <button class="btn btn-sm btn-outline-primary" onclick="addParcel()">+ Add Parcel</button>
      </div>
      <div class="card-body" id="parcelsList">
        <p class="text-muted">No parcels added yet. Click "Add Parcel" or use "Suggest Cartons".</p>
      </div>
    </div>

    <!-- Generate Labels Button -->
    <div class="d-grid gap-2">
      <button class="btn btn-primary btn-lg" onclick="generateLabels()" id="generateBtn">
        Generate Labels
      </button>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" style="display: none;" class="mt-4">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">‚úÖ Labels Generated Successfully</h5>
        </div>
        <div class="card-body" id="resultsContent">
        </div>
      </div>
    </div>

    <!-- Log Panel -->
    <div class="log-panel" id="logPanel">
      <div class="log-entry log-info">[MOCK] Test page loaded - no real API calls will be made</div>
    </div>
  </div>

  <script>
    // Mock data
    const mockOrders = [
      {
        poNumber: '4GF5EXAMPLE1',
        items: [
          { sku: 'ACR-CALC-001', qty: 24, productName: 'Calculator Basic' },
          { sku: 'ACR-LABEL-002', qty: 24, productName: 'Label Maker Pro' }
        ]
      },
      {
        poNumber: '4GF5EXAMPLE2',
        items: [
          { sku: 'ACR-CALC-001', qty: 36, productName: 'Calculator Basic' },
          { sku: 'ACR-STAPLER-003', qty: 24, productName: 'Heavy Duty Stapler' }
        ]
      },
      {
        poNumber: '4GF5EXAMPLE3',
        items: [
          { sku: 'ACR-LABEL-002', qty: 48, productName: 'Label Maker Pro' }
        ]
      }
    ];

    const mockPackaging = {
      'ACR-CALC-001': { masterCarton: { qty: 20, name: 'Master Carton 20pcs' }, innerBox: { qty: 5, name: 'Inner Box 5pcs' } },
      'ACR-LABEL-002': { masterCarton: { qty: 12, name: 'Master Carton 12pcs' }, innerBox: null },
      'ACR-STAPLER-003': { masterCarton: { qty: 10, name: 'Master Carton 10pcs' }, innerBox: { qty: 2, name: 'Inner Box 2pcs' } }
    };

    let parcels = [];
    let isDachser = false;

    function log(message, type = 'info') {
      const panel = document.getElementById('logPanel');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      panel.appendChild(entry);
      panel.scrollTop = panel.scrollHeight;
    }

    function onCarrierChange() {
      const carrier = document.getElementById('carrierSelect').value;
      isDachser = carrier === 'dachser';

      document.getElementById('dachserBanner').classList.toggle('active', isDachser);
      document.getElementById('palletConfig').classList.toggle('active', isDachser);
      document.getElementById('suggestSection').style.display = isDachser ? 'block' : 'none';
      document.getElementById('parcelsTitle').textContent = isDachser ? 'Cartons' : 'Parcels';
      document.getElementById('generateBtn').textContent = isDachser ? 'Generate SSCC Labels & Book Dachser' : 'Generate Labels';

      if (isDachser) {
        log('Switched to Dachser mode - pallet shipment', 'info');
        updatePalletWeightFields();
      } else {
        log('Switched to GLS mode - parcel shipment', 'info');
      }
    }

    function updatePalletWeightFields() {
      const count = parseInt(document.getElementById('palletCount').value) || 1;
      const container = document.getElementById('palletWeights');
      container.innerHTML = '';

      for (let i = 1; i <= count; i++) {
        const row = document.createElement('div');
        row.className = 'pallet-weight-row';
        row.innerHTML = `
          <label style="min-width: 80px;">Pallet ${i}:</label>
          <input type="number" class="form-control" style="width: 100px;" placeholder="kg" onchange="updateActualWeight()">
          <span class="text-muted">kg</span>
        `;
        container.appendChild(row);
      }
    }

    function updateActualWeight() {
      const inputs = document.querySelectorAll('#palletWeights input');
      let total = 0;
      inputs.forEach(input => {
        total += parseFloat(input.value) || 0;
      });
      document.getElementById('actualWeight').textContent = total + ' kg';
    }

    function suggestCartons() {
      log('[MOCK API] POST /api/vendor/packing/suggest-cartons', 'api');
      log('Fetching packaging info from Odoo...', 'info');

      // Simulate API delay
      setTimeout(() => {
        parcels = [];
        const remaining = {};

        // Aggregate all items by SKU
        const totalBySku = {};
        mockOrders.forEach(order => {
          order.items.forEach(item => {
            totalBySku[item.sku] = (totalBySku[item.sku] || 0) + item.qty;
          });
        });

        // Suggest cartons based on packaging
        for (const [sku, qty] of Object.entries(totalBySku)) {
          const packaging = mockPackaging[sku];
          let remainingQty = qty;

          if (packaging?.masterCarton) {
            const masterQty = packaging.masterCarton.qty;
            const numMasters = Math.floor(remainingQty / masterQty);

            for (let i = 0; i < numMasters; i++) {
              parcels.push({
                id: Date.now() + Math.random(),
                type: 'master',
                sku: sku,
                qty: masterQty,
                description: `${sku} - ${packaging.masterCarton.name}`,
                weight: 5 // mock weight
              });
            }
            remainingQty = remainingQty % masterQty;
          }

          if (remainingQty > 0 && packaging?.innerBox) {
            const innerQty = packaging.innerBox.qty;
            const numInners = Math.floor(remainingQty / innerQty);

            for (let i = 0; i < numInners; i++) {
              parcels.push({
                id: Date.now() + Math.random(),
                type: 'inner',
                sku: sku,
                qty: innerQty,
                description: `${sku} - ${packaging.innerBox.name}`,
                weight: 2 // mock weight
              });
            }
            remainingQty = remainingQty % innerQty;
          }

          if (remainingQty > 0) {
            remaining[sku] = remainingQty;
          }
        }

        log(`Suggested ${parcels.length} cartons based on Odoo packaging`, 'success');
        renderParcels();
        renderRemainingItems(remaining);
      }, 500);
    }

    function renderParcels() {
      const container = document.getElementById('parcelsList');

      if (parcels.length === 0) {
        container.innerHTML = '<p class="text-muted">No parcels added yet. Click "Add Parcel" or use "Suggest Cartons".</p>';
        return;
      }

      container.innerHTML = parcels.map((p, i) => `
        <div class="parcel-card">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>Carton ${i + 1}</strong>
              ${p.type ? `<span class="type-badge ${p.type}">${p.type.toUpperCase()}</span>` : ''}
              <button class="delete-parcel-btn" onclick="deleteParcel(${i})">üóëÔ∏è</button>
            </div>
            <span class="text-muted">${p.weight} kg</span>
          </div>
          <div class="mt-2">
            <span class="sku-badge">${p.sku} x${p.qty}</span>
          </div>
          <small class="text-muted">${p.description}</small>
        </div>
      `).join('');
    }

    function renderRemainingItems(remaining) {
      const container = document.getElementById('remainingItems');
      const list = document.getElementById('remainingList');

      if (Object.keys(remaining).length === 0) {
        container.classList.remove('active');
        return;
      }

      container.classList.add('active');
      list.innerHTML = Object.entries(remaining).map(([sku, qty]) => `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span><strong>${sku}</strong> - ${qty} units remaining</span>
          <button class="btn btn-sm btn-outline-warning" onclick="addMixedCarton('${sku}', ${qty})">Add as Mixed Carton</button>
        </div>
      `).join('');
    }

    function deleteParcel(index) {
      parcels.splice(index, 1);
      log(`Deleted carton ${index + 1}`, 'info');
      renderParcels();
    }

    function addParcel() {
      const parcel = {
        id: Date.now(),
        type: 'manual',
        sku: 'MANUAL',
        qty: 1,
        description: 'Manual parcel',
        weight: 1
      };
      parcels.push(parcel);
      log('Added manual parcel', 'info');
      renderParcels();
    }

    function addMixedCarton(sku, qty) {
      parcels.push({
        id: Date.now(),
        type: 'mixed',
        sku: sku,
        qty: qty,
        description: `Mixed carton - ${sku}`,
        weight: 3
      });
      log(`Added mixed carton for ${sku} x${qty}`, 'info');
      renderParcels();

      // Remove from remaining
      document.getElementById('remainingItems').classList.remove('active');
    }

    function generateLabels() {
      if (parcels.length === 0) {
        alert('Please add at least one parcel/carton');
        return;
      }

      const resultsSection = document.getElementById('resultsSection');
      const resultsContent = document.getElementById('resultsContent');

      if (isDachser) {
        // Dachser flow
        log('[MOCK API] Generating SSCC labels...', 'api');

        setTimeout(() => {
          log('[MOCK API] POST /api/vendor/asn/submit - Submitting ASN to Amazon', 'api');

          setTimeout(() => {
            const mockAsnNumber = 'ASN' + Date.now().toString().slice(-8);
            log(`ASN submitted successfully: ${mockAsnNumber}`, 'success');

            log('[MOCK API] POST /api/dachser/transport-order - Creating Dachser booking', 'api');
            log(`Delivery instructions: "PO 4GF5EXAMPLE1 + 4GF5EXAMPLE2 + 4GF5EXAMPLE3 | ASN: ${mockAsnNumber} | 1 PAL - ${parcels.length} cartons"`, 'info');

            setTimeout(() => {
              const mockTrackingNumber = '70' + Date.now().toString().slice(-10);
              log(`Dachser booking created: ${mockTrackingNumber}`, 'success');

              resultsContent.innerHTML = `
                <div class="alert alert-info">
                  <strong>ASN Number:</strong> ${mockAsnNumber}<br>
                  <strong>Dachser Tracking:</strong> ${mockTrackingNumber}
                </div>

                <h6>SSCC Labels (${parcels.length} cartons):</h6>
                ${parcels.map((p, i) => `
                  <div class="mock-label">
                    <div style="text-align: center; font-weight: bold;">SSCC LABEL</div>
                    <div class="barcode"></div>
                    <div>SSCC: 00 3 7612345 ${String(i+1).padStart(9, '0')} 0</div>
                    <div>PO: 4GF5EXAMPLE1, 4GF5EXAMPLE2, 4GF5EXAMPLE3</div>
                    <div>SKU: ${p.sku} x ${p.qty}</div>
                  </div>
                `).join('')}

                <h6 class="mt-4">Dachser Pallet Label:</h6>
                <div class="mock-label">
                  <div style="text-align: center; font-weight: bold; font-size: 18px;">DACHSER</div>
                  <div class="barcode"></div>
                  <div><strong>Tracking:</strong> ${mockTrackingNumber}</div>
                  <div><strong>From:</strong> Acropaq NV, Willebroek, BE</div>
                  <div><strong>To:</strong> Amazon XMS1, Bad Hersfeld, DE</div>
                  <div><strong>Weight:</strong> ${document.getElementById('actualWeight').textContent || '45 kg'}</div>
                </div>
              `;

              resultsSection.style.display = 'block';
              resultsSection.scrollIntoView({ behavior: 'smooth' });
            }, 500);
          }, 500);
        }, 500);

      } else {
        // GLS flow
        log('[MOCK API] POST /api/gls/labels - Generating GLS labels', 'api');

        setTimeout(() => {
          log(`Generated ${parcels.length} GLS labels`, 'success');

          resultsContent.innerHTML = `
            <div class="alert alert-info">
              <strong>GLS Tracking Numbers:</strong><br>
              ${parcels.map((p, i) => `Parcel ${i+1}: GLSBE${Date.now().toString().slice(-8)}${i}`).join('<br>')}
            </div>

            <h6>GLS Labels:</h6>
            ${parcels.map((p, i) => `
              <div class="mock-label">
                <div style="text-align: center; font-weight: bold;">GLS</div>
                <div class="barcode"></div>
                <div>Tracking: GLSBE${Date.now().toString().slice(-8)}${i}</div>
                <div>To: Amazon XMS1, Bad Hersfeld, DE</div>
                <div>Weight: ${p.weight} kg</div>
              </div>
            `).join('')}
          `;

          resultsSection.style.display = 'block';
          resultsSection.scrollIntoView({ behavior: 'smooth' });
        }, 500);
      }
    }

    // Initialize
    updatePalletWeightFields();
  </script>
</body>
</html>
