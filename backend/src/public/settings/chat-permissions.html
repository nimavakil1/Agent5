<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Permissions - Settings</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <script src="/shell-v2.js"></script>
  <style>
    .page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px;
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      margin: 0;
    }

    .page-subtitle {
      font-size: 14px;
      color: #71717a;
      margin-top: 4px;
    }

    /* Summary Cards */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .summary-card {
      background: #18181f;
      border: 1px solid #252532;
      border-radius: 12px;
      padding: 20px;
    }

    .summary-card-title {
      font-size: 12px;
      font-weight: 600;
      color: #71717a;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .summary-card-value {
      font-size: 28px;
      font-weight: 700;
      color: #fff;
    }

    .summary-card-sub {
      font-size: 12px;
      color: #a1a1aa;
      margin-top: 4px;
    }

    /* Users Table */
    .users-table-wrapper {
      background: #18181f;
      border: 1px solid #252532;
      border-radius: 16px;
      overflow: hidden;
    }

    .table-header {
      padding: 16px 20px;
      border-bottom: 1px solid #252532;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .table-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: #12121a;
      border: 1px solid #252532;
      border-radius: 10px;
      width: 280px;
    }

    .search-box .material-symbols-outlined {
      color: #71717a;
      font-size: 20px;
    }

    .search-box input {
      background: transparent;
      border: none;
      outline: none;
      color: #e4e4e7;
      font-size: 14px;
      flex: 1;
    }

    .search-box input::placeholder {
      color: #52525b;
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
    }

    .users-table thead {
      background: #12121a;
    }

    .users-table th {
      padding: 14px 20px;
      font-size: 12px;
      font-weight: 600;
      color: #71717a;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      text-align: left;
      border-bottom: 1px solid #252532;
    }

    .users-table th.module-col {
      text-align: center;
      min-width: 100px;
    }

    .users-table tbody tr {
      border-bottom: 1px solid #252532;
      transition: background 0.15s;
    }

    .users-table tbody tr:last-child {
      border-bottom: none;
    }

    .users-table tbody tr:hover {
      background: rgba(99, 102, 241, 0.05);
    }

    .users-table td {
      padding: 16px 20px;
    }

    .user-cell {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      color: white;
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }

    .user-email {
      font-size: 12px;
      color: #71717a;
    }

    .role-badge {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .role-badge.superadmin {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
    }

    .role-badge.admin {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
    }

    .role-badge.user {
      background: rgba(34, 197, 94, 0.15);
      color: #4ade80;
    }

    /* Module Permission Toggle */
    .module-toggle-cell {
      text-align: center;
    }

    .module-toggle {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggle-label {
      font-size: 10px;
      color: #71717a;
      width: 50px;
      text-align: right;
    }

    .toggle-switch {
      position: relative;
      width: 36px;
      height: 20px;
      background: #252532;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle-switch.active {
      background: #6366f1;
    }

    .toggle-switch.active.execute {
      background: #22c55e;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 14px;
      height: 14px;
      background: white;
      border-radius: 7px;
      transition: transform 0.2s;
    }

    .toggle-switch.active::after {
      transform: translateX(16px);
    }

    .toggle-switch.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Empty & Loading States */
    .empty-state {
      padding: 60px 20px;
      text-align: center;
    }

    .empty-state .material-symbols-outlined {
      font-size: 48px;
      color: #3f3f50;
      margin-bottom: 16px;
    }

    .empty-state-title {
      font-size: 16px;
      font-weight: 600;
      color: #e4e4e7;
      margin-bottom: 4px;
    }

    .empty-state-text {
      font-size: 14px;
      color: #71717a;
    }

    /* Access denied */
    .access-denied {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      text-align: center;
    }

    .access-denied .material-symbols-outlined {
      font-size: 64px;
      color: #ef4444;
      margin-bottom: 20px;
    }

    .access-denied-title {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
    }

    .access-denied-text {
      font-size: 14px;
      color: #71717a;
      max-width: 400px;
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 20px;
      background: #18181f;
      border: 1px solid #252532;
      border-radius: 12px;
      color: #e4e4e7;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-color: #22c55e;
    }

    .toast.success .material-symbols-outlined {
      color: #22c55e;
    }

    .toast.error {
      border-color: #ef4444;
    }

    .toast.error .material-symbols-outlined {
      color: #ef4444;
    }

    /* Module header icons */
    .module-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .module-header .material-symbols-outlined {
      font-size: 20px;
      color: #71717a;
    }

    .module-name {
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div class="page" id="main-page" style="display: none;">
    <header class="page-header">
      <div>
        <h1 class="page-title">Chat Permissions</h1>
        <p class="page-subtitle">Manage which users can access the AI Assistant for each module</p>
      </div>
    </header>

    <!-- Summary Cards -->
    <div class="summary-grid" id="summary-grid">
      <div class="summary-card">
        <div class="summary-card-title">Total Users</div>
        <div class="summary-card-value" id="total-users">-</div>
        <div class="summary-card-sub">with chat access</div>
      </div>
      <div class="summary-card">
        <div class="summary-card-title">Bol.com</div>
        <div class="summary-card-value" id="bol-users">-</div>
        <div class="summary-card-sub">can chat / execute</div>
      </div>
      <div class="summary-card">
        <div class="summary-card-title">Amazon Seller</div>
        <div class="summary-card-value" id="amazon-seller-users">-</div>
        <div class="summary-card-sub">can chat / execute</div>
      </div>
      <div class="summary-card">
        <div class="summary-card-title">Amazon Vendor</div>
        <div class="summary-card-value" id="amazon-vendor-users">-</div>
        <div class="summary-card-sub">can chat / execute</div>
      </div>
      <div class="summary-card">
        <div class="summary-card-title">Odoo</div>
        <div class="summary-card-value" id="odoo-users">-</div>
        <div class="summary-card-sub">can chat / execute</div>
      </div>
      <div class="summary-card">
        <div class="summary-card-title">Purchasing</div>
        <div class="summary-card-value" id="purchasing-users">-</div>
        <div class="summary-card-sub">can chat / execute</div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="users-table-wrapper">
      <div class="table-header">
        <div class="table-title">User Permissions</div>
        <div class="search-box">
          <span class="material-symbols-outlined">search</span>
          <input type="text" id="search-input" placeholder="Search users..." oninput="filterUsers()">
        </div>
      </div>
      <table class="users-table">
        <thead>
          <tr>
            <th style="width: 280px;">User</th>
            <th style="width: 100px;">Role</th>
            <th class="module-col">
              <div class="module-header">
                <span class="material-symbols-outlined">shopping_bag</span>
                <span class="module-name">Bol.com</span>
              </div>
            </th>
            <th class="module-col">
              <div class="module-header">
                <span class="material-symbols-outlined">storefront</span>
                <span class="module-name">Amazon Seller</span>
              </div>
            </th>
            <th class="module-col">
              <div class="module-header">
                <span class="material-symbols-outlined">local_shipping</span>
                <span class="module-name">Amazon Vendor</span>
              </div>
            </th>
            <th class="module-col">
              <div class="module-header">
                <span class="material-symbols-outlined">database</span>
                <span class="module-name">Odoo</span>
              </div>
            </th>
            <th class="module-col">
              <div class="module-header">
                <span class="material-symbols-outlined">shopping_cart</span>
                <span class="module-name">Purchasing</span>
              </div>
            </th>
          </tr>
        </thead>
        <tbody id="users-tbody">
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <span class="material-symbols-outlined">hourglass_empty</span>
                <div class="empty-state-title">Loading users...</div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Access Denied -->
  <div class="page access-denied" id="access-denied" style="display: none;">
    <span class="material-symbols-outlined">lock</span>
    <div class="access-denied-title">Access Denied</div>
    <div class="access-denied-text">Only super administrators can manage chat permissions. Contact your system administrator if you need access.</div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <span class="material-symbols-outlined">check_circle</span>
    <span id="toast-message"></span>
  </div>

  <script>
    const MODULES = ['bol', 'amazon_seller', 'amazon_vendor', 'odoo', 'purchasing'];
    const MODULE_KEYS = {
      'bol': 'bol',
      'amazon_seller': 'amazon-seller',
      'amazon_vendor': 'amazon-vendor',
      'odoo': 'odoo',
      'purchasing': 'purchasing'
    };

    let users = [];
    let currentUser = null;

    async function init() {
      // Check if current user is superadmin
      try {
        const res = await fetch('/api/auth/me', { credentials: 'include' });
        if (!res.ok) {
          window.location.href = '/login.html';
          return;
        }
        currentUser = await res.json();

        if (currentUser.role !== 'superadmin') {
          document.getElementById('access-denied').style.display = 'flex';
          return;
        }

        document.getElementById('main-page').style.display = 'block';
        await loadData();
      } catch (e) {
        console.error('Auth check failed:', e);
        window.location.href = '/login.html';
      }
    }

    async function loadData() {
      await Promise.all([
        loadUsers(),
        loadSummary()
      ]);
    }

    async function loadUsers() {
      try {
        const res = await fetch('/api/chat-permissions/users', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load users');
        const data = await res.json();
        users = data.users;
        renderUsers();
      } catch (e) {
        console.error('Error loading users:', e);
        showToast('Failed to load users: ' + e.message, 'error');
      }
    }

    async function loadSummary() {
      try {
        const res = await fetch('/api/chat-permissions/summary', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load summary');
        const summary = await res.json();

        document.getElementById('total-users').textContent = summary.totalUsers;

        for (const mod of MODULES) {
          const key = MODULE_KEYS[mod] || mod;
          const stats = summary.byModule[mod] || { canChat: 0, canExecute: 0 };
          const el = document.getElementById(`${key}-users`);
          if (el) {
            el.textContent = `${stats.canChat} / ${stats.canExecute}`;
          }
        }
      } catch (e) {
        console.error('Error loading summary:', e);
      }
    }

    function renderUsers() {
      const tbody = document.getElementById('users-tbody');
      const searchTerm = (document.getElementById('search-input').value || '').toLowerCase();

      const filtered = users.filter(u => {
        const fullName = `${u.firstName || ''} ${u.lastName || ''}`.toLowerCase();
        return fullName.includes(searchTerm) || (u.email || '').toLowerCase().includes(searchTerm);
      });

      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <span class="material-symbols-outlined">person_off</span>
                <div class="empty-state-title">No users found</div>
                <div class="empty-state-text">${searchTerm ? 'Try a different search term' : 'No users in the system'}</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filtered.map(user => {
        const initials = getInitials(user);
        const name = [user.firstName, user.lastName].filter(Boolean).join(' ') || user.email;
        const perms = user.permissions || {};

        return `
          <tr data-user-id="${user._id}">
            <td>
              <div class="user-cell">
                <div class="user-avatar">${initials}</div>
                <div class="user-info">
                  <div class="user-name">${escapeHtml(name)}</div>
                  <div class="user-email">${escapeHtml(user.email)}</div>
                </div>
              </div>
            </td>
            <td>
              <span class="role-badge ${user.role}">${user.role || 'user'}</span>
            </td>
            ${MODULES.map(mod => renderModuleToggles(user._id, mod, perms[mod])).join('')}
          </tr>
        `;
      }).join('');

      // Add event listeners to toggles
      tbody.querySelectorAll('.toggle-switch').forEach(toggle => {
        toggle.addEventListener('click', handleToggle);
      });
    }

    function renderModuleToggles(userId, module, permissions) {
      const canChat = permissions?.canChat === true;
      const canExecute = permissions?.canExecute === true;

      return `
        <td class="module-toggle-cell">
          <div class="module-toggle">
            <div class="toggle-row">
              <span class="toggle-label">Chat</span>
              <div class="toggle-switch ${canChat ? 'active' : ''}"
                   data-user-id="${userId}"
                   data-module="${module}"
                   data-type="canChat"></div>
            </div>
            <div class="toggle-row">
              <span class="toggle-label">Execute</span>
              <div class="toggle-switch execute ${canExecute ? 'active' : ''} ${!canChat ? 'disabled' : ''}"
                   data-user-id="${userId}"
                   data-module="${module}"
                   data-type="canExecute"></div>
            </div>
          </div>
        </td>
      `;
    }

    async function handleToggle(e) {
      const toggle = e.currentTarget;
      if (toggle.classList.contains('disabled')) return;

      const userId = toggle.dataset.userId;
      const module = toggle.dataset.module;
      const type = toggle.dataset.type;

      // Find user and current permissions
      const user = users.find(u => u._id === userId);
      if (!user) return;

      const currentPerms = user.permissions || {};

      // Build new permissions
      const newModulePerms = { ...currentPerms };
      for (const mod of MODULES) {
        newModulePerms[mod] = {
          canChat: currentPerms[mod]?.canChat === true,
          canExecute: currentPerms[mod]?.canExecute === true
        };
      }

      // Toggle the specific permission
      const newValue = !newModulePerms[module][type];
      newModulePerms[module][type] = newValue;

      // If turning off canChat, also turn off canExecute
      if (type === 'canChat' && !newValue) {
        newModulePerms[module].canExecute = false;
      }

      // Optimistic UI update
      toggle.classList.toggle('active', newValue);

      // If we changed canChat, update the execute toggle state
      if (type === 'canChat') {
        const executeToggle = document.querySelector(
          `.toggle-switch[data-user-id="${userId}"][data-module="${module}"][data-type="canExecute"]`
        );
        if (executeToggle) {
          executeToggle.classList.toggle('disabled', !newValue);
          if (!newValue) {
            executeToggle.classList.remove('active');
          }
        }
      }

      // Save to server
      try {
        const res = await fetch(`/api/chat-permissions/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ modules: newModulePerms })
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to save');
        }

        // Update local state
        user.permissions = newModulePerms;
        user.hasPermissions = true;

        // Refresh summary
        await loadSummary();

        showToast('Permission updated', 'success');
      } catch (e) {
        console.error('Error saving permission:', e);
        showToast('Failed to save: ' + e.message, 'error');

        // Revert UI
        toggle.classList.toggle('active', !newValue);
        if (type === 'canChat') {
          const executeToggle = document.querySelector(
            `.toggle-switch[data-user-id="${userId}"][data-module="${module}"][data-type="canExecute"]`
          );
          if (executeToggle) {
            executeToggle.classList.toggle('disabled', newValue);
          }
        }
      }
    }

    function filterUsers() {
      renderUsers();
    }

    function getInitials(user) {
      const first = (user.firstName || user.email || '').charAt(0).toUpperCase();
      const last = (user.lastName || '').charAt(0).toUpperCase();
      return first + last || '?';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');

      toastMessage.textContent = message;
      toast.className = `toast ${type}`;
      toast.querySelector('.material-symbols-outlined').textContent =
        type === 'success' ? 'check_circle' : 'error';

      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    init();
  </script>
</body>
</html>
