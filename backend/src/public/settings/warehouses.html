<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Warehouses - Settings</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <script src="/shell-v2.js"></script>
  <style>
    .page { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
    .page-title { font-size: 24px; font-weight: 700; color: #fff; margin: 0; display: flex; align-items: center; gap: 12px; }
    .page-badge { font-size: 12px; padding: 4px 10px; border-radius: 20px; background: rgba(100, 116, 139, 0.15); color: #94a3b8; font-weight: 500; }
    .header-actions { display: flex; gap: 8px; align-items: center; }

    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-primary { background: #8b5cf6; color: white; }
    .btn-primary:hover { background: #7c3aed; }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-secondary { background: #252532; color: #e4e4e7; border: 1px solid #3f3f50; }
    .btn-secondary:hover { background: #2a2a3a; }
    .btn .material-symbols-outlined { font-size: 18px; }

    .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
    @media (max-width: 600px) { .stats-row { grid-template-columns: 1fr; } }
    .stat-card { background: #18181f; border: 1px solid #252532; border-radius: 10px; padding: 16px; }
    .stat-value { font-size: 24px; font-weight: 700; color: #fff; }
    .stat-label { font-size: 11px; color: #71717a; text-transform: uppercase; letter-spacing: 0.02em; margin-top: 4px; }
    .stat-card.info .stat-value { color: #a78bfa; }
    .stat-card.success .stat-value { color: #4ade80; }

    .card { background: #18181f; border: 1px solid #252532; border-radius: 12px; overflow: hidden; }
    .card-header { padding: 14px 16px; border-bottom: 1px solid #252532; display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    .card-title { font-size: 14px; font-weight: 600; color: #fff; margin: 0; }
    .sync-info { display: flex; align-items: center; gap: 6px; color: #71717a; font-size: 12px; }
    .sync-info .material-symbols-outlined { font-size: 16px; }

    .filters { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .filter-input { padding: 6px 10px; background: #12121a; border: 1px solid #252532; border-radius: 6px; color: #e4e4e7; font-size: 12px; min-width: 180px; }
    .filter-input:focus { outline: none; border-color: #8b5cf6; }
    .filter-input::placeholder { color: #52525b; }
    .filter-select { padding: 6px 10px; background: #12121a; border: 1px solid #252532; border-radius: 6px; color: #e4e4e7; font-size: 12px; }
    .filter-select:focus { outline: none; border-color: #8b5cf6; }

    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #252532; }
    th { background: #12121a; font-size: 11px; font-weight: 600; color: #71717a; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; user-select: none; }
    th:hover { color: #a78bfa; }
    th.sorted { color: #8b5cf6; }
    th .sort-icon { font-size: 14px; vertical-align: middle; margin-left: 4px; }
    td { font-size: 13px; color: #e4e4e7; }
    tbody tr { transition: background 0.1s; }
    tbody tr:hover td { background: rgba(139, 92, 246, 0.08); }

    .warehouse-name { font-weight: 500; }
    .warehouse-code {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 12px;
      padding: 3px 8px;
      background: #1e1e2e;
      border: 1px solid #3f3f50;
      border-radius: 4px;
      color: #f0abfc;
      font-weight: 500;
    }
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .badge.active { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .badge.inactive { background: rgba(239, 68, 68, 0.15); color: #f87171; }
    .actions-cell { display: flex; gap: 6px; }
    .btn-icon { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; background: #252532; color: #71717a; transition: all 0.15s; }
    .btn-icon:hover { background: #8b5cf6; color: white; }
    .btn-icon .material-symbols-outlined { font-size: 16px; }

    .empty-state { text-align: center; padding: 48px 20px; color: #71717a; }
    .empty-state .material-symbols-outlined { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state-title { font-size: 16px; font-weight: 600; color: #e4e4e7; margin-bottom: 8px; }
    .empty-state-text { font-size: 13px; margin-bottom: 16px; }

    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .toast { position: fixed; bottom: 20px; right: 20px; background: #252532; border: 1px solid #22c55e; border-radius: 10px; padding: 14px 18px; color: #e4e4e7; font-size: 13px; z-index: 2000; display: none; }
    .toast.show { display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease-out; }
    .toast.error { border-color: #f87171; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-header">
      <h1 class="page-title">
        Warehouses
        <span class="page-badge" id="warehouse-count">Loading...</span>
      </h1>
      <div class="header-actions">
        <button class="btn btn-primary" id="sync-btn" onclick="syncWarehouses()">
          <span class="material-symbols-outlined">sync</span>
          Sync from Odoo
        </button>
      </div>
    </header>

    <div class="stats-row">
      <div class="stat-card info">
        <div class="stat-value" id="total-count">--</div>
        <div class="stat-label">Total Warehouses</div>
      </div>
      <div class="stat-card success">
        <div class="stat-value" id="active-count">--</div>
        <div class="stat-label">Active</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="last-sync" style="font-size: 14px;">Never</div>
        <div class="stat-label">Last Synced</div>
      </div>
    </div>

    <!-- Sync Settings -->
    <div class="card" style="margin-bottom: 16px;">
      <div class="card-header">
        <span class="card-title">Sync Settings</span>
      </div>
      <div style="display: flex; align-items: center; gap: 12px; padding: 14px 16px;">
        <div style="flex: 1; font-size: 13px; color: #e4e4e7;">
          Automatic Sync Interval
          <small style="display: block; color: #71717a; font-size: 11px; margin-top: 2px;">How often to sync warehouses from Odoo (0 = disabled)</small>
        </div>
        <select class="filter-select" id="sync-interval" onchange="saveSyncInterval()" style="min-width: 180px;">
          <option value="0">Disabled</option>
          <option value="6">Every 6 hours</option>
          <option value="12">Every 12 hours</option>
          <option value="24" selected>Every 24 hours (daily)</option>
          <option value="48">Every 48 hours</option>
          <option value="168">Every 7 days (weekly)</option>
        </select>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="filters">
          <input type="text" class="filter-input" id="filter-search" placeholder="Search by code or name..." oninput="filterWarehouses()">
          <select class="filter-select" id="filter-status" onchange="filterWarehouses()">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div class="sync-info">
          <span class="material-symbols-outlined">info</span>
          <span>Read-only from Odoo. Toggle visibility to include in reports.</span>
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th data-sort="id" onclick="sortWarehouses('id')">ID <span class="sort-icon"></span></th>
              <th data-sort="code" onclick="sortWarehouses('code')">Code <span class="sort-icon"></span></th>
              <th data-sort="name" onclick="sortWarehouses('name')">Name <span class="sort-icon"></span></th>
              <th>Stock Location</th>
              <th data-sort="isActive" onclick="sortWarehouses('isActive')">Status <span class="sort-icon"></span></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="warehouses-table">
            <tr>
              <td colspan="6">
                <div class="empty-state">
                  <span class="material-symbols-outlined loading-spinner">sync</span>
                  <div class="empty-state-title">Loading warehouses...</div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <span class="material-symbols-outlined" id="toast-icon">check_circle</span>
    <span id="toast-message"></span>
  </div>

  <script>
    let warehouses = [];
    let filteredWarehouses = [];
    let sortColumn = 'id';
    let sortDirection = 'asc';

    async function loadWarehouses() {
      try {
        const res = await fetch('/api/warehouses', { credentials: 'include' });
        const data = await res.json();

        if (!data.success) throw new Error(data.error);

        warehouses = data.warehouses || [];
        updateStats(data);
        filterWarehouses();

      } catch (error) {
        console.error('Failed to load warehouses:', error);
        document.getElementById('warehouses-table').innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <span class="material-symbols-outlined">cloud_off</span>
                <div class="empty-state-title">Failed to load warehouses</div>
                <div class="empty-state-text">${error.message}</div>
                <button class="btn btn-primary" onclick="syncWarehouses()">
                  <span class="material-symbols-outlined">sync</span>
                  Sync from Odoo
                </button>
              </div>
            </td>
          </tr>
        `;
      }
    }

    function updateStats(data) {
      const total = data.count || 0;
      const active = warehouses.filter(w => w.isActive).length;

      document.getElementById('warehouse-count').textContent = `${total} warehouses`;
      document.getElementById('total-count').textContent = total;
      document.getElementById('active-count').textContent = active;

      if (data.lastSyncedAt) {
        const date = new Date(data.lastSyncedAt);
        document.getElementById('last-sync').textContent =
          date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
    }

    function filterWarehouses() {
      const search = document.getElementById('filter-search').value.toLowerCase();
      const status = document.getElementById('filter-status').value;

      filteredWarehouses = warehouses.filter(w => {
        // Search filter
        if (search && !w.code.toLowerCase().includes(search) && !w.name.toLowerCase().includes(search)) {
          return false;
        }
        // Status filter
        if (status === 'active' && !w.isActive) return false;
        if (status === 'inactive' && w.isActive) return false;
        return true;
      });

      sortAndRender();
    }

    function sortWarehouses(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      sortAndRender();
      updateSortIndicators();
    }

    function sortAndRender() {
      filteredWarehouses.sort((a, b) => {
        let valA = a[sortColumn];
        let valB = b[sortColumn];

        if (typeof valA === 'string') valA = valA.toLowerCase();
        if (typeof valB === 'string') valB = valB.toLowerCase();

        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });

      renderWarehouses();
    }

    function updateSortIndicators() {
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.classList.remove('sorted');
        const icon = th.querySelector('.sort-icon');
        if (th.dataset.sort === sortColumn) {
          th.classList.add('sorted');
          icon.textContent = sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward';
        } else {
          icon.textContent = '';
        }
      });
    }

    function renderWarehouses() {
      const tbody = document.getElementById('warehouses-table');

      if (filteredWarehouses.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <span class="material-symbols-outlined">warehouse</span>
                <div class="empty-state-title">No warehouses found</div>
                <div class="empty-state-text">${warehouses.length === 0 ? 'Click "Sync from Odoo" to import warehouses' : 'Try adjusting your filters'}</div>
                ${warehouses.length === 0 ? `
                  <button class="btn btn-primary" onclick="syncWarehouses()">
                    <span class="material-symbols-outlined">sync</span>
                    Sync from Odoo
                  </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filteredWarehouses.map(w => `
        <tr>
          <td>${w.id}</td>
          <td><span class="warehouse-code">${w.code}</span></td>
          <td class="warehouse-name">${w.name}</td>
          <td>${w.stockLocationId || '-'}</td>
          <td>
            <span class="badge ${w.isActive ? 'active' : 'inactive'}">
              ${w.isActive ? 'Active' : 'Inactive'}
            </span>
          </td>
          <td class="actions-cell">
            <button class="btn-icon" onclick="toggleActive('${w._id}')" data-tooltip="${w.isActive ? 'Deactivate' : 'Activate'}">
              <span class="material-symbols-outlined">${w.isActive ? 'visibility_off' : 'visibility'}</span>
            </button>
          </td>
        </tr>
      `).join('');
    }

    async function syncWarehouses() {
      const btn = document.getElementById('sync-btn');
      const originalHtml = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="material-symbols-outlined loading-spinner">sync</span>Syncing...';

      try {
        const res = await fetch('/api/warehouses/sync', {
          method: 'POST',
          credentials: 'include'
        });
        const data = await res.json();

        if (!data.success) throw new Error(data.error);

        showToast(data.message);
        await loadWarehouses();

      } catch (error) {
        showToast('Sync failed: ' + error.message, true);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
      }
    }

    async function toggleActive(id) {
      try {
        const res = await fetch(`/api/warehouses/${id}/toggle-active`, {
          method: 'POST',
          credentials: 'include'
        });
        const data = await res.json();

        if (!data.success) throw new Error(data.error);

        showToast(data.message);
        await loadWarehouses();

      } catch (error) {
        showToast('Failed to update: ' + error.message, true);
      }
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toast-icon');
      const msg = document.getElementById('toast-message');

      icon.textContent = isError ? 'error' : 'check_circle';
      icon.style.color = isError ? '#f87171' : '#4ade80';
      toast.classList.toggle('error', isError);
      msg.textContent = message;

      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    async function loadSyncInterval() {
      try {
        const res = await fetch('/api/settings/sync-intervals', { credentials: 'include' });
        const data = await res.json();
        if (data.success && data.warehouses !== undefined) {
          document.getElementById('sync-interval').value = data.warehouses;
        }
      } catch (error) {
        console.error('Failed to load sync interval:', error);
      }
    }

    async function saveSyncInterval() {
      const interval = parseInt(document.getElementById('sync-interval').value);
      try {
        const res = await fetch('/api/settings/sync-intervals', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ warehouses: interval })
        });
        const data = await res.json();
        if (data.success) {
          showToast(interval === 0 ? 'Automatic sync disabled' : `Sync interval set to ${interval} hours`);
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        showToast('Failed to save: ' + error.message, true);
      }
    }

    // Initialize
    loadWarehouses();
    loadSyncInterval();
  </script>
</body>
</html>
