<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Accounting Assistant - ACROPAQ</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <script src="/shell-v2.js"></script>
  <style>
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 72px);
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-shrink: 0;
    }

    .page-title {
      font-size: 24px;
      font-weight: 600;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .page-title .material-symbols-outlined {
      font-size: 28px;
      color: #10b981;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      border: none;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #10b981;
      color: white;
    }

    .btn-primary:hover {
      background: #059669;
    }

    .btn-secondary {
      background: #252532;
      color: #a1a1aa;
      border: 1px solid #3f3f46;
    }

    .btn-secondary:hover {
      background: #3f3f46;
      color: #fff;
    }

    /* Chat container */
    .chat-wrapper {
      flex: 1;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
      min-height: 0;
    }

    @media (max-width: 900px) {
      .chat-wrapper {
        grid-template-columns: 1fr;
      }
      .sidebar { display: none; }
    }

    /* Sidebar */
    .sidebar {
      background: #18181f;
      border-radius: 12px;
      border: 1px solid #252532;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #252532;
      font-weight: 600;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .knowledge-item {
      padding: 12px;
      border-radius: 8px;
      background: #252532;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .knowledge-item:hover {
      background: #3f3f46;
    }

    .knowledge-category {
      font-size: 10px;
      text-transform: uppercase;
      color: #10b981;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .knowledge-subject {
      font-size: 13px;
      color: #fff;
      font-weight: 500;
    }

    .knowledge-fact {
      font-size: 12px;
      color: #a1a1aa;
      margin-top: 4px;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Main chat */
    .chat-main {
      background: #18181f;
      border-radius: 12px;
      border: 1px solid #252532;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      max-width: 85%;
      padding: 14px 18px;
      border-radius: 16px;
      line-height: 1.5;
      font-size: 14px;
    }

    .message.user {
      background: #10b981;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message.assistant {
      background: #252532;
      color: #e4e4e7;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .message.system {
      background: #1e1e2e;
      color: #71717a;
      align-self: center;
      font-size: 12px;
      padding: 8px 16px;
    }

    .message-meta {
      font-size: 11px;
      color: #71717a;
      margin-top: 6px;
    }

    .message.assistant .message-meta {
      color: #52525b;
    }

    /* Markdown-like formatting in messages */
    .message pre {
      background: #18181f;
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 8px 0;
      font-size: 12px;
    }

    .message code {
      background: #18181f;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }

    .message table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 13px;
    }

    .message th, .message td {
      border: 1px solid #3f3f46;
      padding: 8px 12px;
      text-align: left;
    }

    .message th {
      background: #252532;
      font-weight: 600;
    }

    .message ul, .message ol {
      margin: 8px 0;
      padding-left: 20px;
    }

    .message li {
      margin: 4px 0;
    }

    /* Chat input */
    .chat-input-container {
      padding: 16px;
      border-top: 1px solid #252532;
      display: flex;
      gap: 12px;
    }

    .chat-input {
      flex: 1;
      background: #252532;
      border: 1px solid #3f3f46;
      border-radius: 12px;
      padding: 14px 18px;
      color: #fff;
      font-size: 14px;
      resize: none;
      min-height: 24px;
      max-height: 120px;
      font-family: inherit;
    }

    .chat-input:focus {
      outline: none;
      border-color: #10b981;
    }

    .chat-input::placeholder {
      color: #71717a;
    }

    .send-btn {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 12px;
      width: 48px;
      height: 48px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .send-btn:hover {
      background: #059669;
    }

    .send-btn:disabled {
      background: #3f3f46;
      cursor: not-allowed;
    }

    .send-btn .material-symbols-outlined {
      font-size: 24px;
    }

    /* Loading indicator */
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 14px 18px;
      background: #252532;
      border-radius: 16px;
      border-bottom-left-radius: 4px;
      align-self: flex-start;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #71717a;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-8px); }
    }

    /* Stats badge */
    .stats-badge {
      display: flex;
      gap: 16px;
      padding: 12px 16px;
      background: #252532;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: #10b981;
    }

    .stat-label {
      font-size: 11px;
      color: #71717a;
      text-transform: uppercase;
    }

    /* Suggestions */
    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .suggestion-chip {
      padding: 8px 14px;
      background: #252532;
      border: 1px solid #3f3f46;
      border-radius: 20px;
      font-size: 12px;
      color: #a1a1aa;
      cursor: pointer;
      transition: all 0.2s;
    }

    .suggestion-chip:hover {
      background: #3f3f46;
      color: #fff;
      border-color: #10b981;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="page-header">
      <div class="page-title">
        <span class="material-symbols-outlined">account_balance</span>
        Accounting Assistant
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="viewKnowledge()">
          <span class="material-symbols-outlined">school</span>
          Knowledge Base
        </button>
        <button class="btn btn-secondary" onclick="viewApprovals()">
          <span class="material-symbols-outlined">approval</span>
          Pending Approvals
        </button>
        <button class="btn btn-secondary" onclick="clearChat()">
          <span class="material-symbols-outlined">refresh</span>
          New Chat
        </button>
      </div>
    </div>

    <div class="chat-wrapper">
      <!-- Sidebar: Knowledge preview -->
      <div class="sidebar">
        <div class="sidebar-header">
          <span class="material-symbols-outlined">lightbulb</span>
          Knowledge Base
        </div>
        <div class="sidebar-content" id="knowledgeList">
          <div class="stats-badge" id="knowledgeStats">
            <div class="stat-item">
              <div class="stat-value" id="knowledgeCount">-</div>
              <div class="stat-label">Entries</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="pendingApprovals">-</div>
              <div class="stat-label">Pending</div>
            </div>
          </div>
          <div id="knowledgeItems">Loading...</div>
        </div>
      </div>

      <!-- Main chat -->
      <div class="chat-main">
        <div class="chat-messages" id="chatMessages">
          <div class="message system">
            Start a conversation with the Accounting Assistant. It remembers facts you teach it!
          </div>
          <div class="suggestions" id="suggestions">
            <div class="suggestion-chip" onclick="sendSuggestion('Which suppliers do I need to pay this week?')">
              Which suppliers to pay this week?
            </div>
            <div class="suggestion-chip" onclick="sendSuggestion('What is my current cash position?')">
              Current cash position
            </div>
            <div class="suggestion-chip" onclick="sendSuggestion('Show me overdue receivables')">
              Overdue receivables
            </div>
            <div class="suggestion-chip" onclick="sendSuggestion('What do you know about German VAT?')">
              German VAT rules
            </div>
          </div>
        </div>

        <div class="chat-input-container">
          <textarea
            class="chat-input"
            id="chatInput"
            placeholder="Ask about invoices, payments, cash flow, or teach me something new..."
            rows="1"
            onkeydown="handleKeydown(event)"
          ></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">
            <span class="material-symbols-outlined">send</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Session ID for this chat
    const sessionId = 'session-' + Date.now();
    let isLoading = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadKnowledge();
      loadStats();
      autoResizeTextarea();
    });

    // Auto-resize textarea
    function autoResizeTextarea() {
      const textarea = document.getElementById('chatInput');
      textarea.addEventListener('input', () => {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
      });
    }

    // Handle Enter key
    function handleKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    // Send message
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();

      if (!message || isLoading) return;

      // Clear input
      input.value = '';
      input.style.height = 'auto';

      // Hide suggestions
      document.getElementById('suggestions').style.display = 'none';

      // Add user message
      addMessage(message, 'user');

      // Show typing indicator
      isLoading = true;
      document.getElementById('sendBtn').disabled = true;
      const typingId = showTypingIndicator();

      try {
        const response = await fetch('/api/accounting-assistant/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, session_id: sessionId })
        });

        const data = await response.json();

        // Remove typing indicator
        removeTypingIndicator(typingId);

        if (data.success) {
          addMessage(data.response, 'assistant', data.metadata);

          // Refresh knowledge if something was remembered
          if (message.toLowerCase().includes('remember')) {
            setTimeout(loadKnowledge, 1000);
          }
        } else {
          addMessage('Error: ' + (data.error || 'Unknown error'), 'system');
        }
      } catch (error) {
        removeTypingIndicator(typingId);
        addMessage('Error: ' + error.message, 'system');
      } finally {
        isLoading = false;
        document.getElementById('sendBtn').disabled = false;
      }
    }

    // Send suggestion
    function sendSuggestion(text) {
      document.getElementById('chatInput').value = text;
      sendMessage();
    }

    // Add message to chat
    function addMessage(text, type, metadata = null) {
      const container = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = `message ${type}`;

      // Simple markdown-like formatting
      let formatted = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>');

      div.innerHTML = formatted;

      if (metadata && type === 'assistant') {
        const meta = document.createElement('div');
        meta.className = 'message-meta';
        const parts = [];
        if (metadata.durationMs) parts.push(`${metadata.durationMs}ms`);
        if (metadata.knowledgeRetrieved) parts.push(`${metadata.knowledgeRetrieved} facts used`);
        if (metadata.toolsUsed?.length) parts.push(`${metadata.toolsUsed.length} tools`);
        if (parts.length) meta.textContent = parts.join(' | ');
        div.appendChild(meta);
      }

      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    // Show typing indicator
    function showTypingIndicator() {
      const container = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = 'typing-indicator';
      div.id = 'typing-' + Date.now();
      div.innerHTML = '<span></span><span></span><span></span>';
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      return div.id;
    }

    // Remove typing indicator
    function removeTypingIndicator(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    // Load knowledge preview
    async function loadKnowledge() {
      try {
        const response = await fetch('/api/accounting-assistant/knowledge?limit=10');
        const data = await response.json();

        if (data.success) {
          document.getElementById('knowledgeCount').textContent = data.total || data.count;

          const container = document.getElementById('knowledgeItems');
          if (data.entries && data.entries.length > 0) {
            container.innerHTML = data.entries.map(k => `
              <div class="knowledge-item" onclick="askAbout('${k.subject.replace(/'/g, "\\'")}')">
                <div class="knowledge-category">${k.category.replace(/_/g, ' ')}</div>
                <div class="knowledge-subject">${k.subject}</div>
                <div class="knowledge-fact">${k.fact}</div>
              </div>
            `).join('');
          } else {
            container.innerHTML = '<div style="color: #71717a; text-align: center; padding: 20px;">No knowledge entries yet</div>';
          }
        }
      } catch (error) {
        console.error('Error loading knowledge:', error);
      }
    }

    // Load stats
    async function loadStats() {
      try {
        const response = await fetch('/api/accounting-assistant/approvals/stats');
        const data = await response.json();

        if (data.success) {
          document.getElementById('pendingApprovals').textContent = data.pendingCount || 0;
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Ask about a knowledge item
    function askAbout(subject) {
      document.getElementById('chatInput').value = `What do you know about ${subject}?`;
      sendMessage();
    }

    // Clear chat
    async function clearChat() {
      try {
        await fetch(`/api/accounting-assistant/chat/${sessionId}`, { method: 'DELETE' });
      } catch (e) {}

      document.getElementById('chatMessages').innerHTML = `
        <div class="message system">
          Chat cleared. Start a new conversation!
        </div>
        <div class="suggestions" id="suggestions">
          <div class="suggestion-chip" onclick="sendSuggestion('Which suppliers do I need to pay this week?')">
            Which suppliers to pay this week?
          </div>
          <div class="suggestion-chip" onclick="sendSuggestion('What is my current cash position?')">
            Current cash position
          </div>
          <div class="suggestion-chip" onclick="sendSuggestion('Show me overdue receivables')">
            Overdue receivables
          </div>
          <div class="suggestion-chip" onclick="sendSuggestion('What do you know about German VAT?')">
            German VAT rules
          </div>
        </div>
      `;

      // New session
      window.sessionId = 'session-' + Date.now();
    }

    // View knowledge base
    function viewKnowledge() {
      window.open('/accounting/knowledge.html', '_blank');
    }

    // View approvals
    function viewApprovals() {
      window.open('/accounting/approvals.html', '_blank');
    }
  </script>
</body>
</html>
